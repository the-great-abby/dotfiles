#!/bin/bash

# Zettelkasten Link Helper - Link atomic notes to PARA categories and GTD items

# Load GTD config
GTD_CONFIG_FILE="$HOME/.gtd_config"
if [[ -f "$HOME/code/personal/dotfiles/zsh/.gtd_config" ]]; then
  GTD_CONFIG_FILE="$HOME/code/personal/dotfiles/zsh/.gtd_config"
elif [[ -f "$HOME/code/dotfiles/zsh/.gtd_config" ]]; then
  GTD_CONFIG_FILE="$HOME/code/dotfiles/zsh/.gtd_config"
fi

# Source config if it exists
if [[ -f "$GTD_CONFIG_FILE" ]]; then
  source "$GTD_CONFIG_FILE"
fi

# Default values
SECOND_BRAIN="${SECOND_BRAIN:-$HOME/Documents/obsidian/Second Brain}"
ZET_DIR="${ZET_DIR:-$SECOND_BRAIN/Zettelkasten}"
ZET_INBOX="${ZET_INBOX:-$SECOND_BRAIN/0-inbox}"

# Colors
CYAN='\033[0;36m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BOLD='\033[1m'
NC='\033[0m'

# Link zettelkasten note to a PARA category or Second Brain note
link_zet_to_para() {
  local zet_note="$1"
  local para_target="$2"
  
  if [[ ! -f "$zet_note" ]]; then
    echo -e "${YELLOW}❌ Error: Zettelkasten note not found: $zet_note${NC}"
    return 1
  fi
  
  local para_path
  case "$para_target" in
    project|projects|Projects)
      para_path="$SECOND_BRAIN/Projects"
      ;;
    area|areas|Areas)
      para_path="$SECOND_BRAIN/Areas"
      ;;
    resource|resources|Resources)
      para_path="$SECOND_BRAIN/Resources"
      ;;
    archive|archives|Archives)
      para_path="$SECOND_BRAIN/Archives"
      ;;
    *)
      # Assume it's a file path
      para_path="$para_target"
      ;;
  esac
  
  # If it's a directory, we need to find/create a specific note
  if [[ -d "$para_path" ]]; then
    echo -e "${CYAN}Linking to PARA category: $para_target${NC}"
    echo -e "${YELLOW}Note: For specific notes, use: zet-link <zet-note> <specific-note-path>${NC}"
    
    # Add link to zet note
    local link_text="PARA: $para_target"
    if ! grep -q "\[\[.*$link_text" "$zet_note" 2>/dev/null; then
      # Add link in Related section
      if grep -q "## Related" "$zet_note"; then
        sed -i.bak "/## Related/a\\
- [[$para_target]] - PARA category
" "$zet_note" && rm -f "${zet_note}.bak"
      else
        echo "" >> "$zet_note"
        echo "## Related" >> "$zet_note"
        echo "- [[$para_target]] - PARA category" >> "$zet_note"
      fi
      echo -e "${GREEN}✓ Added link to $para_target${NC}"
    else
      echo -e "${YELLOW}Link already exists${NC}"
    fi
  else
    # It's a specific note
    if [[ -f "$para_path" ]]; then
      local target_name=$(basename "$para_path" .md)
      
      # Add bidirectional links
      echo -e "${CYAN}Creating bidirectional link...${NC}"
      
      # Add link from zet note to para note
      if ! grep -q "\[\[$target_name\]\]" "$zet_note" 2>/dev/null; then
        if grep -q "## Links" "$zet_note"; then
          sed -i.bak "/## Links/a\\
- [[$target_name]]
" "$zet_note" && rm -f "${zet_note}.bak"
        else
          echo "" >> "$zet_note"
          echo "## Links" >> "$zet_note"
          echo "- [[$target_name]]" >> "$zet_note"
        fi
      fi
      
      # Add link from para note to zet note
      local zet_name=$(basename "$zet_note" .md)
      if ! grep -q "\[\[$zet_name\]\]" "$para_path" 2>/dev/null; then
        if grep -q "## Links\|## Related" "$para_path"; then
          sed -i.bak "/## Links\|## Related/a\\
- [[$zet_name]] - Zettelkasten note
" "$para_path" && rm -f "${para_path}.bak"
        else
          echo "" >> "$para_path"
          echo "## Links" >> "$para_path"
          echo "- [[$zet_name]] - Zettelkasten note" >> "$para_path"
        fi
      fi
      
      echo -e "${GREEN}✓ Created bidirectional link between zettelkasten and PARA note${NC}"
    else
      echo -e "${YELLOW}❌ Error: Target note not found: $para_path${NC}"
      return 1
    fi
  fi
}

# Link zettelkasten note to GTD item
link_zet_to_gtd() {
  local zet_note="$1"
  local gtd_item="$2"
  
  if [[ ! -f "$zet_note" ]]; then
    echo -e "${YELLOW}❌ Error: Zettelkasten note not found: $zet_note${NC}"
    return 1
  fi
  
  if [[ ! -f "$gtd_item" ]]; then
    echo -e "${YELLOW}❌ Error: GTD item not found: $gtd_item${NC}"
    return 1
  fi
  
  local gtd_name=$(basename "$gtd_item" .md)
  local zet_name=$(basename "$zet_note" .md)
  
  # Add link from zet to GTD
  if ! grep -q "\[\[$gtd_name\]\]" "$zet_note" 2>/dev/null; then
    if grep -q "## Related" "$zet_note"; then
      sed -i.bak "/## Related/a\\
- [[$gtd_name]] - GTD item
" "$zet_note" && rm -f "${zet_note}.bak"
    else
      echo "" >> "$zet_note"
      echo "## Related" >> "$zet_note"
      echo "- [[$gtd_name]] - GTD item" >> "$zet_note"
    fi
  fi
  
  # Add link from GTD to zet
  if ! grep -q "\[\[$zet_name\]\]" "$gtd_item" 2>/dev/null; then
    if grep -q "## Links\|## Second Brain\|## Zettelkasten" "$gtd_item"; then
      sed -i.bak "/## Links\|## Second Brain\|## Zettelkasten/a\\
- [[$zet_name]] - Zettelkasten note
" "$gtd_item" && rm -f "${gtd_item}.bak"
    else
      echo "" >> "$gtd_item"
      echo "## Zettelkasten" >> "$gtd_item"
      echo "- [[$zet_name]]" >> "$gtd_item"
    fi
  fi
  
  echo -e "${GREEN}✓ Linked zettelkasten note to GTD item${NC}"
}

# Move zettelkasten note to PARA category
move_zet_to_para() {
  local zet_note="$1"
  local para_category="$2"
  
  if [[ ! -f "$zet_note" ]]; then
    echo -e "${YELLOW}❌ Error: Note not found: $zet_note${NC}"
    return 1
  fi
  
  local dest_dir
  case "$para_category" in
    project|projects|Projects)
      dest_dir="$SECOND_BRAIN/Projects"
      ;;
    area|areas|Areas)
      dest_dir="$SECOND_BRAIN/Areas"
      ;;
    resource|resources|Resources)
      dest_dir="$SECOND_BRAIN/Resources"
      ;;
    archive|archives|Archives)
      dest_dir="$SECOND_BRAIN/Archives"
      ;;
    *)
      echo -e "${YELLOW}❌ Error: Invalid PARA category: $para_category${NC}"
      return 1
      ;;
  esac
  
  local filename=$(basename "$zet_note")
  local dest_path="$dest_dir/$filename"
  
  if [[ "$zet_note" == "$dest_path" ]]; then
    echo -e "${YELLOW}Note is already in $para_category${NC}"
    return 0
  fi
  
  mv "$zet_note" "$dest_path"
  echo -e "${GREEN}✓ Moved zettelkasten note to $para_category${NC}"
  echo "$dest_path"
}

# Show usage
show_usage() {
  cat <<EOF
Usage: zet-link <command> [options]

Commands:
  link <zet-note> <para-target>     Link zettelkasten note to PARA category or note
  gtd <zet-note> <gtd-item>         Link zettelkasten note to GTD item
  move <zet-note> <para-category>   Move zettelkasten note to PARA category

Examples:
  # Link to PARA category
  zet-link link ~/Documents/Second\ Brain/Zettelkasten/202501011200-concept.md Projects
  
  # Link to specific Second Brain note
  zet-link link ~/Documents/Second\ Brain/Zettelkasten/202501011200-concept.md \\
    ~/Documents/Second\ Brain/Projects/my-project.md
  
  # Link to GTD project
  zet-link gtd ~/Documents/Second\ Brain/Zettelkasten/202501011200-concept.md \\
    ~/Documents/gtd/1-projects/my-project.md
  
  # Move to PARA category
  zet-link move ~/Documents/Second\ Brain/0-inbox/202501011200-note.md Resources

EOF
}

# Main command handler
case "$1" in
  link)
    if [[ -z "$2" || -z "$3" ]]; then
      echo -e "${YELLOW}❌ Error: Both zettelkasten note and target required${NC}"
      show_usage
      exit 1
    fi
    link_zet_to_para "$2" "$3"
    ;;
  gtd)
    if [[ -z "$2" || -z "$3" ]]; then
      echo -e "${YELLOW}❌ Error: Both zettelkasten note and GTD item required${NC}"
      show_usage
      exit 1
    fi
    link_zet_to_gtd "$2" "$3"
    ;;
  move)
    if [[ -z "$2" || -z "$3" ]]; then
      echo -e "${YELLOW}❌ Error: Both zettelkasten note and PARA category required${NC}"
      show_usage
      exit 1
    fi
    move_zet_to_para "$2" "$3"
    ;;
  *)
    show_usage
    exit 1
    ;;
esac

