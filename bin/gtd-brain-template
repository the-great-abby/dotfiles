#!/bin/bash
# GTD Second Brain - Template Management
# Create notes from templates

# Source common environment (PATH setup)
COMMON_ENV="$HOME/code/dotfiles/zsh/common_env.sh"
if [[ ! -f "$COMMON_ENV" && -f "$HOME/code/personal/dotfiles/zsh/common_env.sh" ]]; then
  COMMON_ENV="$HOME/code/personal/dotfiles/zsh/common_env.sh"
fi
if [[ -f "$COMMON_ENV" ]]; then
  source "$COMMON_ENV"
fi


# Load GTD config
GTD_CONFIG_FILE="$HOME/.gtd_config"
if [[ -f "$HOME/code/dotfiles/zsh/.gtd_config" ]]; then
  GTD_CONFIG_FILE="$HOME/code/dotfiles/zsh/.gtd_config"
elif [[ -f "$HOME/code/personal/dotfiles/zsh/.gtd_config" ]]; then
  GTD_CONFIG_FILE="$HOME/code/personal/dotfiles/zsh/.gtd_config"
fi

if [[ -f "$GTD_CONFIG_FILE" ]]; then
  source "$GTD_CONFIG_FILE"
fi

# Default values
SECOND_BRAIN="${SECOND_BRAIN:-$HOME/Documents/obsidian/Second Brain}"
TEMPLATES_DIR="${SECOND_BRAIN}/Templates"

# Colors
CYAN='\033[0;36m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BOLD='\033[1m'
NC='\033[0m'

# Get date command
get_date_cmd() {
  if [[ -x "/usr/bin/date" ]]; then
    echo "/usr/bin/date"
  elif [[ -x "/bin/date" ]]; then
    echo "/bin/date"
  else
    echo "date"
  fi
}

DATE_CMD=$(get_date_cmd)

# List available templates
list_templates() {
  echo ""
  echo -e "${BOLD}${CYAN}Available Templates${NC}"
  echo -e "${CYAN}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${NC}"
  echo ""
  
  if [[ ! -d "$TEMPLATES_DIR" ]]; then
    echo "‚ö†Ô∏è  Templates directory not found: $TEMPLATES_DIR"
    return 1
  fi
  
  local templates=$(find "$TEMPLATES_DIR" -name "*.md" -type f 2>/dev/null | sort)
  
  if [[ -z "$templates" ]]; then
    echo "No templates found."
    echo ""
    return 0
  fi
  
  echo "$templates" | while read -r template; do
    local name=$(basename "$template" .md)
    echo -e "${GREEN}‚Ä¢${NC} ${name}"
  done
  echo ""
}

# Create note from template
create_from_template() {
  local template_name="$1"
  local output_name="$2"
  local category="${3:-Resources}"  # Projects, Areas, Resources
  
  if [[ -z "$template_name" ]]; then
    echo "‚ùå Template name required"
    echo "Usage: gtd-brain-template create <template-name> <output-name> [category]"
    return 1
  fi
  
  if [[ -z "$output_name" ]]; then
    echo "‚ùå Output name required"
    echo "Usage: gtd-brain-template create <template-name> <output-name> [category]"
    return 1
  fi
  
  local template_file="${TEMPLATES_DIR}/${template_name}.md"
  
  if [[ ! -f "$template_file" ]]; then
    echo "‚ùå Template not found: $template_file"
    echo ""
    echo "Available templates:"
    list_templates
    return 1
  fi
  
  local today=$($DATE_CMD +"%Y-%m-%d")
  local time=$($DATE_CMD +"%H:%M")
  local timestamp="${today} ${time}"
  local filename=$(echo "$output_name" | tr '[:upper:]' '[:lower:]' | sed 's/[^a-z0-9]/-/g' | sed 's/--*/-/g' | sed 's/^-\|-$//g')
  local output_file="${SECOND_BRAIN}/${category}/${filename}.md"
  
  # Replace template variables
  local content=$(cat "$template_file")
  content=$(echo "$content" | sed "s/{{date}}/${today}/g")
  content=$(echo "$content" | sed "s/{{time}}/${time}/g")
  content=$(echo "$content" | sed "s/{{timestamp}}/${timestamp}/g")
  content=$(echo "$content" | sed "s/{{title}}/${output_name}/g")
  
  # Write output file
  echo "$content" > "$output_file"
  
  echo "‚úì Created note from template: $output_file"
  echo ""
  echo "üìù Next steps:"
  echo "  1. Edit the note to fill in details"
  echo "  2. Replace any remaining {{variables}}"
  echo "  3. Add content and links"
  echo ""
  echo "$output_file"
}

# Show usage
show_usage() {
  cat <<EOF
Usage: gtd-brain-template <command> [options]

Commands:
  list                              List available templates
  create <template> <name> [cat]     Create note from template
                                    category: Projects, Areas, Resources (default)
  help                              Show this help

Examples:
  gtd-brain-template list
  gtd-brain-template create "Meeting Notes" "Team Standup" Resources
  gtd-brain-template create "Book Notes" "Getting Things Done" Resources
  gtd-brain-template create "Project Notes" "Website Redesign" Projects

Available Templates:
  - Meeting Notes
  - Book Notes
  - Article Notes
  - Project Notes
  - Area Notes
  - MOC Template

EOF
}

# Main command handler
case "${1:-}" in
  list)
    list_templates
    ;;
  create)
    create_from_template "$2" "$3" "${4:-Resources}"
    ;;
  help|--help|-h)
    show_usage
    ;;
  "")
    show_usage
    ;;
  *)
    echo "‚ùå Unknown command: $1"
    echo ""
    show_usage
    exit 1
    ;;
esac

