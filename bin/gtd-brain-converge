#!/bin/bash
# GTD Second Brain - Convergence Phase
# Narrow down ideas to the best ones (decision-making)

# Source common environment (PATH setup)
COMMON_ENV="$HOME/code/dotfiles/zsh/common_env.sh"
if [[ ! -f "$COMMON_ENV" && -f "$HOME/code/personal/dotfiles/zsh/common_env.sh" ]]; then
  COMMON_ENV="$HOME/code/personal/dotfiles/zsh/common_env.sh"
fi
if [[ -f "$COMMON_ENV" ]]; then
  source "$COMMON_ENV"
fi


# Load GTD config
GTD_CONFIG_FILE="$HOME/.gtd_config"
if [[ -f "$HOME/code/dotfiles/zsh/.gtd_config" ]]; then
  GTD_CONFIG_FILE="$HOME/code/dotfiles/zsh/.gtd_config"
elif [[ -f "$HOME/code/personal/dotfiles/zsh/.gtd_config" ]]; then
  GTD_CONFIG_FILE="$HOME/code/personal/dotfiles/zsh/.gtd_config"
fi

if [[ -f "$GTD_CONFIG_FILE" ]]; then
  source "$GTD_CONFIG_FILE"
fi

# Default values
SECOND_BRAIN="${SECOND_BRAIN:-$HOME/Documents/obsidian/Second Brain}"
DIVERGE_DIR="${SECOND_BRAIN}/Divergence"
CONVERGE_DIR="${SECOND_BRAIN}/Convergence"
GTD_BASE_DIR="${GTD_BASE_DIR:-$HOME/Documents/gtd}"

# Create Convergence directory
mkdir -p "$CONVERGE_DIR"

# Colors
CYAN='\033[0;36m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BOLD='\033[1m'
NC='\033[0m'

# Get date command
get_date_cmd() {
  if [[ -x "/usr/bin/date" ]]; then
    echo "/usr/bin/date"
  elif [[ -x "/bin/date" ]]; then
    echo "/bin/date"
  else
    echo "date"
  fi
}

DATE_CMD=$(get_date_cmd)

# Start convergence from divergence session
start_convergence() {
  local divergence_file="$1"
  
  if [[ -z "$divergence_file" ]]; then
    echo "‚ùå Divergence session file required"
    echo "Usage: gtd-brain-converge <divergence-session-file>"
    return 1
  fi
  
  # Expand if relative path
  if [[ "$divergence_file" != /* ]]; then
    local found_file=$(find "$DIVERGE_DIR" -name "$(basename "$divergence_file")" -type f 2>/dev/null | head -1)
    if [[ -n "$found_file" ]]; then
      divergence_file="$found_file"
    fi
  fi
  
  if [[ ! -f "$divergence_file" ]]; then
    echo "‚ùå Divergence session not found: $divergence_file"
    return 1
  fi
  
  local topic=$(grep "^# Divergence Session:" "$divergence_file" | head -1 | sed 's/^# Divergence Session: //' || echo "Unknown")
  local timestamp=$($DATE_CMD +"%Y-%m-%d %H:%M")
  local today=$($DATE_CMD +"%Y-%m-%d")
  local filename=$(echo "$topic" | tr '[:upper:]' '[:lower:]' | sed 's/[^a-z0-9]/-/g' | sed 's/--*/-/g' | sed 's/^-\|-$//g')
  local converge_file="${CONVERGE_DIR}/${today}-${filename}-converged.md"
  
  echo ""
  echo -e "${BOLD}${CYAN}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${NC}"
  echo -e "${BOLD}${CYAN}üéØ Convergence Phase: ${topic}${NC}"
  echo -e "${CYAN}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${NC}"
  echo ""
  echo "Rules for convergence:"
  echo "  ‚Ä¢ Evaluate ideas critically"
  echo "  ‚Ä¢ Apply criteria"
  echo "  ‚Ä¢ Narrow down to best options"
  echo "  ‚Ä¢ Make decisions"
  echo "  ‚Ä¢ Quality over quantity"
  echo ""
  
  # Extract ideas from divergence session
  local ideas=$(awk '/^## Ideas$/,/^## / {if (!/^## Ideas$/ && !/^## /) print; if (/^## / && !/^## Ideas$/) exit}' "$divergence_file")
  
  # Create convergence file
  cat > "$converge_file" <<EOF
# Convergence Session: ${topic}

Created: ${timestamp}
Phase: Convergence
Source: [[$(basename "$divergence_file" .md)]]

## Topic
${topic}

## Evaluation Criteria
<!-- Define criteria for evaluating ideas -->
- Feasibility: 
- Impact: 
- Resources needed: 
- Timeline: 
- Alignment with goals: 

## Ideas from Divergence
${ideas}

## Evaluation

### High Priority Ideas
<!-- Ideas that score high on all criteria -->
- 

### Medium Priority Ideas
<!-- Ideas worth considering but not top priority -->
- 

### Low Priority Ideas
<!-- Ideas to set aside for now -->
- 

## Decisions
<!-- Final decisions and commitments -->
- 

## Next Actions
<!-- What will you do with the selected ideas? -->
- 

## Tags
#convergence #decision-making #${filename}

---
Completed: ${timestamp}

EOF

  echo "‚úì Convergence session started: $converge_file"
  echo ""
  echo "üéØ Now evaluate ideas and make decisions!"
  echo "   Edit the file: $converge_file"
  echo ""
  echo "$converge_file"
}

# List convergence sessions
list_sessions() {
  echo ""
  echo -e "${BOLD}${CYAN}Convergence Sessions${NC}"
  echo -e "${CYAN}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${NC}"
  echo ""
  
  local sessions=$(find "$CONVERGE_DIR" -name "*.md" -type f 2>/dev/null | sort -r)
  
  if [[ -z "$sessions" ]]; then
    echo "No convergence sessions found."
    echo ""
    echo "Start one with: gtd-brain-converge <divergence-session-file>"
    echo ""
    return 0
  fi
  
  echo "$sessions" | while read -r session; do
    local topic=$(grep "^# Convergence Session:" "$session" | head -1 | sed 's/^# Convergence Session: //' || basename "$session" .md)
    local created=$(grep "^Created:" "$session" | head -1 | cut -d':' -f2- | sed 's/^[[:space:]]*//' || echo "Unknown")
    local decisions=$(grep -c "^- " "$session" 2>/dev/null | grep -A 100 "## Decisions" | head -20 | wc -l | tr -d ' ' || echo "0")
    
    echo -e "${GREEN}‚Ä¢${NC} ${BOLD}${topic}${NC}"
    echo "  Created: ${created} | Decisions: ${decisions}"
    echo ""
  done
}

# Show usage
show_usage() {
  cat <<EOF
Usage: gtd-brain-converge <command> [options]

Commands:
  <divergence-file>               Start convergence from divergence session
  list                            List all convergence sessions
  help                            Show this help

Examples:
  gtd-brain-converge ~/Documents/obsidian/Second\ Brain/Divergence/2025-01-01-product-features.md
  gtd-brain-converge list

Convergence is the decision-making phase - narrow down ideas to the best ones.
Apply criteria, evaluate, and make decisions. Build on the divergence phase.

EOF
}

# Main command handler
case "${1:-}" in
  list)
    list_sessions
    ;;
  help|--help|-h)
    show_usage
    ;;
  "")
    show_usage
    ;;
  *)
    start_convergence "$1"
    ;;
esac

