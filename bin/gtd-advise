#!/bin/bash
# GTD Advise Command - Get advice from multiple AI personas

# Source common environment (PATH setup)
COMMON_ENV="$HOME/code/dotfiles/zsh/common_env.sh"
if [[ ! -f "$COMMON_ENV" && -f "$HOME/code/personal/dotfiles/zsh/common_env.sh" ]]; then
  COMMON_ENV="$HOME/code/personal/dotfiles/zsh/common_env.sh"
fi
if [[ -f "$COMMON_ENV" ]]; then
  source "$COMMON_ENV"
fi


# Load config
GTD_CONFIG_FILE="$HOME/.gtd_config"
if [[ -f "$HOME/code/personal/dotfiles/zsh/.gtd_config" ]]; then
  GTD_CONFIG_FILE="$HOME/code/personal/dotfiles/zsh/.gtd_config"
fi

if [[ -f "$GTD_CONFIG_FILE" ]]; then
  source "$GTD_CONFIG_FILE"
fi

# Find persona helper
PERSONA_HELPER=""
POSSIBLE_PATHS=(
  "$HOME/code/personal/dotfiles/zsh/functions/gtd_persona_helper.py"
  "$HOME/code/dotfiles/zsh/functions/gtd_persona_helper.py"
)

for path in "${POSSIBLE_PATHS[@]}"; do
  if [[ -f "$path" ]]; then
    PERSONA_HELPER="$path"
    break
  fi
done

if [[ -z "$PERSONA_HELPER" || ! -f "$PERSONA_HELPER" ]]; then
  echo "âŒ Persona helper not found. Expected at:"
  for path in "${POSSIBLE_PATHS[@]}"; do
    echo "   $path"
  done
  exit 1
fi

# Find python
PYTHON_CMD=""
if [[ -f "/opt/homebrew/bin/python3" ]]; then
  PYTHON_CMD="/opt/homebrew/bin/python3"
elif command -v python3 &>/dev/null; then
  PYTHON_CMD="python3"
else
  echo "âŒ python3 not found"
  exit 1
fi

# Available personas
PERSONAS=("hank" "david" "cal" "james" "marie" "warren" "sheryl" "tim" "george" "john" "jon" "bob" "fred" "louiza" "spiderman" "ironman" "squirrelgirl" "harley" "deadpool" "rogue" "esther" "gottman" "gary" "brene" "romance" "kettlebell" "maxfit" "dumbbell" "dipbar" "kelsey" "kent" "charity" "rich" "goggins" "dean" "bioneer")

# Show persona info
show_persona_info() {
  case "$1" in
    hank) echo "Hank Hill - General productivity, practical reminders" ;;
    david) echo "David Allen - GTD methodology, organization" ;;
    cal) echo "Cal Newport - Deep work, focus, eliminating distractions" ;;
    james) echo "James Clear - Habit formation, systems thinking" ;;
    marie) echo "Marie Kondo - Organization, decluttering" ;;
    warren) echo "Warren Buffett - Strategic thinking, prioritization" ;;
    sheryl) echo "Sheryl Sandberg - Leadership, execution" ;;
    tim) echo "Tim Ferriss - Optimization, life hacks" ;;
    george) echo "George Carlin - Satirical critique, dark humor" ;;
    john) echo "John Oliver - Witty analysis, British humor" ;;
    jon) echo "Jon Stewart - Satirical insight, calling out BS" ;;
    bob) echo "Bob Ross - Creativity, calm, finding joy in the process" ;;
    fred) echo "Fred Rogers - Kindness, self-care, emotional support" ;;
    louiza) echo "Mistress Louiza - Accountability, execution, tracking, discipline" ;;
    spiderman) echo "Spider-Man - Creative problem-solving, juggling responsibilities, relatable struggles" ;;
    ironman) echo "Iron Man - Innovation, ADHD-like hyperfocus, engineering creativity" ;;
    squirrelgirl) echo "Squirrel Girl - Positive creativity, communication, unconventional thinking" ;;
    harley) echo "Harley Quinn - Chaotic creativity, resourcefulness, outside-the-box thinking" ;;
    deadpool) echo "Deadpool - Chaotic humor, unpredictable solutions, creative problem-solving" ;;
    rogue) echo "Rogue - Adaptive creativity, working with unique abilities, resourcefulness" ;;
    esther) echo "Esther Perel - Relationships, intimacy, making partners feel special" ;;
    gottman) echo "Dr. John Gottman - Relationship science, building strong foundations" ;;
    gary) echo "Gary Chapman - Love languages, expressing love effectively" ;;
    brene) echo "BrenÃ© Brown - Vulnerability, courage, authentic connection" ;;
    romance) echo "The Romance Coach - Date planning, thoughtful gestures, making partners feel like royalty" ;;
    kettlebell) echo "Kettlebell Coach - EMOM workouts, kettlebell training, strength and functional fitness" ;;
    maxfit) echo "Maxfit Pro Coach - Cable system workouts, resistance training, functional fitness with cables" ;;
    dumbbell) echo "Dumbbell Coach - Dumbbell training, strength building, functional fitness with dumbbells" ;;
    dipbar) echo "Dip Bar Coach - Dip bar and bodyweight training, calisthenics, functional strength" ;;
    kelsey) echo "Kelsey Hightower - SRE pragmatism, avoiding overengineering, practical infrastructure" ;;
    kent) echo "Kent Beck - Software simplicity, YAGNI, TDD, doing the simplest thing that works" ;;
    charity) echo "Charity Majors - SRE reliability, observability, practical engineering, avoiding overengineering" ;;
    rich) echo "Rich Hickey - Software design, simplicity vs complexity, essential vs accidental complexity" ;;
    goggins) echo "David Goggins - Mental toughness, pushing limits, extreme fitness, calling out excuses, staying hard" ;;
    dean) echo "Dean Karnazes - Ultra marathon running, endurance training, long-distance running, building mental resilience" ;;
    bioneer) echo "The Bioneer (Adam) - Functional fitness, science-based training, movement quality, practical fitness advice" ;;
    *) echo "Unknown persona" ;;
  esac
}

# List personas
list_personas() {
  echo ""
  echo "Available personas:"
  echo ""
  for persona in "${PERSONAS[@]}"; do
    echo "  $persona - $(show_persona_info "$persona")"
  done
  echo ""
}

# Get badge status and progress for advisors
get_badge_status() {
  local gtd_base="${GTD_BASE_DIR:-$HOME/Documents/gtd}"
  local gamification_file="${gtd_base}/.gtd/gamification/gamification.json"
  
  if [[ ! -f "$gamification_file" ]]; then
    return 1
  fi
  
  # Use Python to get badge information
  python3 <<PYTHON_SCRIPT
import json
import sys

try:
    with open("$gamification_file", "r") as f:
        data = json.load(f)
    
    badges = data.get("badges", {})
    badges_lost = data.get("badges_lost", [])
    stats = data.get("stats", {})
    streaks = data.get("streaks", {})
    
    tasks_completed = stats.get("tasks_completed", 0)
    habits_completed = stats.get("habits_completed", 0)
    projects_completed = stats.get("projects_completed", 0)
    reviews_completed = stats.get("reviews_completed", 0)
    daily_logs = stats.get("daily_logs", 0)
    exercise_sessions = stats.get("exercise_sessions", 0)
    wizard_uses = stats.get("wizard_uses", 0)
    
    daily_logging_streak = streaks.get("daily_logging", 0)
    task_streak = streaks.get("task_completion", 0)
    review_streak = streaks.get("review", 0)
    exercise_streak = streaks.get("exercise", 0)
    
    current_stats = {
        "daily_logging_streak": daily_logging_streak,
        "task_streak": task_streak,
        "exercise_streak": exercise_streak,
        "review_streak": review_streak,
        "tasks_completed": tasks_completed,
        "habits_completed": habits_completed,
        "projects_completed": projects_completed,
        "exercise_sessions": exercise_sessions,
        "reviews_completed": reviews_completed,
        "wizard_uses": wizard_uses,
    }
    
    # Badge definitions (same as in gtd-gamify)
    badge_definitions = [
        ("daily_logger", "Daily Logger", "Log every day for 7 days", {"daily_logging_streak": 7}, {"daily_logging_streak": 3}, 7),
        ("consistent_logger", "Consistent Logger", "Log every day for 30 days", {"daily_logging_streak": 30}, {"daily_logging_streak": 7}, 14),
        ("dedicated_logger", "Dedicated Logger", "Log every day for 100 days", {"daily_logging_streak": 100}, {"daily_logging_streak": 14}, 21),
        ("task_warrior", "Task Warrior", "Complete tasks for 7 days straight", {"task_streak": 7}, {"task_streak": 3}, 7),
        ("task_master", "Task Master", "Complete tasks for 30 days straight", {"task_streak": 30}, {"task_streak": 7}, 14),
        ("task_champion", "Task Champion", "Complete 100 tasks", {"tasks_completed": 100}, {"task_streak": 3}, 7),
        ("fitness_starter", "Fitness Starter", "Exercise for 7 days straight", {"exercise_streak": 7}, {"exercise_streak": 3}, 7),
        ("fitness_enthusiast", "Fitness Enthusiast", "Exercise for 30 days straight", {"exercise_streak": 30}, {"exercise_streak": 7}, 14),
        ("fitness_champion", "Fitness Champion", "Complete 50 exercise sessions", {"exercise_sessions": 50}, {"exercise_streak": 3}, 7),
        ("reflective", "Reflective", "Complete 7 reviews", {"reviews_completed": 7}, {"review_streak": 3}, 7),
        ("weekly_reviewer", "Weekly Reviewer", "Complete reviews for 7 weeks straight", {"review_streak": 7}, {"review_streak": 3}, 7),
        ("habit_builder", "Habit Builder", "Complete 100 habits", {"habits_completed": 100}, {"habits_completed": 10}, 7),
        ("project_manager", "Project Manager", "Complete 5 projects", {"projects_completed": 5}, {"projects_completed": 1}, 7),
        ("project_master", "Project Master", "Complete 10 projects", {"projects_completed": 10}, {"projects_completed": 2}, 14),
        ("wizard_user", "Wizard User", "Use wizard 50 times", {"wizard_uses": 50}, {"wizard_uses": 5}, 7),
        ("wizard_master", "Wizard Master", "Use wizard 100 times", {"wizard_uses": 100}, {"wizard_uses": 10}, 14),
    ]
    
    def check_requirement(req_dict, stats):
        for key, value in req_dict.items():
            if key == "daily_logging_streak":
                if stats["daily_logging_streak"] < value:
                    return False, stats["daily_logging_streak"], value
            elif key == "task_streak":
                if stats["task_streak"] < value:
                    return False, stats["task_streak"], value
            elif key == "exercise_streak":
                if stats["exercise_streak"] < value:
                    return False, stats["exercise_streak"], value
            elif key == "review_streak":
                if stats["review_streak"] < value:
                    return False, stats["review_streak"], value
            elif key == "tasks_completed":
                if stats["tasks_completed"] < value:
                    return False, stats["tasks_completed"], value
            elif key == "habits_completed":
                if stats["habits_completed"] < value:
                    return False, stats["habits_completed"], value
            elif key == "projects_completed":
                if stats["projects_completed"] < value:
                    return False, stats["projects_completed"], value
            elif key == "exercise_sessions":
                if stats["exercise_sessions"] < value:
                    return False, stats["exercise_sessions"], value
            elif key == "reviews_completed":
                if stats["reviews_completed"] < value:
                    return False, stats["reviews_completed"], value
            elif key == "wizard_uses":
                if stats["wizard_uses"] < value:
                    return False, stats["wizard_uses"], value
        return True, None, None
    
    earned_badges = []
    close_to_earning = []
    close_to_losing = []
    lost_badges = []
    
    for badge_id, name, desc, challenge_req, maintenance_req, recovery_streak in badge_definitions:
        badge_status = badges.get(badge_id, {})
        is_earned = badge_status.get("earned", False)
        is_lost = badge_id in badges_lost
        
        if is_earned and not is_lost:
            earned_badges.append((name, desc))
            # Check if close to losing
            met, current, required = check_requirement(maintenance_req, current_stats)
            if not met:
                # Calculate how close
                if current is not None and required is not None:
                    progress = (current / required * 100) if required > 0 else 0
                    if progress >= 50:  # At least 50% of way there
                        close_to_losing.append((name, desc, current, required, progress))
                    elif progress < 50:
                        lost_badges.append((name, desc))
        elif is_lost:
            lost_badges.append((name, desc))
        else:
            # Not earned yet - check if close
            met, current, required = check_requirement(challenge_req, current_stats)
            if not met and current is not None and required is not None:
                progress = (current / required * 100) if required > 0 else 0
                if progress >= 50:  # At least 50% of way there
                    close_to_earning.append((name, desc, current, required, progress))
    
    # Output
    if earned_badges or close_to_earning or close_to_losing or lost_badges:
        print("")
        print("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”")
        print("# Badge Status")
        print("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”")
        print("")
        
        if earned_badges:
            print("ğŸ–ï¸  Earned Badges:")
            for name, desc in earned_badges:
                print(f"   âœ“ {name} - {desc}")
            print("")
        
        if close_to_earning:
            print("ğŸ“ˆ Close to Earning:")
            for name, desc, current, required, progress in close_to_earning:
                print(f"   ğŸ¯ {name} - {desc}")
                print(f"      Progress: {current}/{required} ({progress:.0f}%)")
            print("")
        
        if close_to_losing:
            print("âš ï¸  At Risk of Losing:")
            for name, desc, current, required, progress in close_to_losing:
                print(f"   âš ï¸  {name} - {desc}")
                print(f"      Current: {current}/{required} ({progress:.0f}%) - Need to maintain!")
            print("")
        
        if lost_badges:
            print("âŒ Lost Badges (can be regained with streaks):")
            for name, desc in lost_badges:
                print(f"   âœ— {name} - {desc}")
            print("")
except Exception as e:
    pass
PYTHON_SCRIPT
}

# Get active goals from goals directory
get_active_goals() {
  local gtd_base="${GTD_BASE_DIR:-$HOME/Documents/gtd}"
  local goals_dir="${gtd_base}/goals"
  
  if [[ ! -d "$goals_dir" ]]; then
    return 1
  fi
  
  local goals_output=""
  local goal_count=0
  
  # Check all goal files
  local goal_files=($(find "$goals_dir" -type f -name "*.md" 2>/dev/null | sort))
  
  for goal_file in "${goal_files[@]}"; do
    local status=$(grep "^status:" "$goal_file" 2>/dev/null | cut -d':' -f2 | sed 's/^[[:space:]]*//' || echo "")
    if [[ "$status" != "active" ]]; then
      continue
    fi
    
    local name=$(grep "^name:" "$goal_file" 2>/dev/null | cut -d':' -f2- | sed 's/^[[:space:]]*//' || basename "$goal_file" .md)
    local progress=$(grep "^progress:" "$goal_file" 2>/dev/null | cut -d':' -f2 | sed 's/^[[:space:]]*//' || echo "0")
    local deadline=$(grep "^deadline:" "$goal_file" 2>/dev/null | cut -d':' -f2 | sed 's/^[[:space:]]*//' || echo "")
    local area=$(grep "^area:" "$goal_file" 2>/dev/null | cut -d':' -f2 | sed 's/^[[:space:]]*//' || echo "")
    local description=$(grep "^description:" "$goal_file" 2>/dev/null | cut -d':' -f2- | sed 's/^[[:space:]]*//' || echo "")
    
    if [[ -n "$name" ]]; then
      ((goal_count++))
      if [[ -n "$goals_output" ]]; then
        goals_output="${goals_output}\n"
      fi
      goals_output="${goals_output}ğŸ¯ ${name}"
      if [[ -n "$progress" ]]; then
        goals_output="${goals_output} (${progress}% complete)"
      fi
      if [[ -n "$deadline" ]]; then
        goals_output="${goals_output} - Deadline: ${deadline}"
      fi
      if [[ -n "$area" ]]; then
        goals_output="${goals_output} - Area: ${area}"
      fi
      if [[ -n "$description" ]]; then
        goals_output="${goals_output}\n   ${description}"
      fi
    fi
  done
  
  if [[ $goal_count -gt 0 ]]; then
    echo ""
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo "# Active Goals"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo ""
    echo -e "$goals_output"
    echo ""
  fi
}

# Get habit tracker data for a specific date
get_habit_tracker_data() {
  local target_date="${1:-today}"  # today or YYYY-MM-DD format
  local date_cmd="date"
  if [[ -x "/usr/bin/date" ]]; then
    date_cmd="/usr/bin/date"
  elif [[ -x "/bin/date" ]]; then
    date_cmd="/bin/date"
  fi
  
  # Get target date
  local check_date=""
  if [[ "$target_date" == "today" ]]; then
    check_date=$($date_cmd +"%Y-%m-%d")
  elif [[ "$target_date" =~ ^[0-9]{4}-[0-9]{2}-[0-9]{2}$ ]]; then
    check_date="$target_date"
  else
    return 1
  fi
  
  # Load GTD config to find habits path
  local gtd_base="${GTD_BASE_DIR:-$HOME/Documents/gtd}"
  local habits_path="${gtd_base}/habits"
  
  if [[ ! -d "$habits_path" ]]; then
    return 1
  fi
  
  local completed_habits=()
  local due_habits=()
  
  # Check all habit files
  local habits=($(find "$habits_path" -type f -name "*.md" 2>/dev/null))
  
  for habit_file in "${habits[@]}"; do
    local status=$(grep "^status:" "$habit_file" 2>/dev/null | cut -d':' -f2 | sed 's/^[[:space:]]*//' || echo "active")
    if [[ "$status" != "active" ]]; then
      continue
    fi
    
    local habit_name=$(grep "^name:" "$habit_file" 2>/dev/null | cut -d':' -f2- | sed 's/^[[:space:]]*//' || basename "$habit_file" .md)
    local frequency=$(grep "^frequency:" "$habit_file" 2>/dev/null | cut -d':' -f2 | sed 's/^[[:space:]]*//' || echo "")
    local last_completed=$(grep "^last_completed:" "$habit_file" 2>/dev/null | cut -d':' -f2 | sed 's/^[[:space:]]*//' || echo "")
    local streak=$(grep "^streak:" "$habit_file" 2>/dev/null | cut -d':' -f2 | sed 's/^[[:space:]]*//' || echo "0")
    
    if [[ "$last_completed" == "$check_date" ]]; then
      completed_habits+=("$habit_name (streak: ${streak} days)")
    elif [[ "$frequency" == "daily" && "$last_completed" != "$check_date" ]]; then
      due_habits+=("$habit_name")
    fi
  done
  
  # Build output
  if [[ ${#completed_habits[@]} -gt 0 || ${#due_habits[@]} -gt 0 ]]; then
    echo ""
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo "# Habit Tracker Status - $check_date"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo ""
    
    if [[ ${#completed_habits[@]} -gt 0 ]]; then
      echo "âœ… Completed Habits:"
      for habit in "${completed_habits[@]}"; do
        echo "  â€¢ $habit"
      done
      echo ""
    fi
    
    if [[ ${#due_habits[@]} -gt 0 ]]; then
      echo "â­• Habits Not Completed Yet:"
      for habit in "${due_habits[@]}"; do
        echo "  â€¢ $habit"
      done
      echo ""
    fi
  fi
}

# Get daily log content
get_daily_log_content() {
  local date_range="${1:-today}"  # today, week, month, all, or specific date
  local date_cmd="date"
  if [[ -x "/usr/bin/date" ]]; then
    date_cmd="/usr/bin/date"
  elif [[ -x "/bin/date" ]]; then
    date_cmd="/bin/date"
  fi
  
  # Load daily log config
  local daily_log_config="$HOME/.daily_log_config"
  if [[ ! -f "$daily_log_config" && -f "$HOME/code/personal/dotfiles/zsh/.daily_log_config" ]]; then
    daily_log_config="$HOME/code/personal/dotfiles/zsh/.daily_log_config"
  fi
  
  local log_dir="${DAILY_LOG_DIR:-$HOME/Documents/daily_logs}"
  if [[ -f "$daily_log_config" ]]; then
    # Try to extract DAILY_LOG_DIR from config
    local config_dir=$(grep "^DAILY_LOG_DIR=" "$daily_log_config" 2>/dev/null | head -1 | cut -d'=' -f2 | tr -d '"' | tr -d "'" | sed "s|\$HOME|$HOME|g")
    if [[ -n "$config_dir" ]]; then
      log_dir="$config_dir"
    fi
  fi
  
  if [[ ! -d "$log_dir" ]]; then
    echo "Daily log directory not found: $log_dir"
    return 1
  fi
  
  case "$date_range" in
    today)
      local today=$($date_cmd +"%Y-%m-%d")
      local log_file="${log_dir}/${today}.md"
      if [[ -f "$log_file" ]]; then
        cat "$log_file"
      else
        echo "No daily log found for today ($today) at: $log_file"
        return 1
      fi
      ;;
    week)
      # Last 7 days
      local today=$($date_cmd +"%Y-%m-%d")
      echo "# Weekly Log Summary - Last 7 Days"
      echo ""
      for i in {0..6}; do
        local date=$($date_cmd -v-${i}d +"%Y-%m-%d" 2>/dev/null || $date_cmd -d "-${i} days" +"%Y-%m-%d" 2>/dev/null || echo "")
        if [[ -z "$date" ]]; then
          # Fallback calculation
          local timestamp=$(($($date_cmd +%s) - (i * 86400)))
          date=$($date_cmd -r $timestamp +"%Y-%m-%d" 2>/dev/null || echo "")
        fi
        local log_file="${log_dir}/${date}.md"
        if [[ -f "$log_file" ]]; then
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "# Daily Log - $date"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          cat "$log_file"
          echo ""
        fi
      done
      ;;
    month)
      # Last 30 days
      local today=$($date_cmd +"%Y-%m-%d")
      echo "# Monthly Log Summary - Last 30 Days"
      echo ""
      for i in {0..29}; do
        local date=$($date_cmd -v-${i}d +"%Y-%m-%d" 2>/dev/null || $date_cmd -d "-${i} days" +"%Y-%m-%d" 2>/dev/null || echo "")
        if [[ -z "$date" ]]; then
          local timestamp=$(($($date_cmd +%s) - (i * 86400)))
          date=$($date_cmd -r $timestamp +"%Y-%m-%d" 2>/dev/null || echo "")
        fi
        local log_file="${log_dir}/${date}.md"
        if [[ -f "$log_file" ]]; then
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "# Daily Log - $date"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          cat "$log_file"
          echo ""
        fi
      done
      ;;
    all)
      # All logs
      echo "# All Daily Logs"
      echo ""
      local logs=($(find "$log_dir" -type f -name "*.md" -maxdepth 1 | sort))
      for log_file in "${logs[@]}"; do
        local date=$(basename "$log_file" .md)
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "# Daily Log - $date"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        cat "$log_file"
        echo ""
      done
      ;;
    *)
      # Specific date (YYYY-MM-DD format)
      if [[ "$date_range" =~ ^[0-9]{4}-[0-9]{2}-[0-9]{2}$ ]]; then
        local log_file="${log_dir}/${date_range}.md"
        if [[ -f "$log_file" ]]; then
          cat "$log_file"
        else
          echo "No daily log found for $date_range at: $log_file"
          return 1
        fi
      else
        echo "Invalid date range: $date_range"
        echo "Use: today, week, month, all, or YYYY-MM-DD"
        return 1
      fi
      ;;
  esac
}

# Get advice from single persona
advise_single() {
  local persona="$1"
  shift
  local content="$*"
  local use_daily_log=false
  local date_range="today"
  
  # Check if content indicates daily log review
  if [[ "$content" == *"daily log"* || "$content" == *"Daily log"* || "$content" == *"review my log"* || "$content" == *"Review my log"* ]]; then
    use_daily_log=true
    # Check if content specifies a range
    if [[ "$content" == *"all my logs"* || "$content" == *"all logs"* ]]; then
      date_range="all"
    elif [[ "$content" == *"this week"* || "$content" == *"week"* ]]; then
      date_range="week"
    elif [[ "$content" == *"this month"* || "$content" == *"month"* ]]; then
      date_range="month"
    fi
  fi
  
  if [[ -z "$content" ]]; then
    if [[ -t 0 ]]; then
      echo "Enter your question (press Ctrl+D when done):"
      content=$(cat)
    else
      echo "Usage: gtd-advise <persona> \"your question\""
      echo "   Or: echo \"your question\" | gtd-advise <persona>"
      exit 1
    fi
  fi
  
  # If daily log requested, load it and include habit tracker data, goals, and badges
  if [[ "$use_daily_log" == "true" ]]; then
    local log_content=$(get_daily_log_content "$date_range")
    local habit_data=""
    local goals_data=""
    local badge_data=""
    
    # Get habit tracker data (for today or specific date)
    if [[ "$date_range" == "today" ]]; then
      habit_data=$(get_habit_tracker_data "today")
    elif [[ "$date_range" =~ ^[0-9]{4}-[0-9]{2}-[0-9]{2}$ ]]; then
      habit_data=$(get_habit_tracker_data "$date_range")
    fi
    
    # Get active goals (always include for context)
    goals_data=$(get_active_goals)
    
    # Get badge status (always include for context)
    badge_data=$(get_badge_status)
    
    if [[ $? -eq 0 ]]; then
      # Combine daily log, habit tracker data, goals, and badges
      local context_parts=""
      context_parts="${log_content}"
      
      if [[ -n "$goals_data" ]]; then
        context_parts="${context_parts}\n${goals_data}"
      fi
      
      if [[ -n "$badge_data" ]]; then
        context_parts="${context_parts}\n${badge_data}"
      fi
      
      if [[ -n "$habit_data" ]]; then
        context_parts="${context_parts}\n${habit_data}"
      fi
      
      content=$(printf "Review my daily log and provide advice:\n\n%s\n\n%s" "$context_parts" "$content")
    fi
  else
    # Even if not reviewing daily log, include goals and badges for context when providing feedback
    # This helps advisors remind about goals and badges related to log entries
    local goals_data=$(get_active_goals)
    local badge_data=$(get_badge_status)
    
    local context_parts=""
    if [[ -n "$goals_data" ]]; then
      context_parts="${goals_data}"
    fi
    if [[ -n "$badge_data" ]]; then
      if [[ -n "$context_parts" ]]; then
        context_parts="${context_parts}\n${badge_data}"
      else
        context_parts="${badge_data}"
      fi
    fi
    
    if [[ -n "$context_parts" ]]; then
      content=$(printf "Here's my current status for context:\n%s\n\n%s" "$context_parts" "$content")
    fi
  fi
  
  $PYTHON_CMD "$PERSONA_HELPER" "$persona" "$content"
}

# Get advice from all personas
advise_all() {
  # Collect all remaining arguments as content (--all already shifted in main)
  local content="$*"
  local use_daily_log=false
  
  # Check if content indicates daily log review
  if [[ "$content" == *"daily log"* || "$content" == *"Daily log"* || "$content" == *"review my log"* || "$content" == *"Review my log"* ]]; then
    use_daily_log=true
  fi
  
  if [[ -z "$content" ]]; then
    if [[ -t 0 ]]; then
      echo "Enter your question (press Ctrl+D when done):"
      content=$(cat)
    else
      echo "Usage: gtd-advise --all \"your question\""
      exit 1
    fi
  fi
  
  # If daily log requested, load it (default to today) and include habit tracker data, goals, and badges
  if [[ "$use_daily_log" == "true" ]]; then
    local date_range="today"
    # Check if content specifies a range
    if [[ "$content" == *"all my logs"* || "$content" == *"all logs"* ]]; then
      date_range="all"
    elif [[ "$content" == *"this week"* || "$content" == *"week"* ]]; then
      date_range="week"
    elif [[ "$content" == *"this month"* || "$content" == *"month"* ]]; then
      date_range="month"
    fi
    local log_content=$(get_daily_log_content "$date_range")
    local habit_data=""
    local goals_data=""
    local badge_data=""
    
    # Get habit tracker data (for today or specific date)
    if [[ "$date_range" == "today" ]]; then
      habit_data=$(get_habit_tracker_data "today")
    elif [[ "$date_range" =~ ^[0-9]{4}-[0-9]{2}-[0-9]{2}$ ]]; then
      habit_data=$(get_habit_tracker_data "$date_range")
    fi
    
    # Get active goals (always include for context)
    goals_data=$(get_active_goals)
    
    # Get badge status (always include for context)
    badge_data=$(get_badge_status)
    
    if [[ $? -eq 0 ]]; then
      # Combine daily log, habit tracker data, goals, and badges
      local context_parts=""
      context_parts="${log_content}"
      
      if [[ -n "$goals_data" ]]; then
        context_parts="${context_parts}\n${goals_data}"
      fi
      
      if [[ -n "$badge_data" ]]; then
        context_parts="${context_parts}\n${badge_data}"
      fi
      
      if [[ -n "$habit_data" ]]; then
        context_parts="${context_parts}\n${habit_data}"
      fi
      
      content=$(printf "Review my daily log and provide advice:\n\n%s\n\n%s" "$context_parts" "$content")
    fi
  else
    # Even if not reviewing daily log, include goals and badges for context
    local goals_data=$(get_active_goals)
    local badge_data=$(get_badge_status)
    
    local context_parts=""
    if [[ -n "$goals_data" ]]; then
      context_parts="${goals_data}"
    fi
    if [[ -n "$badge_data" ]]; then
      if [[ -n "$context_parts" ]]; then
        context_parts="${context_parts}\n${badge_data}"
      else
        context_parts="${badge_data}"
      fi
    fi
    
    if [[ -n "$context_parts" ]]; then
      content=$(printf "Here's my current status for context:\n%s\n\n%s" "$context_parts" "$content")
    fi
  fi
  
  echo ""
  echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
  echo "ğŸ­ Getting advice from all personas..."
  echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
  echo ""
  
  for persona in "${PERSONAS[@]}"; do
    echo ""
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo "ğŸ’¬ $(show_persona_info "$persona")"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    $PYTHON_CMD "$PERSONA_HELPER" "$persona" "$content"
    echo ""
  done
}

# Get advice based on context
advise_context() {
  local context="$1"
  shift
  local content="$*"
  
  if [[ -z "$content" ]]; then
    if [[ -t 0 ]]; then
      echo "Enter your question (press Ctrl+D when done):"
      content=$(cat)
    else
      echo "Usage: gtd-advise --context=<context> \"your question\""
      exit 1
    fi
  fi
  
  # Map context to persona
  local persona="hank"
  case "$context" in
    project|organization|gtd)
      persona="david"
      ;;
    focus|deep_work|distraction)
      persona="cal"
      ;;
    habit|routine|system)
      persona="james"
      ;;
    organize|clutter|declutter)
      persona="marie"
      ;;
    strategy|priority|long_term)
      persona="warren"
      ;;
    execute|leadership|efficiency)
      persona="sheryl"
      ;;
    optimize|hack|experiment)
      persona="tim"
      ;;
    satirical|critique|humor)
      persona="george"
      ;;
    analysis|research|witty)
      persona="john"
      ;;
    insight|truth|bs)
      persona="jon"
      ;;
  esac
  
  echo "Using persona: $persona (matched from context: $context)"
  advise_single "$persona" "$content"
}

# Review advice
advise_review() {
  local review_type="$1"
  shift
  local content="$*"
  
  if [[ -z "$content" ]]; then
    # Try to get review content from recent review files
    local review_dir="${GTD_BASE_DIR:-$HOME/Documents/gtd}/weekly-reviews"
    if [[ -d "$review_dir" ]]; then
      local latest_review=$(find "$review_dir" -name "*.md" -type f | sort -r | head -1)
      if [[ -n "$latest_review" && -f "$latest_review" ]]; then
        content=$(cat "$latest_review")
        echo "Using latest review: $latest_review"
      fi
    fi
  fi
  
  if [[ -z "$content" ]]; then
    echo "Usage: gtd-advise --review [review-content]"
    exit 1
  fi
  
  # Get advice from GTD expert
  echo "Getting GTD review advice from David Allen..."
  advise_single "david" "$content" "review"
  
  echo ""
  read -p "Get strategic advice from Warren Buffett? (y/n) " -n 1 -r
  echo
  if [[ $REPLY =~ ^[Yy]$ ]]; then
    advise_single "warren" "$content" "review"
  fi
}

# Random persona
advise_random() {
  local content="$*"
  
  if [[ -z "$content" ]]; then
    if [[ -t 0 ]]; then
      echo "Enter your question (press Ctrl+D when done):"
      content=$(cat)
    else
      echo "Usage: gtd-advise --random \"your question\""
      exit 1
    fi
  fi
  
  local persona_count=${#PERSONAS[@]}
  local random_index=$((RANDOM % persona_count))
  local selected_persona="${PERSONAS[$random_index + 1]}"
  
  echo "Randomly selected: $selected_persona"
  advise_single "$selected_persona" "$content"
}

# Main
main() {
  case "$1" in
    --list|-l)
      list_personas
      ;;
    --all)
      shift
      advise_all "$@"
      ;;
    -a)
      shift
      advise_all "$@"
      ;;
    --context=*)
      local context="${1#*=}"
      shift
      advise_context "$context" "$@"
      ;;
    --review|-r)
      shift
      advise_review "$@"
      ;;
    --daily-log|--log)
      shift
      local date_range="${1:-today}"
      # Get daily log(s) and review with all personas
      local log_content=$(get_daily_log_content "$date_range")
      if [[ $? -eq 0 ]]; then
        local range_desc="today's"
        case "$date_range" in
          week) range_desc="this week's" ;;
          month) range_desc="this month's" ;;
          all) range_desc="all my" ;;
          *) range_desc="$date_range's" ;;
        esac
        local content=$(printf "Review my %s daily log(s) and provide advice:\n\n%s" "$range_desc" "$log_content")
        advise_all "$content"
      else
        echo "âŒ Could not load daily log"
        exit 1
      fi
      ;;
    --random|-R)
      shift
      advise_random "$@"
      ;;
    --help|-h|"")
      echo "Usage: gtd-advise [options] <persona> [content]"
      echo ""
      echo "Options:"
      echo "  --list, -l                    List all available personas"
      echo "  --all, -a                     Get advice from all personas"
      echo "  --context=<context>           Auto-select persona based on context"
      echo "  --review, -r                  Get review advice (uses latest review)"
      echo "  --daily-log [range]           Review daily log(s) with all personas"
      echo "                                Range: today (default), week, month, all, or YYYY-MM-DD"
      echo "  --random, -R                  Get advice from random persona"
      echo "  <persona>                     Get advice from specific persona"
      echo ""
      echo "Personas:"
      echo "  hank, david, cal, james, marie, warren, sheryl, tim"
      echo "  george, john, jon, bob, fred, louiza"
      echo "  spiderman, ironman, squirrelgirl, harley, deadpool, rogue"
      echo "  esther, gottman, gary, brene, romance (relationship coaches)"
      echo ""
      echo "Contexts (for --context):"
      echo "  project, organization, gtd â†’ David Allen"
      echo "  focus, deep_work â†’ Cal Newport"
      echo "  habit, routine â†’ James Clear"
      echo "  organize, clutter â†’ Marie Kondo"
      echo "  strategy, priority â†’ Warren Buffett"
      echo "  execute, leadership â†’ Sheryl Sandberg"
      echo "  optimize, hack â†’ Tim Ferriss"
      echo "  satirical, critique â†’ George Carlin"
      echo "  analysis, witty â†’ John Oliver"
      echo "  insight, truth â†’ Jon Stewart"
      echo ""
      echo "Examples:"
      echo "  gtd-advise hank \"What should I focus on today?\""
      echo "  gtd-advise --all \"Help me organize my tasks\""
      echo "  gtd-advise --all \"Review my daily log\"  # Auto-loads daily log"
      echo "  gtd-advise --daily-log                    # Review today's log with all personas"
      echo "  gtd-advise --daily-log week               # Review this week's logs"
      echo "  gtd-advise --daily-log month              # Review this month's logs"
      echo "  gtd-advise --daily-log all                # Review all logs"
      echo "  gtd-advise --context=project \"Review my project plan\""
      echo "  gtd-advise --review"
      echo "  gtd-advise --random \"Give me advice\""
      echo "  echo \"My question\" | gtd-advise david"
      exit 0
      ;;
    *)
      # Check if it's a persona name
      local persona="$1"
      if [[ " ${PERSONAS[@]} " =~ " ${persona} " ]]; then
        shift
        advise_single "$persona" "$@"
      else
        echo "Unknown option or persona: $1"
        echo "Run 'gtd-advise --help' for usage"
        exit 1
      fi
      ;;
  esac
}

main "$@"

