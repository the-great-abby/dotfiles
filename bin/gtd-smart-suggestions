#!/bin/bash
# Smart Task Suggestions - One-keystroke interface

# Load config
GTD_CONFIG_FILE="$HOME/.gtd_config"
if [[ -f "$HOME/code/dotfiles/zsh/.gtd_config" ]]; then
  GTD_CONFIG_FILE="$HOME/code/dotfiles/zsh/.gtd_config"
elif [[ -f "$HOME/code/personal/dotfiles/zsh/.gtd_config" ]]; then
  GTD_CONFIG_FILE="$HOME/code/personal/dotfiles/zsh/.gtd_config"
fi

if [[ -f "$GTD_CONFIG_FILE" ]]; then
  source "$GTD_CONFIG_FILE"
fi

GTD_BASE_DIR="${GTD_BASE_DIR:-$HOME/Documents/gtd}"
SMART_SUGGESTIONS_SCRIPT="$HOME/code/dotfiles/mcp/gtd_smart_suggestions.py"
if [[ ! -f "$SMART_SUGGESTIONS_SCRIPT" ]]; then
  SMART_SUGGESTIONS_SCRIPT="$HOME/code/personal/dotfiles/mcp/gtd_smart_suggestions.py"
fi

# Color codes
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
CYAN='\033[0;36m'
BOLD='\033[1m'
NC='\033[0m'

# Get Python command
get_python() {
  if command -v python3 &>/dev/null; then
    echo "python3"
  elif command -v python &>/dev/null; then
    echo "python"
  else
    echo ""
  fi
}

PYTHON_CMD=$(get_python)

if [[ -z "$PYTHON_CMD" ]]; then
  echo "Error: Python not found"
  exit 1
fi

# Immediate high-confidence suggestions (one-keystroke review)
immediate_review() {
  echo ""
  echo "âš¡ Immediate High-Confidence Suggestions"
  echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
  echo ""
  
  if [[ ! -f "$SMART_SUGGESTIONS_SCRIPT" ]]; then
    echo "Smart suggestions module not found at: $SMART_SUGGESTIONS_SCRIPT"
    exit 1
  fi
  
  # Get immediate suggestions
  local suggestions_json=$("$PYTHON_CMD" "$SMART_SUGGESTIONS_SCRIPT" get-immediate 2>/dev/null)
  
  if [[ -z "$suggestions_json" ]]; then
    echo "No high-confidence suggestions available."
    echo ""
    return 0
  fi
  
  # Parse JSON to get suggestions
  local count=$(echo "$suggestions_json" | "$PYTHON_CMD" -c "import json, sys; data = json.load(sys.stdin); print(data.get('count', 0))" 2>/dev/null || echo "0")
  
  if [[ "$count" == "0" ]]; then
    echo "âœ… No high-confidence suggestions - all clear!"
    echo ""
    return 0
  fi
  
  # Extract suggestions into arrays
  local titles=()
  local ids=()
  local confidences=()
  local reasons=()
  
  local idx=0
  while IFS= read -r line; do
    if [[ -n "$line" ]]; then
      local id=$(echo "$line" | cut -d'|' -f1)
      local title=$(echo "$line" | cut -d'|' -f2)
      local confidence=$(echo "$line" | cut -d'|' -f3)
      local reason=$(echo "$line" | cut -d'|' -f4)
      
      ids+=("$id")
      titles+=("$title")
      confidences+=("$confidence")
      reasons+=("$reason")
      ((idx++))
    fi
  done < <(echo "$suggestions_json" | "$PYTHON_CMD" -c "
import json, sys
data = json.load(sys.stdin)
suggestions = data.get('suggestions', [])
for s in suggestions:
    print(f\"{s.get('id', '')}|{s.get('title', '')}|{s.get('confidence', 0.0)}|{s.get('reason', '')}\")
" 2>/dev/null)
  
  if [[ ${#ids[@]} -eq 0 ]]; then
    echo "No suggestions to review."
    return 0
  fi
  
  echo "Found ${#ids[@]} high-confidence suggestion(s):"
  echo ""
  
  # Show each suggestion with one-keystroke options
  for i in "${!ids[@]}"; do
    local suggestion_id="${ids[$i]}"
    local title="${titles[$i]}"
    local confidence="${confidences[$i]}"
    local reason="${reasons[$i]}"
    local confidence_pct=$(echo "$confidence * 100" | bc -l 2>/dev/null | cut -d'.' -f1 || echo "0")
    
    echo -e "${BOLD}[$((i+1))]${NC} ${title}"
    echo "   Confidence: ${confidence_pct}%"
    echo "   Reason: $reason"
    echo ""
    echo "   ${GREEN}y${NC}) Create task  ${YELLOW}n${NC}) Dismiss  ${CYAN}s${NC}) Skip"
    echo ""
    echo -n "   Your choice (y/n/s): "
    read -n 1 choice
    echo ""
    echo ""
    
    case "$choice" in
      y|Y)
        # Create task - one keystroke!
        echo "   â†’ Creating task..."
        local result=$("$PYTHON_CMD" "$SMART_SUGGESTIONS_SCRIPT" create "$suggestion_id" 2>/dev/null)
        local success=$(echo "$result" | "$PYTHON_CMD" -c "import json, sys; data = json.load(sys.stdin); print('true' if data.get('success') else 'false')" 2>/dev/null || echo "false")
        
        if [[ "$success" == "true" ]]; then
          echo -e "   ${GREEN}âœ“${NC} Task created!"
        else
          echo -e "   ${RED}âœ—${NC} Failed to create task"
        fi
        ;;
      n|N)
        # Dismiss
        echo "   â†’ Dismissing suggestion..."
        "$PYTHON_CMD" "$SMART_SUGGESTIONS_SCRIPT" dismiss "$suggestion_id" 2>/dev/null
        echo -e "   ${YELLOW}âœ“${NC} Dismissed"
        ;;
      s|S|"")
        # Skip
        echo "   â†’ Skipped"
        ;;
      *)
        echo "   â†’ Invalid choice, skipped"
        ;;
    esac
    echo ""
  done
}

# Review mode for medium-confidence suggestions
review_mode() {
  echo ""
  echo "ðŸ“‹ Review Mode - Medium-Confidence Suggestions"
  echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
  echo ""
  
  if [[ ! -f "$SMART_SUGGESTIONS_SCRIPT" ]]; then
    echo "Smart suggestions module not found at: $SMART_SUGGESTIONS_SCRIPT"
    exit 1
  fi
  
  # Get review mode suggestions
  local suggestions_json=$("$PYTHON_CMD" "$SMART_SUGGESTIONS_SCRIPT" get-review 2>/dev/null)
  
  if [[ -z "$suggestions_json" ]]; then
    echo "No medium-confidence suggestions for review."
    echo ""
    return 0
  fi
  
  # Parse and display (similar to immediate but with more context)
  local count=$(echo "$suggestions_json" | "$PYTHON_CMD" -c "import json, sys; data = json.load(sys.stdin); print(data.get('count', 0))" 2>/dev/null || echo "0")
  
  if [[ "$count" == "0" ]]; then
    echo "âœ… No suggestions for review."
    echo ""
    return 0
  fi
  
  echo "Found $count suggestion(s) for review:"
  echo ""
  
  # Extract and display
  local idx=0
  while IFS= read -r line; do
    [[ -z "$line" ]] && continue
    
    local id=$(echo "$line" | cut -d'|' -f1)
    local title=$(echo "$line" | cut -d'|' -f2)
    local confidence=$(echo "$line" | cut -d'|' -f3)
    local reason=$(echo "$line" | cut -d'|' -f4)
    local confidence_pct=$(echo "$confidence * 100" | bc -l 2>/dev/null | cut -d'.' -f1 || echo "0")
    
    echo -e "${BOLD}[$((idx+1))]${NC} ${title}"
    echo "   Confidence: ${confidence_pct}% (medium)"
    echo "   Reason: $reason"
    echo ""
    echo "   ${GREEN}y${NC}) Create task  ${YELLOW}n${NC}) Dismiss  ${CYAN}s${NC}) Skip"
    echo ""
    echo -n "   Your choice: "
    read -n 1 choice
    echo ""
    echo ""
    
    case "$choice" in
      y|Y)
        "$PYTHON_CMD" "$SMART_SUGGESTIONS_SCRIPT" create "$id" 2>/dev/null
        echo -e "   ${GREEN}âœ“${NC} Task created!"
        ;;
      n|N)
        "$PYTHON_CMD" "$SMART_SUGGESTIONS_SCRIPT" dismiss "$id" 2>/dev/null
        echo -e "   ${YELLOW}âœ“${NC} Dismissed"
        ;;
      *)
        echo "   â†’ Skipped"
        ;;
    esac
    echo ""
    
    ((idx++))
  done < <(echo "$suggestions_json" | "$PYTHON_CMD" -c "
import json, sys
data = json.load(sys.stdin)
suggestions = data.get('suggestions', [])
for s in suggestions:
    print(f\"{s.get('id', '')}|{s.get('title', '')}|{s.get('confidence', 0.0)}|{s.get('reason', '')}\")
" 2>/dev/null)
}

# Show statistics
show_stats() {
  echo ""
  echo "ðŸ“Š Suggestion Acceptance Statistics"
  echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
  echo ""
  
  if [[ ! -f "$SMART_SUGGESTIONS_SCRIPT" ]]; then
    echo "Smart suggestions module not found"
    exit 1
  fi
  
  local stats_json=$("$PYTHON_CMD" "$SMART_SUGGESTIONS_SCRIPT" stats 2>/dev/null)
  
  if [[ -z "$stats_json" ]]; then
    echo "No statistics available yet."
    return 0
  fi
  
  # Parse and display statistics
  echo "$stats_json" | "$PYTHON_CMD" -c "
import json, sys
try:
    data = json.load(sys.stdin)
    accepted = data.get('total_accepted', 0)
    dismissed = data.get('total_dismissed', 0)
    auto_created = data.get('total_auto_created', 0)
    total = accepted + dismissed
    rate = (accepted / total * 100) if total > 0 else 0
    
    thresholds = data.get('confidence_thresholds', {})
    
    print(f'Accepted: {accepted}')
    print(f'Dismissed: {dismissed}')
    print(f'Auto-created: {auto_created}')
    print(f'Acceptance rate: {rate:.1f}%')
    print('')
    print('Confidence Thresholds:')
    print(f'  High: {thresholds.get(\"high\", 0.85):.2f}')
    print(f'  Medium: {thresholds.get(\"medium\", 0.60):.2f}')
    print(f'  Auto-create: {thresholds.get(\"auto_create\", 0.90):.2f}')
except Exception as e:
    print(f'Error parsing statistics: {e}')
" 2>/dev/null
}

# Main function
case "${1:-immediate}" in
  immediate)
    immediate_review
    ;;
  review)
    review_mode
    ;;
  stats)
    show_stats
    ;;
  thresholds)
    echo ""
    echo "ðŸ”§ Current Confidence Thresholds"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo ""
    if [[ -f "$SMART_SUGGESTIONS_SCRIPT" ]]; then
      "$PYTHON_CMD" "$SMART_SUGGESTIONS_SCRIPT" thresholds 2>/dev/null | "$PYTHON_CMD" -m json.tool 2>/dev/null || "$PYTHON_CMD" "$SMART_SUGGESTIONS_SCRIPT" thresholds 2>/dev/null
    else
      echo "Smart suggestions module not found"
    fi
    ;;
  *)
    echo "Usage: gtd-smart-suggestions [command]"
    echo ""
    echo "Commands:"
    echo "  immediate  - Review high-confidence suggestions (one-keystroke)"
    echo "  review     - Review mode for medium-confidence suggestions"
    echo "  stats      - Show acceptance statistics"
    echo "  thresholds - Show current confidence thresholds"
    exit 1
    ;;
esac
