#!/bin/bash
# CKA Study Gamification System
# Tracks XP, levels, achievements, streaks, and quests

# Load GTD config
GTD_CONFIG_FILE="$HOME/.gtd_config"
if [[ -f "$HOME/code/dotfiles/zsh/.gtd_config" ]]; then
  GTD_CONFIG_FILE="$HOME/code/dotfiles/zsh/.gtd_config"
elif [[ -f "$HOME/code/personal/dotfiles/zsh/.gtd_config" ]]; then
  GTD_CONFIG_FILE="$HOME/code/personal/dotfiles/zsh/.gtd_config"
fi

if [[ -f "$GTD_CONFIG_FILE" ]]; then
  source "$GTD_CONFIG_FILE"
fi

GTD_BASE_DIR="${GTD_BASE_DIR:-$HOME/Documents/gtd}"
STUDY_DIR="${GTD_BASE_DIR}/study"
K8S_STUDY_DIR="${STUDY_DIR}/kubernetes-cka"
GAMIFICATION_FILE="${K8S_STUDY_DIR}/gamification.json"

# Colors
CYAN='\033[0;36m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
MAGENTA='\033[0;35m'
BOLD='\033[1m'
NC='\033[0m'

# Get date command
get_date_cmd() {
  if [[ -x "/usr/bin/date" ]]; then
    echo "/usr/bin/date"
  elif [[ -x "/bin/date" ]]; then
    echo "/bin/date"
  else
    echo "date"
  fi
}

DATE_CMD=$(get_date_cmd)

# Log to daily log
log_to_daily() {
  local message="$1"
  
  # Try multiple methods to log
  if command -v gtd-daily-log &>/dev/null; then
    gtd-daily-log "$message" 2>/dev/null || true
  elif [[ -f "$HOME/code/dotfiles/bin/gtd-daily-log" ]]; then
    "$HOME/code/dotfiles/bin/gtd-daily-log" "$message" 2>/dev/null || true
  elif [[ -f "$HOME/code/personal/dotfiles/bin/gtd-daily-log" ]]; then
    "$HOME/code/personal/dotfiles/bin/gtd-daily-log" "$message" 2>/dev/null || true
  elif command -v addInfoToDailyLog &>/dev/null || type addInfoToDailyLog &>/dev/null 2>/dev/null; then
    addInfoToDailyLog "$message" 2>/dev/null || true
  fi
}

# Log habit completion (if CKA study habit exists)
log_habit_if_exists() {
  local habit_name="CKA Study"
  local habit_slug=$(echo "$habit_name" | tr ' ' '-' | tr '[:upper:]' '[:lower:]' | sed 's/[^a-z0-9-]//g')
  local habits_path="${GTD_BASE_DIR}/habits"
  local habit_file="${habits_path}/${habit_slug}.md"
  
  # Check if habit exists and log it
  if [[ -f "$habit_file" ]] && command -v gtd-habit &>/dev/null; then
    gtd-habit log "$habit_name" > /dev/null 2>&1 || true
  fi
}

# Initialize gamification file
init_gamification() {
  if [[ ! -f "$GAMIFICATION_FILE" ]]; then
    mkdir -p "$K8S_STUDY_DIR"
    cat > "$GAMIFICATION_FILE" <<EOF
{
  "xp": 0,
  "level": 1,
  "total_xp": 0,
  "study_streak": 0,
  "longest_streak": 0,
  "last_study_date": null,
  "topics_completed": {},
  "lessons_completed": 0,
  "practice_sessions": 0,
  "achievements": [],
  "achievements_unlocked": [],
  "quests": {
    "daily": null,
    "weekly": null
  },
  "quests_completed": [],
  "stats": {
    "total_study_time": 0,
    "notes_created": 0,
    "topics_mastered": 0
  },
  "created": "$($DATE_CMD -Iseconds)"
}
EOF
  fi
}

# Get gamification data
get_gamification_data() {
  if [[ ! -f "$GAMIFICATION_FILE" ]]; then
    init_gamification
  fi
  cat "$GAMIFICATION_FILE"
}

# Save gamification data
save_gamification_data() {
  local data="$1"
  echo "$data" > "$GAMIFICATION_FILE"
}

# Award XP
award_xp() {
  local amount="$1"
  local reason="$2"
  
  local data=$(get_gamification_data)
  local current_xp=$(echo "$data" | grep -o '"xp": [0-9]*' | grep -o '[0-9]*')
  local total_xp=$(echo "$data" | grep -o '"total_xp": [0-9]*' | grep -o '[0-9]*')
  local current_level=$(echo "$data" | grep -o '"level": [0-9]*' | grep -o '[0-9]*')
  
  local new_xp=$((current_xp + amount))
  local new_total_xp=$((total_xp + amount))
  
  # Calculate level (100 XP per level, exponential scaling after level 10)
  local new_level=$current_level
  local xp_for_next_level=0
  
  if [[ $current_level -lt 10 ]]; then
    xp_for_next_level=$((current_level * 100))
  else
    # Exponential: level 10 = 1000, level 11 = 1200, level 12 = 1440, etc.
    local base=1000
    local multiplier=1
    for ((i=10; i<$current_level; i++)); do
      multiplier=$((multiplier * 12 / 10))
    done
    xp_for_next_level=$((base * multiplier))
  fi
  
  if [[ $new_total_xp -ge $xp_for_next_level ]]; then
    new_level=$((current_level + 1))
  fi
  
  # Update data
  data=$(echo "$data" | sed "s/\"xp\": $current_xp/\"xp\": $new_xp/")
  data=$(echo "$data" | sed "s/\"total_xp\": $total_xp/\"total_xp\": $new_total_xp/")
  data=$(echo "$data" | sed "s/\"level\": $current_level/\"level\": $new_level/")
  
  save_gamification_data "$data"
  
  # Check for level up
  if [[ $new_level -gt $current_level ]]; then
    echo "ðŸŽ‰ LEVEL UP! You're now Level $new_level!"
    check_achievements
  fi
  
  echo "+${amount} XP (${reason})"
  return 0
}

# Update study streak
update_streak() {
  local data=$(get_gamification_data)
  local last_date=$(echo "$data" | grep -o '"last_study_date": "[^"]*"' | cut -d'"' -f4)
  local current_streak=$(echo "$data" | grep -o '"study_streak": [0-9]*' | grep -o '[0-9]*')
  local longest_streak=$(echo "$data" | grep -o '"longest_streak": [0-9]*' | grep -o '[0-9]*')
  
  local today=$($DATE_CMD +"%Y-%m-%d")
  local yesterday=$($DATE_CMD -v-1d +"%Y-%m-%d" 2>/dev/null || $DATE_CMD -d "yesterday" +"%Y-%m-%d" 2>/dev/null || echo "")
  
  local new_streak=$current_streak
  
  if [[ "$last_date" == "$today" ]]; then
    # Already studied today, no change
    new_streak=$current_streak
  elif [[ "$last_date" == "$yesterday" ]] || [[ -z "$last_date" ]]; then
    # Continue streak
    new_streak=$((current_streak + 1))
  else
    # Streak broken, reset to 1
    new_streak=1
  fi
  
  if [[ $new_streak -gt $longest_streak ]]; then
    longest_streak=$new_streak
  fi
  
  # Update data
  data=$(echo "$data" | sed "s/\"last_study_date\": \"[^\"]*\"/\"last_study_date\": \"$today\"/")
  data=$(echo "$data" | sed "s/\"study_streak\": $current_streak/\"study_streak\": $new_streak/")
  data=$(echo "$data" | sed "s/\"longest_streak\": $longest_streak/\"longest_streak\": $longest_streak/")
  
  save_gamification_data "$data"
  
  echo "$new_streak"
}

# Track lesson completion
track_lesson() {
  local topic="$1"
  local duration="${2:-0}"
  
  local data=$(get_gamification_data)
  local lessons=$(echo "$data" | grep -o '"lessons_completed": [0-9]*' | grep -o '[0-9]*')
  local new_lessons=$((lessons + 1))
  
  # Award XP based on duration
  local xp_amount=10
  if [[ $duration -ge 30 ]]; then
    xp_amount=25
  elif [[ $duration -ge 60 ]]; then
    xp_amount=50
  fi
  
  award_xp $xp_amount "Completed lesson: $topic"
  
  # Update streak
  update_streak > /dev/null
  
  # Update lessons completed
  data=$(get_gamification_data)
  data=$(echo "$data" | sed "s/\"lessons_completed\": $lessons/\"lessons_completed\": $new_lessons/")
  
  # Check if daily quest is lesson-related
  check_quest_completion "lesson"
  
  # Update topic completion
  local topic_key=$(echo "$topic" | tr '[:upper:]' '[:lower:]' | tr ' ' '_')
  if echo "$data" | grep -q "\"$topic_key\""; then
    local topic_count=$(echo "$data" | grep -o "\"$topic_key\": [0-9]*" | grep -o '[0-9]*')
    local new_count=$((topic_count + 1))
    data=$(echo "$data" | sed "s/\"$topic_key\": $topic_count/\"$topic_key\": $new_count/")
  else
    # Add new topic
    data=$(echo "$data" | sed 's/"topics_completed": {/"topics_completed": {\n    "'"$topic_key"'": 1,/' | sed 's/},/}/')
  fi
  
  # Update study time
  local study_time=$(echo "$data" | grep -o '"total_study_time": [0-9]*' | grep -o '[0-9]*')
  local new_study_time=$((study_time + duration))
  data=$(echo "$data" | sed "s/\"total_study_time\": $study_time/\"total_study_time\": $new_study_time/")
  
  save_gamification_data "$data"
  
  # Log to daily log
  log_to_daily "CKA Study: Completed lesson - $topic (${duration} min)"
  
  # Log habit if exists
  log_habit_if_exists
  
  check_achievements
}

# Track practice session
track_practice() {
  local data=$(get_gamification_data)
  local practice=$(echo "$data" | grep -o '"practice_sessions": [0-9]*' | grep -o '[0-9]*')
  local new_practice=$((practice + 1))
  
  award_xp 15 "Practice session"
  
  data=$(get_gamification_data)
  data=$(echo "$data" | sed "s/\"practice_sessions\": $practice/\"practice_sessions\": $new_practice/")
  save_gamification_data "$data"
  
  # Check if daily quest is practice-related
  check_quest_completion "practice"
  
  # Log to daily log
  log_to_daily "CKA Study: Practice session completed"
  
  # Log habit if exists
  log_habit_if_exists
  
  check_achievements
}

# Check quest completion
check_quest_completion() {
  local activity="$1"  # lesson, practice, study_time, etc.
  local data=$(get_gamification_data)
  local daily_quest=$(echo "$data" | grep -o '"daily": "[^"]*"' | cut -d'"' -f4)
  
  if [[ -z "$daily_quest" ]]; then
    return 0
  fi
  
  # Check if activity matches quest
  case "$activity" in
    lesson)
      if echo "$daily_quest" | grep -qi "lesson\|study"; then
        complete_quest "daily"
      fi
      ;;
    practice)
      if echo "$daily_quest" | grep -qi "practice\|exercise"; then
        complete_quest "daily"
      fi
      ;;
  esac
}

# Complete a quest
complete_quest() {
  local quest_type="$1"  # daily or weekly
  local data=$(get_gamification_data)
  local quest=$(echo "$data" | grep -o "\"$quest_type\": \"[^\"]*\"" | cut -d'"' -f4)
  
  if [[ -z "$quest" ]]; then
    return 0
  fi
  
  # Award bonus XP for quest completion
  award_xp 25 "Quest completed: $quest"
  
  # Mark quest as completed
  data=$(get_gamification_data)
  local completed=$(echo "$data" | grep -o '"quests_completed": \[[^]]*\]' | sed 's/"quests_completed": \[//' | sed 's/\]//')
  local today=$($DATE_CMD +"%Y-%m-%d")
  local quest_entry="$today:$quest_type:$quest"
  
  if [[ -z "$completed" || "$completed" == "[]" ]]; then
    completed="\"$quest_entry\""
  else
    # Check if already completed today
    if ! echo "$completed" | grep -q "$today:$quest_type"; then
      completed="$completed, \"$quest_entry\""
    else
      return 0  # Already completed today
    fi
  fi
  
  data=$(echo "$data" | sed "s/\"quests_completed\": \[[^]]*\]/\"quests_completed\": [$completed]/")
  save_gamification_data "$data"
  
  echo ""
  echo "ðŸŽ¯ QUEST COMPLETED: $quest"
  echo ""
}

# Check and unlock achievements
check_achievements() {
  local data=$(get_gamification_data)
  local unlocked=$(echo "$data" | grep -o '"achievements_unlocked": \[[^]]*\]' | sed 's/"achievements_unlocked": \[//' | sed 's/\]//')
  
  # Define achievements
  local achievements=(
    "first_lesson:First Lesson:Completed your first lesson:5"
    "five_lessons:Quick Learner:Completed 5 lessons:25"
    "ten_lessons:Getting Serious:Completed 10 lessons:50"
    "streak_3:Building Habit:3-day study streak:20"
    "streak_7:Week Warrior:7-day study streak:50"
    "streak_30:Month Master:30-day study streak:200"
    "level_5:Halfway There:Reached level 5:100"
    "level_10:Double Digits:Reached level 10:250"
    "practice_10:Practice Makes Perfect:10 practice sessions:75"
    "practice_50:Practice Champion:50 practice sessions:300"
    "all_topics:Topic Master:Completed all major topics:500"
  )
  
  local level=$(echo "$data" | grep -o '"level": [0-9]*' | grep -o '[0-9]*')
  local lessons=$(echo "$data" | grep -o '"lessons_completed": [0-9]*' | grep -o '[0-9]*')
  local streak=$(echo "$data" | grep -o '"study_streak": [0-9]*' | grep -o '[0-9]*')
  local practice=$(echo "$data" | grep -o '"practice_sessions": [0-9]*' | grep -o '[0-9]*')
  
  for achievement in "${achievements[@]}"; do
    IFS=':' read -r id name desc xp <<< "$achievement"
    
    # Check if already unlocked
    if echo "$unlocked" | grep -q "\"$id\""; then
      continue
    fi
    
    local should_unlock=false
    
    case "$id" in
      first_lesson)
        [[ $lessons -ge 1 ]] && should_unlock=true
        ;;
      five_lessons)
        [[ $lessons -ge 5 ]] && should_unlock=true
        ;;
      ten_lessons)
        [[ $lessons -ge 10 ]] && should_unlock=true
        ;;
      streak_3)
        [[ $streak -ge 3 ]] && should_unlock=true
        ;;
      streak_7)
        [[ $streak -ge 7 ]] && should_unlock=true
        ;;
      streak_30)
        [[ $streak -ge 30 ]] && should_unlock=true
        ;;
      level_5)
        [[ $level -ge 5 ]] && should_unlock=true
        ;;
      level_10)
        [[ $level -ge 10 ]] && should_unlock=true
        ;;
      practice_10)
        [[ $practice -ge 10 ]] && should_unlock=true
        ;;
      practice_50)
        [[ $practice -ge 50 ]] && should_unlock=true
        ;;
      all_topics)
        # Check if all major topics completed
        local topics_completed=$(echo "$data" | grep -o '"topics_completed": {[^}]*}' | grep -o '[a-z_]*' | grep -v topics_completed | wc -l | tr -d ' ')
        [[ $topics_completed -ge 8 ]] && should_unlock=true
        ;;
    esac
    
    if [[ "$should_unlock" == "true" ]]; then
      # Unlock achievement
      if [[ -z "$unlocked" || "$unlocked" == "[]" ]]; then
        unlocked="\"$id\""
      else
        unlocked="$unlocked, \"$id\""
      fi
      
      data=$(get_gamification_data)
      data=$(echo "$data" | sed "s/\"achievements_unlocked\": \[[^]]*\]/\"achievements_unlocked\": [$unlocked]/")
      save_gamification_data "$data"
      
      award_xp $xp "Achievement: $name"
      
      echo ""
      echo "ðŸ† ACHIEVEMENT UNLOCKED: $name"
      echo "   $desc"
      echo ""
    fi
  done
}

# Generate daily quest
generate_daily_quest() {
  local data=$(get_gamification_data)
  local today=$($DATE_CMD +"%Y-%m-%d")
  local current_quest=$(echo "$data" | grep -o '"daily": "[^"]*"' | cut -d'"' -f4)
  local quest_date=$(echo "$data" | grep -o '"daily_quest_date": "[^"]*"' | cut -d'"' -f4)
  
  if [[ "$quest_date" != "$today" ]] || [[ -z "$current_quest" ]]; then
    # Generate new quest
    local quests=(
      "Complete 1 lesson today"
      "Study for 30 minutes"
      "Complete a practice exercise"
      "Review notes from a previous lesson"
      "Master a new kubectl command"
    )
    
    local random_quest=${quests[$RANDOM % ${#quests[@]}]}
    
    data=$(get_gamification_data)
    if echo "$data" | grep -q '"daily_quest_date"'; then
      data=$(echo "$data" | sed "s/\"daily_quest_date\": \"[^\"]*\"/\"daily_quest_date\": \"$today\"/")
    else
      data=$(echo "$data" | sed 's/"quests": {/"quests": {\n    "daily_quest_date": "'"$today"'",/' | sed 's/},/}/')
    fi
    data=$(echo "$data" | sed "s/\"daily\": \"[^\"]*\"/\"daily\": \"$random_quest\"/")
    save_gamification_data "$data"
    
    echo "$random_quest"
  else
    echo "$current_quest"
  fi
}

# Show gamification dashboard
show_dashboard() {
  local data=$(get_gamification_data)
  local xp=$(echo "$data" | grep -o '"xp": [0-9]*' | grep -o '[0-9]*')
  local total_xp=$(echo "$data" | grep -o '"total_xp": [0-9]*' | grep -o '[0-9]*')
  local level=$(echo "$data" | grep -o '"level": [0-9]*' | grep -o '[0-9]*')
  local streak=$(echo "$data" | grep -o '"study_streak": [0-9]*' | grep -o '[0-9]*')
  local longest_streak=$(echo "$data" | grep -o '"longest_streak": [0-9]*' | grep -o '[0-9]*')
  local lessons=$(echo "$data" | grep -o '"lessons_completed": [0-9]*' | grep -o '[0-9]*')
  local practice=$(echo "$data" | grep -o '"practice_sessions": [0-9]*' | grep -o '[0-9]*')
  local study_time=$(echo "$data" | grep -o '"total_study_time": [0-9]*' | grep -o '[0-9]*')
  
  # Calculate XP needed for next level
  local xp_for_next=0
  if [[ $level -lt 10 ]]; then
    xp_for_next=$((level * 100))
  else
    local base=1000
    local multiplier=1
    for ((i=10; i<$level; i++)); do
      multiplier=$((multiplier * 12 / 10))
    done
    xp_for_next=$((base * multiplier))
  fi
  local xp_progress=$((total_xp - xp_for_next))
  local xp_needed=$((xp_for_next + (level < 10 ? level * 100 : xp_for_next * 12 / 10) - total_xp))
  
  clear
  echo -e "${BOLD}${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
  echo -e "${BOLD}${CYAN}ðŸŽ® CKA Study Gamification Dashboard${NC}"
  echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
  echo ""
  
  # Level and XP
  echo -e "${BOLD}ðŸ“Š Level & Progress${NC}"
  echo -e "   ${GREEN}Level ${level}${NC} | Total XP: ${total_xp} | XP to next: ${xp_needed}"
  echo ""
  
  # Streak
  echo -e "${BOLD}ðŸ”¥ Study Streak${NC}"
  echo -e "   Current: ${streak} days | Longest: ${longest_streak} days"
  echo ""
  
  # Stats
  echo -e "${BOLD}ðŸ“ˆ Statistics${NC}"
  echo -e "   Lessons Completed: ${lessons}"
  echo -e "   Practice Sessions: ${practice}"
  echo -e "   Total Study Time: ${study_time} minutes"
  echo ""
  
  # Daily Quest
  local daily_quest=$(generate_daily_quest)
  echo -e "${BOLD}ðŸŽ¯ Daily Quest${NC}"
  echo -e "   ${YELLOW}${daily_quest}${NC}"
  echo ""
  
  # Achievements
  local achievements=$(echo "$data" | grep -o '"achievements_unlocked": \[[^]]*\]' | sed 's/"achievements_unlocked": \[//' | sed 's/\]//')
  local achievement_count=$(echo "$achievements" | grep -o '"[^"]*"' | wc -l | tr -d ' ')
  echo -e "${BOLD}ðŸ† Achievements${NC}"
  echo -e "   Unlocked: ${achievement_count}"
  echo ""
  
  read -p "Press Enter to continue..."
}

# Main function
main() {
  case "${1:-dashboard}" in
    award)
      award_xp "${2:-10}" "${3:-Study session}"
      ;;
    lesson)
      track_lesson "${2:-unknown}" "${3:-0}"
      ;;
    practice)
      track_practice
      ;;
    streak)
      update_streak
      ;;
    achievements)
      check_achievements
      ;;
    dashboard|stats)
      show_dashboard
      ;;
    *)
      show_dashboard
      ;;
  esac
}

# Initialize if needed
init_gamification

main "$@"

