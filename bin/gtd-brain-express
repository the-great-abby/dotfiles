#!/bin/bash
# GTD Second Brain - Express Phase
# Create and share content from your Second Brain notes

# Source common environment (PATH setup)
COMMON_ENV="$HOME/code/dotfiles/zsh/common_env.sh"
if [[ ! -f "$COMMON_ENV" && -f "$HOME/code/personal/dotfiles/zsh/common_env.sh" ]]; then
  COMMON_ENV="$HOME/code/personal/dotfiles/zsh/common_env.sh"
fi
if [[ -f "$COMMON_ENV" ]]; then
  source "$COMMON_ENV"
fi


# Load GTD config
GTD_CONFIG_FILE="$HOME/.gtd_config"
if [[ -f "$HOME/code/dotfiles/zsh/.gtd_config" ]]; then
  GTD_CONFIG_FILE="$HOME/code/dotfiles/zsh/.gtd_config"
elif [[ -f "$HOME/code/personal/dotfiles/zsh/.gtd_config" ]]; then
  GTD_CONFIG_FILE="$HOME/code/personal/dotfiles/zsh/.gtd_config"
fi

if [[ -f "$GTD_CONFIG_FILE" ]]; then
  source "$GTD_CONFIG_FILE"
fi

# Default values
SECOND_BRAIN="${SECOND_BRAIN:-$HOME/Documents/obsidian/Second Brain}"
EXPRESS_DIR="${SECOND_BRAIN}/Express"
GTD_BASE_DIR="${GTD_BASE_DIR:-$HOME/Documents/gtd}"

# Create Express directory
mkdir -p "$EXPRESS_DIR"/{drafts,published,ideas}

# Colors
CYAN='\033[0;36m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BOLD='\033[1m'
NC='\033[0m'

# Get date command
get_date_cmd() {
  if [[ -x "/usr/bin/date" ]]; then
    echo "/usr/bin/date"
  elif [[ -x "/bin/date" ]]; then
    echo "/bin/date"
  else
    echo "date"
  fi
}

DATE_CMD=$(get_date_cmd)

# Create content from notes
create_from_notes() {
  local title="$1"
  local source_notes="$2"  # Comma-separated list of note paths
  local content_type="${3:-article}"  # article, blog, presentation, report
  
  if [[ -z "$title" ]]; then
    echo "‚ùå Title required"
    echo "Usage: gtd-brain-express create <title> <note1,note2,...> [type]"
    return 1
  fi
  
  if [[ -z "$source_notes" ]]; then
    echo "‚ùå Source notes required"
    echo "Usage: gtd-brain-express create <title> <note1,note2,...> [type]"
    return 1
  fi
  
  local timestamp=$($DATE_CMD +"%Y-%m-%d %H:%M")
  local today=$($DATE_CMD +"%Y-%m-%d")
  local filename=$(echo "$title" | tr '[:upper:]' '[:lower:]' | sed 's/[^a-z0-9]/-/g' | sed 's/--*/-/g' | sed 's/^-\|-$//g')
  local draft_file="${EXPRESS_DIR}/drafts/${filename}.md"
  
  # Collect content from source notes
  local content=""
  local sources_list=""
  
  IFS=',' read -ra NOTES <<< "$source_notes"
  for note_path in "${NOTES[@]}"; do
    note_path=$(echo "$note_path" | sed 's/^[[:space:]]*//' | sed 's/[[:space:]]*$//')
    
    # Expand if relative path
    if [[ "$note_path" != /* ]]; then
      # Try to find in Second Brain
      local found_note=$(find "$SECOND_BRAIN" -name "$(basename "$note_path")" -type f 2>/dev/null | head -1)
      if [[ -n "$found_note" ]]; then
        note_path="$found_note"
      fi
    fi
    
    if [[ -f "$note_path" ]]; then
      local note_name=$(basename "$note_path" .md)
      sources_list="${sources_list}- [[${note_name}]]\n"
      
      # Extract key content (summary, core insights, or main content)
      if grep -q "## Summary" "$note_path"; then
        content="${content}## From: ${note_name}\n\n"
        content="${content}$(awk '/^## Summary$/,/^##/' "$note_path" | sed '/^## Summary$/d' | sed '/^##/q')\n\n"
      elif grep -q "## Core Insights" "$note_path"; then
        content="${content}## From: ${note_name}\n\n"
        content="${content}$(awk '/^## Core Insights$/,/^##/' "$note_path" | sed '/^## Core Insights$/d' | sed '/^##/q')\n\n"
      else
        # Get first few paragraphs
        content="${content}## From: ${note_name}\n\n"
        content="${content}$(head -20 "$note_path" | grep -v "^#" | grep -v "^---" | head -10)\n\n"
      fi
    else
      echo "‚ö†Ô∏è  Note not found: $note_path"
    fi
  done
  
  # Create draft
  cat > "$draft_file" <<EOF
# ${title}

Created: ${timestamp}
Type: ${content_type}
Status: draft

## Sources
${sources_list}

## Content

${content}

## Notes
<!-- Add your own thoughts, connections, and insights here -->

## Next Steps
<!-- What do you want to do with this content? -->

---
Created from Second Brain notes via Express phase
EOF

  echo "‚úì Created draft: $draft_file"
  echo ""
  echo "üìù Next steps:"
  echo "  1. Review and refine the content"
  echo "  2. Add your own insights and connections"
  echo "  3. Use 'gtd-brain-express publish' when ready"
  echo ""
  echo "$draft_file"
}

# Publish content
publish_content() {
  local draft_path="$1"
  
  if [[ -z "$draft_path" ]]; then
    echo "‚ùå Draft path required"
    echo "Usage: gtd-brain-express publish <draft-path>"
    return 1
  fi
  
  # Expand if relative
  if [[ "$draft_path" != /* ]]; then
    draft_path="${EXPRESS_DIR}/drafts/${draft_path}"
  fi
  
  if [[ ! -f "$draft_path" ]]; then
    echo "‚ùå Draft not found: $draft_path"
    return 1
  fi
    
  local filename=$(basename "$draft_path")
  local published_file="${EXPRESS_DIR}/published/${filename}"
  
  # Add published date
  local today=$($DATE_CMD +"%Y-%m-%d")
  
  # Copy to published
  cp "$draft_path" "$published_file"
  
  # Add published metadata
  if [[ "$OSTYPE" == "darwin"* ]]; then
    sed -i '' "s/Status: draft/Status: published\nPublished: ${today}/" "$published_file"
  else
    sed -i "s/Status: draft/Status: published\nPublished: ${today}/" "$published_file"
  fi
  
  echo "‚úì Published: $published_file"
  echo ""
  echo "üì§ Content is ready to share!"
  echo "   Location: $published_file"
  echo ""
}

# List drafts
list_drafts() {
  echo ""
  echo -e "${BOLD}${CYAN}Express Phase - Drafts${NC}"
  echo -e "${CYAN}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${NC}"
  echo ""
  
  local draft_count=$(find "${EXPRESS_DIR}/drafts" -name "*.md" -type f 2>/dev/null | wc -l | tr -d ' ')
  
  if [[ "$draft_count" -eq 0 ]]; then
    echo "No drafts found."
    echo ""
    return 0
  fi
  
  echo "Found ${draft_count} draft(s):"
  echo ""
  
  find "${EXPRESS_DIR}/drafts" -name "*.md" -type f 2>/dev/null | sort | while read -r draft; do
    local title=$(grep "^# " "$draft" | head -1 | sed 's/^# //' || basename "$draft" .md)
    local created=$(grep "^Created:" "$draft" | head -1 | cut -d':' -f2- | sed 's/^[[:space:]]*//' || echo "Unknown")
    local type=$(grep "^Type:" "$draft" | head -1 | cut -d':' -f2 | sed 's/^[[:space:]]*//' || echo "article")
    
    echo -e "${GREEN}‚Ä¢${NC} ${BOLD}${title}${NC}"
    echo "  Type: ${type} | Created: ${created}"
    echo ""
  done
}

# List published
list_published() {
  echo ""
  echo -e "${BOLD}${CYAN}Express Phase - Published${NC}"
  echo -e "${CYAN}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${NC}"
  echo ""
  
  local published_count=$(find "${EXPRESS_DIR}/published" -name "*.md" -type f 2>/dev/null | wc -l | tr -d ' ')
  
  if [[ "$published_count" -eq 0 ]]; then
    echo "No published content found."
    echo ""
    return 0
  fi
  
  echo "Found ${published_count} published item(s):"
  echo ""
  
  find "${EXPRESS_DIR}/published" -name "*.md" -type f 2>/dev/null | sort -r | while read -r published; do
    local title=$(grep "^# " "$published" | head -1 | sed 's/^# //' || basename "$published" .md)
    local published_date=$(grep "^Published:" "$published" | head -1 | cut -d':' -f2- | sed 's/^[[:space:]]*//' || echo "Unknown")
    local type=$(grep "^Type:" "$published" | head -1 | cut -d':' -f2 | sed 's/^[[:space:]]*//' || echo "article")
    
    echo -e "${GREEN}‚Ä¢${NC} ${BOLD}${title}${NC}"
    echo "  Type: ${type} | Published: ${published_date}"
    echo ""
  done
}

# Create idea from notes
create_idea() {
  local idea="$1"
  
  if [[ -z "$idea" ]]; then
    echo "‚ùå Idea required"
    echo "Usage: gtd-brain-express idea <idea-description>"
    return 1
  fi
  
  local timestamp=$($DATE_CMD +"%Y-%m-%d %H:%M")
  local today=$($DATE_CMD +"%Y-%m-%d")
  local filename=$(echo "$idea" | tr '[:upper:]' '[:lower:]' | sed 's/[^a-z0-9]/-/g' | sed 's/--*/-/g' | sed 's/^-\|-$//g' | cut -c1-50)
  local idea_file="${EXPRESS_DIR}/ideas/${today}-${filename}.md"
  
  cat > "$idea_file" <<EOF
# ${idea}

Created: ${timestamp}
Status: idea

## Description
${idea}

## Related Notes
<!-- Link to relevant Second Brain notes -->
- 

## Potential Content
<!-- What could this become? -->
- 

## Next Steps
<!-- How to develop this idea? -->
- 

## Tags
#idea #express

EOF

  echo "‚úì Created idea: $idea_file"
  echo "$idea_file"
}

# Show usage
show_usage() {
  cat <<EOF
Usage: gtd-brain-express <command> [options]

Commands:
  create <title> <notes> [type]   Create content from notes
                                   notes: comma-separated paths
                                   type: article, blog, presentation, report
  publish <draft-path>             Publish a draft
  drafts                           List all drafts
  published                        List published content
  idea <description>               Create an idea for future content
  help                             Show this help

Examples:
  gtd-brain-express create "Productivity Guide" "note1.md,note2.md" article
  gtd-brain-express create "K8s Learning" "pods.md,deployments.md" blog
  gtd-brain-express publish drafts/productivity-guide.md
  gtd-brain-express drafts
  gtd-brain-express idea "Write about GTD and Second Brain integration"

The Express phase is about creating and sharing from your Second Brain.
Transform your notes into articles, blog posts, presentations, and more.

EOF
}

# Main command handler
case "${1:-}" in
  create)
    create_from_notes "$2" "$3" "${4:-article}"
    ;;
  publish)
    publish_content "$2"
    ;;
  drafts)
    list_drafts
    ;;
  published)
    list_published
    ;;
  idea)
    create_idea "$2"
    ;;
  help|--help|-h)
    show_usage
    ;;
  "")
    show_usage
    ;;
  *)
    echo "‚ùå Unknown command: $1"
    echo ""
    show_usage
    exit 1
    ;;
esac

