#!/bin/bash
# GTD Second Brain - Sync Daily Logs to Second Brain
# Creates daily note summaries in Second Brain from daily logs

# Load GTD config
GTD_CONFIG_FILE="$HOME/.gtd_config"
if [[ -f "$HOME/code/dotfiles/zsh/.gtd_config" ]]; then
  GTD_CONFIG_FILE="$HOME/code/dotfiles/zsh/.gtd_config"
elif [[ -f "$HOME/code/personal/dotfiles/zsh/.gtd_config" ]]; then
  GTD_CONFIG_FILE="$HOME/code/personal/dotfiles/zsh/.gtd_config"
fi

if [[ -f "$GTD_CONFIG_FILE" ]]; then
  source "$GTD_CONFIG_FILE"
fi

# Load daily log config
DAILY_LOG_CONFIG="$HOME/.daily_log_config"
if [[ -f "$HOME/code/dotfiles/zsh/.daily_log_config" ]]; then
  DAILY_LOG_CONFIG="$HOME/code/dotfiles/zsh/.daily_log_config"
elif [[ -f "$HOME/code/personal/dotfiles/zsh/.daily_log_config" ]]; then
  DAILY_LOG_CONFIG="$HOME/code/personal/dotfiles/zsh/.daily_log_config"
fi

if [[ -f "$DAILY_LOG_CONFIG" ]]; then
  source "$DAILY_LOG_CONFIG"
fi

# Default values
SECOND_BRAIN="${SECOND_BRAIN:-$HOME/Documents/obsidian/Second Brain}"
DAILY_LOG_DIR="${DAILY_LOG_DIR:-$HOME/Documents/daily_logs}"
DAILY_NOTES_DIR="${SECOND_BRAIN}/Daily Notes"
GTD_BASE_DIR="${GTD_BASE_DIR:-$HOME/Documents/gtd}"

# Create Daily Notes directory
mkdir -p "$DAILY_NOTES_DIR"

# Colors
CYAN='\033[0;36m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BOLD='\033[1m'
NC='\033[0m'

# Get date command
get_date_cmd() {
  if [[ -x "/usr/bin/date" ]]; then
    echo "/usr/bin/date"
  elif [[ -x "/bin/date" ]]; then
    echo "/bin/date"
  else
    echo "date"
  fi
}

DATE_CMD=$(get_date_cmd)

# Sync a specific daily log
sync_daily_log() {
  local date="$1"  # YYYY-MM-DD format
  
  if [[ -z "$date" ]]; then
    local today=$($DATE_CMD +"%Y-%m-%d")
    date="$today"
  fi
  
  local log_file="${DAILY_LOG_DIR}/${date}.md"
  local brain_note="${DAILY_NOTES_DIR}/${date}.md"
  
  if [[ ! -f "$log_file" ]]; then
    echo "‚ùå Daily log not found: $log_file"
    return 1
  fi
  
  # Read daily log content
  local log_content=$(cat "$log_file")
  
  # Extract key information
  local entry_count=$(grep -c "^[0-9][0-9]:[0-9][0-9] -" "$log_file" 2>/dev/null || echo "0")
  local goals=$(grep -iE "goal|goals" "$log_file" 2>/dev/null | head -5)
  local workouts=$(grep -iE "workout|exercise|kettlebell|walk|run|weight|lifting|gym" "$log_file" 2>/dev/null | head -5)
  local pills=$(grep -iE "pill|pills|medication|medicine|meds|took.*pill" "$log_file" 2>/dev/null | head -5)
  local projects=$(grep -iE "project|working on" "$log_file" 2>/dev/null | head -5)
  
  # Create or update Second Brain note
  local timestamp=$($DATE_CMD +"%Y-%m-%d %H:%M")
  
  if [[ -f "$brain_note" ]]; then
    # Update existing note
    if ! grep -q "## Daily Log Sync" "$brain_note" 2>/dev/null; then
      cat >> "$brain_note" <<EOF

## Daily Log Sync

Synced from daily log: ${timestamp}

### Summary
- Total entries: ${entry_count}
- Log file: [[Daily Log: ${date}]] ‚Üí ${log_file}

### Key Highlights
EOF
      
      if [[ -n "$goals" ]]; then
        echo "" >> "$brain_note"
        echo "#### Goals" >> "$brain_note"
        echo "$goals" | sed 's/^/  - /' >> "$brain_note"
      fi
      
      if [[ -n "$workouts" ]]; then
        echo "" >> "$brain_note"
        echo "#### Workouts" >> "$brain_note"
        echo "$workouts" | sed 's/^/  - /' >> "$brain_note"
      fi
      
      if [[ -n "$pills" ]]; then
        echo "" >> "$brain_note"
        echo "#### Medication" >> "$brain_note"
        echo "$pills" | sed 's/^/  - /' >> "$brain_note"
      fi
      
      if [[ -n "$projects" ]]; then
        echo "" >> "$brain_note"
        echo "#### Projects" >> "$brain_note"
        echo "$projects" | sed 's/^/  - /' >> "$brain_note"
      fi
      
      echo "" >> "$brain_note"
      echo "### Full Log" >> "$brain_note"
      echo "\`\`\`" >> "$brain_note"
      echo "$log_content" >> "$brain_note"
      echo "\`\`\`" >> "$brain_note"
      
      echo "‚úì Updated Second Brain note: $brain_note"
    else
      echo "‚ö†Ô∏è  Note already has daily log sync section"
    fi
  else
    # Create new note
    cat > "$brain_note" <<EOF
# Daily Note - ${date}

Created: ${timestamp}
Type: Daily Note
Source: Daily Log

## Daily Log Sync

Synced from daily log: ${timestamp}

### Summary
- Total entries: ${entry_count}
- Log file: [[Daily Log: ${date}]] ‚Üí ${log_file}

### Key Highlights
EOF
    
    if [[ -n "$goals" ]]; then
      echo "" >> "$brain_note"
      echo "#### Goals" >> "$brain_note"
      echo "$goals" | sed 's/^/  - /' >> "$brain_note"
    fi
    
    if [[ -n "$workouts" ]]; then
      echo "" >> "$brain_note"
      echo "#### Workouts" >> "$brain_note"
      echo "$workouts" | sed 's/^/  - /' >> "$brain_note"
    fi
    
    if [[ -n "$pills" ]]; then
      echo "" >> "$brain_note"
      echo "#### Medication" >> "$brain_note"
      echo "$pills" | sed 's/^/  - /' >> "$brain_note"
    fi
    
    if [[ -n "$projects" ]]; then
      echo "" >> "$brain_note"
      echo "#### Projects" >> "$brain_note"
      echo "$projects" | sed 's/^/  - /' >> "$brain_note"
    fi
    
    echo "" >> "$brain_note"
    echo "### Full Log" >> "$brain_note"
    echo "\`\`\`" >> "$brain_note"
    echo "$log_content" >> "$brain_note"
    echo "\`\`\`" >> "$brain_note"
    echo "" >> "$brain_note"
    echo "## Notes" >> "$brain_note"
    echo "" >> "$brain_note"
    echo "<!-- Add your reflections, insights, and connections here -->" >> "$brain_note"
    echo "" >> "$brain_note"
    echo "## Tags" >> "$brain_note"
    echo "#daily-note #${date}" >> "$brain_note"
    
    echo "‚úì Created Second Brain note: $brain_note"
  fi
  
  echo "$brain_note"
}

# Sync all daily logs
sync_all_daily_logs() {
  echo ""
  echo -e "${BOLD}${CYAN}Syncing Daily Logs to Second Brain${NC}"
  echo -e "${CYAN}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${NC}"
  echo ""
  
  if [[ ! -d "$DAILY_LOG_DIR" ]]; then
    echo "‚ùå Daily log directory not found: $DAILY_LOG_DIR"
    return 1
  fi
  
  local logs=($(find "$DAILY_LOG_DIR" -type f -name "*.md" -maxdepth 1 | sort))
  local count=0
  local synced=0
  
  for log_file in "${logs[@]}"; do
    local date=$(basename "$log_file" .md)
    if [[ "$date" =~ ^[0-9]{4}-[0-9]{2}-[0-9]{2}$ ]]; then
      ((count++))
      local brain_note="${DAILY_NOTES_DIR}/${date}.md"
      
      if [[ ! -f "$brain_note" ]] || ! grep -q "## Daily Log Sync" "$brain_note" 2>/dev/null; then
        sync_daily_log "$date" >/dev/null 2>&1
        ((synced++))
      fi
    fi
  done
  
  echo "üìä Sync Summary:"
  echo "  Total daily logs: ${count}"
  echo "  Synced to Second Brain: ${synced}"
  echo "  Already synced: $((count - synced))"
  echo ""
  echo "‚úì Daily logs synced to: ${DAILY_NOTES_DIR}"
  echo ""
}

# Link daily log to Second Brain note
link_daily_log() {
  local date="$1"
  local brain_note_path="$2"
  
  if [[ -z "$date" || -z "$brain_note_path" ]]; then
    echo "‚ùå Date and note path required"
    echo "Usage: gtd-brain-sync-daily-logs link <date> <note-path>"
    return 1
  fi
  
  local log_file="${DAILY_LOG_DIR}/${date}.md"
  local brain_note="${DAILY_NOTES_DIR}/${date}.md"
  
  if [[ ! -f "$log_file" ]]; then
    echo "‚ùå Daily log not found: $log_file"
    return 1
  fi
  
  if [[ ! -f "$brain_note_path" ]]; then
    echo "‚ùå Second Brain note not found: $brain_note_path"
    return 1
  fi
  
  # Add link in daily log note
  if ! grep -q "\[\[$(basename "$brain_note_path" .md)\]\]" "$brain_note" 2>/dev/null; then
    if ! grep -q "## Related Notes" "$brain_note" 2>/dev/null; then
      echo "" >> "$brain_note"
      echo "## Related Notes" >> "$brain_note"
      echo "" >> "$brain_note"
    fi
    echo "- [[$(basename "$brain_note_path" .md)]]" >> "$brain_note"
    echo "‚úì Linked to: $(basename "$brain_note_path" .md)"
  fi
  
  # Add link in target note
  local target_name=$(basename "$brain_note_path" .md)
  if ! grep -q "\[\[Daily Note: ${date}\]\]" "$brain_note_path" 2>/dev/null; then
    if ! grep -q "## Daily Notes" "$brain_note_path" 2>/dev/null; then
      echo "" >> "$brain_note_path"
      echo "## Daily Notes" >> "$brain_note_path"
      echo "" >> "$brain_note_path"
    fi
    echo "- [[Daily Note: ${date}]] ‚Üí ${brain_note}" >> "$brain_note_path"
    echo "‚úì Added link from: $target_name"
  fi
}

# Show usage
show_usage() {
  cat <<EOF
Usage: gtd-brain-sync-daily-logs <command> [options]

Commands:
  [date]                    Sync specific daily log (default: today)
  all                       Sync all daily logs
  link <date> <note>        Link daily log to Second Brain note
  help                      Show this help

Examples:
  gtd-brain-sync-daily-logs              # Sync today's log
  gtd-brain-sync-daily-logs 2025-11-30   # Sync specific date
  gtd-brain-sync-daily-logs all          # Sync all logs
  gtd-brain-sync-daily-logs link 2025-11-30 ~/Documents/obsidian/Second\ Brain/Projects/project.md

This command syncs your daily logs to Second Brain, creating daily notes with:
- Key highlights (goals, workouts, pills, projects)
- Full log content
- Links back to original log file

Daily notes are created in: ~/Documents/obsidian/Second Brain/Daily Notes/

EOF
}

# Main command handler
case "${1:-}" in
  all)
    sync_all_daily_logs
    ;;
  link)
    link_daily_log "$2" "$3"
    ;;
  help|--help|-h)
    show_usage
    ;;
  "")
    # Sync today's log
    sync_daily_log
    ;;
  *)
    # Try to parse as date or command
    if [[ "$1" =~ ^[0-9]{4}-[0-9]{2}-[0-9]{2}$ ]]; then
      sync_daily_log "$1"
    else
      echo "‚ùå Unknown command: $1"
      echo ""
      show_usage
      exit 1
    fi
    ;;
esac

