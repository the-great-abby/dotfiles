#!/bin/bash
# GTD Second Brain - Intermediate Packets Management
# Intermediate Packets are reusable components of work

# Load GTD config
GTD_CONFIG_FILE="$HOME/.gtd_config"
if [[ -f "$HOME/code/dotfiles/zsh/.gtd_config" ]]; then
  GTD_CONFIG_FILE="$HOME/code/dotfiles/zsh/.gtd_config"
elif [[ -f "$HOME/code/personal/dotfiles/zsh/.gtd_config" ]]; then
  GTD_CONFIG_FILE="$HOME/code/personal/dotfiles/zsh/.gtd_config"
fi

if [[ -f "$GTD_CONFIG_FILE" ]]; then
  source "$GTD_CONFIG_FILE"
fi

# Default values
SECOND_BRAIN="${SECOND_BRAIN:-$HOME/Documents/obsidian/Second Brain}"
PACKETS_DIR="${SECOND_BRAIN}/Packets"
GTD_BASE_DIR="${GTD_BASE_DIR:-$HOME/Documents/gtd}"

# Create Packets directory
mkdir -p "$PACKETS_DIR"/{templates,checklists,code-snippets,design-patterns,meeting-notes,project-kickoff,weekly-review}

# Colors
CYAN='\033[0;36m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BOLD='\033[1m'
NC='\033[0m'

# Get date command
get_date_cmd() {
  if [[ -x "/usr/bin/date" ]]; then
    echo "/usr/bin/date"
  elif [[ -x "/bin/date" ]]; then
    echo "/bin/date"
  else
    echo "date"
  fi
}

DATE_CMD=$(get_date_cmd)

# Create a packet from a note
create_packet() {
  local source_note="$1"
  local packet_name="$2"
  local packet_type="${3:-template}"  # template, checklist, code-snippet, design-pattern, meeting-notes, project-kickoff, weekly-review
  
  if [[ -z "$source_note" || -z "$packet_name" ]]; then
    echo "❌ Source note and packet name required"
    echo "Usage: gtd-brain-packet create <source-note> <packet-name> [type]"
    return 1
  fi
  
  # Expand if relative path
  if [[ "$source_note" != /* ]]; then
    local found_note=$(find "$SECOND_BRAIN" -name "$(basename "$source_note")" -type f 2>/dev/null | head -1)
    if [[ -n "$found_note" ]]; then
      source_note="$found_note"
    fi
  fi
  
  if [[ ! -f "$source_note" ]]; then
    echo "❌ Source note not found: $source_note"
    return 1
  fi
  
  local timestamp=$($DATE_CMD +"%Y-%m-%d %H:%M")
  local today=$($DATE_CMD +"%Y-%m-%d")
  local filename=$(echo "$packet_name" | tr '[:upper:]' '[:lower:]' | sed 's/[^a-z0-9]/-/g' | sed 's/--*/-/g' | sed 's/^-\|-$//g')
  local packet_file="${PACKETS_DIR}/${packet_type}/${filename}.md"
  
  if [[ -f "$packet_file" ]]; then
    echo "⚠️  Packet already exists: $packet_file"
    read -p "Overwrite? (y/n) " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
      return 1
    fi
  fi
  
  # Create packet file
  cat > "$packet_file" <<EOF
# Packet: ${packet_name}

Type: ${packet_type}
Created: ${timestamp}
Source: [[$(basename "$source_note" .md)]]

## Description
<!-- Describe what this packet is for and when to use it -->

## Content

$(cat "$source_note")

## Usage Instructions
<!-- How to use this packet -->

## Related Packets
<!-- Link to related packets -->
- 

## Tags
#packet #${packet_type} #reusable

## Last Updated
${today}

EOF

  echo "✓ Created packet: $packet_file"
  echo "$packet_file"
}

# List all packets
list_packets() {
  local packet_type="${1:-}"  # Optional filter
  
  echo ""
  echo -e "${BOLD}${CYAN}Intermediate Packets${NC}"
  echo -e "${CYAN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
  echo ""
  
  local search_dir="$PACKETS_DIR"
  if [[ -n "$packet_type" ]]; then
    search_dir="${PACKETS_DIR}/${packet_type}"
  fi
  
  local packet_count=$(find "$search_dir" -name "*.md" -type f 2>/dev/null | wc -l | tr -d ' ')
  
  if [[ "$packet_count" -eq 0 ]]; then
    echo "No packets found."
    echo ""
    echo "Create one with: gtd-brain-packet create <note> <name> [type]"
    echo ""
    return 0
  fi
  
  echo "Found ${packet_count} packet(s):"
  echo ""
  
  # Group by type
  for type_dir in "$PACKETS_DIR"/*/; do
    if [[ -d "$type_dir" ]]; then
      local type=$(basename "$type_dir")
      local type_packets=$(find "$type_dir" -name "*.md" -type f 2>/dev/null)
      
      if [[ -n "$type_packets" ]]; then
        echo -e "${BOLD}${type}:${NC}"
        echo "$type_packets" | while read -r packet; do
          local name=$(basename "$packet" .md)
          local title=$(grep "^# Packet:" "$packet" | head -1 | sed 's/^# Packet: //' || echo "$name")
          local last_updated=$(grep "^## Last Updated" "$packet" -A 1 | tail -1 | sed 's/^[[:space:]]*//' || echo "Unknown")
          
          echo -e "  ${GREEN}•${NC} ${title}"
          echo "    Last updated: ${last_updated}"
        done
        echo ""
      fi
    fi
  done
}

# View a packet
view_packet() {
  local packet_name="$1"
  
  if [[ -z "$packet_name" ]]; then
    echo "❌ Packet name required"
    echo "Usage: gtd-brain-packet view <packet-name>"
    return 1
  fi
  
  # Find packet
  local packet_file=$(find "$PACKETS_DIR" -name "${packet_name}.md" -o -name "*${packet_name}*.md" -type f 2>/dev/null | head -1)
  
  if [[ -z "$packet_file" ]]; then
    echo "❌ Packet not found: $packet_name"
    echo ""
    echo "Available packets:"
    list_packets
    return 1
  fi
  
  echo ""
  echo -e "${BOLD}${CYAN}Packet: $(basename "$packet_file" .md)${NC}"
  echo -e "${CYAN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
  echo ""
  cat "$packet_file"
  echo ""
}

# Use a packet (copy to current location or project)
use_packet() {
  local packet_name="$1"
  local destination="${2:-}"  # Optional destination
  
  if [[ -z "$packet_name" ]]; then
    echo "❌ Packet name required"
    echo "Usage: gtd-brain-packet use <packet-name> [destination]"
    return 1
  fi
  
  # Find packet
  local packet_file=$(find "$PACKETS_DIR" -name "${packet_name}.md" -o -name "*${packet_name}*.md" -type f 2>/dev/null | head -1)
  
  if [[ -z "$packet_file" ]]; then
    echo "❌ Packet not found: $packet_name"
    return 1
  fi
  
  # Determine destination
  if [[ -z "$destination" ]]; then
    destination="${SECOND_BRAIN}/Resources"
  fi
  
  # Create destination if needed
  mkdir -p "$destination"
  
  local dest_file="${destination}/$(basename "$packet_file")"
  
  # Copy packet content (without packet metadata)
  awk '/^## Content$/,/^## / {if (!/^## Content$/ && !/^## /) print; if (/^## / && !/^## Content$/) exit}' "$packet_file" > "$dest_file"
  
  # Add usage note
  {
    echo "# $(basename "$packet_file" .md | sed 's/^Packet: //')"
    echo ""
    echo "*Created from packet: [[$(basename "$packet_file" .md)]]*"
    echo ""
    cat "$dest_file"
  } > "${dest_file}.tmp" && mv "${dest_file}.tmp" "$dest_file"
  
  echo "✓ Used packet: $packet_file"
  echo "  → Copied to: $dest_file"
  echo "$dest_file"
}

# Assemble multiple packets into one
assemble_packets() {
  local output_name="$1"
  shift
  local packets=("$@")
  
  if [[ -z "$output_name" || ${#packets[@]} -eq 0 ]]; then
    echo "❌ Output name and at least one packet required"
    echo "Usage: gtd-brain-packet assemble <output-name> <packet1> [packet2] ..."
    return 1
  fi
  
  local timestamp=$($DATE_CMD +"%Y-%m-%d %H:%M")
  local today=$($DATE_CMD +"%Y-%m-%d")
  local filename=$(echo "$output_name" | tr '[:upper:]' '[:lower:]' | sed 's/[^a-z0-9]/-/g' | sed 's/--*/-/g' | sed 's/^-\|-$//g')
  local output_file="${SECOND_BRAIN}/Resources/${filename}.md"
  
  # Start output file
  cat > "$output_file" <<EOF
# ${output_name}

Created: ${timestamp}
Assembled from packets

## Packets Used
EOF

  # Add each packet
  for packet_name in "${packets[@]}"; do
    local packet_file=$(find "$PACKETS_DIR" -name "${packet_name}.md" -o -name "*${packet_name}*.md" -type f 2>/dev/null | head -1)
    
    if [[ -f "$packet_file" ]]; then
      echo "- [[$(basename "$packet_file" .md)]]" >> "$output_file"
      
      # Extract content from packet
      echo "" >> "$output_file"
      echo "## From: $(basename "$packet_file" .md | sed 's/^Packet: //')" >> "$output_file"
      echo "" >> "$output_file"
      awk '/^## Content$/,/^## / {if (!/^## Content$/ && !/^## /) print; if (/^## / && !/^## Content$/) exit}' "$packet_file" >> "$output_file"
      echo "" >> "$output_file"
    else
      echo "⚠️  Packet not found: $packet_name" >&2
    fi
  done
  
  echo "✓ Assembled packets into: $output_file"
  echo "$output_file"
}

# Show usage
show_usage() {
  cat <<EOF
Usage: gtd-brain-packet <command> [options]

Commands:
  create <note> <name> [type]    Create packet from note
                                  types: template, checklist, code-snippet, 
                                        design-pattern, meeting-notes, 
                                        project-kickoff, weekly-review
  list [type]                     List all packets (optionally filter by type)
  view <name>                     View a specific packet
  use <name> [dest]               Use packet (copy to destination)
  assemble <name> <packet...>     Assemble multiple packets into one
  help                            Show this help

Examples:
  gtd-brain-packet create meeting-notes.md "Team Standup" meeting-notes
  gtd-brain-packet list
  gtd-brain-packet view "Team Standup"
  gtd-brain-packet use "Team Standup" ~/Documents/obsidian/Second\ Brain/Projects/current-project
  gtd-brain-packet assemble "Project Plan" "Project Kickoff" "Weekly Review"

Intermediate Packets are reusable components you can assemble into larger projects.
Save time by reusing work and maintaining consistency.

EOF
}

# Main command handler
case "${1:-}" in
  create)
    create_packet "$2" "$3" "${4:-template}"
    ;;
  list)
    list_packets "$2"
    ;;
  view)
    view_packet "$2"
    ;;
  use)
    use_packet "$2" "$3"
    ;;
  assemble)
    shift
    output_name="$1"
    shift
    assemble_packets "$output_name" "$@"
    ;;
  help|--help|-h)
    show_usage
    ;;
  "")
    show_usage
    ;;
  *)
    echo "❌ Unknown command: $1"
    echo ""
    show_usage
    exit 1
    ;;
esac

