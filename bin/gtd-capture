#!/bin/bash
# GTD Capture Command - Quick capture to inbox

# Source common environment (PATH setup)
COMMON_ENV="$HOME/code/dotfiles/zsh/common_env.sh"
if [[ ! -f "$COMMON_ENV" && -f "$HOME/code/personal/dotfiles/zsh/common_env.sh" ]]; then
  COMMON_ENV="$HOME/code/personal/dotfiles/zsh/common_env.sh"
fi
if [[ -f "$COMMON_ENV" ]]; then
  source "$COMMON_ENV"
fi

# Load GTD config
GTD_CONFIG_FILE="$HOME/.gtd_config"
if [[ -f "$HOME/code/personal/dotfiles/zsh/.gtd_config" ]]; then
  GTD_CONFIG_FILE="$HOME/code/personal/dotfiles/zsh/.gtd_config"
fi

# Source config if it exists
if [[ -f "$GTD_CONFIG_FILE" ]]; then
  source "$GTD_CONFIG_FILE"
fi

# Source common GTD helpers (DRY - reuse existing helpers)
GTD_COMMON="$HOME/code/dotfiles/bin/gtd-common.sh"
if [[ ! -f "$GTD_COMMON" && -f "$HOME/code/personal/dotfiles/bin/gtd-common.sh" ]]; then
  GTD_COMMON="$HOME/code/personal/dotfiles/bin/gtd-common.sh"
fi
if [[ -f "$GTD_COMMON" ]]; then
  source "$GTD_COMMON"
else
  echo "Warning: gtd-common.sh not found. Some features may not work." >&2
fi

# GTD_BASE_DIR and INBOX_PATH are already set by init_gtd_paths in gtd-common.sh (DRY - reuse existing helper)
# Keep directory name variable for backward compatibility
GTD_INBOX_DIR="${GTD_INBOX_DIR:-0-inbox}"

# Create directories if they don't exist
mkdir -p "$INBOX_PATH"

# Get current timestamp
TIMESTAMP=$(date +"%Y%m%d%H%M%S")
TODAY=$(date +"%Y-%m-%d")
NOW=$(date +"%H:%M")
CAPTURE_START_TIME=$(date +%s)  # Track capture start time

# Determine capture type
CAPTURE_TYPE="note"
if [[ "$1" == "--type" && -n "$2" ]]; then
  CAPTURE_TYPE="$2"
  shift 2
elif [[ "$1" == "--interactive" ]]; then
  echo "Capture Type:"
  echo "1) note - Fleeting note"
  echo "2) task - Task/action item"
  echo "3) idea - Idea for later"
  echo "4) reminder - Reminder"
  echo "5) link - Link/reference"
  echo "6) meeting - Meeting note"
  echo "7) email - Email action"
  echo "8) call - Phone call"
  read -p "Select type (1-8): " type_choice
  case $type_choice in
    1) CAPTURE_TYPE="note" ;;
    2) CAPTURE_TYPE="task" ;;
    3) CAPTURE_TYPE="idea" ;;
    4) CAPTURE_TYPE="reminder" ;;
    5) CAPTURE_TYPE="link" ;;
    6) CAPTURE_TYPE="meeting" ;;
    7) CAPTURE_TYPE="email" ;;
    8) CAPTURE_TYPE="call" ;;
    *) CAPTURE_TYPE="note" ;;
  esac
  shift
fi

# Get content
if [[ -z "$1" ]]; then
  if [[ -t 0 ]]; then
    # Interactive mode
    echo "Enter your capture (press Ctrl+D when done, or Enter twice):"
    CONTENT=$(cat)
  else
    echo "Usage: gtd-capture [--type=TYPE] [--interactive] \"Your capture text\""
    exit 1
  fi
else
  CONTENT="$*"
fi

# Create filename
FILENAME="${TIMESTAMP}-${CAPTURE_TYPE}.md"
FILEPATH="${INBOX_PATH}/${FILENAME}"

# Capitalize first letter (compatible method)
CAPTURE_TYPE_TITLE=$(echo "${CAPTURE_TYPE}" | awk '{print toupper(substr($0,1,1)) tolower(substr($0,2))}')

# Create file with template
cat > "$FILEPATH" <<EOF
---
type: ${CAPTURE_TYPE}
status: unprocessed
created: ${TODAY}T${NOW}
tags: []
---

# ${CAPTURE_TYPE_TITLE}: ${CONTENT}

## Details


## Next Steps


EOF

echo "âœ“ Captured to inbox: ${FILEPATH}"
echo "  Type: ${CAPTURE_TYPE}"
echo "  Content: ${CONTENT}"

# Track capture time (time to capture = friction metric)
CAPTURE_END_TIME=$(date +%s)
CAPTURE_DURATION=$((CAPTURE_END_TIME - CAPTURE_START_TIME))
if command -v gtd-success-metrics &>/dev/null; then
  gtd-success-metrics track-capture "$CAPTURE_DURATION" 2>/dev/null || true
elif [[ -f "$HOME/code/dotfiles/bin/gtd-success-metrics" ]]; then
  "$HOME/code/dotfiles/bin/gtd-success-metrics" track-capture "$CAPTURE_DURATION" 2>/dev/null || true
fi

# Track daily usage
if command -v gtd-success-metrics &>/dev/null; then
  gtd-success-metrics track "gtd-capture" 2>/dev/null || true
elif [[ -f "$HOME/code/dotfiles/bin/gtd-success-metrics" ]]; then
  "$HOME/code/dotfiles/bin/gtd-success-metrics" track "gtd-capture" 2>/dev/null || true
fi

# Optionally open in editor
if [[ -n "$EDITOR" ]]; then
  read -p "Open in editor? (y/n) " -n 1 -r
  echo
  if [[ $REPLY =~ ^[Yy]$ ]]; then
    $EDITOR "$FILEPATH"
  fi
fi



