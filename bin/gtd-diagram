#!/bin/bash
# GTD Diagram Generator - Create Mermaid.js diagrams and mindmaps with AI

# Load config
GTD_CONFIG_FILE="$HOME/.gtd_config"
if [[ -f "$HOME/code/dotfiles/zsh/.gtd_config" ]]; then
  GTD_CONFIG_FILE="$HOME/code/dotfiles/zsh/.gtd_config"
elif [[ -f "$HOME/code/personal/dotfiles/zsh/.gtd_config" ]]; then
  GTD_CONFIG_FILE="$HOME/code/personal/dotfiles/zsh/.gtd_config"
fi

if [[ -f "$GTD_CONFIG_FILE" ]]; then
  source "$GTD_CONFIG_FILE"
fi

# Find persona helper
PERSONA_HELPER=""
POSSIBLE_PATHS=(
  "$HOME/code/dotfiles/zsh/functions/gtd_persona_helper.py"
  "$HOME/code/personal/dotfiles/zsh/functions/gtd_persona_helper.py"
)

for path in "${POSSIBLE_PATHS[@]}"; do
  if [[ -f "$path" ]]; then
    PERSONA_HELPER="$path"
    break
  fi
done

# Find python
PYTHON_CMD=""
if [[ -f "/opt/homebrew/bin/python3" ]]; then
  PYTHON_CMD="/opt/homebrew/bin/python3"
elif command -v python3 &>/dev/null; then
  PYTHON_CMD="python3"
else
  echo "âŒ python3 not found"
  exit 1
fi

# Default output directory
DIAGRAM_DIR="${GTD_BASE_DIR:-$HOME/Documents/gtd}/diagrams"
SECOND_BRAIN="${SECOND_BRAIN:-$HOME/Documents/obsidian/Second Brain}"

# Diagram types
DIAGRAM_TYPES=("flowchart" "mindmap" "sequence" "gantt" "class" "state" "er" "journey" "gitgraph" "pie" "requirement")

# Clean and validate Mermaid code
clean_mermaid_code() {
  local code="$1"
  local diagram_type="$2"
  
  # Remove any leading/trailing whitespace from each line
  code=$(echo "$code" | sed 's/^[[:space:]]*//;s/[[:space:]]*$//')
  
  # Remove malformed diagram fragments (like "graph LR fa:fa-check-->fa:fa-coffee")
  code=$(echo "$code" | grep -vE "^[[:space:]]*[a-z]+[[:space:]]+[A-Z]+[[:space:]]+fa:")
  
  # For flowcharts and graphs: fix common syntax issues
  if echo "$code" | grep -qE "^(flowchart|graph)"; then
    # Fix subgraph labels with spaces - they need quotes (if not already quoted)
    code=$(echo "$code" | sed -E 's/subgraph[[:space:]]+([^"]+[[:space:]]+[^"]+)/subgraph "\1"/g')
    
    # Fix spacing in edge definitions (B-- "label" should be B -- "label")
    code=$(echo "$code" | sed -E 's/([A-Za-z0-9]+)--([[:space:]]*"[^"]*")/\1 --\2/g')
    code=$(echo "$code" | sed -E 's/([A-Za-z0-9]+)--([[:space:]]*-->)/\1 --\2/g')
    
    # Ensure all subgraphs are properly closed
    local subgraph_count=$(echo "$code" | grep -cE "^[[:space:]]*subgraph" || echo "0")
    local end_count=$(echo "$code" | grep -cE "^[[:space:]]*end" || echo "0")
    
    # If we have subgraphs but missing ends, add them
    if [[ $subgraph_count -gt $end_count ]]; then
      local missing_ends=$((subgraph_count - end_count))
      # Add missing end statements before the last line (or at the end)
      for ((i=0; i<missing_ends; i++)); do
        code="${code}"$'\n'"    end"
      done
    fi
    
    # Remove invalid style blocks with brackets (like "style AA[System Architecture]")
    code=$(echo "$code" | grep -vE "^[[:space:]]*style[[:space:]]+[A-Za-z0-9]+\[")
    
    # Remove incomplete style blocks (lines ending with just "[")
    code=$(echo "$code" | grep -vE "^[[:space:]]*style[[:space:]]+[A-Za-z0-9]+\[[[:space:]]*$")
    
    # Remove style blocks with malformed syntax
    code=$(echo "$code" | grep -vE "^[[:space:]]*style[[:space:]]+[A-Za-z0-9]+[[:space:]]+.*#.*[^,)]$")
  fi
  
  # For mindmaps: ensure proper structure
  if echo "$code" | grep -qE "^mindmap"; then
    # Ensure root node format is correct
    code=$(echo "$code" | sed 's/^[[:space:]]*root[[:space:]]*(\(.*\))/  root((\1))/')
  fi
  
  echo "$code"
}

# Show help
show_help() {
  echo "Usage: gtd-diagram <command> [options]"
  echo ""
  echo "Commands:"
  echo "  create <type> <description>    Create a diagram (AI-generated)"
  echo "  mindmap <topic>               Create a mindmap (AI-generated)"
  echo "  flowchart <process>           Create a flowchart (AI-generated)"
  echo "  save <file>                   Save diagram to Second Brain"
  echo "  list                           List all diagrams"
  echo "  view <name>                   View a diagram"
  echo "  fix <name>                    Fix syntax errors in a diagram"
  echo ""
  echo "Diagram Types:"
  echo "  flowchart                     Flowcharts and process diagrams"
  echo "  mindmap                       Mind maps"
  echo "  sequence                      Sequence diagrams"
  echo "  gantt                         Gantt charts"
  echo "  class                         Class diagrams"
  echo "  state                         State diagrams"
  echo "  er                            Entity-relationship diagrams"
  echo "  journey                       User journey diagrams"
  echo "  gitgraph                      Git graph diagrams"
  echo "  pie                           Pie charts"
  echo "  requirement                   Requirement diagrams"
  echo ""
  echo "Examples:"
  echo "  gtd-diagram mindmap \"GTD System Overview\""
  echo "  gtd-diagram flowchart \"Wedding Planning Process\""
  echo "  gtd-diagram create sequence \"Daily Log Review Process\""
  echo "  gtd-diagram save my-diagram.md"
  echo ""
}

# Generate diagram with AI
generate_diagram() {
  local diagram_type="$1"
  shift
  local description="$*"
  
  if [[ -z "$description" ]]; then
    echo "Enter description for $diagram_type:"
    read description
  fi
  
  if [[ -z "$description" ]]; then
    echo "âŒ Description required"
    exit 1
  fi
  
  echo ""
  echo "ğŸ¨ Generating $diagram_type diagram..."
  echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
  echo ""
  
  # Create prompt for AI
  local prompt="Create a Mermaid.js ${diagram_type} diagram for: ${description}

CRITICAL SYNTAX REQUIREMENTS:
- Use ONLY valid Mermaid.js syntax for ${diagram_type}
- Node IDs must be simple alphanumeric (e.g., A, B, Node1, not 'System Architecture')
- Labels with spaces or special characters MUST be in quotes: [\"System Architecture\"]
- Do NOT use style blocks with color codes unless you know the exact syntax
- Do NOT use dashes or special characters in node IDs
- Keep node IDs short and simple (A, B, C, Node1, Node2, etc.)
- Use descriptive labels in quotes for display text
- For flowcharts: Use format like A[\"Label Text\"] or A{\"Decision\"} or A(\"Process\")
- For mindmaps: Use proper indentation (2 spaces per level)
- Format it as a code block with three backticks and mermaid at the start
- Only output the Mermaid code, no explanations or markdown formatting outside the code block

Example valid syntax:
flowchart TD
    A[\"Start\"]
    B[\"Process Step\"]
    C{\"Decision\"}
    D[\"End\"]
    A --> B
    B --> C
    C -->|Yes| D
    C -->|No| B

The diagram must be syntactically valid and ready to use in Mermaid-compatible viewers."

  # Use persona helper with a diagram-focused persona
  # We'll use "tim" (Tim Ferriss) as he's good at optimization and visualization
  # Or create a special diagram generation call
  local diagram_code
  diagram_code=$("$PYTHON_CMD" "$PERSONA_HELPER" "tim" "$prompt" "diagram_generation" 2>&1)
  
  # Extract mermaid code block if present
  # Use a variable to avoid backtick issues in grep
  local mermaid_start="mermaid"
  if echo "$diagram_code" | grep -q "$mermaid_start"; then
    # Extract content between mermaid code block markers
    diagram_code=$(echo "$diagram_code" | sed -n '/mermaid/,/```/p' | sed '1d;$d')
    # If that didn't work, try a different approach
    if [[ -z "$diagram_code" || ${#diagram_code} -lt 10 ]]; then
      # Try extracting everything after "mermaid" until next code block or end
      diagram_code=$(echo "$diagram_code" | sed 's/.*mermaid//' | sed 's/```.*//' | sed '/^$/d')
    fi
  fi
  
  # Clean and validate the extracted code
  if [[ -n "$diagram_code" && ${#diagram_code} -ge 10 ]]; then
    diagram_code=$(clean_mermaid_code "$diagram_code" "$diagram_type")
  fi
  
  # If no mermaid code found, try to extract any code block
  if [[ -z "$diagram_code" || ${#diagram_code} -lt 10 ]]; then
    echo "âš ï¸  AI response didn't contain valid Mermaid code. Generating basic structure..."
    
    # Generate basic structure based on type
    case "$diagram_type" in
      mindmap)
        diagram_code="mindmap
  root(($(echo "$description" | cut -c1-20)))
    Branch 1
      Leaf 1
      Leaf 2
    Branch 2
      Leaf 3
      Leaf 4"
        ;;
      flowchart)
        diagram_code="flowchart TD
    Start([Start: $description])
    Process1[Process Step 1]
    Process2[Process Step 2]
    Decision{Decision Point}
    End([End])
    
    Start --> Process1
    Process1 --> Process2
    Process2 --> Decision
    Decision -->|Yes| End
    Decision -->|No| Process1"
        ;;
      sequence)
        diagram_code="sequenceDiagram
    participant A as Actor
    participant B as System
    
    A->>B: Request
    B-->>A: Response"
        ;;
      *)
        diagram_code="graph TD
    A[$description]
    B[Related Item 1]
    C[Related Item 2]
    A --> B
    A --> C"
        ;;
    esac
  fi
  
  # Create filename
  local safe_name=$(echo "$description" | tr '[:upper:]' '[:lower:]' | sed 's/[^a-z0-9]/-/g' | sed 's/--*/-/g' | sed 's/^-\|-$//g')
  local filename="${safe_name}.md"
  local filepath="${DIAGRAM_DIR}/${filename}"
  
  # Create directory if needed
  mkdir -p "$DIAGRAM_DIR"
  
  # Create markdown file with diagram
  # Use printf to avoid issues with special characters
  {
    echo "# ${description}"
    echo ""
    echo '```mermaid'
    echo "${diagram_code}"
    echo '```'
    echo ""
    echo "## Notes"
    echo "<!-- Add notes about this diagram -->"
    echo ""
    echo "## Related"
    echo "<!-- Link to related items -->"
    echo ""
    echo "Created: $(date +"%Y-%m-%d %H:%M")"
    echo "Type: ${diagram_type}"
  } > "$filepath"
  
  echo "âœ“ Diagram created: $filepath"
  echo ""
  echo "ğŸ“Š Preview:"
  echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
  echo ""
  cat "$filepath"
  echo ""
  echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
  echo ""
  echo "ğŸ’¡ To view in Obsidian or other Mermaid-compatible viewer, open:"
  echo "   $filepath"
  echo ""
  echo "ğŸ’¡ To save to Second Brain:"
  echo "   gtd-diagram save ${filename}"
  echo ""
}

# Create mindmap
create_mindmap() {
  local topic="$*"
  if [[ -z "$topic" ]]; then
    echo "Enter mindmap topic:"
    read topic
  fi
  generate_diagram "mindmap" "$topic"
}

# Create flowchart
create_flowchart() {
  local process="$*"
  if [[ -z "$process" ]]; then
    echo "Enter process description:"
    read process
  fi
  generate_diagram "flowchart" "$process"
}

# Save diagram to Second Brain
save_diagram() {
  local filename="$1"
  
  if [[ -z "$filename" ]]; then
    echo "Available diagrams:"
    ls -1 "$DIAGRAM_DIR"/*.md 2>/dev/null | xargs -n1 basename
    echo ""
    echo "Enter diagram filename to save:"
    read filename
  fi
  
  local source_file="${DIAGRAM_DIR}/${filename}"
  
  if [[ ! -f "$source_file" ]]; then
    echo "âŒ Diagram not found: $source_file"
    exit 1
  fi
  
  # Determine where to save in Second Brain
  local brain_dir="${SECOND_BRAIN}/Resources"
  if [[ ! -d "$brain_dir" ]]; then
    brain_dir="${SECOND_BRAIN}"
  fi
  
  local target_file="${brain_dir}/${filename}"
  
  # Copy file
  cp "$source_file" "$target_file"
  
  echo "âœ“ Diagram saved to Second Brain: $target_file"
  echo ""
  echo "ğŸ’¡ The diagram is now in your Second Brain and can be viewed in Obsidian"
  echo ""
}

# List diagrams
list_diagrams() {
  echo ""
  echo "ğŸ“Š Your Diagrams"
  echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
  echo ""
  
  if [[ ! -d "$DIAGRAM_DIR" ]] || [[ -z "$(ls -A "$DIAGRAM_DIR"/*.md 2>/dev/null)" ]]; then
    echo "No diagrams found. Create one with:"
    echo "  gtd-diagram mindmap \"Your Topic\""
    echo ""
    exit 0
  fi
  
  local count=1
  for file in "$DIAGRAM_DIR"/*.md; do
    if [[ -f "$file" ]]; then
      local basename=$(basename "$file" .md)
      local title=$(head -1 "$file" | sed 's/^# //')
      local type=$(grep "^Type:" "$file" 2>/dev/null | cut -d' ' -f2)
      local created=$(grep "^Created:" "$file" 2>/dev/null | cut -d' ' -f2-)
      
      echo "$count) $title"
      echo "   Type: ${type:-unknown}"
      echo "   File: $basename.md"
      if [[ -n "$created" ]]; then
        echo "   Created: $created"
      fi
      echo ""
      ((count++))
    fi
  done
}

# View diagram
view_diagram() {
  local name="$1"
  
  if [[ -z "$name" ]]; then
    echo "Available diagrams:"
    list_diagrams
    echo ""
    echo "Enter diagram name to view:"
    read name
  fi
  
  # Remove .md extension if present
  name="${name%.md}"
  local filepath="${DIAGRAM_DIR}/${name}.md"
  
  if [[ ! -f "$filepath" ]]; then
    echo "âŒ Diagram not found: $filepath"
    exit 1
  fi
  
  echo ""
  echo "ğŸ“Š $name"
  echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
  echo ""
  cat "$filepath"
  echo ""
  echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
  echo ""
  echo "ğŸ’¡ To view rendered diagram, open in Obsidian or Mermaid-compatible viewer"
  echo ""
}

# Fix an existing diagram
fix_diagram() {
  local name="$1"
  
  if [[ -z "$name" ]]; then
    echo "Available diagrams:"
    list_diagrams
    echo ""
    echo "Enter diagram name to fix:"
    read name
  fi
  
  # Remove .md extension if present
  name="${name%.md}"
  local filepath="${DIAGRAM_DIR}/${name}.md"
  
  if [[ ! -f "$filepath" ]]; then
    echo "âŒ Diagram not found: $filepath"
    exit 1
  fi
  
  echo ""
  echo "ğŸ”§ Fixing diagram: $name"
  echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
  echo ""
  
  # Extract ALL mermaid code blocks (there might be multiple, including malformed ones)
  local all_blocks
  all_blocks=$(grep -n '```mermaid' "$filepath" | head -1 | cut -d: -f1)
  
  if [[ -z "$all_blocks" ]]; then
    echo "âŒ Could not find Mermaid code block in file"
    exit 1
  fi
  
  # Extract ALL mermaid code blocks and get the last (most complete) one
  # This handles cases where there are multiple blocks (including malformed ones)
  local mermaid_code=""
  local in_block=false
  local current_block=""
  local block_count=0
  
  while IFS= read -r line; do
    if [[ "$line" =~ ^\`\`\`mermaid ]]; then
      if [[ -n "$current_block" ]]; then
        # Save previous block
        mermaid_code="$current_block"
        ((block_count++))
      fi
      current_block=""
      in_block=true
    elif [[ "$line" =~ ^\`\`\` ]] && [[ "$in_block" == true ]]; then
      if [[ -n "$current_block" ]]; then
        # Save this block
        mermaid_code="$current_block"
        ((block_count++))
      fi
      current_block=""
      in_block=false
    elif [[ "$in_block" == true ]]; then
      current_block="${current_block}${current_block:+$'\n'}${line}"
    fi
  done < "$filepath"
  
  # If we're still in a block at the end, use it
  if [[ -n "$current_block" ]]; then
    mermaid_code="$current_block"
  fi
  
  # If that didn't work, try the simpler sed approach
  if [[ -z "$mermaid_code" || ${#mermaid_code} -lt 10 ]]; then
    # Get all blocks and take the last one
    mermaid_code=$(awk '
      /```mermaid/ { 
        in_block=1
        code=""
        next
      }
      /```/ && in_block {
        if (code) {
          blocks[++block_num] = code
        }
        code=""
        in_block=0
        next
      }
      in_block {
        code = code (code ? "\n" : "") $0
      }
      END {
        if (code) blocks[++block_num] = code
        if (block_num > 0) print blocks[block_num]
      }
    ' "$filepath")
  fi
  
  # Remove any malformed fragments from the code
  mermaid_code=$(echo "$mermaid_code" | grep -vE "^[[:space:]]*[a-z]+[[:space:]]+[A-Z]+[[:space:]]+fa:")
  
  if [[ -z "$mermaid_code" || ${#mermaid_code} -lt 10 ]]; then
    echo "âŒ Could not extract valid Mermaid code from file"
    exit 1
  fi
  
  # Detect diagram type from actual content (not metadata, which might be wrong)
  local diagram_type
  if echo "$mermaid_code" | grep -qE "^mindmap"; then
    diagram_type="mindmap"
  elif echo "$mermaid_code" | grep -qE "^(flowchart|graph)"; then
    diagram_type="flowchart"
  else
    # Fall back to metadata if content detection fails
    diagram_type=$(grep "^Type:" "$filepath" 2>/dev/null | cut -d' ' -f2)
    diagram_type="${diagram_type:-flowchart}"  # default to flowchart
  fi
  
  # Clean the code
  local cleaned_code
  cleaned_code=$(clean_mermaid_code "$mermaid_code" "$diagram_type")
  
  # Create backup
  cp "$filepath" "${filepath}.bak"
  
  # Rebuild the file
  local title=$(head -1 "$filepath" | sed 's/^# //')
  {
    echo "# ${title}"
    echo ""
    echo '```mermaid'
    echo "${cleaned_code}"
    echo '```'
    echo ""
    echo "## Notes"
    grep -A 100 "^## Notes" "$filepath" 2>/dev/null | tail -n +2 | head -n -1 || echo "<!-- Add notes about this diagram -->"
    echo ""
    echo "## Related"
    grep -A 100 "^## Related" "$filepath" 2>/dev/null | tail -n +2 | head -n -1 || echo "<!-- Link to related items -->"
    echo ""
    echo "Created: $(grep "^Created:" "$filepath" 2>/dev/null | cut -d' ' -f2- || date +"%Y-%m-%d %H:%M")"
    echo "Type: ${diagram_type}"
    echo "Fixed: $(date +"%Y-%m-%d %H:%M")"
  } > "$filepath"
  
  echo "âœ“ Diagram fixed! Backup saved to: ${filepath}.bak"
  echo ""
  echo "ğŸ“Š Fixed diagram:"
  echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
  echo ""
  cat "$filepath"
  echo ""
  echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
  echo ""
  echo "ğŸ’¡ Try viewing it again. If it still has errors, you may need to manually edit it."
  echo ""
}

# Main
main() {
  case "$1" in
    create)
      shift
      local type="$1"
      shift
      if [[ -z "$type" ]]; then
        echo "Diagram type required"
        echo "Types: ${DIAGRAM_TYPES[*]}"
        exit 1
      fi
      generate_diagram "$type" "$@"
      ;;
    mindmap)
      shift
      create_mindmap "$@"
      ;;
    flowchart)
      shift
      create_flowchart "$@"
      ;;
    save)
      shift
      save_diagram "$@"
      ;;
    list)
      list_diagrams
      ;;
           view)
             shift
             view_diagram "$@"
             ;;
           fix)
             shift
             fix_diagram "$@"
             ;;
           --help|-h|"")
             show_help
             exit 0
             ;;
           *)
             echo "Unknown command: $1"
             echo "Run 'gtd-diagram --help' for usage"
             exit 1
             ;;
         esac
       }
       
       main "$@"

