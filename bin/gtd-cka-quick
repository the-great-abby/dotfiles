#!/bin/bash
# CKA Quick Study - Low-energy, fun micro-learning activities
# Designed to reduce the "lift" of starting to study

# Source common environment (PATH setup)
COMMON_ENV="$HOME/code/dotfiles/zsh/common_env.sh"
if [[ ! -f "$COMMON_ENV" && -f "$HOME/code/personal/dotfiles/zsh/common_env.sh" ]]; then
  COMMON_ENV="$HOME/code/personal/dotfiles/zsh/common_env.sh"
fi
if [[ -f "$COMMON_ENV" ]]; then
  source "$COMMON_ENV"
fi


# Load GTD config
GTD_CONFIG_FILE="$HOME/.gtd_config"
if [[ -f "$HOME/code/dotfiles/zsh/.gtd_config" ]]; then
  GTD_CONFIG_FILE="$HOME/code/dotfiles/zsh/.gtd_config"
elif [[ -f "$HOME/code/personal/dotfiles/zsh/.gtd_config" ]]; then
  GTD_CONFIG_FILE="$HOME/code/personal/dotfiles/zsh/.gtd_config"
fi

if [[ -f "$GTD_CONFIG_FILE" ]]; then
  source "$GTD_CONFIG_FILE"
fi

GTD_BASE_DIR="${GTD_BASE_DIR:-$HOME/Documents/gtd}"
STUDY_DIR="${GTD_BASE_DIR}/study"
K8S_STUDY_DIR="${STUDY_DIR}/kubernetes-cka"

# Colors
CYAN='\033[0;36m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
BLUE='\033[0;34m'
MAGENTA='\033[0;35m'
BOLD='\033[1m'
NC='\033[0m'

# Get date command
get_date_cmd() {
  if [[ -x "/usr/bin/date" ]]; then
    echo "/usr/bin/date"
  elif [[ -x "/bin/date" ]]; then
    echo "/bin/date"
  else
    echo "date"
  fi
}

DATE_CMD=$(get_date_cmd)

# Log to daily log
log_to_daily() {
  local message="$1"
  
  # Try multiple methods to log
  if command -v gtd-daily-log &>/dev/null; then
    gtd-daily-log "$message" 2>/dev/null || true
  elif [[ -f "$HOME/code/dotfiles/bin/gtd-daily-log" ]]; then
    "$HOME/code/dotfiles/bin/gtd-daily-log" "$message" 2>/dev/null || true
  elif [[ -f "$HOME/code/personal/dotfiles/bin/gtd-daily-log" ]]; then
    "$HOME/code/personal/dotfiles/bin/gtd-daily-log" "$message" 2>/dev/null || true
  elif command -v addInfoToDailyLog &>/dev/null || type addInfoToDailyLog &>/dev/null 2>/dev/null; then
    addInfoToDailyLog "$message" 2>/dev/null || true
  fi
}

# Log habit completion (if CKA study habit exists)
log_habit_if_exists() {
  local habit_name="CKA Study"
  local habit_slug=$(echo "$habit_name" | tr ' ' '-' | tr '[:upper:]' '[:lower:]' | sed 's/[^a-z0-9-]//g')
  local habits_path="${GTD_BASE_DIR}/habits"
  local habit_file="${habits_path}/${habit_slug}.md"
  
  # Check if habit exists and log it
  if [[ -f "$habit_file" ]] && command -v gtd-habit &>/dev/null; then
    gtd-habit log "$habit_name" > /dev/null 2>&1 || true
  fi
}

# Command of the day
get_command_of_the_day() {
  local today=$($DATE_CMD +"%Y-%m-%d")
  local commands_file="${K8S_STUDY_DIR}/command-of-the-day.json"
  
  # Initialize if needed
  if [[ ! -f "$commands_file" ]]; then
    mkdir -p "$K8S_STUDY_DIR"
    cat > "$commands_file" <<EOF
{
  "last_date": null,
  "last_command": null,
  "commands": [
    "kubectl get pods",
    "kubectl get pods -A",
    "kubectl describe pod",
    "kubectl logs",
    "kubectl exec -it",
    "kubectl get deployments",
    "kubectl scale deployment",
    "kubectl rollout status",
    "kubectl get services",
    "kubectl expose deployment",
    "kubectl get configmaps",
    "kubectl create configmap",
    "kubectl get secrets",
    "kubectl create secret",
    "kubectl get pv",
    "kubectl get pvc",
    "kubectl get events",
    "kubectl top pods",
    "kubectl top nodes"
  ]
}
EOF
  fi
  
  local data=$(cat "$commands_file")
  local last_date=$(echo "$data" | grep -o '"last_date": "[^"]*"' | cut -d'"' -f4)
  local last_command=$(echo "$data" | grep -o '"last_command": "[^"]*"' | cut -d'"' -f4)
  
  if [[ "$last_date" != "$today" ]]; then
    # Get all commands
    local commands=$(echo "$data" | grep -o '"commands": \[[^]]*\]' | sed 's/"commands": \[//' | sed 's/\]//')
    local cmd_array=()
    while IFS= read -r line; do
      [[ -n "$line" ]] && cmd_array+=("$line")
    done <<< "$(echo "$commands" | tr ',' '\n' | sed 's/"//g' | sed 's/^[[:space:]]*//' | sed 's/[[:space:]]*$//')"
    
    # Pick random command (but not the same as yesterday)
    local new_command=""
    local attempts=0
    while [[ -z "$new_command" && $attempts -lt 10 ]]; do
      local idx=$((RANDOM % ${#cmd_array[@]}))
      new_command="${cmd_array[$idx]}"
      if [[ "$new_command" == "$last_command" && ${#cmd_array[@]} -gt 1 ]]; then
        new_command=""
        ((attempts++))
      fi
    done
    
    # Update file
    data=$(echo "$data" | sed "s/\"last_date\": \"[^\"]*\"/\"last_date\": \"$today\"/")
    data=$(echo "$data" | sed "s/\"last_command\": \"[^\"]*\"/\"last_command\": \"$new_command\"/")
    echo "$data" > "$commands_file"
    
    echo "$new_command"
  else
    echo "$last_command"
  fi
}

# Quick flash card
show_flashcard() {
  local topic="$1"
  
  # Flash card database
  declare -A flashcards
  
  flashcards[pods]="Q: What is the smallest deployable unit in Kubernetes?
A: A Pod. Pods contain one or more containers and share storage and network.

Q: How do you view logs from a pod?
A: kubectl logs <pod-name> or kubectl logs -f <pod-name> for follow mode.

Q: How do you execute a command in a running pod?
A: kubectl exec -it <pod-name> -- /bin/sh (or /bin/bash)"

  flashcards[deployments]="Q: What manages replicated applications in Kubernetes?
A: Deployments. They provide declarative updates and rollback capabilities.

Q: How do you scale a deployment?
A: kubectl scale deployment <name> --replicas=<number>

Q: How do you check rollout status?
A: kubectl rollout status deployment/<name>"

  flashcards[services]="Q: What exposes applications to network traffic?
A: Services. They provide stable IP and DNS name.

Q: What are the three main service types?
A: ClusterIP (internal), NodePort (external via node IP), LoadBalancer (cloud LB).

Q: How do you expose a deployment?
A: kubectl expose deployment <name> --port=<port> --type=<type>"

  flashcards[troubleshooting]="Q: How do you see recent events?
A: kubectl get events --sort-by='.lastTimestamp'

Q: How do you check pod resource usage?
A: kubectl top pods (requires metrics-server)

Q: How do you see detailed pod information?
A: kubectl describe pod <name>"

  local card="${flashcards[$topic]}"
  
  if [[ -z "$card" ]]; then
    # Default card
    card="Q: What command lists all pods in all namespaces?
A: kubectl get pods -A

Q: What is Kubernetes?
A: An open-source container orchestration platform for automating deployment, scaling, and management of containerized applications."
  fi
  
  clear
  echo -e "${BOLD}${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
  echo -e "${BOLD}${CYAN}ğŸ“‡ Quick Flash Card${NC}"
  echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
  echo ""
  echo "$card" | while IFS= read -r line; do
    if [[ "$line" == Q:* ]]; then
      echo -e "${BOLD}${YELLOW}$line${NC}"
    elif [[ "$line" == A:* ]]; then
      echo -e "${GREEN}$line${NC}"
      echo ""
    else
      echo "$line"
    fi
  done
  echo ""
  read -p "Press Enter to continue..."
  
  # Log to daily log
  log_to_daily "CKA Quick: Reviewed flash card - $topic"
  
  # Log habit if exists
  log_habit_if_exists
}

# Quick quiz (1 question)
quick_quiz() {
  local questions=(
    "What is the smallest deployable unit in Kubernetes?|Pod|Deployment|Service|Node"
    "Which command lists all pods?|kubectl get pods|kubectl list pods|kubectl show pods|kubectl pods"
    "What manages replicated applications?|Deployment|Pod|Service|ConfigMap"
    "Which service type is only accessible within the cluster?|ClusterIP|NodePort|LoadBalancer|Ingress"
    "How do you scale a deployment?|kubectl scale deployment|kubectl resize deployment|kubectl grow deployment|kubectl expand deployment"
    "What stores configuration data?|ConfigMap|Secret|Volume|Pod"
    "What stores sensitive data?|Secret|ConfigMap|Volume|Pod"
    "Which command shows pod logs?|kubectl logs|kubectl show logs|kubectl view logs|kubectl get logs"
  )
  
  local q_idx=$((RANDOM % ${#questions[@]}))
  local question_data="${questions[$q_idx]}"
  
  IFS='|' read -r question correct ans2 ans3 ans4 <<< "$question_data"
  
  # Shuffle answers
  local answers=("$correct" "$ans2" "$ans3" "$ans4")
  local shuffled=()
  local used=()
  
  while [[ ${#shuffled[@]} -lt 4 ]]; do
    local idx=$((RANDOM % 4))
    if [[ -z "${used[$idx]}" ]]; then
      shuffled+=("${answers[$idx]}")
      used[$idx]=1
    fi
  done
  
  clear
  echo -e "${BOLD}${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
  echo -e "${BOLD}${CYAN}â“ Quick Quiz${NC}"
  echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
  echo ""
  echo -e "${BOLD}$question${NC}"
  echo ""
  
  for i in {0..3}; do
    local num=$((i + 1))
    if [[ "${shuffled[$i]}" == "$correct" ]]; then
      echo -e "${GREEN}${num})${NC} ${shuffled[$i]}"
    else
      echo -e "  ${num}) ${shuffled[$i]}"
    fi
  done
  
  echo ""
  echo -n "Your answer (1-4, or 's' to skip): "
  read answer
  
  if [[ "$answer" == "s" || "$answer" == "S" ]]; then
    return 0
  fi
  
  local selected_idx=$((answer - 1))
  if [[ "${shuffled[$selected_idx]}" == "$correct" ]]; then
    echo ""
    echo -e "${GREEN}âœ“ Correct!${NC}"
    
    # Award XP
    if command -v gtd-cka-gamification &>/dev/null; then
      gtd-cka-gamification award 5 "Quick quiz correct" > /dev/null 2>&1
    fi
    
    # Log to daily log
    log_to_daily "CKA Quick: Completed quiz - Correct"
    
    # Log habit if exists
    log_habit_if_exists
    
    echo ""
    read -p "Press Enter to continue..."
    return 0
  else
    echo ""
    echo -e "${RED}âœ— Incorrect${NC}"
    echo -e "Correct answer: ${GREEN}$correct${NC}"
    
    # Log to daily log (even incorrect attempts count!)
    log_to_daily "CKA Quick: Completed quiz - Learned: $correct"
    
    echo ""
    read -p "Press Enter to continue..."
    return 1
  fi
}

# Command of the day
show_command_of_the_day() {
  local cmd=$(get_command_of_the_day)
  
  clear
  echo -e "${BOLD}${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
  echo -e "${BOLD}${CYAN}â­ Command of the Day${NC}"
  echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
  echo ""
  echo -e "${BOLD}Today's command to master:${NC}"
  echo ""
  echo -e "${GREEN}${BOLD}$cmd${NC}"
  echo ""
  echo -e "${YELLOW}ğŸ’¡ Practice this command:${NC}"
  echo "   â€¢ Type it 5 times in the typing simulator"
  echo "   â€¢ Use it in a real cluster if you have one"
  echo "   â€¢ Understand what it does"
  echo ""
  echo -e "${BLUE}ğŸ¯ Master it today for bonus XP!${NC}"
  echo ""
  read -p "Press Enter to continue..."
  
  # Award XP for viewing
  if command -v gtd-cka-gamification &>/dev/null; then
    gtd-cka-gamification award 2 "Viewed command of the day" > /dev/null 2>&1
  fi
  
  # Log to daily log
  log_to_daily "CKA Quick: Viewed command of the day - $cmd"
  
  # Log habit if exists
  log_habit_if_exists
}

# Show quick tip

# Quick tip
show_quick_tip() {
  local tips=(
    "ğŸ’¡ Use 'kubectl get pods -A' to see pods in all namespaces"
    "ğŸ’¡ Use 'kubectl get events --sort-by=\".lastTimestamp\"' to see recent events"
    "ğŸ’¡ Use 'kubectl describe pod <name>' for detailed pod information"
    "ğŸ’¡ Use 'kubectl logs -f <pod>' to follow logs in real-time"
    "ğŸ’¡ Use 'kubectl exec -it <pod> -- /bin/sh' to debug inside a pod"
    "ğŸ’¡ Use 'kubectl get pods -o wide' to see which node pods are on"
    "ğŸ’¡ Use 'kubectl scale deployment <name> --replicas=N' to scale quickly"
    "ğŸ’¡ Use 'kubectl rollout undo deployment/<name>' to rollback"
    "ğŸ’¡ Use 'kubectl get all' to see pods, services, and deployments"
    "ğŸ’¡ Use 'kubectl top pods' to see resource usage (needs metrics-server)"
  )
  
  local tip_idx=$((RANDOM % ${#tips[@]}))
  local tip="${tips[$tip_idx]}"
  
  clear
  echo -e "${BOLD}${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
  echo -e "${BOLD}${CYAN}ğŸ’¡ Quick Tip${NC}"
  echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
  echo ""
  echo -e "$tip"
  echo ""
  echo ""
  read -p "Press Enter to continue..."
  
  # Log to daily log
  log_to_daily "CKA Quick: Learned tip - ${tip:0:50}..."
  
  # Log habit if exists
  log_habit_if_exists
}

# Study streak check
check_streak() {
  if command -v gtd-cka-gamification &>/dev/null; then
    local data=$(gtd-cka-gamification streak 2>/dev/null)
    local streak=$(echo "$data" | grep -o '[0-9]*' | head -1)
    
    clear
    echo -e "${BOLD}${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo -e "${BOLD}${CYAN}ğŸ”¥ Study Streak${NC}"
    echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo ""
    
    if [[ -n "$streak" && "$streak" -gt 0 ]]; then
      echo -e "${BOLD}Current Streak: ${YELLOW}${streak} day(s)${NC}"
      echo ""
      
      if [[ $streak -ge 30 ]]; then
        echo -e "${GREEN}ğŸ‰ INCREDIBLE! You're a study champion!${NC}"
      elif [[ $streak -ge 7 ]]; then
        echo -e "${GREEN}ğŸ‰ Amazing! You're building a real habit!${NC}"
      elif [[ $streak -ge 3 ]]; then
        echo -e "${YELLOW}ğŸ‘ Great start! Keep it going!${NC}"
      else
        echo -e "${BLUE}ğŸ’ª Building momentum!${NC}"
      fi
      
      echo ""
      echo -e "${YELLOW}Don't break the chain! Study something today!${NC}"
    else
      echo -e "${BOLD}No active streak${NC}"
      echo ""
      echo -e "${BLUE}Start your study streak today!${NC}"
      echo -e "Even 5 minutes counts!"
    fi
    
    echo ""
    read -p "Press Enter to continue..."
  fi
}

# Main menu
show_menu() {
  clear
  echo -e "${BOLD}${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
  echo -e "${BOLD}${CYAN}âš¡ CKA Quick Study - Low Energy, High Fun${NC}"
  echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
  echo ""
  echo -e "${BOLD}Quick activities (1-5 minutes):${NC}"
  echo ""
  echo -e "${GREEN}1)${NC} â­ Command of the Day (see today's command)"
  echo -e "${GREEN}2)${NC} â“ Quick Quiz (1 question)"
  echo -e "${GREEN}3)${NC} ğŸ“‡ Flash Card (quick review)"
  echo -e "${GREEN}4)${NC} ğŸ’¡ Quick Tip (learn something new)"
  echo -e "${GREEN}5)${NC} ğŸ”¥ Check Streak (see your progress)"
  echo ""
  echo -e "${BOLD}Low-energy study:${NC}"
  echo ""
  echo -e "${BLUE}6)${NC} ğŸ“– Read 1 lesson (5-10 min)"
  echo -e "${BLUE}7)${NC} âŒ¨ï¸  Type 3 commands (practice)"
  echo -e "${BLUE}8)${NC} ğŸ“ Review notes (5 min)"
  echo ""
  echo -e "${YELLOW}0)${NC} Exit"
  echo ""
  echo -n "Choose: "
}

# Main function
main() {
  while true; do
    show_menu
    read choice
    
    case "$choice" in
      1)
        show_command_of_the_day
        ;;
      2)
        quick_quiz
        ;;
      3)
        echo ""
        echo "Flash card topics:"
        echo "  1) Pods"
        echo "  2) Deployments"
        echo "  3) Services"
        echo "  4) Troubleshooting"
        echo ""
        echo -n "Choose topic (1-4): "
        read topic_choice
        case "$topic_choice" in
          1) show_flashcard "pods" ;;
          2) show_flashcard "deployments" ;;
          3) show_flashcard "services" ;;
          4) show_flashcard "troubleshooting" ;;
          *) show_flashcard "pods" ;;
        esac
        ;;
      4)
        show_quick_tip
        ;;
      5)
        check_streak
        ;;
      6)
        if command -v gtd-learn-kubernetes &>/dev/null; then
          # Pick random topic
          local topics=("basics" "pods" "deployments" "services" "configmaps" "storage" "networking" "troubleshooting")
          local topic=${topics[$RANDOM % ${#topics[@]}]}
          echo ""
          echo "Starting quick lesson on: $topic"
          sleep 1
          gtd-learn-kubernetes "$topic"
        else
          echo "Learning system not found"
          read -p "Press Enter to continue..."
        fi
        ;;
      7)
        if command -v gtd-cka-typing &>/dev/null; then
          echo ""
          echo "Starting quick typing practice (3 commands)..."
          sleep 1
          # This would need to be modified to accept count, but for now just start it
          gtd-cka-typing
          
          # Log to daily log
          log_to_daily "CKA Quick: Typing practice session"
          log_habit_if_exists
        else
          echo "Typing simulator not found"
          read -p "Press Enter to continue..."
        fi
        ;;
      8)
        echo ""
        echo "ğŸ“ Recent study notes:"
        local notes_dir="${K8S_STUDY_DIR}/notes"
        if [[ -d "$notes_dir" ]]; then
          find "$notes_dir" -name "*.md" -type f | sort -r | head -5 | while read note; do
            local note_name=$(basename "$note" .md)
            echo "   â€¢ $note_name"
          done
          echo ""
          echo -n "Open a note? (y/n): "
          read open_choice
          if [[ "$open_choice" == "y" || "$open_choice" == "Y" ]]; then
            echo -n "Note name (or Enter for most recent): "
            read note_name
            if [[ -z "$note_name" ]]; then
              local latest=$(find "$notes_dir" -name "*.md" -type f | sort -r | head -1)
              if [[ -n "$latest" ]]; then
                ${EDITOR:-cat} "$latest"
              fi
            else
              local note_file=$(find "$notes_dir" -name "*${note_name}*" -type f | head -1)
              if [[ -n "$note_file" ]]; then
                ${EDITOR:-cat} "$note_file"
              fi
            fi
          fi
        else
          echo "   No notes yet. Start learning to create notes!"
        fi
        echo ""
        read -p "Press Enter to continue..."
        ;;
      0)
        echo ""
        echo "Keep learning! Every little bit helps! âš¡"
        exit 0
        ;;
      *)
        echo "Invalid choice. Press Enter..."
        read
        ;;
    esac
  done
}

main "$@"

