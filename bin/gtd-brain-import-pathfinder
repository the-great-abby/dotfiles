#!/bin/bash
# Import Pathfinder Kingmaker session write-ups into Second Brain
# Converts .txt session files to markdown and integrates with MOC and Zettelkasten

# Source common environment
COMMON_ENV="$HOME/code/dotfiles/zsh/common_env.sh"
if [[ ! -f "$COMMON_ENV" && -f "$HOME/code/personal/dotfiles/zsh/common_env.sh" ]]; then
  COMMON_ENV="$HOME/code/personal/dotfiles/zsh/common_env.sh"
fi
if [[ -f "$COMMON_ENV" ]]; then
  source "$COMMON_ENV"
fi

# Load GTD config
GTD_CONFIG_FILE="$HOME/.gtd_config"
if [[ -f "$HOME/code/dotfiles/zsh/.gtd_config" ]]; then
  GTD_CONFIG_FILE="$HOME/code/dotfiles/zsh/.gtd_config"
elif [[ -f "$HOME/code/personal/dotfiles/zsh/.gtd_config" ]]; then
  GTD_CONFIG_FILE="$HOME/code/personal/dotfiles/zsh/.gtd_config"
fi

if [[ -f "$GTD_CONFIG_FILE" ]]; then
  source "$GTD_CONFIG_FILE"
fi

# Default values
SECOND_BRAIN="${SECOND_BRAIN:-$HOME/Documents/obsidian/Second Brain}"
PATHFINDER_SOURCE_DIR="${PATHFINDER_SOURCE_DIR:-$HOME/Documents/pathfinder - kingmaker}"
PATHFINDER_TARGET_DIR="${SECOND_BRAIN}/Resources/Reference/Pathfinder Kingmaker"
MOC_DIR="${SECOND_BRAIN}/MOCs"

# Colors
CYAN='\033[0;36m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BOLD='\033[1m'
NC='\033[0m'

# Get date command
get_date_cmd() {
  if [[ -x "/usr/bin/date" ]]; then
    echo "/usr/bin/date"
  elif [[ -x "/bin/date" ]]; then
    echo "/bin/date"
  else
    echo "date"
  fi
}

DATE_CMD=$(get_date_cmd)

# Extract session number from filename
extract_session_number() {
  local filename="$1"
  # Try to extract session number from various patterns
  local session_num=$(echo "$filename" | grep -oE "session[[:space:]]*([0-9]+)" | grep -oE "[0-9]+" | head -1)
  
  # If no session number found, try date pattern
  if [[ -z "$session_num" ]]; then
    local date_match=$(echo "$filename" | grep -oE "[0-9]{1,2}-[0-9]{1,2}-[0-9]{2,4}" | head -1)
    if [[ -n "$date_match" ]]; then
      # Use date as identifier
      session_num="date-${date_match}"
    fi
  fi
  
  echo "$session_num"
}

# Extract date from content
extract_date() {
  local content="$1"
  # Look for date patterns at the start of content
  local date_match=$(echo "$content" | head -5 | grep -oE "[0-9]{1,2}/[0-9]{1,2}/[0-9]{2,4}" | head -1)
  if [[ -z "$date_match" ]]; then
    date_match=$(echo "$content" | head -5 | grep -oE "[A-Z][a-z]+[[:space:]]+[0-9]{1,2},[[:space:]]+[0-9]{4}" | head -1)
  fi
  echo "$date_match"
}

# Convert txt file to markdown
convert_to_markdown() {
  local source_file="$1"
  local target_file="$2"
  local session_num="$3"
  local session_date="$4"
  
  local title="Session ${session_num}"
  if [[ -n "$session_date" ]]; then
    title="${title} - ${session_date}"
  fi
  
  local today=$($DATE_CMD +"%Y-%m-%d")
  local timestamp=$($DATE_CMD +"%Y-%m-%d %H:%M")
  
  # Read content from source file
  local content=$(cat "$source_file" 2>/dev/null)
  
  # Create markdown file
  cat > "$target_file" <<EOF
# ${title}

**Session Number:** ${session_num}  
**Date:** ${session_date:-Unknown}  
**Imported:** ${timestamp}

## Session Summary

${content}

## Key Events

<!-- Add key events here -->

## Important NPCs

<!-- Add NPCs mentioned in this session -->

## Locations Visited

<!-- Add locations visited -->

## Loot & Rewards

<!-- Add loot and rewards -->

## Notes & Observations

<!-- Add your observations and notes -->

## Links

- Related sessions: 
- Related locations: 
- Related NPCs: 

## Tags

#pathfinder-kingmaker #session-${session_num} #rpg

---

*Imported from: $(basename "$source_file")*
EOF

  echo "$target_file"
}

# Import a single session file
import_session() {
  local source_file="$1"
  local dry_run="${2:-false}"
  local force="${3:-false}"
  
  if [[ ! -f "$source_file" ]]; then
    echo "❌ File not found: $source_file"
    return 1
  fi
  
  local filename=$(basename "$source_file")
  local session_num=$(extract_session_number "$filename")
  
  if [[ -z "$session_num" ]]; then
    # Use filename as fallback
    session_num=$(echo "$filename" | sed 's/[^a-z0-9]/-/g' | tr '[:upper:]' '[:lower:]')
  fi
  
  # Read first few lines to extract date
  local content=$(head -10 "$source_file" 2>/dev/null)
  local session_date=$(extract_date "$content")
  
  # Create target filename
  local target_filename="Session ${session_num}.md"
  if [[ -n "$session_date" ]]; then
    # Sanitize date for filename
    local date_safe=$(echo "$session_date" | sed 's/[^0-9]/-/g')
    target_filename="Session ${session_num} - ${date_safe}.md"
  fi
  
  local target_file="${PATHFINDER_TARGET_DIR}/${target_filename}"
  
  if [[ "$dry_run" == "true" ]]; then
    local status="new"
    if [[ -f "$target_file" ]]; then
      status="exists (would skip)"
    fi
    echo "Would import: $filename → $target_filename [$status]"
    echo "  Session: $session_num"
    echo "  Date: ${session_date:-Unknown}"
    if [[ -f "$target_file" ]]; then
      return 2  # Return code 2 = already exists
    fi
    return 0
  fi
  
  # Create target directory
  mkdir -p "$PATHFINDER_TARGET_DIR"
  
  # Check if file already exists
  if [[ -f "$target_file" && "$force" != "true" ]]; then
    return 2  # Return code 2 = already exists (skip)
  fi
  
  # If force and file exists, note that we're overwriting
  if [[ -f "$target_file" && "$force" == "true" ]]; then
    echo "⚠️  Overwriting existing file: $target_filename"
  fi
  
  # Convert to markdown
  convert_to_markdown "$source_file" "$target_file" "$session_num" "$session_date"
  
  echo "✓ Imported: $filename → $target_filename"
  echo "$target_file"
}

# Import all sessions
import_all_sessions() {
  local dry_run="${1:-false}"
  local force="${2:-false}"
  
  if [[ ! -d "$PATHFINDER_SOURCE_DIR" ]]; then
    echo "❌ Source directory not found: $PATHFINDER_SOURCE_DIR"
    return 1
  fi
  
  echo ""
  echo -e "${BOLD}${CYAN}Importing Pathfinder Kingmaker Sessions${NC}"
  echo -e "${CYAN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
  echo ""
  
  if [[ "$dry_run" == "true" ]]; then
    echo -e "${YELLOW}DRY RUN MODE - No files will be created${NC}"
    echo ""
  fi
  
  if [[ "$force" == "true" ]]; then
    echo -e "${YELLOW}FORCE MODE - Existing files will be overwritten${NC}"
    echo ""
  fi
  
  local count=0
  local imported=0
  local skipped=0
  local errors=0
  
  # Find all .txt files in source directory
  while IFS= read -r -d '' file; do
    count=$((count + 1))
    local result=$(import_session "$file" "$dry_run" "$force" 2>&1)
    local exit_code=$?
    
    if [[ $exit_code -eq 0 ]]; then
      # Successfully imported
      imported=$((imported + 1))
      if [[ "$dry_run" != "true" ]]; then
        echo "$result"
      else
        echo "$result" | head -3
      fi
    elif [[ $exit_code -eq 2 ]]; then
      # Already exists (skipped)
      skipped=$((skipped + 1))
      if [[ "$dry_run" == "true" ]]; then
        echo "$result" | head -1
      else
        echo -e "${YELLOW}⊘${NC} Skipped (already exists): $(basename "$file")"
      fi
    else
      # Error
      errors=$((errors + 1))
      echo -e "${YELLOW}⚠️${NC} Error processing: $(basename "$file")"
    fi
  done < <(find "$PATHFINDER_SOURCE_DIR" -type f -name "*.txt" -print0 2>/dev/null | sort -z)
  
  echo ""
  echo -e "${CYAN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
  echo -e "${BOLD}Summary:${NC}"
  echo -e "  ${GREEN}Total files:${NC} ${count}"
  echo -e "  ${GREEN}Imported:${NC} ${imported}"
  if [[ $skipped -gt 0 ]]; then
    echo -e "  ${YELLOW}Skipped (already exist):${NC} ${skipped}"
  fi
  if [[ $errors -gt 0 ]]; then
    echo -e "  ${YELLOW}Errors:${NC} ${errors}"
  fi
  echo ""
  
  if [[ "$dry_run" == "false" && "$imported" -gt 0 ]]; then
    echo -e "${YELLOW}Next steps:${NC}"
    echo "  1. Update MOC: gtd-brain-import-pathfinder moc"
    echo "  2. Review imported sessions in: $PATHFINDER_TARGET_DIR"
    echo ""
  elif [[ "$dry_run" == "false" && "$imported" -eq 0 && "$skipped" -gt 0 ]]; then
    echo -e "${CYAN}All sessions already imported.${NC}"
    echo -e "  Use ${BOLD}--force${NC} to re-import existing files"
    echo ""
  fi
}

# Create or update MOC
create_moc() {
  local moc_file="${MOC_DIR}/MOC - Pathfinder Kingmaker.md"
  
  if [[ ! -f "$moc_file" ]]; then
    echo "Creating Pathfinder Kingmaker MOC..."
    gtd-brain-moc create "Pathfinder Kingmaker" "Session write-ups and campaign notes for Pathfinder Kingmaker" >/dev/null 2>&1
  fi
  
  # Auto-populate from tags
  echo "Adding sessions to MOC..."
  gtd-brain-moc auto "Pathfinder Kingmaker" pathfinder-kingmaker
  
  echo "✓ MOC created/updated: $moc_file"
}

# Show usage
show_usage() {
  cat <<EOF
Usage: gtd-brain-import-pathfinder [command] [options]

Commands:
  import [--dry-run]    Import all session write-ups from source directory
  session <file>         Import a single session file
  moc                    Create/update Pathfinder Kingmaker MOC
  list                   List available session files to import
  help                   Show this help message

Options:
  --dry-run              Show what would be imported without creating files
  --force                 Re-import existing files (overwrites them)
  --source <dir>         Override source directory (default: ~/Documents/pathfinder - kingmaker)
  --target <dir>         Override target directory (default: Second Brain/Resources/Reference/Pathfinder Kingmaker)

Examples:
  # Preview what will be imported
  gtd-brain-import-pathfinder import --dry-run

  # Import all new sessions (skips existing)
  gtd-brain-import-pathfinder import

  # Re-import all sessions (overwrites existing)
  gtd-brain-import-pathfinder import --force

  # Import a single session
  gtd-brain-import-pathfinder session "message - pathfinder - session 2.txt"

  # Create/update MOC
  gtd-brain-import-pathfinder moc

  # List available files
  gtd-brain-import-pathfinder list

Configuration:
  Source directory: ${PATHFINDER_SOURCE_DIR}
  Target directory: ${PATHFINDER_TARGET_DIR}
  Second Brain: ${SECOND_BRAIN}
EOF
}

# List available files
list_files() {
  echo ""
  echo -e "${BOLD}${CYAN}Available Session Files${NC}"
  echo -e "${CYAN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
  echo ""
  
  if [[ ! -d "$PATHFINDER_SOURCE_DIR" ]]; then
    echo "❌ Source directory not found: $PATHFINDER_SOURCE_DIR"
    return 1
  fi
  
  local count=0
  find "$PATHFINDER_SOURCE_DIR" -type f -name "*.txt" 2>/dev/null | sort | while read -r file; do
    count=$((count + 1))
    local filename=$(basename "$file")
    local session_num=$(extract_session_number "$filename")
    local size=$(du -h "$file" 2>/dev/null | cut -f1)
    
    echo -e "${GREEN}${count}.${NC} ${BOLD}${filename}${NC}"
    echo "   Session: ${session_num:-Unknown} | Size: ${size}"
    echo ""
  done
}

# Main command handler
main() {
  local command="${1:-help}"
  
  case "$command" in
    import)
      local dry_run="false"
      local force="false"
      
      # Parse options
      shift
      while [[ $# -gt 0 ]]; do
        case "$1" in
          --dry-run)
            dry_run="true"
            shift
            ;;
          --force)
            force="true"
            shift
            ;;
          *)
            echo "❌ Unknown option: $1"
            show_usage
            return 1
            ;;
        esac
      done
      
      import_all_sessions "$dry_run" "$force"
      ;;
    session)
      if [[ -z "$2" ]]; then
        echo "❌ File path required"
        show_usage
        return 1
      fi
      local file_path="$2"
      # If not absolute, assume it's in source directory
      if [[ ! "$file_path" = /* ]]; then
        file_path="${PATHFINDER_SOURCE_DIR}/${file_path}"
      fi
      import_session "$file_path"
      ;;
    moc)
      create_moc
      ;;
    list)
      list_files
      ;;
    help|--help|-h)
      show_usage
      ;;
    *)
      echo "❌ Unknown command: $command"
      echo ""
      show_usage
      return 1
      ;;
  esac
}

# Run main function
main "$@"
