#!/bin/bash
# GTD Review Command - Daily and weekly reviews

# Load GTD config
GTD_CONFIG_FILE="$HOME/.gtd_config"
if [[ -f "$HOME/code/personal/dotfiles/zsh/.gtd_config" ]]; then
  GTD_CONFIG_FILE="$HOME/code/personal/dotfiles/zsh/.gtd_config"
fi

# Source config if it exists
if [[ -f "$GTD_CONFIG_FILE" ]]; then
  source "$GTD_CONFIG_FILE"
fi

# Default values
GTD_BASE_DIR="${GTD_BASE_DIR:-$HOME/Documents/gtd}"
GTD_INBOX_DIR="${GTD_INBOX_DIR:-0-inbox}"
GTD_PROJECTS_DIR="${GTD_PROJECTS_DIR:-1-projects}"
GTD_AREAS_DIR="${GTD_AREAS_DIR:-2-areas}"
GTD_WAITING_DIR="${GTD_WAITING_DIR:-5-waiting-for}"
GTD_SOMEDAY_DIR="${GTD_SOMEDAY_DIR:-4-someday-maybe}"
GTD_WEEKLY_REVIEWS_DIR="${GTD_WEEKLY_REVIEWS_DIR:-weekly-reviews}"

INBOX_PATH="${GTD_BASE_DIR}/${GTD_INBOX_DIR}"
PROJECTS_PATH="${GTD_BASE_DIR}/${GTD_PROJECTS_DIR}"
AREAS_PATH="${GTD_BASE_DIR}/${GTD_AREAS_DIR}"
WAITING_PATH="${GTD_BASE_DIR}/${GTD_WAITING_DIR}"
SOMEDAY_PATH="${GTD_BASE_DIR}/${GTD_SOMEDAY_DIR}"
TASKS_PATH="${GTD_BASE_DIR}/tasks"
WEEKLY_REVIEWS_PATH="${GTD_BASE_DIR}/${GTD_WEEKLY_REVIEWS_DIR}"

mkdir -p "$WEEKLY_REVIEWS_PATH"

TODAY=$(date +"%Y-%m-%d")
NOW=$(date +"%H:%M")

# Count items
count_items() {
  local path="$1"
  find "$path" -type f -name "*.md" 2>/dev/null | wc -l | tr -d ' '
}

# Daily review
daily_review() {
  echo ""
  echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
  echo "ðŸ“… Daily Review - $TODAY"
  echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
  echo ""
  
  # Inbox count
  local inbox_count=$(count_items "$INBOX_PATH")
  echo "ðŸ“¥ Inbox: $inbox_count item(s)"
  if [[ $inbox_count -gt 0 ]]; then
    echo "   â†’ Run 'gtd-process' to process items"
  fi
  echo ""
  
  # Active tasks count
  local active_tasks=$(find "$TASKS_PATH" -type f -name "*.md" 2>/dev/null | while read f; do
    grep -q "^status: active" "$f" 2>/dev/null && echo "$f"
  done | wc -l | tr -d ' ')
  echo "ðŸ“‹ Active tasks: $active_tasks"
  echo ""
  
  # Daily review questions
  echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
  echo "ðŸ’­ Daily Review Questions"
  echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
  echo ""
  
  echo "1. What are my top 3 priorities today?"
  read -p "   Priority 1: " priority1
  read -p "   Priority 2: " priority2
  read -p "   Priority 3: " priority3
  echo ""
  
  echo "2. What did I accomplish yesterday?"
  read -p "   " yesterday_accomplishments
  echo ""
  
  echo "3. What's blocking me?"
  read -p "   " blockers
  echo ""
  
  echo "4. What needs my attention?"
  read -p "   " attention_items
  echo ""
  
  # Save review
  local review_file="${WEEKLY_REVIEWS_PATH}/daily-${TODAY}.md"
  cat > "$review_file" <<EOF
---
type: daily_review
date: ${TODAY}
created: ${TODAY}T${NOW}
---

# Daily Review - ${TODAY}

## Priorities Today
1. ${priority1}
2. ${priority2}
3. ${priority3}

## Yesterday's Accomplishments
${yesterday_accomplishments}

## Blockers
${blockers}

## Needs Attention
${attention_items}

## Stats
- Inbox items: ${inbox_count}
- Active tasks: ${active_tasks}

EOF
  
  echo "âœ“ Daily review saved: $review_file"
  echo ""
  
  # Offer AI advice
  read -p "Get AI advice on your priorities? (y/n) " -n 1 -r
  echo
  if [[ $REPLY =~ ^[Yy]$ ]]; then
    local review_content=$(cat "$review_file")
    if command -v python3 &>/dev/null; then
      local persona_helper="$HOME/code/personal/dotfiles/zsh/functions/gtd_persona_helper.py"
      if [[ -f "$persona_helper" ]]; then
        python3 "$persona_helper" "david" "$review_content" "daily_review"
      fi
    fi
  fi
}

# Weekly review
weekly_review() {
  local week_start=$(date -v-monday +"%Y-%m-%d" 2>/dev/null || date -d "last monday" +"%Y-%m-%d" 2>/dev/null || date +"%Y-%m-%d")
  local week_end=$(date -v-sunday +"%Y-%m-%d" 2>/dev/null || date -d "next sunday" +"%Y-%m-%d" 2>/dev/null || date +"%Y-%m-%d")
  
  echo ""
  echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
  echo "ðŸ“… Weekly Review - Week of $week_start to $week_end"
  echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
  echo ""
  
  # Process inbox first
  local inbox_count=$(count_items "$INBOX_PATH")
  if [[ $inbox_count -gt 0 ]]; then
    echo "ðŸ“¥ Inbox has $inbox_count item(s)"
    read -p "Process inbox now? (y/n) " -n 1 -r
    echo
    if [[ $REPLY =~ ^[Yy]$ ]]; then
      gtd-process --all
    fi
    echo ""
  fi
  
  # Projects
  local projects=($(find "$PROJECTS_PATH" -type d -mindepth 1 -maxdepth 1 2>/dev/null))
  local active_projects=0
  for project_dir in "${projects[@]}"; do
    local readme="${project_dir}/README.md"
    if [[ -f "$readme" ]]; then
      local status=$(grep "^status:" "$readme" 2>/dev/null | head -1 | cut -d':' -f2 | sed 's/^[[:space:]]*//')
      if [[ "$status" == "active" ]]; then
        ((active_projects++))
      fi
    fi
  done
  
  echo "ðŸ“ Active projects: $active_projects"
  echo ""
  
  # Waiting for
  local waiting_count=$(count_items "$WAITING_PATH")
  echo "â³ Waiting for: $waiting_count item(s)"
  if [[ $waiting_count -gt 0 ]]; then
    echo "   â†’ Review and follow up on waiting items"
  fi
  echo ""
  
  # Weekly review questions
  echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
  echo "ðŸ’­ Weekly Review Questions"
  echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
  echo ""
  
  echo "1. What projects need attention?"
  read -p "   " projects_attention
  echo ""
  
  echo "2. What's in my inbox that needs processing?"
  read -p "   " inbox_items
  echo ""
  
  echo "3. What's on my calendar for next week?"
  read -p "   " calendar_next_week
  echo ""
  
  echo "4. What's in Waiting For that I should follow up on?"
  read -p "   " waiting_followups
  echo ""
  
  echo "5. What's in Someday/Maybe that I want to activate?"
  read -p "   " someday_activate
  echo ""
  
  echo "6. What areas of responsibility need attention?"
  read -p "   " areas_attention
  echo ""
  
  # Save review
  local review_file="${WEEKLY_REVIEWS_PATH}/weekly-${TODAY}.md"
  cat > "$review_file" <<EOF
---
type: weekly_review
date: ${TODAY}
week_start: ${week_start}
week_end: ${week_end}
created: ${TODAY}T${NOW}
---

# Weekly Review - Week of ${week_start} to ${week_end}

## Projects Needing Attention
${projects_attention}

## Inbox Items
${inbox_items}

## Calendar - Next Week
${calendar_next_week}

## Waiting For - Follow Ups
${waiting_followups}

## Someday/Maybe - Activate
${someday_activate}

## Areas of Responsibility
${areas_attention}

## Stats
- Inbox items: ${inbox_count}
- Active projects: ${active_projects}
- Waiting for: ${waiting_count}

EOF
  
  echo "âœ“ Weekly review saved: $review_file"
  echo ""
  
  # Offer AI advice
  read -p "Get AI advice on your weekly review? (y/n) " -n 1 -r
  echo
  if [[ $REPLY =~ ^[Yy]$ ]]; then
    local review_content=$(cat "$review_file")
    if command -v python3 &>/dev/null; then
      local persona_helper="$HOME/code/personal/dotfiles/zsh/functions/gtd_persona_helper.py"
      if [[ -f "$persona_helper" ]]; then
        echo ""
        echo "Getting advice from David Allen (GTD expert)..."
        python3 "$persona_helper" "david" "$review_content" "weekly_review"
        echo ""
        read -p "Get strategic advice from Warren Buffett? (y/n) " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
          python3 "$persona_helper" "warren" "$review_content" "weekly_review"
        fi
      fi
    fi
  fi
}

# Review specific project
review_project() {
  local project_name="$1"
  if [[ -z "$project_name" ]]; then
    echo "Usage: gtd-review project <project-name>"
    exit 1
  fi
  
  project_name=$(echo "$project_name" | tr ' ' '-' | tr '[:upper:]' '[:lower:]')
  local project_dir="${PROJECTS_PATH}/${project_name}"
  local readme="${project_dir}/README.md"
  
  if [[ ! -d "$project_dir" || ! -f "$readme" ]]; then
    echo "âŒ Project not found: $project_name"
    exit 1
  fi
  
  echo ""
  echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
  echo "ðŸ“ Project Review: $project_name"
  echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
  echo ""
  
  # Show project status
  gtd-project status "$project_name"
  echo ""
  
  # Review questions
  echo "1. What's the current status of this project?"
  read -p "   " project_status
  echo ""
  
  echo "2. What are the next actions?"
  read -p "   " next_actions
  echo ""
  
  echo "3. What's blocking progress?"
  read -p "   " project_blockers
  echo ""
  
  echo "4. What needs to happen next?"
  read -p "   " project_next
  echo ""
  
  # Append to project README
  cat >> "$readme" <<EOF

## Review - ${TODAY}

### Status
${project_status}

### Next Actions
${next_actions}

### Blockers
${project_blockers}

### Next Steps
${project_next}

EOF
  
  echo "âœ“ Review added to project: $project_name"
}

# Main
main() {
  case "$1" in
    daily)
      daily_review
      ;;
    weekly)
      weekly_review
      ;;
    project)
      shift
      review_project "$1"
      ;;
    --help|-h|"")
      echo "Usage: gtd-review <type> [options]"
      echo ""
      echo "Types:"
      echo "  daily                    Daily review"
      echo "  weekly                   Weekly review"
      echo "  project <name>           Review specific project"
      echo ""
      echo "Examples:"
      echo "  gtd-review daily"
      echo "  gtd-review weekly"
      echo "  gtd-review project website-redesign"
      exit 0
      ;;
    *)
      echo "Unknown review type: $1"
      echo "Run 'gtd-review --help' for usage"
      exit 1
      ;;
  esac
}

main "$@"



