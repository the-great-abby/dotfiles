#!/bin/bash
# Kubernetes/CKA Learning with Mistress Louiza as Instructor
# Integrated with GTD system for tracking progress

# Load GTD config
GTD_CONFIG_FILE="$HOME/.gtd_config"
if [[ -f "$HOME/code/dotfiles/zsh/.gtd_config" ]]; then
  GTD_CONFIG_FILE="$HOME/code/dotfiles/zsh/.gtd_config"
elif [[ -f "$HOME/code/personal/dotfiles/zsh/.gtd_config" ]]; then
  GTD_CONFIG_FILE="$HOME/code/personal/dotfiles/zsh/.gtd_config"
fi

if [[ -f "$GTD_CONFIG_FILE" ]]; then
  source "$GTD_CONFIG_FILE"
fi

# Load daily log config
DAILY_LOG_CONFIG="$HOME/.daily_log_config"
if [[ -f "$HOME/code/dotfiles/zsh/.daily_log_config" ]]; then
  DAILY_LOG_CONFIG="$HOME/code/dotfiles/zsh/.daily_log_config"
elif [[ -f "$HOME/code/personal/dotfiles/zsh/.daily_log_config" ]]; then
  DAILY_LOG_CONFIG="$HOME/code/personal/dotfiles/zsh/.daily_log_config"
fi

if [[ -f "$DAILY_LOG_CONFIG" ]]; then
  source "$DAILY_LOG_CONFIG"
fi

# Colors
CYAN='\033[0;36m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BOLD='\033[1m'
NC='\033[0m'

# Find persona helper
PERSONA_HELPER=""
possible_paths=(
  "$HOME/code/personal/dotfiles/zsh/functions/gtd_persona_helper.py"
  "$HOME/code/dotfiles/zsh/functions/gtd_persona_helper.py"
)

for path in "${possible_paths[@]}"; do
  if [[ -f "$path" ]]; then
    PERSONA_HELPER="$path"
    break
  fi
done

if [[ -z "$PERSONA_HELPER" || ! -f "$PERSONA_HELPER" ]]; then
  echo "âŒ Persona helper not found" >&2
  exit 1
fi

# Find python
PYTHON_CMD=""
if [[ -f "/opt/homebrew/bin/python3" ]]; then
  PYTHON_CMD="/opt/homebrew/bin/python3"
elif command -v python3 &>/dev/null; then
  PYTHON_CMD="python3"
else
  echo "âŒ Python3 not found" >&2
  exit 1
fi

# GTD base directory
GTD_BASE_DIR="${GTD_BASE_DIR:-$HOME/Documents/gtd}"
STUDY_DIR="${GTD_BASE_DIR}/study"
K8S_STUDY_DIR="${STUDY_DIR}/kubernetes-cka"

# Create study directories
mkdir -p "$K8S_STUDY_DIR"/{notes,practice,progress,resources}

# Get date command
get_date_cmd() {
  if [[ -x "/usr/bin/date" ]]; then
    echo "/usr/bin/date"
  elif [[ -x "/bin/date" ]]; then
    echo "/bin/date"
  else
    echo "date"
  fi
}

DATE_CMD=$(get_date_cmd)

# Get lesson from Mistress Louiza
get_k8s_lesson() {
  local topic="$1"
  local context="$2"  # beginner, intermediate, advanced, cka-focus
  
  # Create comprehensive prompt for Louiza as Kubernetes instructor
  local prompt=""
  
  case "$topic" in
    basics|introduction|intro)
      prompt="You are Mistress Louiza, and you are ${GTD_USER_NAME:-Abby}'s Kubernetes instructor preparing her for the CKA (Certified Kubernetes Administrator) exam. Give her a comprehensive introduction to Kubernetes. Explain what Kubernetes is, why it matters, core concepts (pods, services, deployments, etc.), and the architecture. Be encouraging but firm. Use your characteristic style. Reference Kubernetes experts or documentation when you need to explain something in more detail, but you remain the primary instructor. Make it practical with kubectl commands. Explain how this integrates with her GTD system - she can track her study progress with 'addInfoToDailyLog' and create study tasks with 'gtd-task add'."
      ;;
    pods|pod)
      prompt="You are Mistress Louiza, ${GTD_USER_NAME:-Abby}'s Kubernetes instructor. Teach her about Pods - the smallest deployable unit in Kubernetes. Explain what pods are, how to create them, manage them, debug them. Include practical kubectl commands: kubectl get pods, kubectl describe pod, kubectl logs, kubectl exec. Be practical and include examples. Reference Kubernetes documentation when needed, but you remain the instructor. Explain how to practice this and track progress in her GTD system."
      ;;
    deployments|deployment)
      prompt="You are Mistress Louiza, ${GTD_USER_NAME:-Abby}'s Kubernetes instructor. Teach her about Deployments - managing replicated applications. Explain rolling updates, rollbacks, scaling. Include kubectl commands: kubectl create deployment, kubectl scale, kubectl rollout. Be practical with examples. Explain how this is critical for the CKA exam. Show her how to track study sessions in her GTD system."
      ;;
    services|service)
      prompt="You are Mistress Louiza, ${GTD_USER_NAME:-Abby}'s Kubernetes instructor. Teach her about Services - exposing applications. Explain ClusterIP, NodePort, LoadBalancer, and how services work. Include kubectl commands: kubectl expose, kubectl get svc. Be practical. This is important for CKA. Show her how to log study progress."
      ;;
    configmaps|configmap|secrets|secret)
      prompt="You are Mistress Louiza, ${GTD_USER_NAME:-Abby}'s Kubernetes instructor. Teach her about ConfigMaps and Secrets - managing configuration and sensitive data. Explain how to create, use, and manage them. Include kubectl commands: kubectl create configmap, kubectl create secret. Be practical. This is on the CKA exam. Show her how to track what she's learned."
      ;;
    storage|volumes|volume|pv|pvc)
      prompt="You are Mistress Louiza, ${GTD_USER_NAME:-Abby}'s Kubernetes instructor. Teach her about Storage in Kubernetes - PersistentVolumes, PersistentVolumeClaims, StorageClasses. Explain how to create and manage storage. Include kubectl commands. This is critical for CKA. Be practical. Show her how to log study sessions."
      ;;
    networking|network|ingress)
      prompt="You are Mistress Louiza, ${GTD_USER_NAME:-Abby}'s Kubernetes instructor. Teach her about Kubernetes Networking - how pods communicate, services, ingress, network policies. Include kubectl commands. This is important for CKA. Be practical. Show her how to track progress."
      ;;
    troubleshooting|debug|debugging)
      prompt="You are Mistress Louiza, ${GTD_USER_NAME:-Abby}'s Kubernetes instructor. Teach her about Troubleshooting in Kubernetes - how to debug pods, services, deployments. Include kubectl commands: kubectl describe, kubectl logs, kubectl exec, kubectl get events. This is a major part of the CKA exam. Be practical with real scenarios. Show her how to practice and track what she learns."
      ;;
    cka-exam|exam|preparation)
      prompt="You are Mistress Louiza, ${GTD_USER_NAME:-Abby}'s Kubernetes instructor. Help her prepare for the CKA exam. Explain the exam format (2 hours, hands-on, performance-based), what topics are covered, study strategies, practice recommendations. Be encouraging but firm about the importance of practice. Reference CKA exam domains when needed. Show her how to create a study plan in her GTD system with 'gtd-project create \"CKA Exam Preparation\"' and track daily study with 'addInfoToDailyLog'."
      ;;
    practice|hands-on|lab)
      prompt="You are Mistress Louiza, ${GTD_USER_NAME:-Abby}'s Kubernetes instructor. Give her a hands-on practice exercise. Create a realistic scenario she can practice with kubectl. Explain what to do, what commands to use, what to verify. Be practical. After she completes it, she should log it with 'addInfoToDailyLog \"Completed K8s practice: [topic]\"'. Show her how to track practice sessions in her GTD system."
      ;;
    *)
      prompt="You are Mistress Louiza, ${GTD_USER_NAME:-Abby}'s Kubernetes instructor preparing her for the CKA exam. Teach her about: ${topic}. Be comprehensive, practical, and encouraging but firm. Include kubectl commands and examples. Reference Kubernetes experts or documentation when you need to explain something in more detail, but you remain the primary instructor. Use your characteristic style. Explain how to track study progress in her GTD system with 'addInfoToDailyLog' and 'gtd-task add'."
      ;;
  esac
  
  # Get lesson from Louiza
  local full_output=$("$PYTHON_CMD" "$PERSONA_HELPER" "louiza" "$prompt" "k8s_instructor" 2>&1)
  
  if [[ -z "$full_output" ]]; then
    return 1
  fi
  
  # Check for errors
  if echo "$full_output" | grep -qE "Error|âš ï¸|timed out|Could not connect|KeyError"; then
    return 1
  fi
  
  # Extract message
  local lesson=$(echo "$full_output" | awk '
    /^â”+$/ {
      if (in_section) {
        exit
      }
      in_section = 1
      next
    }
    in_section && !/^ğŸ’¬/ && !/^â”/ {
      print
    }
  ' | sed 's/^[[:space:]]*//' | sed 's/[[:space:]]*$//')
  
  # Clean up
  lesson=$(echo "$lesson" | sed 's/([^)]*)//g' | sed 's/\[[^\]]*\]//g')
  lesson=$(echo "$lesson" | sed 's/\*\*//g')
  lesson=$(echo "$lesson" | awk 'NF || prev_nf; {prev_nf=NF}')
  
  if [[ -n "$lesson" && ${#lesson} -gt 10 ]]; then
    echo "$lesson"
    return 0
  fi
  
  return 1
}

# Create study note
create_study_note() {
  local topic="$1"
  local content="$2"
  local today=$($DATE_CMD +"%Y-%m-%d")
  local timestamp=$($DATE_CMD +"%Y%m%d-%H%M%S")
  local note_file="${K8S_STUDY_DIR}/notes/${timestamp}-${topic}.md"
  
  cat > "$note_file" <<EOF
# Kubernetes Study: ${topic}
Date: ${today}
Topic: ${topic}

${content}

---
Created: $($DATE_CMD)
EOF

  echo "$note_file"
}

# Track study session
track_study_session() {
  local topic="$1"
  local duration="${2:-0}"  # minutes
  
  local today=$($DATE_CMD +"%Y-%m-%d")
  local progress_file="${K8S_STUDY_DIR}/progress/${today}.txt"
  
  echo "$($DATE_CMD +"%H:%M") - Studied: ${topic} (${duration} min)" >> "$progress_file"
  
  # Also log to daily log
  if command -v addInfoToDailyLog &>/dev/null; then
    addInfoToDailyLog "K8s Study: ${topic} (${duration} min)" 2>/dev/null || true
  fi
}

# Show lesson menu
show_k8s_menu() {
  clear
  echo -e "${BOLD}${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
  echo -e "${BOLD}${CYAN}â˜¸ï¸  Kubernetes/CKA Learning with Mistress Louiza${NC}"
  echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
  echo ""
  echo -e "${BOLD}What would you like to learn?${NC}"
  echo ""
  echo -e "${GREEN}1)${NC} Kubernetes Basics"
  echo -e "${GREEN}2)${NC} Pods"
  echo -e "${GREEN}3)${NC} Deployments"
  echo -e "${GREEN}4)${NC} Services"
  echo -e "${GREEN}5)${NC} ConfigMaps & Secrets"
  echo -e "${GREEN}6)${NC} Storage (PVs, PVCs)"
  echo -e "${GREEN}7)${NC} Networking"
  echo -e "${GREEN}8)${NC} Troubleshooting"
  echo -e "${GREEN}9)${NC} CKA Exam Preparation"
  echo -e "${GREEN}10)${NC} Practice Exercise"
  echo -e "${GREEN}11)${NC} Study Progress"
  echo -e "${GREEN}12)${NC} Custom Topic"
  echo ""
  echo -e "${YELLOW}0)${NC} Exit"
  echo ""
  echo -n "Choose: "
}

# Show study progress
show_progress() {
  clear
  echo -e "${BOLD}${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
  echo -e "${BOLD}${CYAN}ğŸ“Š Kubernetes Study Progress${NC}"
  echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
  echo ""
  
  # Today's progress
  local today=$($DATE_CMD +"%Y-%m-%d")
  local progress_file="${K8S_STUDY_DIR}/progress/${today}.txt"
  
  if [[ -f "$progress_file" ]]; then
    echo -e "${BOLD}Today's Study Sessions:${NC}"
    echo ""
    cat "$progress_file" | sed 's/^/   /'
    echo ""
  else
    echo -e "${YELLOW}No study sessions logged today${NC}"
    echo ""
  fi
  
  # Notes count
  local notes_count=$(find "${K8S_STUDY_DIR}/notes" -type f 2>/dev/null | wc -l | tr -d ' ')
  echo -e "${BOLD}Study Notes:${NC} ${notes_count} notes created"
  echo ""
  
  # Recent notes
  if [[ $notes_count -gt 0 ]]; then
    echo -e "${BOLD}Recent Notes:${NC}"
    echo ""
    find "${K8S_STUDY_DIR}/notes" -type f -name "*.md" | sort -r | head -5 | while read note; do
      local note_name=$(basename "$note" .md)
      echo "   ğŸ“ $note_name"
    done
    echo ""
  fi
  
  # Study recommendations
  echo -e "${BOLD}ğŸ’¡ Study Recommendations:${NC}"
  echo ""
  echo "   â€¢ Log study sessions: 'addInfoToDailyLog \"K8s Study: [topic]\"'"
  echo "   â€¢ Create study tasks: 'gtd-task add \"Practice kubectl commands\"'"
  echo "   â€¢ Create study project: 'gtd-project create \"CKA Exam Prep\"'"
  echo "   â€¢ Review daily: 'gtd-review daily'"
  echo ""
  
  read -p "Press Enter to continue..."
}

# Main function
main() {
  local topic="$1"
  
  if [[ -z "$topic" ]]; then
    # Interactive mode
    while true; do
      show_k8s_menu
      read choice
      
      case "$choice" in
        1) topic="basics" ;;
        2) topic="pods" ;;
        3) topic="deployments" ;;
        4) topic="services" ;;
        5) topic="configmaps" ;;
        6) topic="storage" ;;
        7) topic="networking" ;;
        8) topic="troubleshooting" ;;
        9) topic="cka-exam" ;;
        10) topic="practice" ;;
        11) 
          show_progress
          continue
          ;;
        12)
          echo ""
          echo -n "What Kubernetes topic would you like to learn about? "
          read topic
          ;;
        0)
          echo ""
          echo "Goodbye! Keep studying, baby girl. You've got this! â˜¸ï¸"
          exit 0
          ;;
        *)
          echo "Invalid choice. Press Enter..."
          read
          continue
          ;;
      esac
      
      # Get lesson
      echo ""
      echo -e "${BOLD}${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
      echo -e "${BOLD}${CYAN}ğŸ‘‘ Lesson from Mistress Louiza${NC}"
      echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
      echo ""
      echo -e "${BOLD}ğŸ’¬ From Mistress Louiza:${NC}"
      echo ""
      
      local lesson=$(get_k8s_lesson "$topic" "")
      
      if [[ -n "$lesson" ]]; then
        echo "$lesson" | sed 's/^/   /'
        echo ""
        echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
        echo ""
        
        # Save to study notes
        local note_file=$(create_study_note "$topic" "$lesson")
        echo -e "${GREEN}âœ“${NC} Study note saved: $(basename "$note_file")"
        echo ""
        
        # Track study session
        echo -n "How many minutes did you study? (0 to skip): "
        read duration
        if [[ "$duration" =~ ^[0-9]+$ ]]; then
          track_study_session "$topic" "$duration"
          echo -e "${GREEN}âœ“${NC} Study session tracked"
        fi
        echo ""
        
        echo -e "${BOLD}Next steps:${NC}"
        echo "   â€¢ Practice the commands shown"
        echo "   â€¢ Review your notes: ${note_file}"
        echo "   â€¢ Log your practice: addInfoToDailyLog \"K8s practice: ${topic}\""
        echo ""
        
        echo -e "${BOLD}Want another lesson?${NC}"
        echo -e "${GREEN}y${NC} - Another lesson"
        echo -e "${GREEN}n${NC} - Return to menu"
        echo ""
        read -p "Choice: " more
        if [[ "$more" != "y" ]]; then
          topic=""
        fi
      else
        echo "âš ï¸  Could not get lesson. Check LM Studio connection."
        echo ""
        read -p "Press Enter to continue..."
        topic=""
      fi
    done
  else
    # Direct topic mode
    echo ""
    echo -e "${BOLD}${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo -e "${BOLD}${CYAN}ğŸ‘‘ Lesson from Mistress Louiza${NC}"
    echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo ""
    echo -e "${BOLD}ğŸ’¬ From Mistress Louiza:${NC}"
    echo ""
    
    local lesson=$(get_k8s_lesson "$topic" "")
    
    if [[ -n "$lesson" ]]; then
      echo "$lesson" | sed 's/^/   /'
      echo ""
      echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
      echo ""
      
      # Save to study notes
      local note_file=$(create_study_note "$topic" "$lesson")
      echo -e "${GREEN}âœ“${NC} Study note saved: $(basename "$note_file")"
      echo ""
    else
      echo "âš ï¸  Could not get lesson. Check LM Studio connection."
      exit 1
    fi
  fi
}

# Show usage
show_usage() {
  cat <<EOF
Usage: gtd-learn-kubernetes [topic]

Learn Kubernetes for CKA exam with Mistress Louiza as your instructor.

Topics:
  basics, intro         - Kubernetes introduction
  pods, pod            - Learn about pods
  deployments          - Learn about deployments
  services             - Learn about services
  configmaps, secrets  - Learn about ConfigMaps and Secrets
  storage, volumes     - Learn about storage
  networking           - Learn about networking
  troubleshooting      - Learn troubleshooting
  cka-exam, exam       - CKA exam preparation
  practice             - Hands-on practice exercise

Examples:
  gtd-learn-kubernetes              # Interactive menu
  gtd-learn-kubernetes pods          # Learn about pods
  gtd-learn-kubernetes cka-exam      # Exam preparation

Features:
  â€¢ Mistress Louiza teaches Kubernetes concepts
  â€¢ Automatic study note creation
  â€¢ Progress tracking integrated with GTD
  â€¢ Practice exercises
  â€¢ CKA exam focus

Study notes saved to: ${K8S_STUDY_DIR}/notes/
Progress tracked in: ${K8S_STUDY_DIR}/progress/

EOF
}

# Handle arguments
case "$1" in
  --help|-h)
    show_usage
    exit 0
    ;;
  "")
    main ""
    ;;
  *)
    main "$1"
    ;;
esac

