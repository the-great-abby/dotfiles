#!/bin/bash
# Kubernetes/CKA Learning with Mistress Louiza as Instructor
# Integrated with GTD system for tracking progress

# Load GTD config
GTD_CONFIG_FILE="$HOME/.gtd_config"
if [[ -f "$HOME/code/dotfiles/zsh/.gtd_config" ]]; then
  GTD_CONFIG_FILE="$HOME/code/dotfiles/zsh/.gtd_config"
elif [[ -f "$HOME/code/personal/dotfiles/zsh/.gtd_config" ]]; then
  GTD_CONFIG_FILE="$HOME/code/personal/dotfiles/zsh/.gtd_config"
fi

if [[ -f "$GTD_CONFIG_FILE" ]]; then
  source "$GTD_CONFIG_FILE"
fi

# Load daily log config
DAILY_LOG_CONFIG="$HOME/.daily_log_config"
if [[ -f "$HOME/code/dotfiles/zsh/.daily_log_config" ]]; then
  DAILY_LOG_CONFIG="$HOME/code/dotfiles/zsh/.daily_log_config"
elif [[ -f "$HOME/code/personal/dotfiles/zsh/.daily_log_config" ]]; then
  DAILY_LOG_CONFIG="$HOME/code/personal/dotfiles/zsh/.daily_log_config"
fi

if [[ -f "$DAILY_LOG_CONFIG" ]]; then
  source "$DAILY_LOG_CONFIG"
fi

# Colors
CYAN='\033[0;36m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
MAGENTA='\033[0;35m'
BLUE='\033[0;34m'
BOLD='\033[1m'
NC='\033[0m'

# Find persona helper
PERSONA_HELPER=""
possible_paths=(
  "$HOME/code/personal/dotfiles/zsh/functions/gtd_persona_helper.py"
  "$HOME/code/dotfiles/zsh/functions/gtd_persona_helper.py"
)

for path in "${possible_paths[@]}"; do
  if [[ -f "$path" ]]; then
    PERSONA_HELPER="$path"
    break
  fi
done

if [[ -z "$PERSONA_HELPER" || ! -f "$PERSONA_HELPER" ]]; then
  echo "‚ùå Persona helper not found" >&2
  exit 1
fi

# Find python
PYTHON_CMD=""
if [[ -f "/opt/homebrew/bin/python3" ]]; then
  PYTHON_CMD="/opt/homebrew/bin/python3"
elif command -v python3 &>/dev/null; then
  PYTHON_CMD="python3"
else
  echo "‚ùå Python3 not found" >&2
  exit 1
fi

# GTD base directory
GTD_BASE_DIR="${GTD_BASE_DIR:-$HOME/Documents/gtd}"
STUDY_DIR="${GTD_BASE_DIR}/study"
K8S_STUDY_DIR="${STUDY_DIR}/kubernetes-cka"

# Create study directories
mkdir -p "$K8S_STUDY_DIR"/{notes,practice,progress,resources}

# Get date command
get_date_cmd() {
  if [[ -x "/usr/bin/date" ]]; then
    echo "/usr/bin/date"
  elif [[ -x "/bin/date" ]]; then
    echo "/bin/date"
  else
    echo "date"
  fi
}

DATE_CMD=$(get_date_cmd)

# Gather study data for critique
gather_k8s_study_data() {
  local topic="$1"
  
  # Default paths
  SECOND_BRAIN="${SECOND_BRAIN:-$HOME/Documents/obsidian/Second Brain}"
  GTD_BASE_DIR="${GTD_BASE_DIR:-$HOME/Documents/gtd}"
  PROJECTS_PATH="${PROJECTS_PATH:-$GTD_BASE_DIR/1-projects}"
  
  local study_data=""
  
  # Study notes count and recent topics
  local notes_count=$(find "${K8S_STUDY_DIR}/notes" -type f -name "*.md" 2>/dev/null | wc -l | tr -d ' ')
  if [[ "$notes_count" -gt 0 ]]; then
    study_data="${study_data}\nKubernetes Study Notes: ${notes_count} notes created"
    local recent_topics=$(find "${K8S_STUDY_DIR}/notes" -type f -name "*.md" -exec basename {} \; 2>/dev/null | sed 's/^[0-9]*-//' | sed 's/\.md$//' | head -5 | tr '\n' ', ' | sed 's/, $//')
    if [[ -n "$recent_topics" ]]; then
      study_data="${study_data} (recent: ${recent_topics})"
    fi
  fi
  
  # Progress tracking
  local progress_files=$(find "${K8S_STUDY_DIR}/progress" -type f -name "*.txt" 2>/dev/null | wc -l | tr -d ' ')
  if [[ "$progress_files" -gt 0 ]]; then
    study_data="${study_data}\nStudy Sessions Tracked: ${progress_files} days with logged sessions"
  fi
  
  # Second Brain notes related to Kubernetes
  if [[ -d "$SECOND_BRAIN" ]]; then
    local k8s_notes=$(find "$SECOND_BRAIN" -type f -name "*.md" ! -path "*/Templates/*" ! -path "*/.obsidian/*" -exec grep -l -i "kubernetes\|k8s\|cka\|kubectl" {} \; 2>/dev/null | wc -l | tr -d ' ')
    if [[ "$k8s_notes" -gt 0 ]]; then
      study_data="${study_data}\nSecond Brain Notes: ${k8s_notes} notes mentioning Kubernetes/K8s/CKA"
    fi
  fi
  
  # GTD projects related to Kubernetes
  if [[ -d "$PROJECTS_PATH" ]]; then
    local k8s_projects=$(find "$PROJECTS_PATH" -type d -mindepth 1 -maxdepth 1 -exec basename {} \; 2>/dev/null | grep -i "kubernetes\|k8s\|cka" | wc -l | tr -d ' ')
    if [[ "$k8s_projects" -gt 0 ]]; then
      local project_names=$(find "$PROJECTS_PATH" -type d -mindepth 1 -maxdepth 1 -exec basename {} \; 2>/dev/null | grep -i "kubernetes\|k8s\|cka" | tr '\n' ', ' | sed 's/, $//')
      study_data="${study_data}\nGTD Projects: ${k8s_projects} Kubernetes-related projects (${project_names})"
    fi
  fi
  
  # Sample note content for quality analysis (if topic-specific)
  if [[ -n "$topic" && "$notes_count" -gt 0 ]]; then
    local topic_notes=$(find "${K8S_STUDY_DIR}/notes" -type f -name "*${topic}*" -o -name "*.md" 2>/dev/null | head -3)
    if [[ -n "$topic_notes" ]]; then
      study_data="${study_data}\nNotes on '${topic}': Found related notes"
    fi
  fi
  
  echo -e "$study_data"
}

# Get lesson from Mistress Louiza
get_k8s_lesson() {
  local topic="$1"
  local context="$2"  # beginner, intermediate, advanced, cka-focus
  local critique_mode="${3:-false}"  # true = include study data for critique
  
  # Gather study data if in critique mode
  local study_data=""
  if [[ "$critique_mode" == "true" ]]; then
    study_data=$(gather_k8s_study_data "$topic")
  fi
  
  # Create comprehensive prompt for Louiza as Kubernetes instructor
  local prompt=""
  
  if [[ "$critique_mode" == "true" && -n "$study_data" ]]; then
    prompt="You are Mistress Louiza, ${GTD_USER_NAME:-Abby}'s Kubernetes instructor preparing her for the CKA exam. ${GTD_USER_NAME:-Abby} wants personalized critique and feedback on her actual Kubernetes study progress and note-taking. I've provided her actual study data below. Analyze it critically and provide specific, actionable feedback on how well she's studying Kubernetes, taking notes, tracking progress, and preparing for the CKA exam. Be firm but encouraging. Point out what's working well and what needs improvement. Give specific recommendations based on what you see in her data. Use your characteristic style.

${GTD_USER_NAME:-Abby}'s Current Kubernetes Study Data:
${study_data}

"
  fi
  
  case "$topic" in
    basics|introduction|intro)
      if [[ "$critique_mode" == "true" && -n "$study_data" ]]; then
        prompt="${prompt}Based on her actual study data above, critique her Kubernetes learning approach, especially for basics. How many notes has she taken? Is she tracking progress? Give specific feedback on her study habits and recommend improvements. Then provide targeted guidance on Kubernetes basics."
      else
        prompt="${prompt}You are Mistress Louiza, and you are ${GTD_USER_NAME:-Abby}'s Kubernetes instructor preparing her for the CKA (Certified Kubernetes Administrator) exam. Give her a comprehensive introduction to Kubernetes. Explain what Kubernetes is, why it matters, core concepts (pods, services, deployments, etc.), and the architecture. Be encouraging but firm. Use your characteristic style. Reference Kubernetes experts or documentation when you need to explain something in more detail, but you remain the primary instructor. Make it practical with kubectl commands. Explain how this integrates with her GTD system - she can track her study progress with 'addInfoToDailyLog' and create study tasks with 'gtd-task add'."
      fi
      ;;
    pods|pod)
      prompt="You are Mistress Louiza, ${GTD_USER_NAME:-Abby}'s Kubernetes instructor. Teach her about Pods - the smallest deployable unit in Kubernetes. Explain what pods are, how to create them, manage them, debug them. Include practical kubectl commands: kubectl get pods, kubectl describe pod, kubectl logs, kubectl exec. Be practical and include examples. Reference Kubernetes documentation when needed, but you remain the instructor. Explain how to practice this and track progress in her GTD system."
      ;;
    deployments|deployment)
      prompt="You are Mistress Louiza, ${GTD_USER_NAME:-Abby}'s Kubernetes instructor. Teach her about Deployments - managing replicated applications. Explain rolling updates, rollbacks, scaling. Include kubectl commands: kubectl create deployment, kubectl scale, kubectl rollout. Be practical with examples. Explain how this is critical for the CKA exam. Show her how to track study sessions in her GTD system."
      ;;
    services|service)
      prompt="You are Mistress Louiza, ${GTD_USER_NAME:-Abby}'s Kubernetes instructor. Teach her about Services - exposing applications. Explain ClusterIP, NodePort, LoadBalancer, and how services work. Include kubectl commands: kubectl expose, kubectl get svc. Be practical. This is important for CKA. Show her how to log study progress."
      ;;
    configmaps|configmap|secrets|secret)
      prompt="You are Mistress Louiza, ${GTD_USER_NAME:-Abby}'s Kubernetes instructor. Teach her about ConfigMaps and Secrets - managing configuration and sensitive data. Explain how to create, use, and manage them. Include kubectl commands: kubectl create configmap, kubectl create secret. Be practical. This is on the CKA exam. Show her how to track what she's learned."
      ;;
    storage|volumes|volume|pv|pvc)
      prompt="You are Mistress Louiza, ${GTD_USER_NAME:-Abby}'s Kubernetes instructor. Teach her about Storage in Kubernetes - PersistentVolumes, PersistentVolumeClaims, StorageClasses. Explain how to create and manage storage. Include kubectl commands. This is critical for CKA. Be practical. Show her how to log study sessions."
      ;;
    networking|network|ingress)
      prompt="You are Mistress Louiza, ${GTD_USER_NAME:-Abby}'s Kubernetes instructor. Teach her about Kubernetes Networking - how pods communicate, services, ingress, network policies. Include kubectl commands. This is important for CKA. Be practical. Show her how to track progress."
      ;;
    troubleshooting|debug|debugging)
      prompt="You are Mistress Louiza, ${GTD_USER_NAME:-Abby}'s Kubernetes instructor. Teach her about Troubleshooting in Kubernetes - how to debug pods, services, deployments. Include kubectl commands: kubectl describe, kubectl logs, kubectl exec, kubectl get events. This is a major part of the CKA exam. Be practical with real scenarios. Show her how to practice and track what she learns."
      ;;
    cka-exam|exam|preparation)
      prompt="You are Mistress Louiza, ${GTD_USER_NAME:-Abby}'s Kubernetes instructor. Help her prepare for the CKA exam. Explain the exam format (2 hours, hands-on, performance-based), what topics are covered, study strategies, practice recommendations. Be encouraging but firm about the importance of practice. Reference CKA exam domains when needed. Show her how to create a study plan in her GTD system with 'gtd-project create \"CKA Exam Preparation\"' and track daily study with 'addInfoToDailyLog'."
      ;;
    practice|hands-on|lab)
      prompt="You are Mistress Louiza, ${GTD_USER_NAME:-Abby}'s Kubernetes instructor. Give her a hands-on practice exercise. Create a realistic scenario she can practice with kubectl. Explain what to do, what commands to use, what to verify. Be practical. After she completes it, she should log it with 'addInfoToDailyLog \"Completed K8s practice: [topic]\"'. Show her how to track practice sessions in her GTD system."
      ;;
    *)
      if [[ "$critique_mode" == "true" && -n "$study_data" ]]; then
        prompt="${prompt}Based on her actual study data above, critique her Kubernetes learning for: ${topic}. Analyze her notes, progress tracking, and study habits. Give specific feedback and recommendations. Then provide targeted guidance on ${topic} for CKA exam preparation."
      else
        prompt="${prompt}You are Mistress Louiza, ${GTD_USER_NAME:-Abby}'s Kubernetes instructor preparing her for the CKA exam. Teach her about: ${topic}. Be comprehensive, practical, and encouraging but firm. Include kubectl commands and examples. Reference Kubernetes experts or documentation when you need to explain something in more detail, but you remain the primary instructor. Use your characteristic style. Explain how to track study progress in her GTD system with 'addInfoToDailyLog' and 'gtd-task add'."
      fi
      ;;
  esac
  
  # Get lesson from Louiza
  local full_output=$("$PYTHON_CMD" "$PERSONA_HELPER" "louiza" "$prompt" "k8s_instructor" 2>&1)
  
  if [[ -z "$full_output" ]]; then
    return 1
  fi
  
  # Check for errors
  if echo "$full_output" | grep -qE "Error|‚ö†Ô∏è|timed out|Could not connect|KeyError"; then
    return 1
  fi
  
  # Extract message
  local lesson=$(echo "$full_output" | awk '
    /^‚îÅ+$/ {
      if (in_section) {
        exit
      }
      in_section = 1
      next
    }
    in_section && !/^üí¨/ && !/^‚îÅ/ {
      print
    }
  ' | sed 's/^[[:space:]]*//' | sed 's/[[:space:]]*$//')
  
  # Clean up
  lesson=$(echo "$lesson" | sed 's/([^)]*)//g' | sed 's/\[[^\]]*\]//g')
  lesson=$(echo "$lesson" | sed 's/\*\*//g')
  lesson=$(echo "$lesson" | awk 'NF || prev_nf; {prev_nf=NF}')
  
  if [[ -n "$lesson" && ${#lesson} -gt 10 ]]; then
    echo "$lesson"
    return 0
  fi
  
  return 1
}

# Handle Q&A session after a lesson or critique
handle_qa_session() {
  local topic="$1"
  local is_critique="${2:-false}"
  
  # Ask if student wants to ask questions
  if [[ "$is_critique" == "true" ]]; then
    echo -e "${BOLD}Do you have any questions about this critique?${NC}"
  else
    echo -e "${BOLD}Do you have any questions about this topic?${NC}"
  fi
  echo -e "${GREEN}y${NC} - Ask questions"
  echo -e "${GREEN}n${NC} - Continue"
  echo ""
  read -p "Choice: " ask_questions
  echo ""
  
  if [[ "$ask_questions" != "y" && "$ask_questions" != "Y" ]]; then
    return 0
  fi
  
  # Q&A session loop
  while true; do
    echo -e "${CYAN}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${NC}"
    if [[ "$is_critique" == "true" ]]; then
      echo -e "${BOLD}üí¨ Ask Mistress Louiza about the critique on: ${topic}${NC}"
    else
      echo -e "${BOLD}üí¨ Ask Mistress Louiza about: ${topic}${NC}"
    fi
    echo -e "${CYAN}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${NC}"
    echo ""
    echo -e "${YELLOW}Type your question (or 'done' to finish asking questions):${NC}"
    echo ""
    read -p "‚ùì Question: " student_question
    
    if [[ -z "$student_question" ]]; then
      echo "Please enter a question or 'done' to continue."
      echo ""
      continue
    fi
    
    # Check if student is done
    if [[ "$student_question" == "done" || "$student_question" == "Done" || "$student_question" == "DONE" ]]; then
      echo ""
      echo "‚úì Finished asking questions."
      echo ""
      break
    fi
    
    # Get answer from Mistress Louiza with context
    echo ""
    echo -e "${BOLD}${CYAN}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${NC}"
    echo -e "${BOLD}${CYAN}üëë Answer from Mistress Louiza${NC}"
    echo -e "${CYAN}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${NC}"
    echo ""
    echo -e "${BOLD}üí¨ From Mistress Louiza:${NC}"
    echo ""
    
    local question_prompt=""
    if [[ "$is_critique" == "true" ]]; then
      question_prompt="You are Mistress Louiza, ${GTD_USER_NAME:-Abby}'s Kubernetes instructor preparing her for the CKA exam. ${GTD_USER_NAME:-Abby} just received personalized critique on: ${topic}. Now she has a question about the critique: '${student_question}'. Answer her question in detail, referencing the critique you just gave her about ${topic}. Be helpful, encouraging, and use your characteristic style with phrases like 'good girl' and 'baby girl' when appropriate. Reference other experts if needed, but you remain the primary instructor."
    else
      question_prompt="You are Mistress Louiza, ${GTD_USER_NAME:-Abby}'s Kubernetes instructor preparing her for the CKA exam. ${GTD_USER_NAME:-Abby} just learned about: ${topic}. Now she has a question: '${student_question}'. Answer her question in detail, referencing what you just taught her about ${topic}. Be helpful, encouraging, and use your characteristic style with phrases like 'good girl' and 'baby girl' when appropriate. Reference other experts if needed, but you remain the primary instructor."
    fi
    
    local answer=$("$PYTHON_CMD" "$PERSONA_HELPER" "louiza" "$question_prompt" "k8s_instructor" 2>&1)
    
    if [[ -n "$answer" ]]; then
      # Extract message (same extraction logic as lesson)
      local answer_text=$(echo "$answer" | awk '
        /^‚îÅ+$/ {
          if (in_section) {
            exit
          }
          in_section = 1
          next
        }
        in_section && !/^üí¨/ && !/^‚îÅ/ {
          print
        }
      ' | sed 's/^[[:space:]]*//' | sed 's/[[:space:]]*$//')
      
      # Clean up
      answer_text=$(echo "$answer_text" | sed 's/([^)]*)//g' | sed 's/\[[^\]]*\]//g')
      answer_text=$(echo "$answer_text" | sed 's/\*\*//g')
      answer_text=$(echo "$answer_text" | awk 'NF || prev_nf; {prev_nf=NF}')
      
      if [[ -n "$answer_text" && ${#answer_text} -gt 10 ]]; then
        echo "$answer_text" | sed 's/^/   /'
        echo ""
      else
        echo "   I'm here to help, baby girl. Could you rephrase your question?"
        echo ""
      fi
    else
      echo "   ‚ö†Ô∏è  Could not get answer. Check LM Studio connection."
      echo ""
    fi
    
    echo -e "${CYAN}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${NC}"
    echo ""
  done
}

# Create study note
create_study_note() {
  local topic="$1"
  local content="$2"
  local today=$($DATE_CMD +"%Y-%m-%d")
  local timestamp=$($DATE_CMD +"%Y%m%d-%H%M%S")
  local note_file="${K8S_STUDY_DIR}/notes/${timestamp}-${topic}.md"
  
  cat > "$note_file" <<EOF
# Kubernetes Study: ${topic}
Date: ${today}
Topic: ${topic}

${content}

---
Created: $($DATE_CMD)
EOF

  echo "$note_file"
}

# Track study session
track_study_session() {
  local topic="$1"
  local duration="${2:-0}"  # minutes
  
  local today=$($DATE_CMD +"%Y-%m-%d")
  local progress_file="${K8S_STUDY_DIR}/progress/${today}.txt"
  
  echo "$($DATE_CMD +"%H:%M") - Studied: ${topic} (${duration} min)" >> "$progress_file"
  
  # Also log to daily log
  if command -v addInfoToDailyLog &>/dev/null; then
    addInfoToDailyLog "K8s Study: ${topic} (${duration} min)" 2>/dev/null || true
  fi
}

# Get gamification stats for menu
get_gamification_stats() {
  if [[ -f "${K8S_STUDY_DIR}/gamification.json" ]]; then
    local data=$(cat "${K8S_STUDY_DIR}/gamification.json")
    local level=$(echo "$data" | grep -o '"level": [0-9]*' | grep -o '[0-9]*')
    local xp=$(echo "$data" | grep -o '"total_xp": [0-9]*' | grep -o '[0-9]*')
    local streak=$(echo "$data" | grep -o '"study_streak": [0-9]*' | grep -o '[0-9]*')
    echo "$level|$xp|$streak"
  else
    echo "1|0|0"
  fi
}

# Show lesson menu
show_k8s_menu() {
  clear
  echo -e "${BOLD}${CYAN}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${NC}"
  echo -e "${BOLD}${CYAN}‚ò∏Ô∏è  Kubernetes/CKA Learning with Mistress Louiza${NC}"
  echo -e "${CYAN}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${NC}"
  
  # Show gamification stats
  local stats=$(get_gamification_stats)
  local level=$(echo "$stats" | cut -d'|' -f1)
  local xp=$(echo "$stats" | cut -d'|' -f2)
  local streak=$(echo "$stats" | cut -d'|' -f3)
  
  echo ""
  echo -e "${BOLD}üéÆ Level ${level}${NC} | ${GREEN}${xp} XP${NC} | ${YELLOW}üî• ${streak} day streak${NC}"
  echo ""
  echo -e "${BOLD}What would you like to learn?${NC}"
  echo ""
  echo -e "${GREEN}1)${NC} Kubernetes Basics"
  echo -e "${GREEN}2)${NC} Pods"
  echo -e "${GREEN}3)${NC} Deployments"
  echo -e "${GREEN}4)${NC} Services"
  echo -e "${GREEN}5)${NC} ConfigMaps & Secrets"
  echo -e "${GREEN}6)${NC} Storage (PVs, PVCs)"
  echo -e "${GREEN}7)${NC} Networking"
  echo -e "${GREEN}8)${NC} Troubleshooting"
  echo -e "${GREEN}9)${NC} CKA Exam Preparation"
  echo -e "${GREEN}10)${NC} Practice Exercise"
  echo -e "${GREEN}11)${NC} Study Progress"
  echo -e "${GREEN}12)${NC} Custom Topic"
  echo -e "${MAGENTA}13)${NC} üéÆ Gamification Dashboard"
  echo -e "${BLUE}14)${NC} ‚å®Ô∏è  Typing Simulator (Practice kubectl commands)"
  echo -e "${YELLOW}15)${NC} ‚ö° Quick Study (Low-energy activities)"
  echo ""
  echo -e "${CYAN}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${NC}"
  echo -e "${BOLD}üìä Personalized Critique${NC}"
  echo -e "${CYAN}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${NC}"
  echo -e "${GREEN}16)${NC} Get Personalized Critique on My K8s Study"
  echo ""
  echo -e "${YELLOW}0)${NC} Exit"
  echo ""
  echo -n "Choose: "
}

# Show study progress
show_progress() {
  clear
  echo -e "${BOLD}${CYAN}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${NC}"
  echo -e "${BOLD}${CYAN}üìä Kubernetes Study Progress${NC}"
  echo -e "${CYAN}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${NC}"
  echo ""
  
  # Today's progress
  local today=$($DATE_CMD +"%Y-%m-%d")
  local progress_file="${K8S_STUDY_DIR}/progress/${today}.txt"
  
  if [[ -f "$progress_file" ]]; then
    echo -e "${BOLD}Today's Study Sessions:${NC}"
    echo ""
    cat "$progress_file" | sed 's/^/   /'
    echo ""
  else
    echo -e "${YELLOW}No study sessions logged today${NC}"
    echo ""
  fi
  
  # Notes count
  local notes_count=$(find "${K8S_STUDY_DIR}/notes" -type f 2>/dev/null | wc -l | tr -d ' ')
  echo -e "${BOLD}Study Notes:${NC} ${notes_count} notes created"
  echo ""
  
  # Recent notes
  if [[ $notes_count -gt 0 ]]; then
    echo -e "${BOLD}Recent Notes:${NC}"
    echo ""
    find "${K8S_STUDY_DIR}/notes" -type f -name "*.md" | sort -r | head -5 | while read note; do
      local note_name=$(basename "$note" .md)
      echo "   üìù $note_name"
    done
    echo ""
  fi
  
  # Study recommendations
  echo -e "${BOLD}üí° Study Recommendations:${NC}"
  echo ""
  echo "   ‚Ä¢ Log study sessions: 'addInfoToDailyLog \"K8s Study: [topic]\"'"
  echo "   ‚Ä¢ Create study tasks: 'gtd-task add \"Practice kubectl commands\"'"
  echo "   ‚Ä¢ Create study project: 'gtd-project create \"CKA Exam Prep\"'"
  echo "   ‚Ä¢ Review daily: 'gtd-review daily'"
  echo ""
  
  read -p "Press Enter to continue..."
}

# Main function
main() {
  local topic="$1"
  local critique_mode="false"
  
  if [[ -z "$topic" ]]; then
    # Interactive mode
    while true; do
      show_k8s_menu
      read choice
      
      # Reset critique mode for each lesson
      critique_mode="false"
      
      case "$choice" in
        1) topic="basics" ;;
        2) topic="pods" ;;
        3) topic="deployments" ;;
        4) topic="services" ;;
        5) topic="configmaps" ;;
        6) topic="storage" ;;
        7) topic="networking" ;;
        8) topic="troubleshooting" ;;
        9) topic="cka-exam" ;;
        10) topic="practice" ;;
        11) 
          show_progress
          continue
          ;;
        12)
          echo ""
          echo -n "What Kubernetes topic would you like to learn about? "
          read topic
          ;;
        13)
          if command -v gtd-cka-gamification &>/dev/null; then
            gtd-cka-gamification dashboard
          else
            echo "Gamification system not found"
            read -p "Press Enter to continue..."
          fi
          continue
          ;;
        14)
          if command -v gtd-cka-typing &>/dev/null; then
            gtd-cka-typing
          else
            echo "Typing simulator not found"
            read -p "Press Enter to continue..."
          fi
          continue
          ;;
        15)
          if command -v gtd-cka-quick &>/dev/null; then
            gtd-cka-quick
          else
            echo "Quick study not found"
            read -p "Press Enter to continue..."
          fi
          continue
          ;;
        16)
          # Personalized critique mode
          echo ""
          echo -e "${BOLD}üìä Personalized Kubernetes Study Critique${NC}"
          echo ""
          echo "Mistress Louiza will analyze your actual Kubernetes study progress and provide"
          echo "personalized feedback. This includes:"
          echo "  ‚Ä¢ Your study notes and topics covered"
          echo "  ‚Ä¢ Your study session tracking"
          echo "  ‚Ä¢ Your Second Brain notes related to Kubernetes/K8s/CKA"
          echo "  ‚Ä¢ Your GTD projects for CKA exam preparation"
          echo "  ‚Ä¢ How well you're tracking and organizing your learning"
          echo ""
          
          # Build dynamic topic list from notes
          local topic_map=()
          local topic_index=1
          
          # Always include "Overall study critique" as option 1
          topic_map[1]=""
          echo -e "${GREEN}  ${topic_index})${NC} Overall study critique"
          ((topic_index++))
          
          # Extract unique topics from note filenames
          if [[ -d "${K8S_STUDY_DIR}/notes" ]]; then
            local found_topics=$(find "${K8S_STUDY_DIR}/notes" -type f -name "*.md" -exec basename {} \; 2>/dev/null | \
              sed 's/^[0-9]*-//' | sed 's/\.md$//' | \
              tr '[:upper:]' '[:lower:]' | \
              sed 's/-/ /g' | sed 's/_/ /g' | \
              awk '{for(i=1;i<=NF;i++) $i=toupper(substr($i,1,1)) substr($i,2)}1' | \
              sort -u)
            
            # Map common topic names to their canonical form
            # Initialize topic_canonical (simulated associative array)
            _set_array_value "topic_canonical" "Pods" "pods"
            _set_array_value "topic_canonical" "Pod" "pods"
            _set_array_value "topic_canonical" "Deployments" "deployments"
            _set_array_value "topic_canonical" "Deployment" "deployments"
            _set_array_value "topic_canonical" "Services" "services"
            _set_array_value "topic_canonical" "Service" "services"
            _set_array_value "topic_canonical" "Troubleshooting" "troubleshooting"
            _set_array_value "topic_canonical" "Debug" "troubleshooting"
            _set_array_value "topic_canonical" "Debugging" "troubleshooting"
            _set_array_value "topic_canonical" "Cka Exam" "cka-exam"
            _set_array_value "topic_canonical" "Cka" "cka-exam"
            _set_array_value "topic_canonical" "Exam" "cka-exam"
            _set_array_value "topic_canonical" "Configmaps" "configmaps"
            _set_array_value "topic_canonical" "Configmap" "configmaps"
            _set_array_value "topic_canonical" "Secrets" "secrets"
            _set_array_value "topic_canonical" "Secret" "secrets"
            _set_array_value "topic_canonical" "Storage" "storage"
            _set_array_value "topic_canonical" "Volumes" "storage"
            _set_array_value "topic_canonical" "Networking" "networking"
            _set_array_value "topic_canonical" "Network" "networking"
            _set_array_value "topic_canonical" "Ingress" "networking"
            
            # Process found topics and add to menu
            local seen_canonical_keys=("")
            _set_array_value "seen_canonical" "" "1"  # Mark overall as seen
            
            while IFS= read -r found_topic; do
              [[ -z "$found_topic" ]] && continue
              
              # Get canonical form
              local canonical="$(_get_array_value "topic_canonical" "$found_topic")"
              [[ -z "$canonical" ]] && canonical=""
              if [[ -z "$canonical" ]]; then
                # If not in map, use lowercase with hyphens
                canonical=$(echo "$found_topic" | tr '[:upper:]' '[:lower:]' | sed 's/ /-/g')
              fi
              
              # Skip if we've already added this canonical topic
              local seen_value="$(_get_array_value "seen_canonical" "$canonical")"
              if [[ -n "$seen_value" ]]; then
                continue
              fi
              
              _set_array_value "seen_canonical" "$canonical" "1"
              seen_canonical_keys+=("$canonical")
              topic_map[$topic_index]="$canonical"
              echo -e "${GREEN}  ${topic_index})${NC} ${found_topic}"
              ((topic_index++))
            done <<< "$found_topics"
          fi
          
          # Always include important topics that might not have notes yet
          local important_topics=("pods" "deployments" "services" "troubleshooting" "cka-exam")
          local important_labels=("Pods" "Deployments" "Services" "Troubleshooting" "CKA Exam Preparation")
          
          for i in "${!important_topics[@]}"; do
            local imp_topic="${important_topics[$i]}"
            local imp_label="${important_labels[$i]}"
            
            # Check if already added
            local already_added=0
            for idx in "${!topic_map[@]}"; do
              if [[ "${topic_map[$idx]}" == "$imp_topic" ]]; then
                already_added=1
                break
              fi
            done
            
            if [[ $already_added -eq 0 ]]; then
              topic_map[$topic_index]="$imp_topic"
              echo -e "${GREEN}  ${topic_index})${NC} ${imp_label}"
              ((topic_index++))
            fi
          done
          
          echo ""
          local max_choice=$((topic_index - 1))
          read -p "Choice (1-${max_choice}): " critique_topic
          
          # Map selection to topic
          if [[ "$critique_topic" =~ ^[0-9]+$ ]] && [[ "$critique_topic" -ge 1 ]] && [[ "$critique_topic" -le $max_choice ]]; then
            topic="${topic_map[$critique_topic]}"
          else
            echo "Invalid choice, using overall study critique"
            topic=""
          fi
          
          # Set critique mode flag
          critique_mode="true"
          ;;
        0)
          echo ""
          echo "Goodbye! Keep studying, baby girl. You've got this! ‚ò∏Ô∏è"
          exit 0
          ;;
        *)
          echo "Invalid choice. Press Enter..."
          read
          continue
          ;;
      esac
      
      # Get lesson
      echo ""
      echo -e "${BOLD}${CYAN}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${NC}"
      echo -e "${BOLD}${CYAN}üëë Lesson from Mistress Louiza${NC}"
      echo -e "${CYAN}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${NC}"
      echo ""
      echo -e "${BOLD}üí¨ From Mistress Louiza:${NC}"
      echo ""
      
      # Get lesson
      if [[ "$critique_mode" == "true" ]]; then
        echo ""
        echo -e "${BOLD}${CYAN}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${NC}"
        echo -e "${BOLD}${CYAN}üìä Gathering your Kubernetes study data for critique...${NC}"
        echo -e "${CYAN}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${NC}"
        echo ""
      fi
      
      echo -e "${BOLD}${CYAN}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${NC}"
      echo -e "${BOLD}${CYAN}üëë Lesson from Mistress Louiza${NC}"
      echo -e "${CYAN}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${NC}"
      echo ""
      echo -e "${BOLD}üí¨ From Mistress Louiza:${NC}"
      echo ""
      
      local lesson=$(get_k8s_lesson "$topic" "" "$critique_mode")
      
      if [[ -n "$lesson" ]]; then
        if [[ "$critique_mode" == "true" ]]; then
          echo -e "${BOLD}${YELLOW}üìä Personalized Critique from Mistress Louiza:${NC}"
          echo ""
        fi
        echo "$lesson" | sed 's/^/   /'
        echo ""
        echo -e "${CYAN}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${NC}"
        echo ""
        
        # Q&A session (especially important for critiques)
        handle_qa_session "$topic" "$critique_mode"
        
        echo -e "${CYAN}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${NC}"
        echo ""
        
        # Save to study notes
        local note_file=$(create_study_note "$topic" "$lesson")
        echo -e "${GREEN}‚úì${NC} Study note saved: $(basename "$note_file")"
        echo ""
        echo -e "${CYAN}üí° Note: This note can be reviewed by Mistress Louiza during personalized critique${NC}"
        echo ""
        
        # Track study session
        echo -n "How many minutes did you study? (0 to skip): "
        read duration
        if [[ "$duration" =~ ^[0-9]+$ ]]; then
          track_study_session "$topic" "$duration"
          echo -e "${GREEN}‚úì${NC} Study session tracked"
          
          # Award XP and track lesson
          if command -v gtd-cka-gamification &>/dev/null; then
            echo ""
            local xp_gain=$(gtd-cka-gamification lesson "$topic" "$duration" 2>&1)
            echo -e "${GREEN}${xp_gain}${NC}"
          fi
        fi
        echo ""
        
        echo -e "${BOLD}Next steps:${NC}"
        echo "   ‚Ä¢ Practice the commands shown"
        echo "   ‚Ä¢ Review your notes: ${note_file}"
        echo "   ‚Ä¢ Log your practice: addInfoToDailyLog \"K8s practice: ${topic}\""
        echo ""
        
        echo -e "${BOLD}Want another lesson?${NC}"
        echo -e "${GREEN}y${NC} - Another lesson"
        echo -e "${GREEN}n${NC} - Return to menu"
        echo ""
        read -p "Choice: " more
        if [[ "$more" != "y" ]]; then
          topic=""
        fi
      else
        echo "‚ö†Ô∏è  Could not get lesson. Check LM Studio connection."
        echo ""
        read -p "Press Enter to continue..."
        topic=""
      fi
    done
  else
    # Direct topic mode
    echo ""
    echo -e "${BOLD}${CYAN}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${NC}"
    echo -e "${BOLD}${CYAN}üëë Lesson from Mistress Louiza${NC}"
    echo -e "${CYAN}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${NC}"
    echo ""
    echo -e "${BOLD}üí¨ From Mistress Louiza:${NC}"
    echo ""
    
    local lesson=$(get_k8s_lesson "$topic" "" "false")
    
    if [[ -n "$lesson" ]]; then
      echo "$lesson" | sed 's/^/   /'
      echo ""
      echo -e "${CYAN}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${NC}"
      echo ""
      
        # Save to study notes
        local note_file=$(create_study_note "$topic" "$lesson")
        echo -e "${GREEN}‚úì${NC} Study note saved: $(basename "$note_file")"
        echo ""
        
        # Track lesson (non-interactive mode, default duration)
        if command -v gtd-cka-gamification &>/dev/null; then
          local xp_gain=$(gtd-cka-gamification lesson "$topic" "15" 2>&1)
          echo -e "${GREEN}${xp_gain}${NC}"
          echo ""
        fi
    else
      echo "‚ö†Ô∏è  Could not get lesson. Check LM Studio connection."
      exit 1
    fi
  fi
}

# Show usage
show_usage() {
  cat <<EOF
Usage: gtd-learn-kubernetes [topic]

Learn Kubernetes for CKA exam with Mistress Louiza as your instructor.

Topics:
  basics, intro         - Kubernetes introduction
  pods, pod            - Learn about pods
  deployments          - Learn about deployments
  services             - Learn about services
  configmaps, secrets  - Learn about ConfigMaps and Secrets
  storage, volumes     - Learn about storage
  networking           - Learn about networking
  troubleshooting      - Learn troubleshooting
  cka-exam, exam       - CKA exam preparation
  practice             - Hands-on practice exercise

Examples:
  gtd-learn-kubernetes              # Interactive menu
  gtd-learn-kubernetes pods          # Learn about pods
  gtd-learn-kubernetes cka-exam      # Exam preparation

Features:
  ‚Ä¢ Mistress Louiza teaches Kubernetes concepts
  ‚Ä¢ Automatic study note creation
  ‚Ä¢ Progress tracking integrated with GTD
  ‚Ä¢ Practice exercises
  ‚Ä¢ CKA exam focus

Study notes saved to: ${K8S_STUDY_DIR}/notes/
Progress tracked in: ${K8S_STUDY_DIR}/progress/

EOF
}

# Handle arguments
case "$1" in
  --help|-h)
    show_usage
    exit 0
    ;;
  "")
    main ""
    ;;
  *)
    main "$1"
    ;;
esac

