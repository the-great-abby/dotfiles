#!/bin/bash
# GTD Morning Reminder - Morning motivation from Mistress Louiza

# Source common environment (PATH setup)
COMMON_ENV="$HOME/code/dotfiles/zsh/common_env.sh"
if [[ ! -f "$COMMON_ENV" && -f "$HOME/code/personal/dotfiles/zsh/common_env.sh" ]]; then
  COMMON_ENV="$HOME/code/personal/dotfiles/zsh/common_env.sh"
fi
if [[ -f "$COMMON_ENV" ]]; then
  source "$COMMON_ENV"
fi


# Load GTD config
GTD_CONFIG_FILE="$HOME/.gtd_config"
if [[ -f "$HOME/code/dotfiles/zsh/.gtd_config" ]]; then
  GTD_CONFIG_FILE="$HOME/code/dotfiles/zsh/.gtd_config"
elif [[ -f "$HOME/code/personal/dotfiles/zsh/.gtd_config" ]]; then
  GTD_CONFIG_FILE="$HOME/code/personal/dotfiles/zsh/.gtd_config"
fi

if [[ -f "$GTD_CONFIG_FILE" ]]; then
  source "$GTD_CONFIG_FILE"
fi

# Load daily log config
DAILY_LOG_CONFIG="$HOME/.daily_log_config"
if [[ -f "$HOME/code/dotfiles/zsh/.daily_log_config" ]]; then
  DAILY_LOG_CONFIG="$HOME/code/dotfiles/zsh/.daily_log_config"
elif [[ -f "$HOME/code/personal/dotfiles/zsh/.daily_log_config" ]]; then
  DAILY_LOG_CONFIG="$HOME/code/personal/dotfiles/zsh/.daily_log_config"
fi

if [[ -f "$DAILY_LOG_CONFIG" ]]; then
  source "$DAILY_LOG_CONFIG"
fi

# Source common GTD helpers (DRY - reuse existing helpers)
GTD_COMMON="$HOME/code/dotfiles/bin/gtd-common.sh"
if [[ ! -f "$GTD_COMMON" && -f "$HOME/code/personal/dotfiles/bin/gtd-common.sh" ]]; then
  GTD_COMMON="$HOME/code/personal/dotfiles/bin/gtd-common.sh"
fi
if [[ -f "$GTD_COMMON" ]]; then
  source "$GTD_COMMON"
else
  echo "Warning: gtd-common.sh not found. Some features may not work." >&2
fi

# Default values
DAILY_LOG_DIR="${DAILY_LOG_DIR:-$HOME/Documents/daily_logs}"
# GTD_BASE_DIR is already set by init_gtd_paths in gtd-common.sh (DRY - reuse existing helper)
GTD_MORNING_REMINDER_TIME="${GTD_MORNING_REMINDER_TIME:-08:00}"
GTD_NOTIFICATIONS="${GTD_NOTIFICATIONS:-true}"

# Get date command
get_date_cmd() {
  if [[ -x "/usr/bin/date" ]]; then
    echo "/usr/bin/date"
  elif [[ -x "/bin/date" ]]; then
    echo "/bin/date"
  else
    echo "date"
  fi
}

DATE_CMD=$(get_date_cmd)

# Get today's date
get_today() {
  $DATE_CMD +"%Y-%m-%d"
}

# Get today's daily log content (if exists)
get_todays_log() {
  local today=$(get_today)
  local log_file="${DAILY_LOG_DIR}/${today}.md"
  
  if [[ -f "$log_file" ]]; then
    cat "$log_file"
    return 0
  else
    return 1
  fi
}

# Check for lack of progress
check_lack_of_progress() {
  local today=$(get_today)
  local log_file="${DAILY_LOG_DIR}/${today}.md"
  
  # Check if no log exists
  if [[ ! -f "$log_file" ]]; then
    echo "no_log"
    return
  fi
  
  # Check entry count - use same pattern as other reminders for consistency
  # Pattern 1: Standard format "HH:MM - entry" (exactly 2 digits for hours and minutes)
  local entry_count=$(grep -c "^[0-9][0-9]:[0-9][0-9] -" "$log_file" 2>/dev/null || echo "0")
  
  # Fallback patterns
  if [[ "$entry_count" == "0" ]] || [[ -z "$entry_count" ]]; then
    entry_count=$(grep -cE "^[0-9]{1,2}:[0-9]{2}[[:space:]]*-" "$log_file" 2>/dev/null || echo "0")
  fi
  if [[ "$entry_count" == "0" ]] || [[ -z "$entry_count" ]]; then
    entry_count=$(grep -cE "^[0-9]{1,2}:[0-9]{2}" "$log_file" 2>/dev/null | grep -v "^#" | wc -l | tr -d ' ' || echo "0")
  fi
  
  # Ensure entry_count is numeric
  if [[ ! "$entry_count" =~ ^[0-9]+$ ]]; then
    entry_count=0
  fi
  
  # Check if last entry is old (more than 2 hours ago for morning, more than 4 hours for lunch)
  local last_entry_time=$(grep "^[0-9][0-9]:[0-9][0-9] -" "$log_file" 2>/dev/null | tail -1 | cut -d' ' -f1)
  if [[ -z "$last_entry_time" ]]; then
    echo "no_entries"
    return
  fi
  
  # Get current time
  local current_hour=$($DATE_CMD +"%H")
  local current_min=$($DATE_CMD +"%M")
  local entry_hour=$(echo "$last_entry_time" | cut -d':' -f1)
  local entry_min=$(echo "$last_entry_time" | cut -d':' -f2)
  
  # Convert to minutes (use 10# to force base-10, avoiding octal issues)
  local current_minutes=$((10#$current_hour * 60 + 10#$current_min))
  local entry_minutes=$((10#$entry_hour * 60 + 10#$entry_min))
  local diff=$((current_minutes - entry_minutes))
  
  # For morning (8 AM), if last entry was before 6 AM, it's old
  if [[ $diff -gt 120 ]]; then
    echo "old_entries"
    return
  fi
  
  if [[ $entry_count -eq 0 ]]; then
    echo "no_entries"
    return
  fi
  
  if [[ $entry_count -lt 2 ]]; then
    echo "low_entries"
    return
  fi
  
  echo "good"
}

# Get reminder message from Mistress Louiza
get_louiza_morning_message() {
  local has_log="$1"  # "yes" or "no"
  local progress_status="$2"  # "good", "no_log", "no_entries", "old_entries", "low_entries"
  
  # Find persona helper
  local persona_helper=""
  local possible_paths=(
    "$HOME/code/personal/dotfiles/zsh/functions/gtd_persona_helper.py"
    "$HOME/code/dotfiles/zsh/functions/gtd_persona_helper.py"
  )
  
  for path in "${possible_paths[@]}"; do
    if [[ -f "$path" ]]; then
      persona_helper="$path"
      break
    fi
  done
  
  if [[ -z "$persona_helper" || ! -f "$persona_helper" ]]; then
    return 1
  fi
  
  # Find python
  local python_cmd=""
  if [[ -f "/opt/homebrew/bin/python3" ]]; then
    python_cmd="/opt/homebrew/bin/python3"
  elif command -v python3 &>/dev/null; then
    python_cmd="python3"
  else
    return 1
  fi
  
  # Create prompt for Louiza based on progress
  local prompt=""
  local gtd_reminder="Remember: Use 'addInfoToDailyLog \"your entry\"' to log activities, 'gtd-capture' for quick notes, 'gtd-process' to process your inbox, and 'gtd-review daily' for evening reviews."
  
  # Punishment suggestions based on severity
  local punishment_hint=""
  case "$progress_status" in
    no_log)
      punishment_hint="Consider assigning punishments like: write an accountability letter, process entire inbox, log every hour for rest of day, or complete 3 tasks immediately."
      prompt="Good morning, ${GTD_USER_NAME:-Abby}. It's a new day and I see NO logging activity yet. This is unacceptable. I'm watching, and I expect to see progress. Give her a full, detailed morning message (at least 3-4 sentences). Scold ${GTD_USER_NAME:-Abby} firmly but constructively. Remind her that tracking everything is non-negotiable. Tell her to use 'addInfoToDailyLog' immediately. Be strict - no excuses. Use phrases like 'we need to talk' or 'this is not acceptable' when scolding, but also encourage with 'good girl' when she does log. Consider assigning a punishment: ${punishment_hint} Make this a complete, engaging message that sets the tone for the day. Include this GTD reminder: ${gtd_reminder}"
      ;;
    no_entries|old_entries)
      punishment_hint="Consider assigning punishments like: reconstruct the day from memory, process inbox, log every hour, or complete 2 tasks immediately."
      prompt="Good morning, ${GTD_USER_NAME:-Abby}. I see she started a log file but there are NO entries or the entries are very old. This is sloppy. Scold her firmly. Tell her that starting a log and not using it is worse than not starting at all. Remind her that I'm watching and expect consistent tracking. Be strict but constructive. Consider assigning a punishment: ${punishment_hint} Include this GTD reminder: ${gtd_reminder}"
      ;;
    low_entries)
      punishment_hint="Consider assigning punishments like: log every hour for rest of day, complete 1 task, or write a reflection on consistency."
      prompt="Good morning, ${GTD_USER_NAME:-Abby}. She has only 1 entry so far today. That's a start, but it's not enough. Be firm but encouraging. Remind her that I expect to see regular logging throughout the day. Tell her to keep using 'addInfoToDailyLog' frequently. Consider a light punishment: ${punishment_hint} Include this GTD reminder: ${gtd_reminder}"
      ;;
    good)
      # Get stats to extract entry count
      local stats=""
      if command -v gtd_get_log_stats &>/dev/null; then
        stats=$(gtd_get_log_stats)
      else
        # Fallback: try to get stats manually
        local today=$(get_today)
        local log_file="${DAILY_LOG_DIR}/${today}.md"
        if [[ -f "$log_file" ]]; then
          local entry_count=$(grep -c "^[0-9][0-9]:[0-9][0-9] -" "$log_file" 2>/dev/null || echo "0")
          if [[ "$entry_count" == "0" ]]; then
            entry_count=$(grep -cE "^[0-9]{1,2}:[0-9]{2}[[:space:]]*-" "$log_file" 2>/dev/null || echo "0")
          fi
          stats="Entries: $entry_count"
        fi
      fi
      local entry_count=$(echo "$stats" | grep -oE "Entries: [0-9]+" | grep -oE "[0-9]+" || echo "0")
      
      if [[ "$has_log" == "yes" && "$entry_count" != "0" ]]; then
        prompt="IMPORTANT: ${GTD_USER_NAME:-Abby} has ALREADY logged ${entry_count} entries today. This is GOOD progress - she IS tracking her activities. Do NOT say she has logged nothing or zero entries.\n\nGood morning, ${GTD_USER_NAME:-Abby}! She has already logged ${entry_count} entries today, which is excellent! Acknowledge these ${entry_count} entries she has already made. Give her a motivating message to encourage her to keep recording her progress throughout the day. Tell her 'good girl' or 'baby girl' for the ${entry_count} entries. Remind her that I'm watching and I'm pleased with her tracking so far (${entry_count} entries is great progress!). Be encouraging and acknowledge the work she's already done. Include this GTD reminder: ${gtd_reminder}"
      else
        prompt="Good morning, ${GTD_USER_NAME:-Abby}! It's a new day. Give her a full, detailed morning message (at least 3-4 sentences) to encourage her to start logging her daily progress. Remind her that I'm watching and I'll be proud when she logs her accomplishments. Tell her to use 'addInfoToDailyLog' to record what she does. Use phrases like 'good girl' or 'baby girl'. Be encouraging but firm about the importance of tracking everything. Make this a complete, engaging message that motivates her for the day ahead. Include this GTD reminder: ${gtd_reminder}"
      fi
      ;;
    *)
      prompt="Good morning, ${GTD_USER_NAME:-Abby}. Give her a full, detailed morning message (at least 3-4 sentences) to encourage her to log her daily progress. Remind her that I'm watching and I'll be proud when she logs her accomplishments. Tell her to use 'addInfoToDailyLog' to record what she does. Make this a complete, engaging message. Include this GTD reminder: ${gtd_reminder}"
      ;;
  esac
  
  # Get message from Louiza
  local full_output=$("$python_cmd" "$persona_helper" "louiza" "$prompt" "morning_reminder" 2>&1)
  
  if [[ -z "$full_output" ]]; then
    return 1
  fi
  
  # Check for errors
  if echo "$full_output" | grep -qE "Error|âš ï¸|timed out|Could not connect|KeyError"; then
    return 1
  fi
  
  # Extract message
  local louiza_message=$(echo "$full_output" | awk '
    /^â”+$/ {
      if (in_section) {
        exit
      }
      in_section = 1
      next
    }
    in_section && !/^ğŸ’¬/ && !/^â”/ {
      print
    }
  ' | sed 's/^[[:space:]]*//' | sed 's/[[:space:]]*$//')
  
  # Clean up - remove thinking tags, parentheses, brackets, markdown
  # First remove multiline think blocks (this deletes entire lines containing think tags)
  louiza_message=$(echo "$louiza_message" | sed '/<think>/,/<\/think>/d')
  # Then remove any single-line think blocks
  louiza_message=$(echo "$louiza_message" | sed 's/<think>.*<\/think>//g')
  # Remove any remaining orphaned tags
  louiza_message=$(echo "$louiza_message" | sed 's/<think>//g' | sed 's/<\/think>//g')
  # Remove parentheses, brackets, markdown
  louiza_message=$(echo "$louiza_message" | sed 's/([^)]*)//g' | sed 's/\[[^\]]*\]//g')
  louiza_message=$(echo "$louiza_message" | sed 's/\*\*//g')
  # Clean up extra whitespace
  louiza_message=$(echo "$louiza_message" | awk 'NF || prev_nf; {prev_nf=NF}')
  
  if [[ -n "$louiza_message" && ${#louiza_message} -gt 10 ]]; then
    echo "$louiza_message"
    return 0
  fi
  
  return 1
}

# Send message to Discord
send_discord_message() {
  local title="$1"
  local message="$2"
  local webhook_url="${GTD_DISCORD_WEBHOOK_URL:-}"
  
  if [[ -z "$webhook_url" ]]; then
    return 1
  fi
  
  # Clean message before sending - remove <think> tags and other artifacts
  # First remove multiline think blocks (this deletes entire lines containing think tags)
  message=$(echo "$message" | sed '/<think>/,/<\/think>/d')
  # Then remove any single-line think blocks
  message=$(echo "$message" | sed 's/<think>.*<\/think>//g')
  # Remove any remaining orphaned tags
  message=$(echo "$message" | sed 's/<think>//g' | sed 's/<\/think>//g')
  
  # Use Python to properly escape JSON and truncate if needed
  # Pass as arguments to avoid stdin issues
  local json_payload=$(python3 -c "
import json
import sys
import re
from datetime import datetime, timezone

title = sys.argv[1] if len(sys.argv) > 1 else 'GTD Notification'
message = sys.argv[2] if len(sys.argv) > 2 else ''

# Remove any remaining <think> tags (Python regex is more reliable for multiline)
message = re.sub(r'<think>.*?</think>', '', message, flags=re.DOTALL)
message = re.sub(r'<think>', '', message)
message = re.sub(r'</think>', '', message)

# Discord embed description limit is 2000 characters
if len(message) > 2000:
    truncated = message[:1900]
    last_newline = truncated.rfind('\n')
    last_period = truncated.rfind('.')
    cut_point = max(last_newline, last_period)
    if cut_point > 1500:
        message = message[:cut_point + 1] + '\n\n... (truncated)'
    else:
        message = message[:1900] + '\n\n... (truncated)'

payload = {
    'embeds': [{
        'title': title,
        'description': message,
        'color': 15158332,
        'timestamp': datetime.now(timezone.utc).isoformat()
    }]
}

print(json.dumps(payload))
" "$title" "$message")
  
  # Send to Discord
  local response=$(curl -s -w "\n%{http_code}" -X POST "$webhook_url" \
    -H "Content-Type: application/json" \
    -d "$json_payload" 2>&1)
  
  local http_code=$(echo "$response" | tail -1)
  
  if [[ "$http_code" == "204" ]]; then
    return 0
  else
    echo "âš ï¸  Discord send failed (HTTP $http_code)" >&2
    return 1
  fi
}

# Send morning reminder
send_morning_reminder() {
  if [[ "$GTD_NOTIFICATIONS" != "true" ]]; then
    return 0
  fi
  
  local today=$(get_today)
  local has_log="no"
  local log_content=""
  
  if get_todays_log > /dev/null 2>&1; then
    has_log="yes"
    log_content=$(get_todays_log)
  fi
  
  # Check for lack of progress
  local progress_status=$(check_lack_of_progress)
  
  local notify_cmd="$(dirname "$0")/gtd-notify"
  
  # Get message from Mistress Louiza
  local reminder_message=$(get_louiza_morning_message "$has_log" "$progress_status")
  
  # Get streak stats
  local stats_script="$(dirname "$0")/gtd-log-stats"
  if [[ ! -f "$stats_script" ]]; then
    stats_script="gtd-log-stats"
  fi
  local current_streak=$("$stats_script" streak 2>/dev/null || echo "0")
  local streak_info=""
  if [[ $current_streak -gt 0 ]]; then
    streak_info=$(printf "\n\nğŸ”¥ **Current Streak:** ${current_streak} day(s)")
  fi
  
  # Send to Discord if enabled
  if [[ "${GTD_DISCORD_DAILY_REMINDERS:-true}" == "true" && -n "${GTD_DISCORD_WEBHOOK_URL:-}" ]]; then
    if [[ -n "$reminder_message" ]]; then
      local discord_message="$reminder_message${streak_info}"
      if [[ "$has_log" == "yes" && -n "$log_content" ]]; then
        local log_preview=$(echo "$log_content" | head -5)
        discord_message=$(printf "%s\n\nğŸ“ **Today's Progress So Far:**\n\`\`\`\n%s\n\`\`\`\n\nğŸ’¡ Keep logging with: \`addInfoToDailyLog \"your entry\"\`" "$discord_message" "$log_preview")
      else
        discord_message=$(printf "%s\n\nğŸ’¡ Start logging with: \`addInfoToDailyLog \"your entry\"\`" "$discord_message")
      fi
      if send_discord_message "Mistress Louiza - Good Morning" "$discord_message"; then
        echo "âœ“ Sent to Discord" >&2
      fi
    else
      # Enhanced fallback with more context
      local fallback=""
      if [[ "$has_log" == "yes" ]]; then
        local entry_count=$(echo "$log_content" | grep -cE "^[0-9]{1,2}:[0-9]{2}" 2>/dev/null || echo "0")
        if [[ "$entry_count" -gt 0 ]]; then
          fallback="Good morning, ${GTD_USER_NAME:-Abby}! I see you've already logged ${entry_count} entry/entries today - that's great! Keep up the momentum and continue logging throughout the day. Use \`addInfoToDailyLog \"your entry\"\` to record your progress. I'm watching and I'm proud of your consistency! ğŸ‘€"
        else
          fallback="Good morning, ${GTD_USER_NAME:-Abby}! I see you started a log file but haven't added any entries yet. Let's change that! Use \`addInfoToDailyLog \"your entry\"\` to start recording your day. I'm watching and I expect to see progress! ğŸ‘€"
        fi
      else
        fallback="Good morning, ${GTD_USER_NAME:-Abby}! It's a new day and time to start logging. I'm watching and I expect to see you track your progress throughout the day. Use \`addInfoToDailyLog \"your entry\"\` to record what you're doing. Let's make today count! ğŸ‘€"
      fi
      send_discord_message "Mistress Louiza - Good Morning" "$fallback"
    fi
  fi
  
  # Also send macOS notification
  if [[ -n "$reminder_message" ]]; then
    local short_message=$(echo "$reminder_message" | cut -c1-150)
    if [[ ${#short_message} -lt 20 ]]; then
      short_message="Good morning! Time to log your progress, baby girl."
    fi
    "$notify_cmd" "Mistress Louiza" "$short_message" "Start logging your day" "Ping" 2>/dev/null || true
  else
    "$notify_cmd" "GTD Morning" "Time to start logging your day" "Use addInfoToDailyLog" "Ping" 2>/dev/null || true
  fi
  
  # Print to terminal
  echo ""
  echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
  echo "ğŸŒ… Morning Reminder from Mistress Louiza"
  echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
  echo ""
  
  if [[ -n "$reminder_message" ]]; then
    echo "ğŸ’¬ From Mistress Louiza:"
    echo ""
    echo "$reminder_message" | sed 's/^/   /'
    echo ""
  fi
  
  if [[ "$has_log" == "yes" ]]; then
    echo "ğŸ“ You've already started logging today - good girl!"
    echo "   Keep it up with: addInfoToDailyLog \"your entry\""
  else
    echo "ğŸ“ Start logging your day:"
    echo "   addInfoToDailyLog \"your entry\""
  fi
  echo ""
  echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
  echo ""
}

# Main
case "$1" in
  --force)
    send_morning_reminder
    ;;
  "")
    send_morning_reminder
    ;;
  *)
    echo "Usage: gtd-morning-reminder [--force]"
    exit 1
    ;;
esac

