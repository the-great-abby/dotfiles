#!/bin/bash
# GTD Second Brain - Enhanced Distill Workflow
# Explicit workflow for progressive summarization

# Load GTD config
GTD_CONFIG_FILE="$HOME/.gtd_config"
if [[ -f "$HOME/code/dotfiles/zsh/.gtd_config" ]]; then
  GTD_CONFIG_FILE="$HOME/code/dotfiles/zsh/.gtd_config"
elif [[ -f "$HOME/code/personal/dotfiles/zsh/.gtd_config" ]]; then
  GTD_CONFIG_FILE="$HOME/code/personal/dotfiles/zsh/.gtd_config"
fi

if [[ -f "$GTD_CONFIG_FILE" ]]; then
  source "$GTD_CONFIG_FILE"
fi

# Default values
SECOND_BRAIN="${SECOND_BRAIN:-$HOME/Documents/obsidian/Second Brain}"

# Colors
CYAN='\033[0;36m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BOLD='\033[1m'
NC='\033[0m'

# Get date command
get_date_cmd() {
  if [[ -x "/usr/bin/date" ]]; then
    echo "/usr/bin/date"
  elif [[ -x "/bin/date" ]]; then
    echo "/bin/date"
  else
    echo "date"
  fi
}

DATE_CMD=$(get_date_cmd)

# Distill workflow wizard
distill_workflow() {
  local note_path="$1"
  
  if [[ -z "$note_path" ]]; then
    echo "âŒ Note path required"
    echo "Usage: gtd-brain-distill <note-path>"
    return 1
  fi
  
  # Expand if relative path
  if [[ "$note_path" != /* ]]; then
    local found_note=$(find "$SECOND_BRAIN" -name "$(basename "$note_path")" -type f 2>/dev/null | head -1)
    if [[ -n "$found_note" ]]; then
      note_path="$found_note"
    fi
  fi
  
  if [[ ! -f "$note_path" ]]; then
    echo "âŒ Note not found: $note_path"
    return 1
  fi
  
  local note_name=$(basename "$note_path" .md)
  local today=$($DATE_CMD +"%Y-%m-%d")
  
  echo ""
  echo -e "${BOLD}${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
  echo -e "${BOLD}${CYAN}ğŸ”¬ Distill Workflow: ${note_name}${NC}"
  echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
  echo ""
  
  # Check current distill level
  local has_summary=$(grep -q "## Summary" "$note_path" 2>/dev/null && echo "yes" || echo "no")
  local has_insights=$(grep -q "## Core Insights" "$note_path" 2>/dev/null && echo "yes" || echo "no")
  
  echo "Current distill status:"
  echo "  Level 1 (Highlights): Manual - review the note"
  echo "  Level 2 (Summary): $has_summary"
  echo "  Level 3 (Core Insights): $has_insights"
  echo ""
  
  # Level 1: Highlights
  echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
  echo "ğŸ“ Level 1: Highlights"
  echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
  echo ""
  echo "Have you highlighted key points in the note? (y/n)"
  read -p "   " has_highlights
  echo ""
  
  if [[ "$has_highlights" != "y" && "$has_highlights" != "Y" ]]; then
    echo "ğŸ’¡ Open the note and highlight important sentences:"
    echo "   $note_path"
    echo ""
    read -p "Press Enter when done highlighting..."
  fi
  
  # Level 2: Summary
  echo ""
  echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
  echo "ğŸ“ Level 2: Summary"
  echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
  echo ""
  
  if [[ "$has_summary" == "no" ]]; then
    echo "Creating summary section..."
    if ! grep -q "## Summary" "$note_path"; then
      echo "" >> "$note_path"
      echo "## Summary" >> "$note_path"
      echo "" >> "$note_path"
      echo "<!-- Add a brief summary of the key points -->" >> "$note_path"
      echo "" >> "$note_path"
    fi
    echo "âœ“ Summary section created"
  else
    echo "âœ“ Summary section already exists"
  fi
  
  echo ""
  echo "Add your summary now? (y/n)"
  read -p "   " add_summary
  if [[ "$add_summary" == "y" || "$add_summary" == "Y" ]]; then
    echo ""
    echo "Enter your summary (Ctrl+D when done):"
    local summary=$(cat)
    if [[ -n "$summary" ]]; then
      # Replace placeholder or add to summary
      if grep -q "<!-- Add a brief summary" "$note_path"; then
        if [[ "$OSTYPE" == "darwin"* ]]; then
          sed -i '' "/<!-- Add a brief summary/,/-->/c\\
## Summary\\
\\
${summary}\\
" "$note_path"
        else
          sed -i "/<!-- Add a brief summary/,/-->/c\\## Summary\n\n${summary}" "$note_path"
        fi
      else
        # Append to existing summary
        echo "" >> "$note_path"
        echo "${summary}" >> "$note_path"
      fi
      echo "âœ“ Summary added"
    fi
  fi
  
  # Level 3: Core Insights
  echo ""
  echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
  echo "ğŸ“ Level 3: Core Insights"
  echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
  echo ""
  
  if [[ "$has_insights" == "no" ]]; then
    echo "Creating core insights section..."
    if ! grep -q "## Core Insights" "$note_path"; then
      echo "" >> "$note_path"
      echo "## Core Insights" >> "$note_path"
      echo "" >> "$note_path"
      echo "<!-- Distill to the most important insights -->" >> "$note_path"
      echo "" >> "$note_path"
    fi
    echo "âœ“ Core insights section created"
  else
    echo "âœ“ Core insights section already exists"
  fi
  
  echo ""
  echo "Add your core insights now? (y/n)"
  read -p "   " add_insights
  if [[ "$add_insights" == "y" || "$add_insights" == "Y" ]]; then
    echo ""
    echo "Enter your core insights (Ctrl+D when done):"
    local insights=$(cat)
    if [[ -n "$insights" ]]; then
      # Replace placeholder or add to insights
      if grep -q "<!-- Distill to the most important" "$note_path"; then
        if [[ "$OSTYPE" == "darwin"* ]]; then
          sed -i '' "/<!-- Distill to the most important/,/-->/c\\
## Core Insights\\
\\
${insights}\\
" "$note_path"
        else
          sed -i "/<!-- Distill to the most important/,/-->/c\\## Core Insights\n\n${insights}" "$note_path"
        fi
      else
        # Append to existing insights
        echo "" >> "$note_path"
        echo "${insights}" >> "$note_path"
      fi
      echo "âœ“ Core insights added"
    fi
  fi
  
  # Add distill metadata
  if ! grep -q "## Distill Progress" "$note_path"; then
    echo "" >> "$note_path"
    echo "## Distill Progress" >> "$note_path"
    echo "" >> "$note_path"
  fi
  
  # Update progress
  local progress_entry="- ${today}: Completed distill workflow"
  if ! grep -q "$progress_entry" "$note_path"; then
    if [[ "$OSTYPE" == "darwin"* ]]; then
      sed -i '' "/^## Distill Progress$/a\\
${progress_entry}
" "$note_path"
    else
      sed -i "/^## Distill Progress$/a\\${progress_entry}" "$note_path"
    fi
  fi
  
  echo ""
  echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
  echo "âœ“ Distill workflow completed!"
  echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
  echo ""
  echo "Note: $note_path"
  echo ""
}

# Show usage
show_usage() {
  cat <<EOF
Usage: gtd-brain-distill <note-path>

Enhanced distill workflow for progressive summarization.

The workflow guides you through:
  1. Level 1: Highlight key points
  2. Level 2: Create summary
  3. Level 3: Distill to core insights

Examples:
  gtd-brain-distill ~/Documents/obsidian/Second\ Brain/Resources/note.md
  gtd-brain-distill note.md

EOF
}

# Main command handler
case "${1:-}" in
  help|--help|-h)
    show_usage
    ;;
  "")
    show_usage
    ;;
  *)
    distill_workflow "$1"
    ;;
esac

