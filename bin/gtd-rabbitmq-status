#!/bin/bash
# Check RabbitMQ Queue Status
# Shows messages, consumers, and processing status for GTD queues

set -e

# Colors
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
CYAN='\033[0;36m'
BOLD='\033[1m'
NC='\033[0m' # No Color

# Find Python executable (prefer virtualenv)
MCP_VENV="$HOME/code/dotfiles/mcp/venv/bin/python3"
if [[ ! -f "$MCP_VENV" ]]; then
    MCP_VENV="$HOME/code/personal/dotfiles/mcp/venv/bin/python3"
fi

if [[ -f "$MCP_VENV" ]]; then
    PYTHON_CMD="$MCP_VENV"
else
    PYTHON_CMD="python3"
fi

# Read config
GTD_CONFIG_DIR="${HOME}/code/dotfiles/zsh"
if [[ -f "${GTD_CONFIG_DIR}/.gtd_config_database" ]]; then
    source "${GTD_CONFIG_DIR}/.gtd_config_database"
fi

# Get RabbitMQ settings
RABBITMQ_URL="${RABBITMQ_URL:-amqp://localhost:5672}"
RABBITMQ_USER="${RABBITMQ_USER:-guest}"
RABBITMQ_PASS="${RABBITMQ_PASS:-guest}"

# Build URL with credentials if not in URL
if [[ "$RABBITMQ_URL" != *"@"* ]]; then
    if [[ -n "$RABBITMQ_USER" ]]; then
        if [[ -n "$RABBITMQ_PASS" ]]; then
            RABBITMQ_URL="amqp://${RABBITMQ_USER}:${RABBITMQ_PASS}@${RABBITMQ_URL#amqp://}"
        else
            RABBITMQ_URL="amqp://${RABBITMQ_USER}@${RABBITMQ_URL#amqp://}"
        fi
    fi
fi

echo -e "${BOLD}${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo -e "${BOLD}${CYAN}ğŸ“Š RabbitMQ Queue Status${NC}"
echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo ""

# Check RabbitMQ connection and get queue stats
export RABBITMQ_URL_TO_CHECK="$RABBITMQ_URL"
"$PYTHON_CMD" << 'EOF'
import os
import sys
import json
import pika
from datetime import datetime

rabbitmq_url = os.environ.get('RABBITMQ_URL_TO_CHECK')
if not rabbitmq_url:
    print("\033[0;31mâŒ Error: RABBITMQ_URL_TO_CHECK not set\033[0m")
    sys.exit(1)

deep_queue = "gtd_deep_analysis"
vector_queue = "gtd_vectorization"

try:
    # Connect to RabbitMQ with timeout
    # Note: pika uses connection_attempts and retry_delay for connection timeouts
    # For socket timeout, we use socket_timeout in URLParameters
    params = pika.URLParameters(rabbitmq_url)
    params.socket_timeout = 5  # 5 second socket timeout
    params.connection_attempts = 2  # Only try twice
    params.retry_delay = 2  # Wait 2 seconds between attempts
    
    connection = pika.BlockingConnection(params)
    channel = connection.channel()
    
    print("\033[0;32mâœ… Connected to RabbitMQ\033[0m")
    print(f"   URL: {rabbitmq_url.split('@')[-1]}")  # Hide credentials
    print("")
    
    # Helper to get queue info
    def get_queue_info(queue_name):
        try:
            # Declare queue (passive=False to create if needed)
            result = channel.queue_declare(queue=queue_name, durable=True, passive=False)
            message_count = result.method.message_count
            consumer_count = result.method.consumer_count
            
            # Get queue details
            queue_info = {
                'name': queue_name,
                'messages': message_count,
                'consumers': consumer_count,
                'exists': True
            }
            
            # Try to get more details (may not work on all RabbitMQ versions)
            try:
                # Get messages ready/unacknowledged
                queue_stats = channel.queue_declare(queue=queue_name, durable=True, passive=True)
                queue_info['messages_ready'] = queue_stats.method.message_count
            except:
                pass
                
            return queue_info
        except Exception as e:
            return {
                'name': queue_name,
                'messages': 0,
                'consumers': 0,
                'exists': False,
                'error': str(e)
            }
    
    # Check Deep Analysis queue
    print("\033[1mDeep Analysis Queue:\033[0m")
    deep_info = get_queue_info(deep_queue)
    if deep_info['exists']:
        print(f"   Queue: \033[0;36m{deep_info['name']}\033[0m")
        print(f"   Messages waiting: \033[0;33m{deep_info['messages']}\033[0m")
        print(f"   Active consumers: \033[0;32m{deep_info['consumers']}\033[0m")
        
        if deep_info['messages'] > 0 and deep_info['consumers'] == 0:
            print("   \033[1;33mâš ï¸  Warning: Messages queued but no consumers!\033[0m")
            print("      Start worker: make worker-deep-start")
            print("      Check status: make worker-status")
        elif deep_info['messages'] == 0 and deep_info['consumers'] > 0:
            print("   \033[0;32mâœ… Queue empty, worker waiting for jobs\033[0m")
        elif deep_info['messages'] > 0 and deep_info['consumers'] > 0:
            print("   \033[0;32mğŸ”„ Jobs being processed\033[0m")
        else:
            print("   \033[0;36mâ„¹ï¸  Queue empty, no workers connected\033[0m")
    else:
        print(f"   \033[1;33mâš ï¸  Queue '{deep_queue}' not found\033[0m")
    print("")
    
    # Check Vectorization queue
    print("\033[1mVectorization Queue:\033[0m")
    vector_info = get_queue_info(vector_queue)
    if vector_info['exists']:
        print(f"   Queue: \033[0;36m{vector_info['name']}\033[0m")
        print(f"   Messages waiting: \033[0;33m{vector_info['messages']}\033[0m")
        print(f"   Active consumers: \033[0;32m{vector_info['consumers']}\033[0m")
        
        if vector_info['messages'] > 0 and vector_info['consumers'] == 0:
            print("   \033[1;33mâš ï¸  Warning: Messages queued but no consumers!\033[0m")
            print("      Start worker: make worker-vector-start")
            print("      Check status: make worker-status")
        elif vector_info['messages'] == 0 and vector_info['consumers'] > 0:
            print("   \033[0;32mâœ… Queue empty, worker waiting for jobs\033[0m")
        elif vector_info['messages'] > 0 and vector_info['consumers'] > 0:
            print("   \033[0;32mğŸ”„ Jobs being processed\033[0m")
        else:
            print("   \033[0;36mâ„¹ï¸  Queue empty, no workers connected\033[0m")
    else:
        print(f"   \033[1;33mâš ï¸  Queue '{vector_queue}' not found\033[0m")
    print("")
    
    connection.close()
    
except ImportError:
    print("\033[0;31mâŒ Error: pika not installed\033[0m")
    print("   Install with: pip install pika")
    print("   Or in virtualenv: $HOME/code/dotfiles/mcp/venv/bin/pip install pika")
    sys.exit(1)
except (pika.exceptions.AMQPConnectionError, ConnectionRefusedError, OSError) as e:
    print("\033[0;31mâŒ Cannot connect to RabbitMQ\033[0m")
    error_msg = str(e) if str(e) else "Connection refused"
    print(f"   Error: {error_msg}")
    print("")
    print("   Make sure:")
    print("   1. RabbitMQ is running")
    print("   2. Port-forward is active (if using Kubernetes):")
    print("      kubectl port-forward -n rabbitmq-system svc/rabbitmq 5672:5672 15672:15672 15692:15692")
    print("   3. Check if port-forward is running:")
    print("      ps aux | grep 'kubectl port-forward.*5672'")
    print("   4. RABBITMQ_URL is correct in .gtd_config_database")
    print("")
    print("   Quick check: nc -zv localhost 5672")
    sys.exit(1)
except Exception as e:
    print(f"\033[0;31mâŒ Error: {e}\033[0m")
    sys.exit(1)
EOF

# Also show file queue status (fallback)
echo -e "${BOLD}File Queue Status (Fallback):${NC}"
echo ""

# Deep Analysis file queue
DEEP_QUEUE_FILE="${HOME}/Documents/gtd/deep_analysis_queue.jsonl"
if [[ -f "$DEEP_QUEUE_FILE" ]]; then
    deep_count=$(wc -l < "$DEEP_QUEUE_FILE" 2>/dev/null || echo "0")
    if [[ "$deep_count" -gt 0 ]]; then
        echo -e "   Deep Analysis: \033[0;33m$deep_count message(s)\033[0m"
        echo -e "   File: \033[0;36m$DEEP_QUEUE_FILE\033[0m"
    else
        echo -e "   Deep Analysis: \033[0;32mEmpty\033[0m"
    fi
else
    echo -e "   Deep Analysis: \033[0;36mNo queue file\033[0m"
fi

# Vectorization file queue
VECTOR_QUEUE_FILE="${HOME}/Documents/gtd/vectorization_queue.jsonl"
if [[ -f "$VECTOR_QUEUE_FILE" ]]; then
    vector_count=$(wc -l < "$VECTOR_QUEUE_FILE" 2>/dev/null || echo "0")
    if [[ "$vector_count" -gt 0 ]]; then
        echo -e "   Vectorization: \033[0;33m$vector_count message(s)\033[0m"
        echo -e "   File: \033[0;36m$VECTOR_QUEUE_FILE\033[0m"
    else
        echo -e "   Vectorization: \033[0;32mEmpty\033[0m"
    fi
else
    echo -e "   Vectorization: \033[0;36mNo queue file\033[0m"
fi

echo ""
echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
