#!/bin/bash
# GTD Area Command - Areas of responsibility management

# Source common environment (PATH setup)
COMMON_ENV="$HOME/code/dotfiles/zsh/common_env.sh"
if [[ ! -f "$COMMON_ENV" && -f "$HOME/code/personal/dotfiles/zsh/common_env.sh" ]]; then
  COMMON_ENV="$HOME/code/personal/dotfiles/zsh/common_env.sh"
fi
if [[ -f "$COMMON_ENV" ]]; then
  source "$COMMON_ENV"
fi

# Load GTD config
GTD_CONFIG_FILE="$HOME/.gtd_config"
if [[ -f "$HOME/code/personal/dotfiles/zsh/.gtd_config" ]]; then
  GTD_CONFIG_FILE="$HOME/code/personal/dotfiles/zsh/.gtd_config"
fi

# Source config if it exists
if [[ -f "$GTD_CONFIG_FILE" ]]; then
  source "$GTD_CONFIG_FILE"
fi

# Default values
GTD_BASE_DIR="${GTD_BASE_DIR:-$HOME/Documents/gtd}"
AREAS_PATH="${GTD_BASE_DIR}/${GTD_AREAS_DIR:-2-areas}"
PROJECTS_PATH="${GTD_BASE_DIR}/${GTD_PROJECTS_DIR:-1-projects}"
TASKS_PATH="${GTD_BASE_DIR}/tasks"
ARCHIVE_PATH="${GTD_BASE_DIR}/${GTD_ARCHIVE_DIR:-6-archive}"

mkdir -p "$AREAS_PATH" "$ARCHIVE_PATH"

# Source selection helper
SELECT_HELPER="$HOME/code/dotfiles/bin/gtd-select-helper.sh"
if [[ ! -f "$SELECT_HELPER" && -f "$HOME/code/personal/dotfiles/bin/gtd-select-helper.sh" ]]; then
  SELECT_HELPER="$HOME/code/personal/dotfiles/bin/gtd-select-helper.sh"
fi
if [[ -f "$SELECT_HELPER" ]]; then
  source "$SELECT_HELPER"
fi

TODAY=$(date +"%Y-%m-%d")
NOW=$(date +"%H:%M")

# Extract frontmatter value
get_frontmatter_value() {
  local file="$1"
  local key="$2"
  grep "^${key}:" "$file" 2>/dev/null | head -1 | cut -d':' -f2 | sed 's/^[[:space:]]*//' | sed 's/[[:space:]]*$//'
}

# Update frontmatter value
update_frontmatter_value() {
  local file="$1"
  local key="$2"
  local value="$3"
  
  if grep -q "^${key}:" "$file" 2>/dev/null; then
    if [[ "$OSTYPE" == "darwin"* ]]; then
      sed -i '' "s/^${key}:.*/${key}: ${value}/" "$file"
    else
      sed -i "s/^${key}:.*/${key}: ${value}/" "$file"
    fi
  else
    if [[ "$OSTYPE" == "darwin"* ]]; then
      sed -i '' "/^---$/a\\
${key}: ${value}
" "$file"
    else
      sed -i "/^---$/a\\${key}: ${value}" "$file"
    fi
  fi
}

# Create area
create_area() {
  local area_name="$*"
  if [[ -z "$area_name" ]]; then
    read -p "Area name: " area_name
  fi
  
  area_name=$(echo "$area_name" | tr ' ' '-' | tr '[:upper:]' '[:lower:]')
  local area_file="${AREAS_PATH}/${area_name}.md"
  
  if [[ -f "$area_file" ]]; then
    echo "âš ï¸  Area already exists: $area_name"
    exit 1
  fi
  
  # Get description
  read -p "Description: " description
  
  # Create area file
  cat > "$area_file" <<EOF
---
type: area
status: active
created: ${TODAY}T${NOW}
area: ${area_name}
tags: []
---

# ${area_name}

## Description
${description}

## Goals


## Current Focus


## Projects in this Area


## Tasks in this Area


## Notes


EOF
  
  echo "âœ“ Created area: $area_name"
  echo "  File: $area_file"
}

# List areas
list_areas() {
  echo ""
  echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
  echo "ğŸ“‚ Areas of Responsibility"
  echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
  echo ""
  
  local areas=($(find "$AREAS_PATH" -type f -name "*.md" 2>/dev/null))
  local count=${#areas[@]}
  
  if [[ $count -eq 0 ]]; then
    echo "No areas defined yet."
    echo ""
    echo "Create one with: gtd-area create <name>"
    return
  fi
  
  for area_file in "${areas[@]}"; do
    local area_name=$(basename "$area_file" .md)
    local status=$(get_frontmatter_value "$area_file" "status")
    local created=$(get_frontmatter_value "$area_file" "created")
    local description=$(get_frontmatter_value "$area_file" "description")
    
    # Count related projects and tasks
    local project_count=0
    local task_count=0
    
    # Count projects with this area
    if [[ -d "$PROJECTS_PATH" ]]; then
      while IFS= read -r project_dir; do
        local readme="${project_dir}/README.md"
        if [[ -f "$readme" ]]; then
          local project_area=$(get_frontmatter_value "$readme" "area")
          if [[ "$project_area" == "$area_name" ]]; then
            ((project_count++))
          fi
        fi
      done < <(find "$PROJECTS_PATH" -type d -mindepth 1 -maxdepth 1 2>/dev/null)
    fi
    
    # Count tasks with this area
    if [[ -d "$TASKS_PATH" ]]; then
      while IFS= read -r task_file; do
        local task_area=$(get_frontmatter_value "$task_file" "area")
        if [[ "$task_area" == "$area_name" ]]; then
          ((task_count++))
        fi
      done < <(find "$TASKS_PATH" -type f -name "*.md" 2>/dev/null)
    fi
    
    echo "[$area_name]"
    echo "  Status: $status | Created: $created"
    if [[ -n "$description" ]]; then
      echo "  Description: $description"
    fi
    echo "  Projects: $project_count | Tasks: $task_count"
    echo ""
  done
  
  echo "Total: $count area(s)"
}

# View area
view_area() {
  local area_name="$1"
  if [[ -z "$area_name" ]]; then
    echo "Usage: gtd-area view <area-name>"
    exit 1
  fi
  
  area_name=$(echo "$area_name" | tr ' ' '-' | tr '[:upper:]' '[:lower:]')
  local area_file="${AREAS_PATH}/${area_name}.md"
  
  if [[ ! -f "$area_file" ]]; then
    echo "âŒ Area not found: $area_name"
    exit 1
  fi
  
  echo ""
  echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
  echo "ğŸ“‚ Area: $area_name"
  echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
  echo ""
  
  # Show area file
  cat "$area_file"
  echo ""
  
  # Show related projects
  echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
  echo "ğŸ“ Related Projects"
  echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
  echo ""
  
  local project_found=false
  if [[ -d "$PROJECTS_PATH" ]]; then
    while IFS= read -r project_dir; do
      local readme="${project_dir}/README.md"
      if [[ -f "$readme" ]]; then
        local project_area=$(get_frontmatter_value "$readme" "area")
        if [[ "$project_area" == "$area_name" ]]; then
          project_found=true
          local project_name=$(basename "$project_dir")
          local project_status=$(get_frontmatter_value "$readme" "status")
          echo "  â€¢ $project_name (status: $project_status)"
        fi
      fi
    done < <(find "$PROJECTS_PATH" -type d -mindepth 1 -maxdepth 1 2>/dev/null)
  fi
  
  if [[ "$project_found" == "false" ]]; then
    echo "  No projects in this area"
  fi
  echo ""
  
  # Show related tasks
  echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
  echo "ğŸ“‹ Related Tasks"
  echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
  echo ""
  
  local task_found=false
  if [[ -d "$TASKS_PATH" ]]; then
    while IFS= read -r task_file; do
      local task_area=$(get_frontmatter_value "$task_file" "area")
      if [[ "$task_area" == "$area_name" ]]; then
        task_found=true
        local task_name=$(head -20 "$task_file" | grep "^# " | head -1 | sed 's/^# //')
        local task_status=$(get_frontmatter_value "$task_file" "status")
        local task_context=$(get_frontmatter_value "$task_file" "context")
        echo "  â€¢ $task_name (status: $task_status, context: $task_context)"
      fi
    done < <(find "$TASKS_PATH" -type f -name "*.md" 2>/dev/null)
  fi
  
  if [[ "$task_found" == "false" ]]; then
    echo "  No tasks in this area"
  fi
  echo ""
}

# Add task to area
add_task_to_area() {
  local area_name="$1"
  shift
  local task_desc="$*"
  
  if [[ -z "$area_name" || -z "$task_desc" ]]; then
    echo "Usage: gtd-area add-task <area-name> <task-description>"
    exit 1
  fi
  
  area_name=$(echo "$area_name" | tr ' ' '-' | tr '[:upper:]' '[:lower:]')
  local area_file="${AREAS_PATH}/${area_name}.md"
  
  if [[ ! -f "$area_file" ]]; then
    echo "âŒ Area not found: $area_name"
    exit 1
  fi
  
  # Use gtd-task to create the task, then assign to area
  local timestamp=$(date +"%Y%m%d%H%M%S")
  local filename="${timestamp}-task.md"
  local filepath="${TASKS_PATH}/${filename}"
  
  mkdir -p "$TASKS_PATH"
  
  read -p "Context (home/office/computer/phone/errands): " context
  read -p "Energy level (low/medium/high/creative/administrative): " energy
  
  cat > "$filepath" <<EOF
---
type: task
status: active
created: ${TODAY}T${NOW}
area: ${area_name}
context: ${context:-computer}
energy: ${energy:-medium}
tags: []
---

# ${task_desc}

## Next Action
${task_desc}

## Notes


EOF
  
  echo "âœ“ Added task to area: $area_name"
  echo "  Task: $task_desc"
  echo "  File: $filepath"
}

# Add project to area
add_project_to_area() {
  local area_name="$1"
  shift
  local project_name="$*"
  
  if [[ -z "$area_name" || -z "$project_name" ]]; then
    echo "Usage: gtd-area add-project <area-name> <project-name>"
    exit 1
  fi
  
  area_name=$(echo "$area_name" | tr ' ' '-' | tr '[:upper:]' '[:lower:]')
  local area_file="${AREAS_PATH}/${area_name}.md"
  
  if [[ ! -f "$area_file" ]]; then
    echo "âŒ Area not found: $area_name"
    exit 1
  fi
  
  # Create project and assign to area
  project_name=$(echo "$project_name" | tr ' ' '-' | tr '[:upper:]' '[:lower:]')
  local project_dir="${PROJECTS_PATH}/${project_name}"
  
  if [[ -d "$project_dir" ]]; then
    # Project exists, just assign area
    local readme="${project_dir}/README.md"
    if [[ -f "$readme" ]]; then
      update_frontmatter_value "$readme" "area" "$area_name"
      echo "âœ“ Assigned existing project to area: $area_name"
    fi
  else
    # Create new project
    mkdir -p "$project_dir"
    cat > "${project_dir}/README.md" <<EOF
---
type: project
status: active
created: ${TODAY}T${NOW}
project: ${project_name}
area: ${area_name}
tags: []
---

# ${project_name}

## Description


## Goals


## Next Actions


## Tasks

EOF
    echo "âœ“ Created project in area: $area_name"
    echo "  Project: $project_name"
    echo "  Location: $project_dir"
  fi
}

# Review area
review_area() {
  local area_name="$1"
  if [[ -z "$area_name" ]]; then
    echo "Usage: gtd-area review <area-name>"
    exit 1
  fi
  
  area_name=$(echo "$area_name" | tr ' ' '-' | tr '[:upper:]' '[:lower:]')
  local area_file="${AREAS_PATH}/${area_name}.md"
  
  if [[ ! -f "$area_file" ]]; then
    echo "âŒ Area not found: $area_name"
    exit 1
  fi
  
  echo ""
  echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
  echo "ğŸ“‚ Area Review: $area_name"
  echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
  echo ""
  
  # Review questions
  echo "1. How is this area doing overall?"
  read -p "   " area_status
  echo ""
  
  echo "2. What needs attention in this area?"
  read -p "   " area_attention
  echo ""
  
  echo "3. What are the current priorities?"
  read -p "   " area_priorities
  echo ""
  
  echo "4. What's blocking progress?"
  read -p "   " area_blockers
  echo ""
  
  # Append to area file
  cat >> "$area_file" <<EOF

## Review - ${TODAY}

### Overall Status
${area_status}

### Needs Attention
${area_attention}

### Current Priorities
${area_priorities}

### Blockers
${area_blockers}

EOF
  
  echo "âœ“ Review added to area: $area_name"
}

# Review all areas systematically
review_all_areas() {
  echo ""
  echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
  echo "ğŸ¯ Comprehensive Area Review"
  echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
  echo ""
  
  local areas=($(find "$AREAS_PATH" -type f -name "*.md" 2>/dev/null | sort))
  local area_count=${#areas[@]}
  
  if [[ $area_count -eq 0 ]]; then
    echo "No areas defined yet."
    echo ""
    echo "Would you like to create starter areas?"
    read -p "  (y/n): " create_areas
    if [[ "$create_areas" == "y" || "$create_areas" == "Y" ]]; then
      if command -v gtd-area-starter &>/dev/null; then
        gtd-area-starter
      else
        echo "Run: gtd-area create \"Area Name\""
      fi
    fi
    return 0
  fi
  
  echo "Reviewing ${area_count} area(s) of responsibility..."
  echo ""
  echo "For each area, consider:"
  echo "  âœ“ Is it still relevant?"
  echo "  âœ“ Does it need regular attention?"
  echo "  âœ“ Are standards being met?"
  echo "  âœ“ Should it be archived or merged?"
  echo ""
  echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
  echo ""
  
  local areas_to_archive=()
  local areas_to_merge=()
  local areas_needing_attention=()
  
  for area_file in "${areas[@]}"; do
    local area_name=$(basename "$area_file" .md | tr '-' ' ' | sed 's/\b\(.\)/\u\1/g')
    local area_slug=$(basename "$area_file" .md)
    local status=$(grep "^status:" "$area_file" 2>/dev/null | head -1 | cut -d':' -f2 | sed 's/^[[:space:]]*//' || echo "active")
    local last_review=$(grep "^## Review -" "$area_file" 2>/dev/null | tail -1 | sed 's/^## Review - //' || echo "Never")
    
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo "ğŸ“‚ ${area_name}"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo ""
    echo "Status: ${status}"
    echo "Last reviewed: ${last_review}"
    echo ""
    
    # Show related projects and tasks
    local project_count=0
    local task_count=0
    
    if [[ -d "$PROJECTS_PATH" ]]; then
      project_count=$(find "$PROJECTS_PATH" -type f -name "README.md" -exec grep -l "area: ${area_slug}" {} \; 2>/dev/null | wc -l | tr -d ' ')
    fi
    
    if [[ -d "$TASKS_PATH" ]]; then
      task_count=$(find "$TASKS_PATH" -type f -name "*.md" -exec grep -l "area: ${area_slug}" {} \; 2>/dev/null | wc -l | tr -d ' ')
    fi
    
    echo "Related items:"
    echo "  â€¢ Projects: ${project_count}"
    echo "  â€¢ Tasks: ${task_count}"
    echo ""
    
    # Review questions
    echo "1. Is this area still relevant to your life? (y/n/archive)"
    read -p "   " is_relevant
    echo ""
    
    if [[ "$is_relevant" == "archive" || "$is_relevant" == "a" ]]; then
      areas_to_archive+=("$area_slug")
      echo "   â†’ Marked for archiving"
    elif [[ "$is_relevant" == "n" || "$is_relevant" == "no" ]]; then
      echo "2. Should it be merged with another area? (y/n)"
      read -p "   " should_merge
      if [[ "$should_merge" == "y" || "$should_merge" == "Y" ]]; then
        echo "   Which area should it merge with?"
        echo ""
        if [[ -d "$AREAS_PATH" ]] && [[ -n "$(find "$AREAS_PATH" -type f -name "*.md" 2>/dev/null)" ]]; then
          merge_target=$(select_from_list "area" "$AREAS_PATH" "name" 2>/dev/null)
          if [[ -z "$merge_target" ]]; then
            echo "   âŒ No area selected, skipping merge"
          else
            areas_to_merge+=("$area_slug|$merge_target")
            echo "   â†’ Marked for merging with: $merge_target"
          fi
        else
          read -p "   Area name: " merge_target
          if [[ -n "$merge_target" ]]; then
            areas_to_merge+=("$area_slug|$merge_target")
            echo "   â†’ Marked for merging with: $merge_target"
          fi
        fi
      else
        areas_to_archive+=("$area_slug")
        echo "   â†’ Marked for archiving"
      fi
    else
      echo "2. How is this area doing? (good/needs-attention/excellent)"
      read -p "   " area_status
      echo ""
      
      if [[ "$area_status" == "needs-attention" ]]; then
        areas_needing_attention+=("$area_slug")
        echo "3. What needs attention?"
        read -p "   " attention_needed
        echo ""
        
        # Quick review
        review_area "$area_slug"
      else
        echo "3. Any updates needed? (y/n)"
        read -p "   " needs_update
        if [[ "$needs_update" == "y" || "$needs_update" == "Y" ]]; then
          review_area "$area_slug"
        fi
      fi
    fi
    
    echo ""
  done
  
  # Summary
  echo ""
  echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
  echo "ğŸ“Š Review Summary"
  echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
  echo ""
  
  if [[ ${#areas_to_archive[@]} -gt 0 ]]; then
    echo "Areas to archive:"
    for area in "${areas_to_archive[@]}"; do
      local area_name=$(echo "$area" | tr '-' ' ' | sed 's/\b\(.\)/\u\1/g')
      echo "  â€¢ $area_name"
    done
    echo ""
    read -p "Archive these areas now? (y/n) " archive_now
    if [[ "$archive_now" == "y" || "$archive_now" == "Y" ]]; then
      for area in "${areas_to_archive[@]}"; do
        gtd-area archive "$area"
      done
    fi
    echo ""
  fi
  
  if [[ ${#areas_to_merge[@]} -gt 0 ]]; then
    echo "Areas to merge:"
    for merge_pair in "${areas_to_merge[@]}"; do
      local source=$(echo "$merge_pair" | cut -d'|' -f1 | tr '-' ' ' | sed 's/\b\(.\)/\u\1/g')
      local target=$(echo "$merge_pair" | cut -d'|' -f2 | tr '-' ' ' | sed 's/\b\(.\)/\u\1/g')
      echo "  â€¢ $source â†’ $target"
    done
    echo ""
    echo "Note: Manual merge required. Review projects and tasks in these areas."
    echo ""
  fi
  
  if [[ ${#areas_needing_attention[@]} -gt 0 ]]; then
    echo "Areas needing attention:"
    for area in "${areas_needing_attention[@]}"; do
      local area_name=$(echo "$area" | tr '-' ' ' | sed 's/\b\(.\)/\u\1/g')
      echo "  â€¢ $area_name"
    done
    echo ""
  fi
  
  # Ask about new areas
  echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
  echo "ğŸ†• New Areas"
  echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
  echo ""
  echo "Are there new areas of responsibility you need to add?"
  read -p "  (y/n): " add_new
  echo ""
  
  if [[ "$add_new" == "y" || "$add_new" == "Y" ]]; then
    echo "Options:"
    echo "  1) Use starter areas wizard (recommended)"
    echo "  2) Create custom area"
    echo ""
    read -p "Choose (1/2): " choice
    
    case "$choice" in
      1)
        if command -v gtd-area-starter &>/dev/null; then
          gtd-area-starter
        else
          echo "Run: gtd-area-starter"
        fi
        ;;
      2)
        echo ""
        read -p "Area name: " new_area_name
        if [[ -n "$new_area_name" ]]; then
          gtd-area create "$new_area_name"
        fi
        ;;
    esac
  fi
  
  echo ""
  echo "âœ“ Area review complete!"
  echo ""
}

# Archive area
archive_area() {
  local area_name="$1"
  if [[ -z "$area_name" ]]; then
    echo "Usage: gtd-area archive <area-name>"
    exit 1
  fi
  
  area_name=$(echo "$area_name" | tr ' ' '-' | tr '[:upper:]' '[:lower:]')
  local area_file="${AREAS_PATH}/${area_name}.md"
  
  if [[ ! -f "$area_file" ]]; then
    echo "âŒ Area not found: $area_name"
    exit 1
  fi
  
  # Update status to archived
  update_frontmatter_value "$area_file" "status" "archived"
  update_frontmatter_value "$area_file" "archived" "${TODAY}T${NOW}"
  
  # Move to archive directory
  mkdir -p "${ARCHIVE_PATH}/areas"
  mv "$area_file" "${ARCHIVE_PATH}/areas/"
  
  echo "âœ“ Archived: $area_name"
  echo "  Moved to: ${ARCHIVE_PATH}/areas/"
  
  # Show warning if there are related projects or tasks
  local project_count=0
  local task_count=0
  
  if [[ -d "$PROJECTS_PATH" ]]; then
    while IFS= read -r project_dir; do
      local readme="${project_dir}/README.md"
      if [[ -f "$readme" ]]; then
        local project_area=$(get_frontmatter_value "$readme" "area")
        if [[ "$project_area" == "$area_name" ]]; then
          ((project_count++))
        fi
      fi
    done < <(find "$PROJECTS_PATH" -type d -mindepth 1 -maxdepth 1 2>/dev/null)
  fi
  
  if [[ -d "$TASKS_PATH" ]]; then
    while IFS= read -r task_file; do
      local task_area=$(get_frontmatter_value "$task_file" "area")
      if [[ "$task_area" == "$area_name" ]]; then
        ((task_count++))
      fi
    done < <(find "$TASKS_PATH" -type f -name "*.md" 2>/dev/null)
  fi
  
  if [[ $project_count -gt 0 || $task_count -gt 0 ]]; then
    echo ""
    echo "âš ï¸  Warning: This area has related items:"
    if [[ $project_count -gt 0 ]]; then
      echo "   â€¢ $project_count project(s) still linked to this area"
    fi
    if [[ $task_count -gt 0 ]]; then
      echo "   â€¢ $task_count task(s) still linked to this area"
    fi
    echo ""
    echo "   Consider reassigning these items to another area before archiving."
  fi
}

# Main
main() {
  case "$1" in
    create)
      shift
      create_area "$@"
      ;;
    list|ls)
      list_areas
      ;;
    view)
      shift
      view_area "$1"
      ;;
    add-task)
      shift
      add_task_to_area "$@"
      ;;
    add-project)
      shift
      add_project_to_area "$@"
      ;;
    review)
      shift
      if [[ -z "$1" ]]; then
        review_all_areas
      else
        review_area "$1"
      fi
      ;;
    review-all)
      review_all_areas
      ;;
    archive)
      shift
      archive_area "$1"
      ;;
    --help|-h|"")
      echo "Usage: gtd-area <command> [options]"
      echo ""
      echo "Commands:"
      echo "  create <name>                  Create a new area"
      echo "  list|ls                        List all areas"
      echo "  view <name>                    View area details"
      echo "  add-task <area> <description>  Add task to area"
      echo "  add-project <area> <name>      Add project to area"
      echo "  review [name]                  Review area (or all areas if no name)"
      echo "  review-all                     Review all areas systematically"
      echo "  archive <name>                 Archive an area"
      echo ""
      echo "Examples:"
      echo "  gtd-area create \"Health\""
      echo "  gtd-area list"
      echo "  gtd-area view health"
      echo "  gtd-area add-task health \"Exercise daily\""
      echo "  gtd-area add-project health \"Fitness Program\""
      echo "  gtd-area review health"
      exit 0
      ;;
    *)
      echo "Unknown command: $1"
      echo "Run 'gtd-area --help' for usage"
      exit 1
      ;;
  esac
}

main "$@"



