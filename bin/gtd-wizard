#!/bin/bash
# GTD Interactive Wizard - Guides you through GTD processes

# Source common GTD helpers
GTD_COMMON="$HOME/code/dotfiles/bin/gtd-common.sh"
if [[ ! -f "$GTD_COMMON" && -f "$HOME/code/personal/dotfiles/bin/gtd-common.sh" ]]; then
  GTD_COMMON="$HOME/code/personal/dotfiles/bin/gtd-common.sh"
fi
if [[ -f "$GTD_COMMON" ]]; then
  source "$GTD_COMMON"
else
  echo "Warning: gtd-common.sh not found. Some features may not work." >&2
fi

# Source guide functions
GTD_GUIDES="$HOME/code/dotfiles/bin/gtd-guides.sh"
if [[ ! -f "$GTD_GUIDES" && -f "$HOME/code/personal/dotfiles/bin/gtd-guides.sh" ]]; then
  GTD_GUIDES="$HOME/code/personal/dotfiles/bin/gtd-guides.sh"
fi
if [[ -f "$GTD_GUIDES" ]]; then
  source "$GTD_GUIDES"
fi

# Source wizard core functions
GTD_WIZARD_CORE="$HOME/code/dotfiles/bin/gtd-wizard-core.sh"
if [[ ! -f "$GTD_WIZARD_CORE" && -f "$HOME/code/personal/dotfiles/bin/gtd-wizard-core.sh" ]]; then
  GTD_WIZARD_CORE="$HOME/code/personal/dotfiles/bin/gtd-wizard-core.sh"
fi
if [[ -f "$GTD_WIZARD_CORE" ]]; then
  source "$GTD_WIZARD_CORE"
fi

# Source select helper for project/area selection
GTD_SELECT_HELPER="$HOME/code/dotfiles/bin/gtd-select-helper.sh"
if [[ ! -f "$GTD_SELECT_HELPER" && -f "$HOME/code/personal/dotfiles/bin/gtd-select-helper.sh" ]]; then
  GTD_SELECT_HELPER="$HOME/code/personal/dotfiles/bin/gtd-select-helper.sh"
fi
if [[ -f "$GTD_SELECT_HELPER" ]]; then
  source "$GTD_SELECT_HELPER"
fi

# Source wizard input functions
GTD_WIZARD_INPUTS="$HOME/code/dotfiles/bin/gtd-wizard-inputs.sh"
if [[ ! -f "$GTD_WIZARD_INPUTS" && -f "$HOME/code/personal/dotfiles/bin/gtd-wizard-inputs.sh" ]]; then
  GTD_WIZARD_INPUTS="$HOME/code/personal/dotfiles/bin/gtd-wizard-inputs.sh"
fi
if [[ -f "$GTD_WIZARD_INPUTS" ]]; then
  source "$GTD_WIZARD_INPUTS"
fi

# Source wizard organization functions
GTD_WIZARD_ORG="$HOME/code/dotfiles/bin/gtd-wizard-org.sh"
if [[ ! -f "$GTD_WIZARD_ORG" && -f "$HOME/code/personal/dotfiles/bin/gtd-wizard-org.sh" ]]; then
  GTD_WIZARD_ORG="$HOME/code/personal/dotfiles/bin/gtd-wizard-org.sh"
fi
if [[ -f "$GTD_WIZARD_ORG" ]]; then
  source "$GTD_WIZARD_ORG"
fi

# Source wizard Second Brain functions
GTD_WIZARD_BRAIN="$HOME/code/dotfiles/bin/gtd-wizard-brain.sh"
if [[ ! -f "$GTD_WIZARD_BRAIN" && -f "$HOME/code/personal/dotfiles/bin/gtd-wizard-brain.sh" ]]; then
  GTD_WIZARD_BRAIN="$HOME/code/personal/dotfiles/bin/gtd-wizard-brain.sh"
fi
if [[ -f "$GTD_WIZARD_BRAIN" ]]; then
  source "$GTD_WIZARD_BRAIN"
fi

# Source wizard output functions
GTD_WIZARD_OUTPUTS="$HOME/code/dotfiles/bin/gtd-wizard-outputs.sh"
if [[ ! -f "$GTD_WIZARD_OUTPUTS" && -f "$HOME/code/personal/dotfiles/bin/gtd-wizard-outputs.sh" ]]; then
  GTD_WIZARD_OUTPUTS="$HOME/code/personal/dotfiles/bin/gtd-wizard-outputs.sh"
fi
if [[ -f "$GTD_WIZARD_OUTPUTS" ]]; then
  source "$GTD_WIZARD_OUTPUTS"
fi

# Source wizard analysis functions
GTD_WIZARD_ANALYSIS="$HOME/code/dotfiles/bin/gtd-wizard-analysis.sh"
if [[ ! -f "$GTD_WIZARD_ANALYSIS" && -f "$HOME/code/personal/dotfiles/bin/gtd-wizard-analysis.sh" ]]; then
  GTD_WIZARD_ANALYSIS="$HOME/code/personal/dotfiles/bin/gtd-wizard-analysis.sh"
fi
if [[ -f "$GTD_WIZARD_ANALYSIS" ]]; then
  source "$GTD_WIZARD_ANALYSIS"
fi

# Source wizard tools functions
GTD_WIZARD_TOOLS="$HOME/code/dotfiles/bin/gtd-wizard-tools.sh"
if [[ ! -f "$GTD_WIZARD_TOOLS" && -f "$HOME/code/personal/dotfiles/bin/gtd-wizard-tools.sh" ]]; then
  GTD_WIZARD_TOOLS="$HOME/code/personal/dotfiles/bin/gtd-wizard-tools.sh"
fi
if [[ -f "$GTD_WIZARD_TOOLS" ]]; then
  source "$GTD_WIZARD_TOOLS"
fi

# Source wizard preferences functions
GTD_WIZARD_PREFERENCES="$HOME/code/dotfiles/bin/gtd-wizard-preferences.sh"
if [[ ! -f "$GTD_WIZARD_PREFERENCES" && -f "$HOME/code/personal/dotfiles/bin/gtd-wizard-preferences.sh" ]]; then
  GTD_WIZARD_PREFERENCES="$HOME/code/personal/dotfiles/bin/gtd-wizard-preferences.sh"
fi
if [[ -f "$GTD_WIZARD_PREFERENCES" ]]; then
  source "$GTD_WIZARD_PREFERENCES"
fi

# Source wizard enhanced review functions
GTD_WIZARD_ENHANCED_REVIEW="$HOME/code/dotfiles/bin/gtd-wizard-enhanced-review.sh"
if [[ ! -f "$GTD_WIZARD_ENHANCED_REVIEW" && -f "$HOME/code/personal/dotfiles/bin/gtd-wizard-enhanced-review.sh" ]]; then
  GTD_WIZARD_ENHANCED_REVIEW="$HOME/code/personal/dotfiles/bin/gtd-wizard-enhanced-review.sh"
fi
if [[ -f "$GTD_WIZARD_ENHANCED_REVIEW" ]]; then
  source "$GTD_WIZARD_ENHANCED_REVIEW"
fi

# Clear screen
clear

# Use common menu navigation (aliased for backward compatibility)
alias push_menu='gtd_push_menu'
alias pop_menu='gtd_pop_menu'
alias get_menu_level='gtd_get_menu_level'
alias show_breadcrumb='gtd_show_breadcrumb'

# Define wrapper functions (aliases don't always work in subshells)
show_breadcrumb() {
  gtd_show_breadcrumb
}

# Menu navigation wrappers (functions work better than aliases)
push_menu() {
  gtd_push_menu "$@"
}

pop_menu() {
  gtd_pop_menu
}

# Helper function to select from a numbered list
select_from_numbered_list() {
  local items=("$@")
  local item_count=${#items[@]}
  
  if [[ $item_count -eq 0 ]]; then
    echo "No items to select from" >&2
    return 1
  fi
  
  # Display numbered list to stderr so it shows even when capturing stdout
  echo "" >&2
  for i in "${!items[@]}"; do
    local num=$((i + 1))
    echo -e "  ${GREEN}${num})${NC} ${items[$i]}" >&2
  done
  echo "" >&2
  
  # Get user input (read from terminal, not captured)
  echo -n "Select item (number): " >&2
  read user_input
  
  if [[ -z "$user_input" ]]; then
    return 1
  fi
  
  # Check if it's a number
  if [[ "$user_input" =~ ^[0-9]+$ ]]; then
    local selected_index=$((user_input - 1))
    if [[ $selected_index -ge 0 && $selected_index -lt $item_count ]]; then
      echo "${items[$selected_index]}"
      return 0
    else
      echo "âŒ Invalid number. Please select 1-$item_count" >&2
      return 1
    fi
  else
    # Try to match by name
    for i in "${!items[@]}"; do
      if [[ "${items[$i]}" == *"$user_input"* ]]; then
        echo "${items[$i]}"
        return 0
      fi
    done
    echo "âŒ No match found" >&2
    return 1
  fi
}

# Use common helper functions (aliased for backward compatibility)
alias get_mcp_python='gtd_get_mcp_python'
alias get_moc_names_array='gtd_get_moc_names'
alias get_second_brain_notes='gtd_get_second_brain_notes'

# Helper function to mark suggestion as accepted
mark_suggestion_accepted() {
  local suggestion_file="$1"
  if command -v python3 &>/dev/null; then
    python3 -c "
import json
from datetime import datetime
file = '$suggestion_file'
with open(file, 'r') as f:
    data = json.load(f)
data['status'] = 'accepted'
data['accepted_at'] = datetime.now().isoformat()
with open(file, 'w') as f:
    json.dump(data, f, indent=2)
" 2>/dev/null
  fi
}

# Helper function to mark suggestion as dismissed
mark_suggestion_dismissed() {
  local suggestion_file="$1"
  if command -v python3 &>/dev/null; then
    python3 -c "
import json
from datetime import datetime
file = '$suggestion_file'
with open(file, 'r') as f:
    data = json.load(f)
data['status'] = 'dismissed'
data['dismissed_at'] = datetime.now().isoformat()
with open(file, 'w') as f:
    json.dump(data, f, indent=2)
" 2>/dev/null
  fi
}

# Use common guide functions (aliased for backward compatibility)
alias show_areas_guide='gtd_show_areas_guide'
alias show_projects_guide='gtd_show_projects_guide'
alias show_tasks_guide='gtd_show_tasks_guide'
alias show_express_guide='gtd_show_express_guide'
alias show_moc_guide='gtd_show_moc_guide'
alias show_templates_guide='gtd_show_templates_guide'
alias show_zettelkasten_guide='gtd_show_zettelkasten_guide'
alias show_checkin_guide='gtd_show_checkin_guide'
alias show_organization_guide='gtd_show_organization_guide'
alias show_review_guide='gtd_show_review_guide'
alias show_capture_guide='gtd_show_capture_guide'
alias show_process_guide='gtd_show_process_guide'
alias show_sync_guide='gtd_show_sync_guide'
alias show_advice_guide='gtd_show_advice_guide'
alias show_daily_log_guide='gtd_show_daily_log_guide'
alias show_search_guide='gtd_show_search_guide'
alias show_status_guide='gtd_show_status_guide'
alias show_config_guide='gtd_show_config_guide'
alias show_second_brain_learning_guide='gtd_show_second_brain_learning_guide'
alias show_life_vision_guide='gtd_show_life_vision_guide'
alias show_diagram_guide='gtd_show_diagram_guide'
alias show_habits_guide='gtd_show_habits_guide'
alias show_learning_guide='gtd_show_learning_guide'
alias show_ai_suggestions_guide='gtd_show_ai_suggestions_guide'
alias show_goal_tracking_guide='gtd_show_goal_tracking_guide'
alias show_energy_audit_guide='gtd_show_energy_audit_guide'
alias show_gamification_guide='gtd_show_gamification_guide'
alias show_healthkit_guide='gtd_show_healthkit_guide'
alias show_calendar_guide='gtd_show_calendar_guide'
alias show_mood_tracking_guide='gtd_show_mood_tracking_guide'
alias show_metric_correlations_guide='gtd_show_metric_correlations_guide'
alias show_pattern_recognition_guide='gtd_show_pattern_recognition_guide'
alias show_energy_schedule_guide='gtd_show_energy_schedule_guide'
alias show_note_packets_guide='gtd_show_note_packets_guide'
alias show_connect_notes_guide='gtd_show_connect_notes_guide'
alias show_converge_notes_guide='gtd_show_converge_notes_guide'
alias show_discover_connections_guide='gtd_show_discover_connections_guide'
alias show_distill_guide='gtd_show_distill_guide'
alias show_diverge_guide='gtd_show_diverge_guide'
alias show_evergreen_notes_guide='gtd_show_evergreen_notes_guide'

# Define wrapper functions (aliases don't always work in subshells)
show_areas_guide() {
  gtd_show_areas_guide
}

show_projects_guide() {
  gtd_show_projects_guide
}

show_tasks_guide() {
  gtd_show_tasks_guide
}

show_express_guide() {
  gtd_show_express_guide
}

show_moc_guide() {
  gtd_show_moc_guide
}

show_templates_guide() {
  gtd_show_templates_guide
}

show_zettelkasten_guide() {
  gtd_show_zettelkasten_guide
}

show_checkin_guide() {
  gtd_show_checkin_guide
}

show_organization_guide() {
  gtd_show_organization_guide
}

show_review_guide() {
  gtd_show_review_guide
}

show_capture_guide() {
  gtd_show_capture_guide
}

show_process_guide() {
  gtd_show_process_guide
}

show_sync_guide() {
  gtd_show_sync_guide
}

show_advice_guide() {
  gtd_show_advice_guide
}

show_daily_log_guide() {
  gtd_show_daily_log_guide
}

show_search_guide() {
  gtd_show_search_guide
}

show_status_guide() {
  gtd_show_status_guide
}

show_config_guide() {
  gtd_show_config_guide
}

show_second_brain_learning_guide() {
  gtd_show_second_brain_learning_guide
}

show_life_vision_guide() {
  gtd_show_life_vision_guide
}

show_diagram_guide() {
  gtd_show_diagram_guide
}

show_habits_guide() {
  gtd_show_habits_guide
}

show_learning_guide() {
  gtd_show_learning_guide
}

show_ai_suggestions_guide() {
  gtd_show_ai_suggestions_guide
}

show_goal_tracking_guide() {
  gtd_show_goal_tracking_guide
}

show_energy_audit_guide() {
  gtd_show_energy_audit_guide
}

show_gamification_guide() {
  gtd_show_gamification_guide
}

show_healthkit_guide() {
  gtd_show_healthkit_guide
}

show_calendar_guide() {
  gtd_show_calendar_guide
}

show_mood_tracking_guide() {
  gtd_show_mood_tracking_guide
}

show_metric_correlations_guide() {
  gtd_show_metric_correlations_guide
}

show_pattern_recognition_guide() {
  gtd_show_pattern_recognition_guide
}

show_energy_schedule_guide() {
  gtd_show_energy_schedule_guide
}

show_note_packets_guide() {
  gtd_show_note_packets_guide
}

show_connect_notes_guide() {
  gtd_show_connect_notes_guide
}

show_converge_notes_guide() {
  gtd_show_converge_notes_guide
}

show_discover_connections_guide() {
  gtd_show_discover_connections_guide
}

show_distill_guide() {
  gtd_show_distill_guide
}

show_diverge_guide() {
  gtd_show_diverge_guide
}

show_evergreen_notes_guide() {
  gtd_show_evergreen_notes_guide
}

# Legacy guide function (replaced by alias above)
show_express_guide() {
  echo -e "${YELLOW}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
  echo -e "${BOLD}${YELLOW}âœï¸  Express Phase - Quick Guide${NC}"
  echo -e "${YELLOW}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
  echo ""
  echo -e "${BOLD}What is the Express Phase?${NC}"
  echo "  The Express phase is the final step in the CODE method - creating"
  echo "  and sharing content from your Second Brain notes. It's where your"
  echo "  knowledge becomes useful to others (and yourself)."
  echo ""
  echo -e "${BOLD}Why is it important?${NC}"
  echo "  â€¢ Turns your notes into valuable content (articles, presentations, etc.)"
  echo "  â€¢ Helps you share knowledge and insights with others"
  echo "  â€¢ Reinforces learning by creating from what you've captured"
  echo "  â€¢ Makes your Second Brain a creative tool, not just storage"
  echo ""
  echo -e "${BOLD}What should you do here?${NC}"
  echo "  âœ“ Create content from your notes (articles, blog posts, presentations)"
  echo "  âœ“ Combine multiple notes into cohesive pieces"
  echo "  âœ“ Draft content, refine it, then publish when ready"
  echo "  âœ“ Capture ideas for future content creation"
  echo ""
  echo -e "${BOLD}When to use:${NC}"
  echo "  â€¢ Weekly: Create content from notes you've captured and organized"
  echo "  â€¢ When you have insights: Turn notes into shareable content"
  echo "  â€¢ For projects: Create deliverables from your knowledge base"
  echo ""
  echo -e "${YELLOW}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
  echo ""
}

# Show contextual guide for MOCs
show_moc_guide() {
  echo -e "${YELLOW}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
  echo -e "${BOLD}${YELLOW}ðŸ—ºï¸  Maps of Content (MOCs) - Quick Guide${NC}"
  echo -e "${YELLOW}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
  echo ""
  echo -e "${BOLD}What are MOCs?${NC}"
  echo "  MOCs (Maps of Content) are index notes that organize related notes"
  echo "  by topic. Think of them as a table of contents for your knowledge base."
  echo ""
  echo -e "${BOLD}Why are they important?${NC}"
  echo "  â€¢ They help you find related notes quickly without searching"
  echo "  â€¢ They organize knowledge by topic, not just by folder structure"
  echo "  â€¢ They reveal connections and patterns in your notes"
  echo "  â€¢ They make your Second Brain more navigable and useful"
  echo ""
  echo -e "${BOLD}What should you do here?${NC}"
  echo "  âœ“ Create MOCs for major topics (Learning, Projects, Health, etc.)"
  echo "  âœ“ Add notes to MOCs as you create them"
  echo "  âœ“ Auto-populate MOCs from tags to organize existing notes"
  echo "  âœ“ Review MOCs regularly to see what you've captured"
  echo ""
  echo -e "${BOLD}When to use:${NC}"
  echo "  â€¢ When starting: Create starter MOCs for your key areas"
  echo "  â€¢ As you capture: Add notes to relevant MOCs"
  echo "  â€¢ Weekly: Review and organize notes into MOCs"
  echo "  â€¢ Monthly: Auto-populate MOCs from tags to catch missed notes"
  echo ""
  echo -e "${YELLOW}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
  echo ""
}

# Show contextual guide for Templates
show_templates_guide() {
  echo -e "${YELLOW}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
  echo -e "${BOLD}${YELLOW}ðŸ“‹ Templates - Quick Guide${NC}"
  echo -e "${YELLOW}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
  echo ""
  echo -e "${BOLD}What are Templates?${NC}"
  echo "  Templates are pre-structured note formats that help you create"
  echo "  consistent, organized notes quickly. They save time and ensure"
  echo "  important information is captured in a standard format."
  echo ""
  echo -e "${BOLD}Why are they important?${NC}"
  echo "  â€¢ Save time by providing a ready-made structure"
  echo "  â€¢ Ensure consistency across similar notes"
  echo "  â€¢ Help you capture the right information every time"
  echo "  â€¢ Make notes more useful by following proven formats"
  echo ""
  echo -e "${BOLD}What should you do here?${NC}"
  echo "  âœ“ Browse available templates (Meeting Notes, Book Notes, etc.)"
  echo "  âœ“ Create new notes using templates for structure"
  echo "  âœ“ Use templates for recurring note types (meetings, projects, etc.)"
  echo "  âœ“ Customize templates as you learn what works best for you"
  echo ""
  echo -e "${BOLD}When to use:${NC}"
  echo "  â€¢ Creating meeting notes: Use Meeting Notes template"
  echo "  â€¢ Taking book/article notes: Use Book/Article Notes templates"
  echo "  â€¢ Starting a project: Use Project Notes template"
  echo "  â€¢ Any time you want structured, consistent notes"
  echo ""
  echo -e "${YELLOW}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
  echo ""
}

# Show contextual guide for Zettelkasten
show_zettelkasten_guide() {
  echo -e "${YELLOW}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
  echo -e "${BOLD}${YELLOW}ðŸ”— Zettelkasten (Atomic Notes) - Quick Guide${NC}"
  echo -e "${YELLOW}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
  echo ""
  echo -e "${BOLD}What are Zettelkasten Notes?${NC}"
  echo "  Atomic notes capture ONE idea per note. They're the building blocks"
  echo "  of your knowledge - simple, focused notes that you link together to"
  echo "  create a web of interconnected ideas."
  echo ""
  echo -e "${BOLD}Why are they important?${NC}"
  echo "  â€¢ They capture ideas in their simplest form (one concept = one note)"
  echo "  â€¢ They build your knowledge graph through linking"
  echo "  â€¢ They work with GTD (actions) and Second Brain (organization)"
  echo "  â€¢ They help you discover connections between ideas"
  echo ""
  echo -e "${BOLD}How do they fit in the system?${NC}"
  echo "  â€¢ Zettelkasten = Atomic ideas (the building blocks)"
  echo "  â€¢ GTD = Actions and tasks (what to do)"
  echo "  â€¢ Second Brain = Organization (PARA, MOCs, content creation)"
  echo "  â€¢ Together they form one unified knowledge system"
  echo ""
  echo -e "${BOLD}What should you do here?${NC}"
  echo "  âœ“ Capture atomic ideas quickly to inbox (one idea per note)"
  echo "  âœ“ Link notes together to build connections"
  echo "  âœ“ Link notes to Second Brain (Projects, Areas, Resources)"
  echo "  âœ“ Link notes to GTD items (projects, tasks) for actionability"
  echo "  âœ“ Process inbox regularly to organize and link notes"
  echo ""
  echo -e "${BOLD}When to use:${NC}"
  echo "  â€¢ Throughout the day: Capture ideas quickly to inbox"
  echo "  â€¢ Daily/Weekly: Process inbox, link notes, organize"
  echo "  â€¢ When learning: Create atomic notes for each concept"
  echo "  â€¢ When researching: Build a web of linked ideas"
  echo ""
  echo -e "${YELLOW}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
  echo ""
}

# Show contextual guide for Check-Ins
show_checkin_guide() {
  echo -e "${YELLOW}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
  echo -e "${BOLD}${YELLOW}ðŸŒ…ðŸŒ™ Morning/Evening Check-Ins - Quick Guide${NC}"
  echo -e "${YELLOW}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
  echo ""
  echo -e "${BOLD}What are Check-Ins?${NC}"
  echo "  Check-ins are intentional moments to reflect, plan, and connect with"
  echo "  your day. Morning check-ins set your priorities and intentions, while"
  echo "  evening check-ins help you reflect on accomplishments and prepare"
  echo "  for tomorrow."
  echo ""
  echo -e "${BOLD}Why are they important?${NC}"
  echo "  â€¢ They help you start and end each day with intention"
  echo "  â€¢ They connect your feelings, priorities, and accomplishments"
  echo "  â€¢ They track habits and ensure important areas get attention"
  echo "  â€¢ They provide structure for reflection and planning"
  echo ""
  echo -e "${BOLD}What should you do here?${NC}"
  echo "  âœ“ Morning: Set priorities, check system status, plan your day"
  echo "  âœ“ Evening: Reflect on accomplishments, review what went well"
  echo "  âœ“ Complete habits during check-ins to stay on track"
  echo "  âœ“ Be honest about feelings and priorities"
  echo ""
  echo -e "${BOLD}When to use:${NC}"
  echo "  â€¢ Morning: When you start your day (5-10 minutes)"
  echo "  â€¢ Evening: Before bed or at end of work day (5-10 minutes)"
  echo "  â€¢ Daily: Make it a routine - same time every day"
  echo ""
  echo -e "${YELLOW}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
  echo ""
}

# Get existing notes for a task
get_task_notes() {
  local task_id="$1"
  local -n notes_array="$2"
  local -n titles_array="$3"
  
  notes_array=()
  titles_array=()
  
  # Find task file
  local task_file=""
  if [[ -d "$TASKS_PATH" ]]; then
    task_file=$(find "$TASKS_PATH" -name "${task_id}*.md" 2>/dev/null | head -1)
  fi
  
  if [[ -z "$task_file" ]] && [[ -d "$PROJECTS_PATH" ]]; then
    task_file=$(find "$PROJECTS_PATH" -name "${task_id}*.md" ! -name "README.md" 2>/dev/null | head -1)
  fi
  
  if [[ -z "$task_file" || ! -f "$task_file" ]]; then
    return 1
  fi
  
  # Get notes directory
  local task_base=$(basename "$task_file" .md)
  local task_dir=$(dirname "$task_file")
  local notes_dir="${task_dir}/${task_base}/notes"
  
  if [[ ! -d "$notes_dir" ]]; then
    return 1
  fi
  
  # Find notes and extract titles
  while IFS= read -r note_file; do
    if [[ -f "$note_file" ]]; then
      local note_title=$(grep "^# " "$note_file" 2>/dev/null | head -1 | sed 's/^# //' || echo "")
      if [[ -z "$note_title" ]]; then
        note_title=$(basename "$note_file" .md | sed 's/^[0-9]*-//')
      fi
      if [[ -n "$note_title" ]]; then
        notes_array+=("$note_file")
        titles_array+=("$note_title")
      fi
    fi
  done < <(find "$notes_dir" -type f -name "*.md" 2>/dev/null | sort)
  
  return 0
}

# Get task ID by number from task list output
# This function parses the output of 'gtd-task list' to map numbers to task IDs
# Usage: get_task_id_by_number <task_number_or_id> [task_list_output]
# If task_list_output is provided, it will be used instead of calling gtd-task list again
get_task_id_by_number() {
  local task_num="$1"
  local task_list_output="$2"
  
  if [[ -z "$task_num" ]]; then
    return 1
  fi
  
  # Check if it's already a task ID (contains letters or dashes, not just numbers)
  if [[ ! "$task_num" =~ ^[0-9]+$ ]]; then
    # It's likely already a task ID, return as-is
    echo "$task_num"
    return 0
  fi
  
  # If no list output provided, get it now
  if [[ -z "$task_list_output" ]]; then
    task_list_output=$(gtd-task list 2>/dev/null)
  fi
  
  local current_num=""
  local task_id=""
  
  while IFS= read -r line; do
    # Look for lines like "[1] Task name"
    if [[ "$line" =~ ^\[([0-9]+)\]\ .+ ]]; then
      current_num="${BASH_REMATCH[1]}"
      task_id=""
    # Look for lines like "     ID: task-id"
    elif [[ -n "$current_num" && "$line" =~ ^[[:space:]]+ID:[[:space:]]+(.+)$ ]]; then
      task_id="${BASH_REMATCH[1]}"
      if [[ "$current_num" == "$task_num" ]]; then
        echo "$task_id"
        return 0
      fi
    fi
  done <<< "$task_list_output"
  
  # If we get here, the number wasn't found
  return 1
}

# Select from existing tasks
select_from_tasks() {
  local item_type="${1:-task}"
  
  if [[ ! -d "$TASKS_PATH" ]]; then
    echo "âŒ Tasks directory not found: $TASKS_PATH" >&2
    return 1
  fi
  
  # Find all task files in TASKS_PATH (standalone tasks)
  declare -a task_files
  declare -a task_names
  declare -a task_ids
  
  while IFS= read -r task_file; do
    if [[ -f "$task_file" ]]; then
      # Get task description from first heading or frontmatter
      local task_desc=$(grep "^# " "$task_file" 2>/dev/null | head -1 | sed 's/^# //' || echo "")
      if [[ -z "$task_desc" ]]; then
        # Fall back to filename without extension
        task_desc=$(basename "$task_file" .md | sed 's/^[0-9]*-//')
      fi
      
      # Get task ID (filename without extension, or just the timestamp part)
      local task_id=$(basename "$task_file" .md)
      
      if [[ -n "$task_desc" ]]; then
        task_files+=("$task_file")
        task_names+=("$task_desc")
        task_ids+=("$task_id")
      fi
    fi
  done < <(find "$TASKS_PATH" -type f -name "*.md" 2>/dev/null | sort)
  
  local task_count=${#task_names[@]}
  
  if [[ $task_count -eq 0 ]]; then
    echo "No standalone tasks found in $TASKS_PATH" >&2
    return 1
  fi
  
  # Display numbered list to stderr so it shows even when capturing stdout
  echo "" >&2
  for i in "${!task_names[@]}"; do
    local num=$((i + 1))
    echo "  ${num}) ${task_names[$i]}" >&2
  done
  echo "" >&2
  
  # Get user input (prompt to stderr so it shows)
  echo -n "Select ${item_type} (number or partial name): " >&2
  read user_input
  
  if [[ -z "$user_input" ]]; then
    return 1
  fi
  
  # Check if it's a number
  if [[ "$user_input" =~ ^[0-9]+$ ]]; then
    local selected_index=$((user_input - 1))
    if [[ $selected_index -ge 0 && $selected_index -lt $task_count ]]; then
      echo "${task_ids[$selected_index]}"
      return 0
    else
      echo "âŒ Invalid number. Please select 1-$task_count" >&2
      return 1
    fi
  fi
  
  # Try partial name matching (case-insensitive)
  declare -a matches
  declare -a match_indices
  
  for i in "${!task_names[@]}"; do
    local task_name="${task_names[$i]}"
    local task_id="${task_ids[$i]}"
    
    # Case-insensitive partial match (bash 3.2 compatible)
    local task_name_lower=$(echo "$task_name" | tr '[:upper:]' '[:lower:]')
    local task_id_lower=$(echo "$task_id" | tr '[:upper:]' '[:lower:]')
    local user_input_lower=$(echo "$user_input" | tr '[:upper:]' '[:lower:]')
    if [[ "$task_name_lower" == *"$user_input_lower"* ]] || [[ "$task_id_lower" == *"$user_input_lower"* ]]; then
      matches+=("$task_name")
      match_indices+=($i)
    fi
  done
  
  local match_count=${#matches[@]}
  
  if [[ $match_count -eq 0 ]]; then
    echo "âŒ No ${item_type}s found matching '$user_input'" >&2
    return 1
  elif [[ $match_count -eq 1 ]]; then
    # Single match - return the task ID
    echo "${task_ids[${match_indices[0]}]}"
    return 0
  else
    # Multiple matches - show them and ask again
    echo "" >&2
    echo "Multiple matches found:" >&2
    echo "" >&2
    for i in "${!matches[@]}"; do
      local num=$((i + 1))
      echo "  ${num}) ${matches[$i]}" >&2
    done
    echo "" >&2
    echo -n "Select ${item_type} (number): " >&2
    read user_input
    
    if [[ "$user_input" =~ ^[0-9]+$ ]]; then
      local selected_index=$((user_input - 1))
      if [[ $selected_index -ge 0 && $selected_index -lt $match_count ]]; then
        echo "${task_ids[${match_indices[$selected_index]}]}"
        return 0
      else
        echo "âŒ Invalid number. Please select 1-$match_count" >&2
        return 1
      fi
    else
      echo "âŒ Invalid input" >&2
      return 1
    fi
  fi
}

# Show review process quick reference guide
show_review_guide() {
  echo -e "${YELLOW}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
  echo -e "${BOLD}${YELLOW}ðŸ“‹ Quick Reference: Review Process Guides${NC}"
  echo -e "${YELLOW}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
  echo ""
  echo -e "${BOLD}1) Daily Review${NC} (5-10 min)"
  echo "   â€¢ Morning: Set priorities, plan day, check system"
  echo "   â€¢ Evening: Reflect on accomplishments, plan tomorrow"
  echo "   â€¢ Auto-detects time of day for appropriate questions"
  echo ""
  echo -e "${BOLD}2) Weekly Review${NC} (1-2 hours)"
  echo "   â€¢ Process inbox to zero"
  echo "   â€¢ Review calendar (past & upcoming week)"
  echo "   â€¢ Review waiting-for items"
  echo "   â€¢ Review all active projects & tasks"
  echo "   â€¢ Review someday/maybe list"
  echo ""
  echo -e "${BOLD}3) Monthly Review${NC} (2-3 hours)"
  echo "   â€¢ Archive completed projects & tasks"
  echo "   â€¢ Comprehensive project portfolio review"
  echo "   â€¢ Area portfolio review"
  echo "   â€¢ Strategic goal assessment"
  echo ""
  echo -e "${BOLD}4) Quarterly Review${NC} (3-4 hours)"
  echo "   â€¢ Complete system audit"
  echo "   â€¢ Project & area portfolio deep-dive"
  echo "   â€¢ Quarterly goals review"
  echo "   â€¢ Strategic planning for next quarter"
  echo ""
  echo -e "${BOLD}5) Yearly Review${NC} (4-6 hours)"
  echo "   â€¢ Comprehensive annual assessment"
  echo "   â€¢ Life vision review"
  echo "   â€¢ Set annual goals"
  echo "   â€¢ Plan for the year ahead"
  echo ""
  echo -e "${BOLD}6) Financial Review${NC} (varies)"
  echo "   â€¢ Weekly/Monthly/Quarterly/Annual options"
  echo "   â€¢ Budget review & planning"
  echo "   â€¢ Financial goal tracking"
  echo ""
  echo -e "${YELLOW}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
  echo ""
}

# Show a specific review guide
show_specific_review_guide() {
  local review_type="$1"
  local guide_file=""
  
  case "$review_type" in
    daily)
      guide_file="$HOME/code/dotfiles/zsh/DAILY_REVIEW_TIMING_GUIDE.md"
      if [[ ! -f "$guide_file" ]]; then
        guide_file="$HOME/code/personal/dotfiles/zsh/DAILY_REVIEW_TIMING_GUIDE.md"
      fi
      ;;
    weekly)
      guide_file="$HOME/code/dotfiles/zsh/WEEKLY_REVIEW_TASKS_GUIDE.md"
      if [[ ! -f "$guide_file" ]]; then
        guide_file="$HOME/code/personal/dotfiles/zsh/WEEKLY_REVIEW_TASKS_GUIDE.md"
      fi
      ;;
    monthly)
      guide_file="$HOME/code/dotfiles/zsh/MONTHLY_REVIEW_TASKS_GUIDE.md"
      if [[ ! -f "$guide_file" ]]; then
        guide_file="$HOME/code/personal/dotfiles/zsh/MONTHLY_REVIEW_TASKS_GUIDE.md"
      fi
      ;;
    quarterly)
      guide_file="$HOME/code/dotfiles/zsh/QUARTERLY_REVIEW_TASKS_GUIDE.md"
      if [[ ! -f "$guide_file" ]]; then
        guide_file="$HOME/code/personal/dotfiles/zsh/QUARTERLY_REVIEW_TASKS_GUIDE.md"
      fi
      ;;
    yearly)
      guide_file="$HOME/code/dotfiles/zsh/YEARLY_REVIEW_TASKS_GUIDE.md"
      if [[ ! -f "$guide_file" ]]; then
        guide_file="$HOME/code/personal/dotfiles/zsh/YEARLY_REVIEW_TASKS_GUIDE.md"
      fi
      ;;
    *)
      echo "Unknown review type: $review_type"
      return 1
      ;;
  esac
  
  if [[ -f "$guide_file" ]]; then
    # Capitalize first letter of review type
    local review_title=$(echo "$review_type" | sed 's/^./\U&/')
    
    clear
    echo ""
    echo -e "${BOLD}${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo -e "${BOLD}${CYAN}ðŸ“– ${review_title} Review Guide${NC}"
    echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo ""
    if command -v less &>/dev/null; then
      less "$guide_file"
    elif command -v cat &>/dev/null; then
      cat "$guide_file"
      echo ""
      echo "Press Enter to continue..."
      read
    else
      echo "Guide: $guide_file"
      echo ""
      echo "Press Enter to continue..."
      read
    fi
  else
    echo "âš ï¸  Guide not found: $guide_file"
    echo ""
    echo "Press Enter to continue..."
    read
  fi
}

# Show detailed review guide for a specific review type
show_detailed_review_guide() {
  clear
  echo ""
  echo -e "${BOLD}${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
  echo -e "${BOLD}${CYAN}ðŸ“– Detailed Review Guides${NC}"
  echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
  echo ""
  echo "Which review guide would you like to view?"
  echo ""
  echo "  1) Daily Review Guide"
  echo "  2) Weekly Review Guide"
  echo "  3) Monthly Review Guide"
  echo "  4) Quarterly Review Guide"
  echo "  5) Yearly Review Guide"
  echo "  6) Financial Review Guide"
  echo ""
  echo -n "Choose: "
  read guide_choice
  
  local guide_file=""
  case "$guide_choice" in
    1)
      guide_file="$HOME/code/dotfiles/zsh/DAILY_REVIEW_TIMING_GUIDE.md"
      if [[ ! -f "$guide_file" ]]; then
        guide_file="$HOME/code/personal/dotfiles/zsh/DAILY_REVIEW_TIMING_GUIDE.md"
      fi
      ;;
    2)
      guide_file="$HOME/code/dotfiles/zsh/WEEKLY_REVIEW_TASKS_GUIDE.md"
      if [[ ! -f "$guide_file" ]]; then
        guide_file="$HOME/code/personal/dotfiles/zsh/WEEKLY_REVIEW_TASKS_GUIDE.md"
      fi
      ;;
    3)
      guide_file="$HOME/code/dotfiles/zsh/MONTHLY_REVIEW_TASKS_GUIDE.md"
      if [[ ! -f "$guide_file" ]]; then
        guide_file="$HOME/code/personal/dotfiles/zsh/MONTHLY_REVIEW_TASKS_GUIDE.md"
      fi
      ;;
    4)
      guide_file="$HOME/code/dotfiles/zsh/QUARTERLY_REVIEW_TASKS_GUIDE.md"
      if [[ ! -f "$guide_file" ]]; then
        guide_file="$HOME/code/personal/dotfiles/zsh/QUARTERLY_REVIEW_TASKS_GUIDE.md"
      fi
      ;;
    5)
      guide_file="$HOME/code/dotfiles/zsh/YEARLY_REVIEW_TASKS_GUIDE.md"
      if [[ ! -f "$guide_file" ]]; then
        guide_file="$HOME/code/personal/dotfiles/zsh/YEARLY_REVIEW_TASKS_GUIDE.md"
      fi
      ;;
    6)
      guide_file="$HOME/code/dotfiles/zsh/FINANCIAL_REVIEW_GUIDE.md"
      if [[ ! -f "$guide_file" ]]; then
        guide_file="$HOME/code/personal/dotfiles/zsh/FINANCIAL_REVIEW_GUIDE.md"
      fi
      ;;
    *)
      echo "Invalid choice"
      echo ""
      echo "Press Enter to continue..."
      read
      review_wizard
      return
      ;;
  esac
  
  if [[ -f "$guide_file" ]]; then
    if command -v less &>/dev/null; then
      less "$guide_file"
    elif command -v cat &>/dev/null; then
      cat "$guide_file"
    else
      echo "Guide: $guide_file"
    fi
  else
    echo "âŒ Guide not found: $guide_file"
    echo ""
    echo "Available guides should be in:"
    echo "  ~/code/dotfiles/zsh/"
    echo "  or"
    echo "  ~/code/personal/dotfiles/zsh/"
  fi
}

# Analysis and tools wizards moved to their respective modules

# Award XP for wizard usage (gamification)
award_wizard_xp() {
  local action_type="${1:-wizard_use}"  # wizard_use, wizard_action, wizard_productive
  local reason="${2:-Used GTD wizard}"
  
  if command -v gtd-gamify-award &>/dev/null; then
    gtd-gamify-award "$action_type" "" "$reason" 2>/dev/null || true
  elif [[ -f "$HOME/code/dotfiles/bin/gtd-gamify-award" ]]; then
    "$HOME/code/dotfiles/bin/gtd-gamify-award" "$action_type" "" "$reason" 2>/dev/null || true
  elif [[ -f "$HOME/code/personal/dotfiles/bin/gtd-gamify-award" ]]; then
    "$HOME/code/personal/dotfiles/bin/gtd-gamify-award" "$action_type" "" "$reason" 2>/dev/null || true
  fi
}


# Analysis and tools wizards moved to their respective modules
# Output wizards moved to gtd-wizard-outputs.sh
# Helper functions (quick_start_second_brain, show_second_brain_topics) moved to tools module

# Ensure MCP virtualenv is set up and requirements are installed
ensure_mcp_virtualenv() {
  # Find MCP directory
  local mcp_dir="$HOME/code/dotfiles/mcp"
  if [[ ! -d "$mcp_dir" ]]; then
    mcp_dir="$HOME/code/personal/dotfiles/mcp"
  fi
  
  # If MCP directory doesn't exist, skip setup (optional feature)
  if [[ ! -d "$mcp_dir" ]]; then
    return 0
  fi
  
  local venv_dir="${mcp_dir}/venv"
  local venv_python="${venv_dir}/bin/python3"
  local requirements_file="${mcp_dir}/requirements.txt"
  
  # Create virtualenv if it doesn't exist
  if [[ ! -d "$venv_dir" ]] || [[ ! -f "$venv_python" ]]; then
    # Try to run setup.sh if it exists
    local setup_script="${mcp_dir}/setup.sh"
    if [[ -f "$setup_script" ]] && [[ -x "$setup_script" ]]; then
      "$setup_script" >/dev/null 2>&1 || {
        echo "Warning: Failed to set up MCP virtualenv. Some features may not work." >&2
        return 1
      }
    else
      # Fallback: create virtualenv manually
      python3 -m venv "$venv_dir" >/dev/null 2>&1 || {
        echo "Warning: Failed to create MCP virtualenv. Some features may not work." >&2
        return 1
      }
    fi
  fi
  
  # Always install/update requirements to ensure mcp package is available
  if [[ -f "$requirements_file" ]] && [[ -f "$venv_python" ]]; then
    "$venv_python" -m pip install --quiet --upgrade pip >/dev/null 2>&1 || true
    "$venv_python" -m pip install --quiet -r "$requirements_file" >/dev/null 2>&1 || {
      echo "Warning: Failed to install MCP requirements. Some features may not work." >&2
      return 1
    }
  fi
  
  return 0
}

# Ensure virtualenv is set up before starting wizard
ensure_mcp_virtualenv

# Run main function (defined in gtd-wizard-core.sh)
main


# Second Brain wizards moved to gtd-wizard-brain.sh
# Second Brain wizards moved to gtd-wizard-brain.sh
# Second Brain wizards moved to gtd-wizard-brain.sh
# Second Brain wizards moved to gtd-wizard-brain.sh
# Second Brain wizards moved to gtd-wizard-brain.sh
# Second Brain wizards moved to gtd-wizard-brain.sh
# Second Brain wizards moved to gtd-wizard-brain.sh
