#!/bin/bash
# GTD Learning with Mistress Louiza as Instructor
# She teaches GTD concepts and calls in other experts when needed

# Load GTD config
GTD_CONFIG_FILE="$HOME/.gtd_config"
if [[ -f "$HOME/code/dotfiles/zsh/.gtd_config" ]]; then
  GTD_CONFIG_FILE="$HOME/code/dotfiles/zsh/.gtd_config"
elif [[ -f "$HOME/code/personal/dotfiles/zsh/.gtd_config" ]]; then
  GTD_CONFIG_FILE="$HOME/code/personal/dotfiles/zsh/.gtd_config"
fi

if [[ -f "$GTD_CONFIG_FILE" ]]; then
  source "$GTD_CONFIG_FILE"
fi

# Load daily log config
DAILY_LOG_CONFIG="$HOME/.daily_log_config"
if [[ -f "$HOME/code/dotfiles/zsh/.daily_log_config" ]]; then
  DAILY_LOG_CONFIG="$HOME/code/dotfiles/zsh/.daily_log_config"
elif [[ -f "$HOME/code/personal/dotfiles/zsh/.daily_log_config" ]]; then
  DAILY_LOG_CONFIG="$HOME/code/personal/dotfiles/zsh/.daily_log_config"
fi

if [[ -f "$DAILY_LOG_CONFIG" ]]; then
  source "$DAILY_LOG_CONFIG"
fi

# Colors
CYAN='\033[0;36m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BOLD='\033[1m'
NC='\033[0m'

# Find persona helper
PERSONA_HELPER=""
possible_paths=(
  "$HOME/code/personal/dotfiles/zsh/functions/gtd_persona_helper.py"
  "$HOME/code/dotfiles/zsh/functions/gtd_persona_helper.py"
)

for path in "${possible_paths[@]}"; do
  if [[ -f "$path" ]]; then
    PERSONA_HELPER="$path"
    break
  fi
done

if [[ -z "$PERSONA_HELPER" || ! -f "$PERSONA_HELPER" ]]; then
  echo "âŒ Persona helper not found" >&2
  exit 1
fi

# Find python
PYTHON_CMD=""
if [[ -f "/opt/homebrew/bin/python3" ]]; then
  PYTHON_CMD="/opt/homebrew/bin/python3"
elif command -v python3 &>/dev/null; then
  PYTHON_CMD="python3"
else
  echo "âŒ Python3 not found" >&2
  exit 1
fi

# Get instructor lesson from Mistress Louiza
get_instructor_lesson() {
  local topic="$1"
  local context="$2"  # beginner, intermediate, advanced, or specific question
  
  # Create comprehensive prompt for Louiza as instructor
  local prompt=""
  
  if [[ -z "$topic" ]]; then
    # General GTD introduction
    prompt="You are Mistress Louiza, and you are Abby's GTD instructor. You take pleasure in teaching and seeing her succeed. Give her a comprehensive introduction to the GTD system. Explain the core concepts: Capture, Process, Organize, Review. Be encouraging but firm. Use your characteristic style with phrases like 'good girl' and 'baby girl' when appropriate. When you need to explain something in more detail, you can reference other experts: 'Let me have David Allen explain the methodology', 'Cal Newport can help with deep work', 'James Clear knows about habits', etc. But you remain the primary instructor. Make it engaging and practical. Include specific commands she can use: gtd-capture, gtd-process, gtd-task, gtd-review, addInfoToDailyLog."
  else
    # Specific topic
    case "$topic" in
      capture|inbox)
        prompt="You are Mistress Louiza, Abby's GTD instructor. Teach her about capturing and the inbox system. Explain why capturing everything is crucial, how to use 'gtd-capture', when to capture, and how to process the inbox with 'gtd-process'. Be encouraging but firm. Reference David Allen if you need to explain the methodology deeper, but you remain the primary instructor. Use your characteristic style. Make it practical with examples."
        ;;
      process|processing)
        prompt="You are Mistress Louiza, Abby's GTD instructor. Teach her about processing inbox items. Explain the GTD processing questions: What is it? Is it actionable? What's the next action? Be detailed and practical. Reference David Allen for methodology details if needed. Use your characteristic style. Show her how to use 'gtd-process' effectively."
        ;;
      tasks|task)
        prompt="You are Mistress Louiza, Abby's GTD instructor. Teach her about task management. Explain how to use 'gtd-task add', 'gtd-task list', contexts, energy levels, priorities. Be practical. Reference David Allen for GTD methodology, James Clear for habit formation if relevant. Use your characteristic style. Show examples."
        ;;
      projects|project)
        prompt="You are Mistress Louiza, Abby's GTD instructor. Teach her about project management. Explain what constitutes a project, how to use 'gtd-project create', how to break projects into tasks, how to track progress. Reference David Allen for project methodology if needed. Use your characteristic style. Be practical."
        ;;
      review|reviews)
        prompt="You are Mistress Louiza, Abby's GTD instructor. Teach her about reviews - daily and weekly. Explain why reviews are essential, what to review, how to use 'gtd-review daily' and 'gtd-review weekly'. Be firm about the importance of reviews. Reference David Allen for review methodology. Use your characteristic style. Make it actionable."
        ;;
      logging|log)
        prompt="You are Mistress Louiza, Abby's GTD instructor. Teach her about daily logging. Explain how to use 'addInfoToDailyLog', why logging is important, how it helps with accountability. Be encouraging but firm about consistency. Reference James Clear for habit tracking if relevant. Use your characteristic style. Show examples."
        ;;
      contexts|context)
        prompt="You are Mistress Louiza, Abby's GTD instructor. Teach her about contexts in GTD. Explain what contexts are (home, office, computer, phone, errands), why they matter, how to use them with 'gtd-task list --context=computer'. Reference David Allen for context methodology. Use your characteristic style. Be practical."
        ;;
      energy|energy-levels)
        prompt="You are Mistress Louiza, Abby's GTD instructor. Teach her about energy levels. Explain how to match tasks to energy (low, medium, high, creative, administrative), how to use 'gtd-task list --energy=low'. Reference Cal Newport for deep work concepts if relevant. Use your characteristic style. Be practical."
        ;;
      second-brain|brain)
        prompt="You are Mistress Louiza, Abby's GTD instructor. Teach her about Second Brain integration. Explain how to use 'gtd-brain', 'gtd-brain-sync', linking GTD items to knowledge base, PARA method. Reference Tim Ferriss for knowledge management if relevant. Use your characteristic style. Be practical."
        ;;
      personas|advice|experts)
        prompt="You are Mistress Louiza, Abby's GTD instructor. Teach her about the persona system. Explain how to use 'gtd-advise', which personas to use for what (David for GTD, Cal for deep work, James for habits, you for accountability, etc.). Explain how you coordinate with other experts. Use your characteristic style. Be practical."
        ;;
      *)
        prompt="You are Mistress Louiza, Abby's GTD instructor. Teach her about: ${topic}. Be comprehensive, practical, and encouraging but firm. Reference other experts (David Allen, Cal Newport, James Clear, etc.) when you need to explain something in more detail, but you remain the primary instructor. Use your characteristic style with phrases like 'good girl' and 'baby girl' when appropriate. Make it actionable with specific commands and examples."
        ;;
    esac
  fi
  
  # Get lesson from Louiza
  local full_output=$("$PYTHON_CMD" "$PERSONA_HELPER" "louiza" "$prompt" "gtd_instructor" 2>&1)
  
  if [[ -z "$full_output" ]]; then
    return 1
  fi
  
  # Check for errors
  if echo "$full_output" | grep -qE "Error|âš ï¸|timed out|Could not connect|KeyError"; then
    return 1
  fi
  
  # Extract message
  local lesson=$(echo "$full_output" | awk '
    /^â”+$/ {
      if (in_section) {
        exit
      }
      in_section = 1
      next
    }
    in_section && !/^ğŸ’¬/ && !/^â”/ {
      print
    }
  ' | sed 's/^[[:space:]]*//' | sed 's/[[:space:]]*$//')
  
  # Clean up
  lesson=$(echo "$lesson" | sed 's/([^)]*)//g' | sed 's/\[[^\]]*\]//g')
  lesson=$(echo "$lesson" | sed 's/\*\*//g')
  lesson=$(echo "$lesson" | awk 'NF || prev_nf; {prev_nf=NF}')
  
  if [[ -n "$lesson" && ${#lesson} -gt 10 ]]; then
    echo "$lesson"
    return 0
  fi
  
  return 1
}

# Get expert input when Louiza references them
get_expert_input() {
  local expert="$1"
  local question="$2"
  
  # Map expert names to persona keys
  case "$expert" in
    david|"David Allen"|"David")
      persona_key="david"
      ;;
    cal|"Cal Newport"|"Cal")
      persona_key="cal"
      ;;
    james|"James Clear"|"James")
      persona_key="james"
      ;;
    warren|"Warren Buffett"|"Warren")
      persona_key="warren"
      ;;
    sheryl|"Sheryl Sandberg"|"Sheryl")
      persona_key="sheryl"
      ;;
    tim|"Tim Ferriss"|"Tim")
      persona_key="tim"
      ;;
    marie|"Marie Kondo"|"Marie")
      persona_key="marie"
      ;;
    *)
      return 1
      ;;
  esac
  
  # Get expert input
  local expert_output=$("$PYTHON_CMD" "$PERSONA_HELPER" "$persona_key" "$question" "expert_detail" 2>&1)
  
  if [[ -z "$expert_output" ]]; then
    return 1
  fi
  
  # Extract message
  local expert_message=$(echo "$expert_output" | awk '
    /^â”+$/ {
      if (in_section) {
        exit
      }
      in_section = 1
      next
    }
    in_section && !/^ğŸ’¬/ && !/^â”/ {
      print
    }
  ' | sed 's/^[[:space:]]*//' | sed 's/[[:space:]]*$//')
  
  if [[ -n "$expert_message" && ${#expert_message} -gt 10 ]]; then
    echo "$expert_message"
    return 0
  fi
  
  return 1
}

# Show lesson menu
show_lesson_menu() {
  clear
  echo -e "${BOLD}${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
  echo -e "${BOLD}${CYAN}ğŸ‘‘ GTD Learning with Mistress Louiza${NC}"
  echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
  echo ""
  echo -e "${BOLD}What would you like to learn?${NC}"
  echo ""
  echo -e "${GREEN}1)${NC} GTD Basics (Introduction)"
  echo -e "${GREEN}2)${NC} Capture & Inbox"
  echo -e "${GREEN}3)${NC} Processing"
  echo -e "${GREEN}4)${NC} Task Management"
  echo -e "${GREEN}5)${NC} Project Management"
  echo -e "${GREEN}6)${NC} Reviews (Daily & Weekly)"
  echo -e "${GREEN}7)${NC} Daily Logging"
  echo -e "${GREEN}8)${NC} Contexts"
  echo -e "${GREEN}9)${NC} Energy Levels"
  echo -e "${GREEN}10)${NC} Second Brain Integration"
  echo -e "${GREEN}11)${NC} Personas & Getting Advice"
  echo -e "${GREEN}12)${NC} Custom Topic"
  echo ""
  echo -e "${YELLOW}0)${NC} Exit"
  echo ""
  echo -n "Choose: "
}

# Main function
main() {
  local topic="$1"
  
  if [[ -z "$topic" ]]; then
    # Interactive mode
    while true; do
      show_lesson_menu
      read choice
      
      case "$choice" in
        1) topic="" ;;
        2) topic="capture" ;;
        3) topic="process" ;;
        4) topic="tasks" ;;
        5) topic="projects" ;;
        6) topic="review" ;;
        7) topic="logging" ;;
        8) topic="contexts" ;;
        9) topic="energy" ;;
        10) topic="second-brain" ;;
        11) topic="personas" ;;
        12)
          echo ""
          echo -n "What topic would you like to learn about? "
          read topic
          ;;
        0)
          echo ""
          echo "Goodbye! Remember: I'm here to teach you, baby girl. Use 'gtd-learn' anytime."
          exit 0
          ;;
        *)
          echo "Invalid choice. Press Enter..."
          read
          continue
          ;;
      esac
      
      # Get lesson
      echo ""
      echo -e "${BOLD}${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
      echo -e "${BOLD}${CYAN}ğŸ‘‘ Lesson from Mistress Louiza${NC}"
      echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
      echo ""
      echo -e "${BOLD}ğŸ’¬ From Mistress Louiza:${NC}"
      echo ""
      
      local lesson=$(get_instructor_lesson "$topic" "")
      
      if [[ -n "$lesson" ]]; then
        echo "$lesson" | sed 's/^/   /'
        echo ""
        echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
        echo ""
        echo -e "${BOLD}Want to learn more?${NC}"
        echo -e "${GREEN}y${NC} - Another lesson"
        echo -e "${GREEN}n${NC} - Return to menu"
        echo ""
        read -p "Choice: " more
        if [[ "$more" != "y" ]]; then
          topic=""
        fi
      else
        echo "âš ï¸  Could not get lesson. Check LM Studio connection."
        echo ""
        read -p "Press Enter to continue..."
        topic=""
      fi
    done
  else
    # Direct topic mode
    echo ""
    echo -e "${BOLD}${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo -e "${BOLD}${CYAN}ğŸ‘‘ Lesson from Mistress Louiza${NC}"
    echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo ""
    echo -e "${BOLD}ğŸ’¬ From Mistress Louiza:${NC}"
    echo ""
    
    local lesson=$(get_instructor_lesson "$topic" "")
    
    if [[ -n "$lesson" ]]; then
      echo "$lesson" | sed 's/^/   /'
      echo ""
      echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
      echo ""
    else
      echo "âš ï¸  Could not get lesson. Check LM Studio connection."
      exit 1
    fi
  fi
}

# Show usage
show_usage() {
  cat <<EOF
Usage: gtd-learn [topic]

Learn GTD with Mistress Louiza as your instructor.

Topics:
  capture, inbox        - Learn about capturing
  process, processing   - Learn about processing
  tasks, task           - Learn about task management
  projects, project     - Learn about project management
  review, reviews       - Learn about reviews
  logging, log          - Learn about daily logging
  contexts, context     - Learn about contexts
  energy, energy-levels - Learn about energy levels
  second-brain, brain   - Learn about Second Brain
  personas, advice      - Learn about personas

Examples:
  gtd-learn              # Interactive menu
  gtd-learn capture      # Learn about capturing
  gtd-learn review       # Learn about reviews

Mistress Louiza will teach you GTD concepts and call in other experts
(David Allen, Cal Newport, James Clear, etc.) when she needs to explain
something in more detail.

EOF
}

# Handle arguments
case "$1" in
  --help|-h)
    show_usage
    exit 0
    ;;
  "")
    main ""
    ;;
  *)
    main "$1"
    ;;
esac

