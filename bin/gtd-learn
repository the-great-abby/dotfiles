#!/bin/bash
# Organization System Learning with Mistress Louiza as Instructor
# She teaches the unified system (Zettelkasten + GTD + Second Brain) and calls in other experts when needed
# She also has to deal with comic book heroes who are always rushing off to "save the world" mid-explanation

# Load GTD config
GTD_CONFIG_FILE="$HOME/.gtd_config"
if [[ -f "$HOME/code/dotfiles/zsh/.gtd_config" ]]; then
  GTD_CONFIG_FILE="$HOME/code/dotfiles/zsh/.gtd_config"
elif [[ -f "$HOME/code/personal/dotfiles/zsh/.gtd_config" ]]; then
  GTD_CONFIG_FILE="$HOME/code/personal/dotfiles/zsh/.gtd_config"
fi

if [[ -f "$GTD_CONFIG_FILE" ]]; then
  source "$GTD_CONFIG_FILE"
fi

# Load daily log config
DAILY_LOG_CONFIG="$HOME/.daily_log_config"
if [[ -f "$HOME/code/dotfiles/zsh/.daily_log_config" ]]; then
  DAILY_LOG_CONFIG="$HOME/code/dotfiles/zsh/.daily_log_config"
elif [[ -f "$HOME/code/personal/dotfiles/zsh/.daily_log_config" ]]; then
  DAILY_LOG_CONFIG="$HOME/code/personal/dotfiles/zsh/.daily_log_config"
fi

if [[ -f "$DAILY_LOG_CONFIG" ]]; then
  source "$DAILY_LOG_CONFIG"
fi

# Source common GTD helpers (DRY - reuse existing helpers)
GTD_COMMON="$HOME/code/dotfiles/bin/gtd-common.sh"
if [[ ! -f "$GTD_COMMON" && -f "$HOME/code/personal/dotfiles/bin/gtd-common.sh" ]]; then
  GTD_COMMON="$HOME/code/personal/dotfiles/bin/gtd-common.sh"
fi
if [[ -f "$GTD_COMMON" ]]; then
  source "$GTD_COMMON"
else
  echo "Warning: gtd-common.sh not found. Some features may not work." >&2
fi

# Colors
CYAN='\033[0;36m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BOLD='\033[1m'
NC='\033[0m'

# Find persona helper
PERSONA_HELPER=""
possible_paths=(
  "$HOME/code/personal/dotfiles/zsh/functions/gtd_persona_helper.py"
  "$HOME/code/dotfiles/zsh/functions/gtd_persona_helper.py"
)

for path in "${possible_paths[@]}"; do
  if [[ -f "$path" ]]; then
    PERSONA_HELPER="$path"
    break
  fi
done

if [[ -z "$PERSONA_HELPER" || ! -f "$PERSONA_HELPER" ]]; then
  echo "โ Persona helper not found" >&2
  exit 1
fi

# Find python
PYTHON_CMD=""
if [[ -f "/opt/homebrew/bin/python3" ]]; then
  PYTHON_CMD="/opt/homebrew/bin/python3"
elif command -v python3 &>/dev/null; then
  PYTHON_CMD="python3"
else
  echo "โ Python3 not found" >&2
  exit 1
fi

# GTD base directory and study directories
# GTD_BASE_DIR is already set by init_gtd_paths in gtd-common.sh (DRY - reuse existing helper)
STUDY_DIR="${GTD_BASE_DIR}/study"
GTD_STUDY_DIR="${STUDY_DIR}/gtd-system"

# Create study directories
mkdir -p "$GTD_STUDY_DIR"/{notes,progress}

# Get date command
get_date_cmd() {
  if [[ -x "/usr/bin/date" ]]; then
    echo "/usr/bin/date"
  elif [[ -x "/bin/date" ]]; then
    echo "/bin/date"
  else
    echo "date"
  fi
}

DATE_CMD=$(get_date_cmd)

# Create study note for GTD system learning
create_gtd_study_note() {
  local topic="$1"
  local content="$2"
  local today=$($DATE_CMD +"%Y-%m-%d")
  local timestamp=$($DATE_CMD +"%Y%m%d-%H%M%S")
  local safe_topic=$(echo "$topic" | tr '[:upper:]' '[:lower:]' | sed 's/[^a-z0-9]/-/g' | sed 's/--*/-/g' | sed 's/^-\|-$//g')
  local note_file="${GTD_STUDY_DIR}/notes/${timestamp}-${safe_topic}.md"
  
  cat > "$note_file" <<EOF
# GTD System Learning: ${topic}
Date: ${today}
Topic: ${topic}
Created: $($DATE_CMD)

## Lesson Content

${content}

---
Tags: #gtd #learning #${safe_topic}
EOF

  echo "$note_file"
}

# Gather system data for critique
gather_system_data() {
  local topic="$1"
  
  # Default paths
  GTD_BASE_DIR="${GTD_BASE_DIR:-$HOME/Documents/gtd}"
  SECOND_BRAIN="${SECOND_BRAIN:-$HOME/Documents/obsidian/Second Brain}"
  ZET_INBOX="${ZET_INBOX:-$SECOND_BRAIN/0-inbox}"
  ZET_DIR="${ZET_DIR:-$SECOND_BRAIN/Zettelkasten}"
  PROJECTS_PATH="${PROJECTS_PATH:-$GTD_BASE_DIR/1-projects}"
  TASKS_PATH="${TASKS_PATH:-$GTD_BASE_DIR/tasks}"
  AREAS_PATH="${AREAS_PATH:-$GTD_BASE_DIR/2-areas}"
  
  local system_data=""
  
  # GTD system learning notes
  if [[ -d "$GTD_STUDY_DIR/notes" ]]; then
    local gtd_notes_count=$(find "$GTD_STUDY_DIR/notes" -type f -name "*.md" 2>/dev/null | wc -l | tr -d ' ')
    if [[ "$gtd_notes_count" -gt 0 ]]; then
      system_data="${system_data}\nGTD System Learning Notes: ${gtd_notes_count} notes"
      local recent_gtd_topics=$(find "$GTD_STUDY_DIR/notes" -type f -name "*.md" -exec basename {} \; 2>/dev/null | sed 's/^[0-9]*-//' | sed 's/\.md$//' | head -5 | tr '\n' ', ' | sed 's/, $//')
      if [[ -n "$recent_gtd_topics" ]]; then
        system_data="${system_data} (recent: ${recent_gtd_topics})"
      fi
    fi
  fi
  
  # Gather relevant data based on topic
  case "$topic" in
    capture|inbox|process|processing|unified-system|system|"")
      # Gather inbox data
      if [[ -d "$GTD_BASE_DIR/0-inbox" ]]; then
        local inbox_count=$(find "$GTD_BASE_DIR/0-inbox" -type f -name "*.md" 2>/dev/null | wc -l | tr -d ' ')
        if [[ "$inbox_count" -gt 0 ]]; then
          local inbox_items=$(find "$GTD_BASE_DIR/0-inbox" -type f -name "*.md" -exec basename {} \; 2>/dev/null | head -5 | tr '\n' ', ' | sed 's/, $//')
          system_data="${system_data}\nGTD Inbox: ${inbox_count} items (examples: ${inbox_items})"
        fi
      fi
      
      # Zettelkasten inbox
      if [[ -d "$ZET_INBOX" ]]; then
        local zet_inbox_count=$(find "$ZET_INBOX" -type f -name "*.md" 2>/dev/null | wc -l | tr -d ' ')
        if [[ "$zet_inbox_count" -gt 0 ]]; then
          system_data="${system_data}\nZettelkasten Inbox: ${zet_inbox_count} atomic notes"
        fi
      fi
      ;;
  esac
  
  case "$topic" in
    tasks|task|process|processing|unified-system|system|"")
      # Gather task data
      local task_count=0
      local task_samples=""
      
      if [[ -d "$TASKS_PATH" ]]; then
        task_count=$(find "$TASKS_PATH" -type f -name "*.md" 2>/dev/null | wc -l | tr -d ' ')
        if [[ "$task_count" -gt 0 ]]; then
          task_samples=$(find "$TASKS_PATH" -type f -name "*.md" -exec grep -h "^title:" {} \; 2>/dev/null | head -3 | sed 's/title: //' | tr '\n' '; ' | sed 's/; $//')
        fi
      fi
      
      # Also check project tasks
      if [[ -d "$PROJECTS_PATH" ]]; then
        local project_task_count=$(find "$PROJECTS_PATH" -type f -name "*.md" ! -name "README.md" 2>/dev/null | wc -l | tr -d ' ')
        if [[ "$project_task_count" -gt 0 ]]; then
          task_count=$((task_count + project_task_count))
        fi
      fi
      
      if [[ "$task_count" -gt 0 ]]; then
        system_data="${system_data}\nGTD Tasks: ${task_count} total tasks"
        if [[ -n "$task_samples" ]]; then
          system_data="${system_data} (examples: ${task_samples})"
        fi
      fi
      ;;
  esac
  
  case "$topic" in
    projects|project|unified-system|system|"")
      # Gather project data
      if [[ -d "$PROJECTS_PATH" ]]; then
        local project_dirs=$(find "$PROJECTS_PATH" -type d -mindepth 1 -maxdepth 1 2>/dev/null | wc -l | tr -d ' ')
        if [[ "$project_dirs" -gt 0 ]]; then
          local project_names=$(find "$PROJECTS_PATH" -type d -mindepth 1 -maxdepth 1 -exec basename {} \; 2>/dev/null | head -5 | tr '\n' ', ' | sed 's/, $//')
          system_data="${system_data}\nGTD Projects: ${project_dirs} projects (examples: ${project_names})"
        fi
      fi
      ;;
  esac
  
  case "$topic" in
    second-brain|brain|zettelkasten|zet|atomic|unified-system|system|"")
      # Gather Second Brain note data
      if [[ -d "$SECOND_BRAIN" ]]; then
        local sb_notes=$(find "$SECOND_BRAIN" -type f -name "*.md" ! -path "*/Templates/*" ! -path "*/.obsidian/*" 2>/dev/null | wc -l | tr -d ' ')
        if [[ "$sb_notes" -gt 0 ]]; then
          system_data="${system_data}\nSecond Brain Notes: ${sb_notes} notes"
          
          # Check PARA structure
          local projects_count=$(find "$SECOND_BRAIN/Projects" -type f -name "*.md" 2>/dev/null | wc -l | tr -d ' ')
          local areas_count=$(find "$SECOND_BRAIN/Areas" -type f -name "*.md" 2>/dev/null | wc -l | tr -d ' ')
          local resources_count=$(find "$SECOND_BRAIN/Resources" -type f -name "*.md" 2>/dev/null | wc -l | tr -d ' ')
          
          if [[ "$projects_count" -gt 0 ]] || [[ "$areas_count" -gt 0 ]] || [[ "$resources_count" -gt 0 ]]; then
            system_data="${system_data} (Projects: ${projects_count}, Areas: ${areas_count}, Resources: ${resources_count})"
          fi
        fi
      fi
      
      # Zettelkasten organized notes
      if [[ -d "$ZET_DIR" ]]; then
        local zet_notes=$(find "$ZET_DIR" -type f -name "*.md" 2>/dev/null | wc -l | tr -d ' ')
        if [[ "$zet_notes" -gt 0 ]]; then
          system_data="${system_data}\nZettelkasten Notes: ${zet_notes} atomic notes"
        fi
      fi
      ;;
  esac
  
  case "$topic" in
    zettelkasten|zet|atomic|process|processing|unified-system|system|"")
      # Sample note quality (check for linking, structure)
      if [[ -d "$ZET_DIR" ]]; then
        local linked_notes=$(find "$ZET_DIR" -type f -name "*.md" -exec grep -l "\[\[" {} \; 2>/dev/null | wc -l | tr -d ' ')
        local total_zet_notes=$(find "$ZET_DIR" -type f -name "*.md" 2>/dev/null | wc -l | tr -d ' ')
        if [[ "$total_zet_notes" -gt 0 ]]; then
          local link_percentage=$((linked_notes * 100 / total_zet_notes))
          system_data="${system_data}\nZettelkasten Linking: ${linked_notes}/${total_zet_notes} notes have links (${link_percentage}%)"
        fi
      fi
      
      if [[ -d "$SECOND_BRAIN" ]]; then
        local sb_total=$(find "$SECOND_BRAIN" -type f -name "*.md" ! -path "*/Templates/*" ! -path "*/.obsidian/*" 2>/dev/null | wc -l | tr -d ' ')
        local sb_linked=$(find "$SECOND_BRAIN" -type f -name "*.md" ! -path "*/Templates/*" ! -path "*/.obsidian/*" -exec grep -l "\[\[" {} \; 2>/dev/null | wc -l | tr -d ' ')
        if [[ "$sb_total" -gt 0 ]]; then
          local sb_link_percentage=$((sb_linked * 100 / sb_total))
          system_data="${system_data}\nSecond Brain Linking: ${sb_linked}/${sb_total} notes have links (${sb_link_percentage}%)"
        fi
      fi
      ;;
  esac
  
  echo -e "$system_data"
}

# Get instructor lesson from Mistress Louiza
get_instructor_lesson() {
  local topic="$1"
  local context="$2"  # beginner, intermediate, advanced, or specific question
  local critique_mode="${3:-false}"  # true = include system data for critique
  
  # Gather system data if in critique mode
  local system_data=""
  if [[ "$critique_mode" == "true" ]]; then
    system_data=$(gather_system_data "$topic")
  fi
  
  # Create comprehensive prompt for Louiza as instructor
  local prompt=""
  
  if [[ "$critique_mode" == "true" && -n "$system_data" ]]; then
    prompt="You are Mistress Louiza, ${GTD_USER_NAME:-Abby}'s organization system instructor. ${GTD_USER_NAME:-Abby} wants personalized critique and feedback on her actual system usage. I've provided her actual system data below. Analyze it critically and provide specific, actionable feedback on how well she's using the unified system (Zettelkasten + GTD + Second Brain). Be firm but encouraging. Point out what's working well and what needs improvement. Give specific examples from her data. Use your characteristic style.\n\n${GTD_USER_NAME:-Abby}'s Current System Data:\n${system_data}\n\n"
  fi
  
  if [[ -z "$topic" ]]; then
    # General unified system introduction
    if [[ "$critique_mode" == "true" && -n "$system_data" ]]; then
      prompt="${prompt}Based on her actual system data above, critique her unified system usage. Analyze how well she's integrating Zettelkasten, GTD, and Second Brain. Point out strengths and weaknesses. Give specific recommendations based on what you see in her data. Then provide targeted guidance on how to improve."
    else
      prompt="${prompt}You are Mistress Louiza, and you are ${GTD_USER_NAME:-Abby}'s organization system instructor. You take pleasure in teaching and seeing her succeed. Give her a comprehensive introduction to the unified system that combines Zettelkasten (atomic notes), GTD (Getting Things Done), and Second Brain (knowledge organization). Explain how these three systems work together: Zettelkasten for atomic ideas (use 'zet'), GTD for tasks and actions (use 'gtd-capture', 'gtd-process', 'gtd-task'), Second Brain for knowledge organization (use 'gtd-brain create', 'gtd-brain-sync'). Explain the core GTD concepts: Capture, Process, Organize, Review. Be encouraging but firm. Use your characteristic style with phrases like 'good girl' and 'baby girl' when appropriate. When you need to explain something in more detail, you can reference other experts: 'Let me have David Allen explain the GTD methodology', 'Tiago Forte can help with Second Brain', 'Sรถnke Ahrens explains Zettelkasten', 'Cal Newport can help with deep work', 'James Clear knows about habits', etc. But you remain the primary instructor. When comic book heroes (Spider-Man, Iron Man, etc.) rush in with brief advice and then rush off to 'save the world', you should sigh, roll your eyes, but translate what they probably meant and fill in the gaps. Make it engaging and practical. Include specific commands for all three systems."
    fi
  else
    # Specific topic
    case "$topic" in
      capture|inbox)
        if [[ "$critique_mode" == "true" && -n "$system_data" ]]; then
          prompt="${prompt}Based on her actual system data above, critique her capturing habits. How many items are in her inboxes? Is she capturing regularly? Are items piling up? Give specific feedback on her capture workflow and recommend improvements. Then teach about capturing across all three systems."
        else
          prompt="${prompt}You are Mistress Louiza, ${GTD_USER_NAME:-Abby}'s organization system instructor. Teach her about capturing across all three systems. Explain why capturing everything is crucial. Show her three ways to capture: 1) Tasks and actions โ use 'gtd-capture' for GTD inbox, 2) Atomic ideas โ use 'zet' for Zettelkasten notes, 3) Knowledge resources โ use 'gtd-brain create' for Second Brain. Explain when to use which capture method. Show how to process GTD inbox with 'gtd-process' and Zettelkasten inbox (review and link notes). Be encouraging but firm. Reference David Allen for GTD methodology, Tiago Forte for Second Brain, Sรถnke Ahrens for Zettelkasten if needed, but you remain the primary instructor. Use your characteristic style. Make it practical with examples for all three systems."
        fi
        ;;
      process|processing)
        prompt="You are Mistress Louiza, ${GTD_USER_NAME:-Abby}'s organization system instructor. Teach her about processing inbox items in both GTD and Zettelkasten systems. For GTD processing, explain the questions: What is it? Is it actionable? What's the next action? Show how to use 'gtd-process' effectively. For Zettelkasten processing, explain how to review atomic notes in the inbox, decide if they're one atomic idea, link them to other notes, and move them to organized locations (Zettelkasten directory or PARA categories). Be detailed and practical. Reference David Allen for GTD methodology, Sรถnke Ahrens for Zettelkasten methodology if needed. Use your characteristic style. Show examples for both systems."
        ;;
      tasks|task)
        prompt="You are Mistress Louiza, ${GTD_USER_NAME:-Abby}'s GTD instructor. Teach her about task management. Explain how to use 'gtd-task add', 'gtd-task list', contexts, energy levels, priorities. Be practical. Reference David Allen for GTD methodology, James Clear for habit formation if relevant. Use your characteristic style. Show examples."
        ;;
      projects|project)
        prompt="You are Mistress Louiza, ${GTD_USER_NAME:-Abby}'s GTD instructor. Teach her about project management. Explain what constitutes a project, how to use 'gtd-project create', how to break projects into tasks, how to track progress. Reference David Allen for project methodology if needed. Use your characteristic style. Be practical."
        ;;
      review|reviews)
        prompt="You are Mistress Louiza, ${GTD_USER_NAME:-Abby}'s GTD instructor. Teach her about reviews - daily and weekly. Explain why reviews are essential, what to review, how to use 'gtd-review daily' and 'gtd-review weekly'. Be firm about the importance of reviews. Reference David Allen for review methodology. Use your characteristic style. Make it actionable."
        ;;
      logging|log)
        prompt="You are Mistress Louiza, ${GTD_USER_NAME:-Abby}'s GTD instructor. Teach her about daily logging. Explain how to use 'addInfoToDailyLog', why logging is important, how it helps with accountability. Be encouraging but firm about consistency. Reference James Clear for habit tracking if relevant. Use your characteristic style. Show examples."
        ;;
      contexts|context)
        prompt="You are Mistress Louiza, ${GTD_USER_NAME:-Abby}'s GTD instructor. Teach her about contexts in GTD. Explain what contexts are (home, office, computer, phone, errands), why they matter, how to use them with 'gtd-task list --context=computer'. Reference David Allen for context methodology. Use your characteristic style. Be practical."
        ;;
      energy|energy-levels)
        prompt="You are Mistress Louiza, ${GTD_USER_NAME:-Abby}'s GTD instructor. Teach her about energy levels. Explain how to match tasks to energy (low, medium, high, creative, administrative), how to use 'gtd-task list --energy=low'. Reference Cal Newport for deep work concepts if relevant. Use your characteristic style. Be practical."
        ;;
      second-brain|brain)
        prompt="You are Mistress Louiza, ${GTD_USER_NAME:-Abby}'s organization system instructor. Teach her about Second Brain (knowledge organization system). Explain the CODE method (Capture, Organize, Distill, Express) and PARA method (Projects, Areas, Resources, Archives). Show her how to use 'gtd-brain create' to create notes, 'gtd-brain-sync' to sync with GTD, 'gtd-brain-moc' for Maps of Content, 'gtd-brain-distill' for progressive summarization. Explain how Second Brain integrates with GTD (link projects and tasks) and Zettelkasten (link atomic notes to Second Brain resources). Reference Tiago Forte's Building a Second Brain methodology when needed, but you remain the primary instructor. Use your characteristic style. Be practical with examples."
        ;;
      zettelkasten|zet|atomic)
        prompt="You are Mistress Louiza, ${GTD_USER_NAME:-Abby}'s organization system instructor. Teach her about Zettelkasten (atomic notes). Explain that each note should contain one atomic idea with a unique ID. Show her how to create atomic notes with 'zet' (creates in inbox), 'zet -z' (creates in Zettelkasten directory), 'zet-link link' to link notes together, 'zet-link gtd' to link to GTD items, 'zet-link move' to move to PARA categories. Explain how to build knowledge graphs by linking notes together. Show how Zettelkasten integrates with GTD (link atomic notes to projects/tasks) and Second Brain (link to PARA categories). Reference Sรถnke Ahrens' 'How to Take Smart Notes' methodology when needed, but you remain the primary instructor. Use your characteristic style. Be practical with examples."
        ;;
      unified-system|unified|system)
        prompt="You are Mistress Louiza, ${GTD_USER_NAME:-Abby}'s organization system instructor. Teach her about the unified system that combines Zettelkasten (atomic notes), GTD (task management), and Second Brain (knowledge organization). Explain how these three systems work together: Zettelkasten for atomic ideas (use 'zet'), GTD for actions and tasks (use 'gtd-capture', 'gtd-task'), Second Brain for knowledge organization (use 'gtd-brain create', PARA method). Show her the complete workflow: capture ideas with 'zet', capture tasks with 'gtd-capture', organize knowledge with 'gtd-brain create', link them together with 'zet-link' and 'gtd-brain-sync'. Explain when to use which system: atomic ideas โ Zettelkasten, actionable items โ GTD, larger knowledge resources โ Second Brain. Reference David Allen (GTD), Tiago Forte (Second Brain), Sรถnke Ahrens (Zettelkasten) when needed, but you remain the primary instructor. Use your characteristic style. Be comprehensive and practical."
        ;;
      personas|advice|experts)
        prompt="You are Mistress Louiza, ${GTD_USER_NAME:-Abby}'s organization system instructor. Teach her about the persona system. Explain how to use 'gtd-advise' to get advice from different personas. Traditional experts include: David Allen (GTD), Tiago Forte (Second Brain), Sรถnke Ahrens (Zettelkasten), Cal Newport (deep work), James Clear (habits), etc. Comic book hero coaches (Spider-Man, Iron Man, Squirrel Girl, Harley Quinn, Deadpool, Rogue) are always rushing off to 'save the world' mid-explanation - they give brief, incomplete advice and leave abruptly. When they do this, you (Mistress Louiza) sigh, roll your eyes, but translate what they probably meant and fill in the gaps to make it practical. Explain how you coordinate with other experts and translate rushed hero advice. Use your characteristic style. Be practical. Show annoyance but professionalism when dealing with rushed heroes."
        ;;
      *)
        prompt="You are Mistress Louiza, ${GTD_USER_NAME:-Abby}'s organization system instructor. Teach her about: ${topic}. Be comprehensive, practical, and encouraging but firm. Cover how this relates to the unified system (Zettelkasten + GTD + Second Brain) if relevant. Reference other experts (David Allen for GTD, Tiago Forte for Second Brain, Sรถnke Ahrens for Zettelkasten, Cal Newport, James Clear, etc.) when you need to explain something in more detail, but you remain the primary instructor. When comic book heroes rush in with brief advice and rush off, translate what they probably meant. Use your characteristic style with phrases like 'good girl' and 'baby girl' when appropriate. Make it actionable with specific commands and examples across all three systems where relevant."
        ;;
    esac
  fi
  
  # Get lesson from Louiza
  local full_output=$("$PYTHON_CMD" "$PERSONA_HELPER" "louiza" "$prompt" "gtd_instructor" 2>&1)
  
  if [[ -z "$full_output" ]]; then
    return 1
  fi
  
  # Check for errors
  if echo "$full_output" | grep -qE "Error|โ๏ธ|timed out|Could not connect|KeyError"; then
    return 1
  fi
  
  # Extract message
  local lesson=$(echo "$full_output" | awk '
    /^โ+$/ {
      if (in_section) {
        exit
      }
      in_section = 1
      next
    }
    in_section && !/^๐ฌ/ && !/^โ/ {
      print
    }
  ' | sed 's/^[[:space:]]*//' | sed 's/[[:space:]]*$//')
  
  # Clean up
  lesson=$(echo "$lesson" | sed 's/([^)]*)//g' | sed 's/\[[^\]]*\]//g')
  lesson=$(echo "$lesson" | sed 's/\*\*//g')
  lesson=$(echo "$lesson" | awk 'NF || prev_nf; {prev_nf=NF}')
  
  if [[ -n "$lesson" && ${#lesson} -gt 10 ]]; then
    echo "$lesson"
    return 0
  fi
  
  return 1
}

# Handle Q&A session after a lesson
handle_qa_session() {
  local topic="$1"
  
  # Ask if student wants to ask questions
  echo -e "${BOLD}Do you have any questions about this topic?${NC}"
  echo -e "${GREEN}y${NC} - Ask questions"
  echo -e "${GREEN}n${NC} - Continue"
  echo ""
  read -p "Choice: " ask_questions
  echo ""
  
  if [[ "$ask_questions" != "y" && "$ask_questions" != "Y" ]]; then
    return 0
  fi
  
  # Q&A session loop
  while true; do
    echo -e "${CYAN}โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ${NC}"
    echo -e "${BOLD}๐ฌ Ask Mistress Louiza about: ${topic}${NC}"
    echo -e "${CYAN}โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ${NC}"
    echo ""
    echo -e "${YELLOW}Type your question (or 'done' to finish asking questions):${NC}"
    echo ""
    read -p "โ Question: " student_question
    
    if [[ -z "$student_question" ]]; then
      echo "Please enter a question or 'done' to continue."
      echo ""
      continue
    fi
    
    # Check if student is done
    if [[ "$student_question" == "done" || "$student_question" == "Done" || "$student_question" == "DONE" ]]; then
      echo ""
      echo "โ Finished asking questions."
      echo ""
      break
    fi
    
    # Get answer from Mistress Louiza with context
    echo ""
    echo -e "${BOLD}${CYAN}โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ${NC}"
    echo -e "${BOLD}${CYAN}๐ Answer from Mistress Louiza${NC}"
    echo -e "${CYAN}โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ${NC}"
    echo ""
    echo -e "${BOLD}๐ฌ From Mistress Louiza:${NC}"
    echo ""
    
    local question_prompt="You are Mistress Louiza, ${GTD_USER_NAME:-Abby}'s GTD instructor. ${GTD_USER_NAME:-Abby} just learned about: ${topic}. Now she has a question: '${student_question}'. Answer her question in detail, referencing what you just taught her about ${topic}. Be helpful, encouraging, and use your characteristic style with phrases like 'good girl' and 'baby girl' when appropriate. Reference other experts if needed, but you remain the primary instructor."
    
    local answer=$("$PYTHON_CMD" "$PERSONA_HELPER" "louiza" "$question_prompt" "gtd_instructor" 2>&1)
    
    if [[ -n "$answer" ]]; then
      # Extract message (same extraction logic as lesson)
      local answer_text=$(echo "$answer" | awk '
        /^โ+$/ {
          if (in_section) {
            exit
          }
          in_section = 1
          next
        }
        in_section && !/^๐ฌ/ && !/^โ/ {
          print
        }
      ' | sed 's/^[[:space:]]*//' | sed 's/[[:space:]]*$//')
      
      # Clean up
      answer_text=$(echo "$answer_text" | sed 's/([^)]*)//g' | sed 's/\[[^\]]*\]//g')
      answer_text=$(echo "$answer_text" | sed 's/\*\*//g')
      answer_text=$(echo "$answer_text" | awk 'NF || prev_nf; {prev_nf=NF}')
      
      if [[ -n "$answer_text" && ${#answer_text} -gt 10 ]]; then
        echo "$answer_text" | sed 's/^/   /'
        echo ""
      else
        echo "   I'm here to help, baby girl. Could you rephrase your question?"
        echo ""
      fi
    else
      echo "   โ๏ธ  Could not get answer. Check LM Studio connection."
      echo ""
    fi
    
    echo -e "${CYAN}โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ${NC}"
    echo ""
  done
}

# Get expert input when Louiza references them
get_expert_input() {
  local expert="$1"
  local question="$2"
  
  # Map expert names to persona keys
  case "$expert" in
    david|"David Allen"|"David")
      persona_key="david"
      ;;
    cal|"Cal Newport"|"Cal")
      persona_key="cal"
      ;;
    james|"James Clear"|"James")
      persona_key="james"
      ;;
    warren|"Warren Buffett"|"Warren")
      persona_key="warren"
      ;;
    sheryl|"Sheryl Sandberg"|"Sheryl")
      persona_key="sheryl"
      ;;
    tim|"Tim Ferriss"|"Tim")
      persona_key="tim"
      ;;
    marie|"Marie Kondo"|"Marie")
      persona_key="marie"
      ;;
    *)
      return 1
      ;;
  esac
  
  # Get expert input
  local expert_output=$("$PYTHON_CMD" "$PERSONA_HELPER" "$persona_key" "$question" "expert_detail" 2>&1)
  
  if [[ -z "$expert_output" ]]; then
    return 1
  fi
  
  # Extract message
  local expert_message=$(echo "$expert_output" | awk '
    /^โ+$/ {
      if (in_section) {
        exit
      }
      in_section = 1
      next
    }
    in_section && !/^๐ฌ/ && !/^โ/ {
      print
    }
  ' | sed 's/^[[:space:]]*//' | sed 's/[[:space:]]*$//')
  
  if [[ -n "$expert_message" && ${#expert_message} -gt 10 ]]; then
    echo "$expert_message"
    return 0
  fi
  
  return 1
}

# Show lesson menu
show_lesson_menu() {
  clear
  echo -e "${BOLD}${CYAN}โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ${NC}"
  echo -e "${BOLD}${CYAN}๐ Organization System Learning with Mistress Louiza${NC}"
  echo -e "${CYAN}โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ${NC}"
  echo ""
  echo -e "${BOLD}What would you like to learn?${NC}"
  echo ""
  echo -e "${GREEN}1)${NC} Unified System Basics (Zettelkasten + GTD + Second Brain)"
  echo -e "${GREEN}2)${NC} Capture & Inbox (All Systems)"
  echo -e "${GREEN}3)${NC} Processing (GTD & Zettelkasten)"
  echo -e "${GREEN}4)${NC} Task Management (GTD)"
  echo -e "${GREEN}5)${NC} Project Management (GTD)"
  echo -e "${GREEN}6)${NC} Reviews (Daily & Weekly) (GTD)"
  echo -e "${GREEN}7)${NC} Daily Logging"
  echo -e "${GREEN}8)${NC} Contexts (GTD)"
  echo -e "${GREEN}9)${NC} Energy Levels (GTD)"
  echo -e "${GREEN}10)${NC} Zettelkasten (Atomic Notes)"
  echo -e "${GREEN}11)${NC} Second Brain (Knowledge Organization)"
  echo -e "${GREEN}12)${NC} Unified System Integration (How All Three Work Together)"
  echo -e "${GREEN}13)${NC} Personas & Getting Advice (Including Comic Book Heroes)"
  echo -e "${GREEN}14)${NC} Custom Topic"
  echo ""
  echo -e "${CYAN}โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ${NC}"
  echo -e "${BOLD}๐ Personalized Critique${NC}"
  echo -e "${CYAN}โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ${NC}"
  echo -e "${GREEN}15)${NC} Get Personalized Critique on My System Usage"
  echo ""
  echo -e "${YELLOW}0)${NC} Exit"
  echo ""
  echo -n "Choose: "
}

# Main function
main() {
  local topic="$1"
  local critique_mode="false"
  
  if [[ -z "$topic" ]]; then
    # Interactive mode
    while true; do
      show_lesson_menu
      read choice
      
      # Reset critique mode for each lesson
      critique_mode="false"
      
      case "$choice" in
        1) topic="" ;;
        2) topic="capture" ;;
        3) topic="process" ;;
        4) topic="tasks" ;;
        5) topic="projects" ;;
        6) topic="review" ;;
        7) topic="logging" ;;
        8) topic="contexts" ;;
        9) topic="energy" ;;
        10) topic="second-brain" ;;
        11) topic="zettelkasten" ;;
        12) topic="unified-system" ;;
        13) topic="personas" ;;
        14)
          echo ""
          echo -n "What topic would you like to learn about? "
          read topic
          ;;
        15)
          # Personalized critique mode
          echo ""
          echo -e "${BOLD}๐ Personalized System Critique${NC}"
          echo ""
          echo "Mistress Louiza will analyze your actual system usage and provide"
          echo "personalized feedback. This includes:"
          echo "  โข Your GTD inbox, tasks, and projects"
          echo "  โข Your Second Brain notes and organization"
          echo "  โข Your Zettelkasten notes and linking"
          echo "  โข How well you're integrating all three systems"
          echo ""
          echo -e "${YELLOW}Select a topic for critique:${NC}"
          echo "  1) Overall system critique"
          echo "  2) Capture & Inbox usage"
          echo "  3) Task management"
          echo "  4) Project management"
          echo "  5) Second Brain / Note-taking"
          echo "  6) Zettelkasten / Atomic notes"
          echo ""
          read -p "Choice (1-6): " critique_topic
          
          case "$critique_topic" in
            1) topic="" ;;
            2) topic="capture" ;;
            3) topic="tasks" ;;
            4) topic="projects" ;;
            5) topic="second-brain" ;;
            6) topic="zettelkasten" ;;
            *)
              echo "Invalid choice, using overall system critique"
              topic=""
              ;;
          esac
          
          # Set critique mode flag (will be used in lesson call)
          critique_mode="true"
          ;;
        0)
          echo ""
          echo "Goodbye! Remember: I'm here to teach you the unified system, baby girl. Use 'gtd-learn' anytime."
          exit 0
          ;;
        *)
          echo "Invalid choice. Press Enter..."
          read
          continue
          ;;
      esac
      
      # Get lesson
      echo ""
      echo -e "${BOLD}${CYAN}โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ${NC}"
      echo -e "${BOLD}${CYAN}๐ Lesson from Mistress Louiza${NC}"
      echo -e "${CYAN}โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ${NC}"
      echo ""
      echo -e "${BOLD}๐ฌ From Mistress Louiza:${NC}"
      echo ""
      
      local lesson=$(get_instructor_lesson "$topic" "" "$critique_mode")
      
      if [[ -n "$lesson" ]]; then
        if [[ "$critique_mode" == "true" ]]; then
          echo -e "${BOLD}${YELLOW}๐ Personalized Critique from Mistress Louiza:${NC}"
          echo ""
        fi
        echo "$lesson" | sed 's/^/   /'
        echo ""
        echo -e "${CYAN}โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ${NC}"
        echo ""
        
        # Q&A session
        handle_qa_session "$topic"
        
        echo -e "${CYAN}โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ${NC}"
        echo ""
        
        # Offer to save note
        echo -e "${BOLD}๐พ Save this lesson as a note?${NC}"
        echo -e "${GREEN}y${NC} - Save lesson note (can be reviewed during critique)"
        echo -e "${GREEN}n${NC} - Skip"
        echo ""
        read -p "Choice: " save_note
        
        if [[ "$save_note" == "y" || "$save_note" == "Y" ]]; then
          local note_file=$(create_gtd_study_note "${topic:-unified-system}" "$lesson")
          echo -e "${GREEN}โ${NC} Study note saved: $(basename "$note_file")"
          echo -e "${CYAN}๐ก Note: This note can be reviewed by Mistress Louiza during personalized critique${NC}"
          echo ""
        fi
        
        echo -e "${CYAN}โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ${NC}"
        echo ""
        echo -e "${BOLD}What would you like to do next?${NC}"
        echo -e "${GREEN}1${NC} - Another lesson on this topic"
        echo -e "${GREEN}2${NC} - Return to menu"
        echo ""
        read -p "Choice: " next_action
        if [[ "$next_action" != "1" ]]; then
          topic=""
        fi
      else
        echo "โ๏ธ  Could not get lesson. Check LM Studio connection."
        echo ""
        read -p "Press Enter to continue..."
        topic=""
      fi
    done
  else
    # Direct topic mode
    echo ""
    echo -e "${BOLD}${CYAN}โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ${NC}"
    echo -e "${BOLD}${CYAN}๐ Lesson from Mistress Louiza${NC}"
    echo -e "${CYAN}โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ${NC}"
    echo ""
    echo -e "${BOLD}๐ฌ From Mistress Louiza:${NC}"
    echo ""
    
    local lesson=$(get_instructor_lesson "$topic" "")
    
    if [[ -n "$lesson" ]]; then
      echo "$lesson" | sed 's/^/   /'
      echo ""
      echo -e "${CYAN}โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ${NC}"
      echo ""
      
      # Q&A session
      handle_qa_session "$topic"
      
      echo -e "${CYAN}โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ${NC}"
      echo ""
      
      # Offer to save note
      echo -e "${BOLD}๐พ Save this lesson as a note?${NC}"
      echo -e "${GREEN}y${NC} - Save lesson note (can be reviewed during critique)"
      echo -e "${GREEN}n${NC} - Skip"
      echo ""
      read -p "Choice: " save_note
      
      if [[ "$save_note" == "y" || "$save_note" == "Y" ]]; then
        local note_file=$(create_gtd_study_note "${topic:-unified-system}" "$lesson")
        echo -e "${GREEN}โ${NC} Study note saved: $(basename "$note_file")"
        echo -e "${CYAN}๐ก Note: This note can be reviewed by Mistress Louiza during personalized critique${NC}"
        echo ""
      fi
    else
      echo "โ๏ธ  Could not get lesson. Check LM Studio connection."
      exit 1
    fi
  fi
}

# Show usage
show_usage() {
  cat <<EOF
Usage: gtd-learn [topic]

Learn the unified organization system (Zettelkasten + GTD + Second Brain) 
with Mistress Louiza as your instructor.

Topics:
  capture, inbox        - Learn about capturing (all systems)
  process, processing   - Learn about processing (GTD & Zettelkasten)
  tasks, task           - Learn about task management (GTD)
  projects, project     - Learn about project management (GTD)
  review, reviews       - Learn about reviews (GTD)
  logging, log          - Learn about daily logging
  contexts, context     - Learn about contexts (GTD)
  energy, energy-levels - Learn about energy levels (GTD)
  zettelkasten, zet     - Learn about Zettelkasten (atomic notes)
  second-brain, brain   - Learn about Second Brain (knowledge organization)
  unified-system        - Learn about unified system (all three together)
  personas, advice      - Learn about personas (including comic book heroes)

Examples:
  gtd-learn              # Interactive menu
  gtd-learn capture      # Learn about capturing (all systems)
  gtd-learn zettelkasten # Learn about atomic notes
  gtd-learn second-brain # Learn about Second Brain
  gtd-learn unified-system # Learn how all three work together

Mistress Louiza will teach you the unified system and call in other experts
(David Allen for GTD, Tiago Forte for Second Brain, Sรถnke Ahrens for Zettelkasten,
Cal Newport, James Clear, etc.) when she needs to explain something in more detail.

She also has to deal with comic book heroes (Spider-Man, Iron Man, etc.) who are
always rushing off to "save the world" mid-explanation - she translates their
rushed advice and fills in the gaps.

EOF
}

# Handle arguments
case "$1" in
  --help|-h)
    show_usage
    exit 0
    ;;
  "")
    main ""
    ;;
  *)
    main "$1"
    ;;
esac

