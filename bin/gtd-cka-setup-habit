#!/bin/bash
# Create CKA Study habit in GTD habit system

# Source common environment (PATH setup)
COMMON_ENV="$HOME/code/dotfiles/zsh/common_env.sh"
if [[ ! -f "$COMMON_ENV" && -f "$HOME/code/personal/dotfiles/zsh/common_env.sh" ]]; then
  COMMON_ENV="$HOME/code/personal/dotfiles/zsh/common_env.sh"
fi
if [[ -f "$COMMON_ENV" ]]; then
  source "$COMMON_ENV"
fi


# Load GTD config
GTD_CONFIG_FILE="$HOME/.gtd_config"
if [[ -f "$HOME/code/dotfiles/zsh/.gtd_config" ]]; then
  GTD_CONFIG_FILE="$HOME/code/dotfiles/zsh/.gtd_config"
elif [[ -f "$HOME/code/personal/dotfiles/zsh/.gtd_config" ]]; then
  GTD_CONFIG_FILE="$HOME/code/personal/dotfiles/zsh/.gtd_config"
fi

if [[ -f "$GTD_CONFIG_FILE" ]]; then
  source "$GTD_CONFIG_FILE"
fi

# Source common GTD helpers (DRY - reuse existing helpers)
GTD_COMMON="$HOME/code/dotfiles/bin/gtd-common.sh"
if [[ ! -f "$GTD_COMMON" && -f "$HOME/code/personal/dotfiles/bin/gtd-common.sh" ]]; then
  GTD_COMMON="$HOME/code/personal/dotfiles/bin/gtd-common.sh"
fi
if [[ -f "$GTD_COMMON" ]]; then
  source "$GTD_COMMON"
else
  echo "Warning: gtd-common.sh not found. Some features may not work." >&2
fi

# GTD_BASE_DIR is already set by init_gtd_paths in gtd-common.sh (DRY - reuse existing helper)
HABITS_PATH="${GTD_BASE_DIR}/habits"

# Colors
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BOLD='\033[1m'
NC='\033[0m'

# Check if habit exists
habit_slug="cka-study"
habit_file="${HABITS_PATH}/${habit_slug}.md"

if [[ -f "$habit_file" ]]; then
  echo "✓ CKA Study habit already exists!"
  echo ""
  echo "Location: $habit_file"
  echo ""
  echo "Track your study with:"
  echo "  gtd-habit log 'CKA Study'"
  echo ""
  echo "Or it will be logged automatically when you:"
  echo "  • Complete lessons"
  echo "  • Do quick study activities"
  echo "  • Complete practice sessions"
  exit 0
fi

# Create habit
echo "Creating CKA Study habit..."
echo ""

if command -v gtd-habit &>/dev/null; then
  # Use gtd-habit to create it
  echo "CKA Study" | gtd-habit create
  
  # Set description and area
  if [[ -f "$habit_file" ]]; then
    # Update description
    if [[ "$OSTYPE" == "darwin"* ]]; then
      sed -i '' '/^## Description$/a\
Study Kubernetes/CKA - any activity counts (lessons, practice, quick activities)
' "$habit_file"
    else
      sed -i '/^## Description$/a\Study Kubernetes/CKA - any activity counts (lessons, practice, quick activities)' "$habit_file"
    fi
    
    # Set area to Learning/Personal Development
    if [[ "$OSTYPE" == "darwin"* ]]; then
      sed -i '' 's/^area:.*/area: Learning/' "$habit_file"
    else
      sed -i 's/^area:.*/area: Learning/' "$habit_file"
    fi
  fi
  
  echo ""
  echo -e "${GREEN}✓${NC} CKA Study habit created!"
  echo ""
  echo "This habit will be automatically logged when you:"
  echo "  • Complete lessons (gtd-learn-kubernetes)"
  echo "  • Do quick study activities (gtd-cka-quick)"
  echo "  • Complete practice sessions (gtd-cka-typing)"
  echo ""
  echo "You can also log it manually:"
  echo "  gtd-habit log 'CKA Study'"
  echo ""
else
  echo "❌ gtd-habit command not found"
  echo ""
  echo "Please install the habit system first, or create the habit manually:"
  echo "  gtd-habit create 'CKA Study'"
  exit 1
fi

