#!/bin/bash
# Generic Quiz System for GTD Learning Areas
# Supports: Organization System, Second Brain, CKA/Kubernetes, Greek

# Load GTD config
GTD_CONFIG_FILE="$HOME/.gtd_config"
if [[ -f "$HOME/code/dotfiles/zsh/.gtd_config" ]]; then
  GTD_CONFIG_FILE="$HOME/code/dotfiles/zsh/.gtd_config"
elif [[ -f "$HOME/code/personal/dotfiles/zsh/.gtd_config" ]]; then
  GTD_CONFIG_FILE="$HOME/code/personal/dotfiles/zsh/.gtd_config"
fi

if [[ -f "$GTD_CONFIG_FILE" ]]; then
  source "$GTD_CONFIG_FILE"
fi

# Source common GTD helpers (DRY - reuse existing helpers)
GTD_COMMON="$HOME/code/dotfiles/bin/gtd-common.sh"
if [[ ! -f "$GTD_COMMON" && -f "$HOME/code/personal/dotfiles/bin/gtd-common.sh" ]]; then
  GTD_COMMON="$HOME/code/personal/dotfiles/bin/gtd-common.sh"
fi
if [[ -f "$GTD_COMMON" ]]; then
  source "$GTD_COMMON"
else
  echo "Warning: gtd-common.sh not found. Some features may not work." >&2
fi

# GTD_BASE_DIR is already set by init_gtd_paths in gtd-common.sh (DRY - reuse existing helper)
QUIZ_DIR="${GTD_BASE_DIR}/quizzes"
QUIZ_DATA_DIR="${QUIZ_DIR}/data"
QUIZ_PROGRESS_DIR="${QUIZ_DIR}/progress"

# Colors
CYAN='\033[0;36m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
RED='\033[0;31m'
MAGENTA='\033[0;35m'
BOLD='\033[1m'
NC='\033[0m'

# Helper function to capitalize first character (bash 3.2 compatible)
capitalize_first() {
  local str="$1"
  if [[ -z "$str" ]]; then
    echo ""
    return
  fi
  echo "$(echo "${str:0:1}" | tr '[:lower:]' '[:upper:]')${str:1}"
}

# Initialize quiz directories
init_quiz_dirs() {
  mkdir -p "$QUIZ_DATA_DIR"
  mkdir -p "$QUIZ_PROGRESS_DIR"
}

# Load question bank for a topic
load_questions() {
  local topic="$1"
  local question_file="${QUIZ_DATA_DIR}/${topic}.json"
  
  if [[ ! -f "$question_file" ]]; then
    echo "{}"
    return 1
  fi
  
  cat "$question_file"
}

# Get quiz progress
get_quiz_progress() {
  local topic="$1"
  local progress_file="${QUIZ_PROGRESS_DIR}/${topic}.json"
  
  if [[ ! -f "$progress_file" ]]; then
    echo '{"total_quizzes": 0, "correct": 0, "incorrect": 0, "best_score": 0, "last_quiz_date": null}'
    return
  fi
  
  cat "$progress_file"
}

# Save quiz progress
save_quiz_progress() {
  local topic="$1"
  local progress_data="$2"
  local progress_file="${QUIZ_PROGRESS_DIR}/${topic}.json"
  
  echo "$progress_data" > "$progress_file"
}

# Run a quiz
run_quiz() {
  local topic="$1"
  local mode="${2:-practice}"  # practice, timed, pop-quiz
  local num_questions="${3:-5}"
  
  clear
  echo ""
  echo -e "${BOLD}${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
  echo -e "${BOLD}${CYAN}ğŸ¯ Quiz: $(capitalize_first "$topic")${NC}"
  echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
  echo ""
  
  # Load questions
  local questions_json=$(load_questions "$topic")
  if [[ "$questions_json" == "{}" ]] || [[ -z "$questions_json" ]]; then
    echo -e "${RED}âŒ No questions found for topic: ${topic}${NC}"
    echo ""
    echo "Press Enter to continue..."
    read
    return 1
  fi
  
  # Parse and display questions
  local correct=0
  local total=0
  local question_num=1
  
  # Extract questions from JSON (simplified - assumes JSON format)
  # For now, we'll use a simple format: question|answer|option1|option2|option3|option4
  # In a real implementation, you'd use jq or python to parse JSON
  
  echo -e "${YELLOW}Mode: ${mode}${NC}"
  echo -e "${YELLOW}Questions: ${num_questions}${NC}"
  echo ""
  echo "Press Enter to start..."
  read
  
  # For now, show a message that questions need to be set up
  echo ""
  echo -e "${YELLOW}ğŸ“ Quiz questions for ${topic} are being set up.${NC}"
  echo ""
  echo "This quiz system supports:"
  echo "  â€¢ Multiple choice questions"
  echo "  â€¢ True/False questions"
  echo "  â€¢ Fill-in-the-blank questions"
  echo "  â€¢ Timed quizzes"
  echo "  â€¢ Pop quizzes (random questions)"
  echo ""
  echo "Question banks will be created for:"
  echo "  â€¢ Organization System (GTD, Second Brain, Zettelkasten)"
  echo "  â€¢ Second Brain (CODE, PARA, MOCs)"
  echo "  â€¢ CKA/Kubernetes"
  echo "  â€¢ Greek Language"
  echo ""
  echo "Press Enter to continue..."
  read
}

# Quiz menu
quiz_menu() {
  local topic="$1"
  
  while true; do
    clear
    echo ""
    echo -e "${BOLD}${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo -e "${BOLD}${CYAN}ğŸ¯ Quiz Menu: $(capitalize_first "$topic")${NC}"
    echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo ""
    
    # Show progress
    local progress=$(get_quiz_progress "$topic")
    echo -e "${BOLD}Your Progress:${NC}"
    echo "  Total Quizzes: $(echo "$progress" | grep -o '"total_quizzes":[0-9]*' | grep -o '[0-9]*' || echo "0")"
    echo "  Correct Answers: $(echo "$progress" | grep -o '"correct":[0-9]*' | grep -o '[0-9]*' || echo "0")"
    echo "  Best Score: $(echo "$progress" | grep -o '"best_score":[0-9]*' | grep -o '[0-9]*' || echo "0")%"
    echo ""
    
    echo "What would you like to do?"
    echo ""
    echo "  1) ğŸ¯ Practice Quiz (5 questions, untimed)"
    echo "  2) â±ï¸  Timed Quiz (10 questions, 2 min per question)"
    echo "  3) ğŸ² Pop Quiz (Random 3 questions)"
    echo "  4) ğŸ“Š View Progress & Stats"
    echo "  5) ğŸ† View Achievements"
    echo ""
    echo -e "${YELLOW}0)${NC} Back"
    echo ""
    echo -n "Choose: "
    read choice
    
    case "$choice" in
      1)
        run_quiz "$topic" "practice" 5
        ;;
      2)
        run_quiz "$topic" "timed" 10
        ;;
      3)
        run_quiz "$topic" "pop-quiz" 3
        ;;
      4)
        show_progress "$topic"
        ;;
      5)
        show_achievements "$topic"
        ;;
      0|"")
        return 0
        ;;
      *)
        echo "Invalid choice"
        echo ""
        echo "Press Enter to continue..."
        read
        ;;
    esac
  done
}

# Show progress
show_progress() {
  local topic="$1"
  clear
  echo ""
  echo -e "${BOLD}${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
  echo -e "${BOLD}${CYAN}ğŸ“Š Quiz Progress: $(capitalize_first "$topic")${NC}"
  echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
  echo ""
  
  local progress=$(get_quiz_progress "$topic")
  # Parse and display progress
  echo "Progress data will be displayed here"
  echo ""
  echo "Press Enter to continue..."
  read
}

# Show achievements
show_achievements() {
  local topic="$1"
  clear
  echo ""
  echo -e "${BOLD}${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
  echo -e "${BOLD}${CYAN}ğŸ† Achievements: $(capitalize_first "$topic")${NC}"
  echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
  echo ""
  
  echo "Achievements will be displayed here"
  echo ""
  echo "Press Enter to continue..."
  read
}

# Main function
main() {
  init_quiz_dirs
  
  if [[ $# -eq 0 ]]; then
    # Show topic selection menu
    clear
    echo ""
    echo -e "${BOLD}${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo -e "${BOLD}${CYAN}ğŸ¯ Quiz System${NC}"
    echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo ""
    echo "Which topic would you like to quiz yourself on?"
    echo ""
    echo "  1) Organization System (GTD, Second Brain, Zettelkasten)"
    echo "  2) Second Brain (CODE, PARA, MOCs)"
    echo "  3) CKA/Kubernetes"
    echo "  4) Greek Language"
    echo ""
    echo -e "${YELLOW}0)${NC} Exit"
    echo ""
    echo -n "Choose: "
    read topic_choice
    
    case "$topic_choice" in
      1)
        quiz_menu "organization-system"
        ;;
      2)
        quiz_menu "second-brain"
        ;;
      3)
        quiz_menu "cka-kubernetes"
        ;;
      4)
        quiz_menu "greek"
        ;;
      0|"")
        exit 0
        ;;
      *)
        echo "Invalid choice"
        exit 1
        ;;
    esac
  else
    # Direct topic specified
    quiz_menu "$1"
  fi
}

main "$@"

