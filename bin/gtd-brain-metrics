#!/bin/bash
# GTD Second Brain - Note Quality Metrics
# Track and improve note quality over time

# Load GTD config
GTD_CONFIG_FILE="$HOME/.gtd_config"
if [[ -f "$HOME/code/dotfiles/zsh/.gtd_config" ]]; then
  GTD_CONFIG_FILE="$HOME/code/dotfiles/zsh/.gtd_config"
elif [[ -f "$HOME/code/personal/dotfiles/zsh/.gtd_config" ]]; then
  GTD_CONFIG_FILE="$HOME/code/personal/dotfiles/zsh/.gtd_config"
fi

if [[ -f "$GTD_CONFIG_FILE" ]]; then
  source "$GTD_CONFIG_FILE"
fi

# Default values
SECOND_BRAIN="${SECOND_BRAIN:-$HOME/Documents/obsidian/Second Brain}"

# Colors
CYAN='\033[0;36m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
BOLD='\033[1m'
NC='\033[0m'

# Calculate metrics for a note
calculate_metrics() {
  local note_path="$1"
  
  if [[ ! -f "$note_path" ]]; then
    echo "âŒ Note not found: $note_path"
    return 1
  fi
  
  local note_name=$(basename "$note_path" .md)
  
  # Link count (internal links)
  local link_count=$(grep -oE "\[\[[^\]]+\]\]" "$note_path" 2>/dev/null | wc -l | tr -d ' ')
  
  # Backlink count (notes linking to this)
  local note_name_clean=$(echo "$note_name" | sed 's/[^a-zA-Z0-9]/\\&/g')
  local backlink_count=$(find "$SECOND_BRAIN" -type f -name "*.md" ! -path "*/Templates/*" ! -path "*/MOCs/*" ! -path "*/Packets/*" ! -path "*/Connections/*" ! -path "*/.obsidian/*" ! -path "*/Express/*" -exec grep -l "\[\[${note_name_clean}\]\]" {} \; 2>/dev/null | grep -v "$note_path" | wc -l | tr -d ' ')
  
  # Update frequency (days since last update)
  local last_updated=$(grep -E "^## Last Updated|^Last Updated:" "$note_path" 2>/dev/null | head -1 | grep -oE "[0-9]{4}-[0-9]{2}-[0-9]{2}" || echo "")
  local days_since_update="N/A"
  if [[ -n "$last_updated" ]]; then
    if [[ "$OSTYPE" == "darwin"* ]]; then
      local today=$(date +"%Y-%m-%d")
      local days=$(( ($(date -j -f "%Y-%m-%d" "$today" +%s) - $(date -j -f "%Y-%m-%d" "$last_updated" +%s)) / 86400 ))
      days_since_update="$days"
    else
      local today=$(date +"%Y-%m-%d")
      local days=$(( ($(date -d "$today" +%s) - $(date -d "$last_updated" +%s)) / 86400 ))
      days_since_update="$days"
    fi
  fi
  
  # Word count
  local word_count=$(wc -w < "$note_path" 2>/dev/null | tr -d ' ')
  
  # Has summary
  local has_summary=$(grep -q "## Summary" "$note_path" 2>/dev/null && echo "yes" || echo "no")
  
  # Has core insights
  local has_insights=$(grep -q "## Core Insights" "$note_path" 2>/dev/null && echo "yes" || echo "no")
  
  # Tag count
  local tag_count=$(grep -oE "#[a-zA-Z0-9_-]+" "$note_path" 2>/dev/null | wc -l | tr -d ' ')
  
  # Quality score (0-100)
  local score=0
  if [[ $link_count -gt 0 ]]; then ((score += 20)); fi
  if [[ $backlink_count -gt 0 ]]; then ((score += 20)); fi
  if [[ "$has_summary" == "yes" ]]; then ((score += 20)); fi
  if [[ "$has_insights" == "yes" ]]; then ((score += 20)); fi
  if [[ $tag_count -gt 0 ]]; then ((score += 10)); fi
  if [[ $word_count -gt 100 ]]; then ((score += 10)); fi
  
  # Output metrics
  echo ""
  echo -e "${BOLD}${CYAN}Note Quality Metrics: ${note_name}${NC}"
  echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
  echo ""
  echo "ğŸ“Š Quality Score: ${score}/100"
  echo ""
  echo "Metrics:"
  echo "  â€¢ Links: ${link_count}"
  echo "  â€¢ Backlinks: ${backlink_count}"
  echo "  â€¢ Tags: ${tag_count}"
  echo "  â€¢ Word count: ${word_count}"
  echo "  â€¢ Has summary: ${has_summary}"
  echo "  â€¢ Has core insights: ${has_insights}"
  if [[ "$days_since_update" != "N/A" ]]; then
    echo "  â€¢ Days since update: ${days_since_update}"
  fi
  echo ""
  
  # Improvement suggestions
  echo "ğŸ’¡ Improvement Suggestions:"
  if [[ $link_count -eq 0 ]]; then
    echo -e "  ${YELLOW}â€¢${NC} Add links to related notes"
  fi
  if [[ "$has_summary" == "no" ]]; then
    echo -e "  ${YELLOW}â€¢${NC} Add a summary section (gtd-brain summarize <note> 2)"
  fi
  if [[ "$has_insights" == "no" ]]; then
    echo -e "  ${YELLOW}â€¢${NC} Add core insights (gtd-brain summarize <note> 3)"
  fi
  if [[ $tag_count -eq 0 ]]; then
    echo -e "  ${YELLOW}â€¢${NC} Add tags for better discoverability"
  fi
  if [[ "$days_since_update" != "N/A" && $days_since_update -gt 90 ]]; then
    echo -e "  ${YELLOW}â€¢${NC} Consider updating this note (last updated ${days_since_update} days ago)"
  fi
  echo ""
}

# Show dashboard
show_dashboard() {
  echo ""
  echo -e "${BOLD}${CYAN}Second Brain Quality Dashboard${NC}"
  echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
  echo ""
  
  local total_notes=$(find "$SECOND_BRAIN" -type f -name "*.md" ! -path "*/Templates/*" ! -path "*/MOCs/*" ! -path "*/Packets/*" ! -path "*/Connections/*" ! -path "*/.obsidian/*" ! -path "*/Express/*" 2>/dev/null | wc -l | tr -d ' ')
  local notes_with_links=$(find "$SECOND_BRAIN" -type f -name "*.md" ! -path "*/Templates/*" ! -path "*/MOCs/*" ! -path "*/Packets/*" ! -path "*/Connections/*" ! -path "*/.obsidian/*" ! -path "*/Express/*" -exec grep -l "\[\[" {} \; 2>/dev/null | wc -l | tr -d ' ')
  local notes_with_summary=$(find "$SECOND_BRAIN" -type f -name "*.md" ! -path "*/Templates/*" ! -path "*/MOCs/*" ! -path "*/Packets/*" ! -path "*/Connections/*" ! -path "*/.obsidian/*" ! -path "*/Express/*" -exec grep -l "## Summary" {} \; 2>/dev/null | wc -l | tr -d ' ')
  local notes_with_insights=$(find "$SECOND_BRAIN" -type f -name "*.md" ! -path "*/Templates/*" ! -path "*/MOCs/*" ! -path "*/Packets/*" ! -path "*/Connections/*" ! -path "*/.obsidian/*" ! -path "*/Express/*" -exec grep -l "## Core Insights" {} \; 2>/dev/null | wc -l | tr -d ' ')
  local evergreen_notes=$(find "$SECOND_BRAIN" -type f -name "*.md" ! -path "*/Templates/*" ! -path "*/MOCs/*" ! -path "*/Packets/*" ! -path "*/Connections/*" ! -path "*/.obsidian/*" ! -path "*/Express/*" -exec grep -l "#evergreen" {} \; 2>/dev/null | wc -l | tr -d ' ')
  
  echo "ğŸ“Š Overall Statistics:"
  echo "  â€¢ Total notes: ${total_notes}"
  echo "  â€¢ Notes with links: ${notes_with_links} ($(( notes_with_links * 100 / (total_notes > 0 ? total_notes : 1) ))%)"
  echo "  â€¢ Notes with summary: ${notes_with_summary} ($(( notes_with_summary * 100 / (total_notes > 0 ? total_notes : 1) ))%)"
  echo "  â€¢ Notes with insights: ${notes_with_insights} ($(( notes_with_insights * 100 / (total_notes > 0 ? total_notes : 1) ))%)"
  echo "  â€¢ Evergreen notes: ${evergreen_notes}"
  echo ""
  
  # Find notes needing improvement
  echo "ğŸ“ˆ Notes Needing Improvement:"
  local unlinked_notes=$(find "$SECOND_BRAIN" -type f -name "*.md" ! -path "*/Templates/*" ! -path "*/MOCs/*" ! -path "*/Packets/*" ! -path "*/Connections/*" ! -path "*/.obsidian/*" ! -path "*/Express/*" ! -exec grep -l "\[\[" {} \; 2>/dev/null | head -5)
  if [[ -n "$unlinked_notes" ]]; then
    echo "  Notes without links:"
    echo "$unlinked_notes" | while read -r note; do
      echo -e "    ${YELLOW}â€¢${NC} $(basename "$note" .md)"
    done
  fi
  echo ""
}

# Show usage
show_usage() {
  cat <<EOF
Usage: gtd-brain-metrics <command> [options]

Commands:
  <note-path>                    Calculate metrics for a specific note
  dashboard                       Show overall quality dashboard
  help                            Show this help

Examples:
  gtd-brain-metrics ~/Documents/obsidian/Second\ Brain/Resources/note.md
  gtd-brain-metrics dashboard

Metrics tracked:
  - Link count (how connected)
  - Backlink count (how referenced)
  - Update frequency (how active)
  - Word count (how detailed)
  - Has summary (distill level 2)
  - Has core insights (distill level 3)
  - Tag count (how discoverable)
  - Quality score (0-100)

EOF
}

# Main command handler
case "${1:-}" in
  dashboard)
    show_dashboard
    ;;
  help|--help|-h)
    show_usage
    ;;
  "")
    show_usage
    ;;
  *)
    calculate_metrics "$1"
    ;;
esac

