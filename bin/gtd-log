#!/bin/bash
# GTD Log Command - View daily logs

# Load daily log config
DAILY_LOG_CONFIG="$HOME/.daily_log_config"
if [[ ! -f "$DAILY_LOG_CONFIG" && -f "$HOME/code/personal/dotfiles/zsh/.daily_log_config" ]]; then
  DAILY_LOG_CONFIG="$HOME/code/personal/dotfiles/zsh/.daily_log_config"
fi

# Source config if it exists
if [[ -f "$DAILY_LOG_CONFIG" ]]; then
  source "$DAILY_LOG_CONFIG"
fi

# Default values
DAILY_LOG_DIR="${DAILY_LOG_DIR:-$HOME/Documents/daily_logs}"

# Get date command
get_date_cmd() {
  if [[ -x "/usr/bin/date" ]]; then
    echo "/usr/bin/date"
  elif [[ -x "/bin/date" ]]; then
    echo "/bin/date"
  else
    echo "date"
  fi
}

DATE_CMD=$(get_date_cmd)

# View today's log
view_today() {
  local today=$($DATE_CMD +"%Y-%m-%d")
  local log_file="${DAILY_LOG_DIR}/${today}.md"
  
  if [[ ! -f "$log_file" ]]; then
    echo "ðŸ“ No daily log found for today ($today)"
    echo "   Location: $log_file"
    echo ""
    echo "Create one with: addInfoToDailyLog \"your entry\""
    return 1
  fi
  
  echo ""
  echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
  echo "ðŸ“… Daily Log - $today"
  echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
  echo ""
  cat "$log_file"
  echo ""
  echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
  echo ""
  
  # Show stats
  local entry_count=$(grep -c "^[0-9][0-9]:[0-9][0-9] -" "$log_file" 2>/dev/null || echo "0")
  local goal_count=$(grep -ci "goal" "$log_file" 2>/dev/null || echo "0")
  
  echo "ðŸ“Š Stats:"
  echo "   Entries: $entry_count"
  if [[ $goal_count -gt 0 ]]; then
    echo "   Goals mentioned: $goal_count"
  fi
  echo ""
}

# View specific date
view_date() {
  local date="$1"
  local log_file="${DAILY_LOG_DIR}/${date}.md"
  
  if [[ ! -f "$log_file" ]]; then
    echo "âŒ No daily log found for $date"
    echo "   Location: $log_file"
    return 1
  fi
  
  echo ""
  echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
  echo "ðŸ“… Daily Log - $date"
  echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
  echo ""
  cat "$log_file"
  echo ""
  echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
  echo ""
}

# List available logs
list_logs() {
  local limit="${1:-10}"
  
  echo ""
  echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
  echo "ðŸ“š Available Daily Logs"
  echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
  echo ""
  
  if [[ ! -d "$DAILY_LOG_DIR" ]]; then
    echo "âŒ Daily log directory not found: $DAILY_LOG_DIR"
    return 1
  fi
  
  local logs=($(find "$DAILY_LOG_DIR" -type f -name "*.md" -maxdepth 1 | sort -r | head -$limit))
  local count=${#logs[@]}
  
  if [[ $count -eq 0 ]]; then
    echo "No daily logs found."
    return 1
  fi
  
  for log in "${logs[@]}"; do
    local filename=$(basename "$log" .md)
    local entry_count=$(grep -c "^[0-9][0-9]:[0-9][0-9] -" "$log" 2>/dev/null || echo "0")
    local size=$(stat -f%z "$log" 2>/dev/null || stat -c%s "$log" 2>/dev/null || echo "0")
    local size_kb=$((size / 1024))
    
    echo "ðŸ“… $filename"
    echo "   Entries: $entry_count | Size: ${size_kb}KB"
    echo ""
  done
  
  echo "Total: $count log(s) shown"
  echo ""
  echo "View a specific log: gtd-log view <date>"
  echo "   Example: gtd-log view 2025-11-29"
}

# Search logs
search_logs() {
  local pattern="$1"
  local limit="${2:-10}"
  
  if [[ -z "$pattern" ]]; then
    echo "Usage: gtd-log search <pattern>"
    exit 1
  fi
  
  echo ""
  echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
  echo "ðŸ” Searching daily logs for: \"$pattern\""
  echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
  echo ""
  
  if [[ ! -d "$DAILY_LOG_DIR" ]]; then
    echo "âŒ Daily log directory not found: $DAILY_LOG_DIR"
    return 1
  fi
  
  local matches=0
  local logs=($(find "$DAILY_LOG_DIR" -type f -name "*.md" -maxdepth 1 | sort -r))
  
  for log in "${logs[@]}"; do
    if grep -qi "$pattern" "$log" 2>/dev/null; then
      ((matches++))
      local filename=$(basename "$log" .md)
      echo "ðŸ“… $filename"
      echo "   Matches:"
      grep -i "$pattern" "$log" 2>/dev/null | head -3 | sed 's/^/     /'
      echo ""
      
      if [[ $matches -ge $limit ]]; then
        break
      fi
    fi
  done
  
  if [[ $matches -eq 0 ]]; then
    echo "No matches found."
  else
    echo "Found $matches matching log(s)"
  fi
  echo ""
}

# Show recent entries
show_recent() {
  local limit="${1:-5}"
  
  echo ""
  echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
  echo "ðŸ“ Recent Daily Log Entries"
  echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
  echo ""
  
  if [[ ! -d "$DAILY_LOG_DIR" ]]; then
    echo "âŒ Daily log directory not found: $DAILY_LOG_DIR"
    return 1
  fi
  
  local logs=($(find "$DAILY_LOG_DIR" -type f -name "*.md" -maxdepth 1 | sort -r | head -5))
  
  for log in "${logs[@]}"; do
    local filename=$(basename "$log" .md)
    local recent_entries=$(grep "^[0-9][0-9]:[0-9][0-9] -" "$log" 2>/dev/null | tail -$limit)
    
    if [[ -n "$recent_entries" ]]; then
      echo "ðŸ“… $filename:"
      echo "$recent_entries" | sed 's/^/   /'
      echo ""
    fi
  done
}

# Main
main() {
  case "$1" in
    view|show)
      shift
      if [[ -z "$1" ]]; then
        view_today
      else
        view_date "$1"
      fi
      ;;
    list|ls)
      shift
      list_logs "${1:-10}"
      ;;
    search)
      shift
      search_logs "$1" "${2:-10}"
      ;;
    recent)
      shift
      show_recent "${1:-5}"
      ;;
    today|"")
      view_today
      ;;
    --help|-h)
      echo "Usage: gtd-log [command] [options]"
      echo ""
      echo "Commands:"
      echo "  [no args] or today        View today's daily log (default)"
      echo "  view [date]               View log for specific date (YYYY-MM-DD)"
      echo "  list [limit]              List available logs (default: 10)"
      echo "  search <pattern>          Search across all logs"
      echo "  recent [limit]            Show recent entries from recent logs"
      echo ""
      echo "Examples:"
      echo "  gtd-log                   # View today's log"
      echo "  gtd-log view 2025-11-29   # View specific date"
      echo "  gtd-log list              # List all logs"
      echo "  gtd-log search \"goal\"     # Search for 'goal' in logs"
      echo "  gtd-log recent 10          # Show 10 most recent entries"
      exit 0
      ;;
    *)
      # Try to parse as date
      if [[ "$1" =~ ^[0-9]{4}-[0-9]{2}-[0-9]{2}$ ]]; then
        view_date "$1"
      else
        echo "Unknown command: $1"
        echo "Run 'gtd-log --help' for usage"
        exit 1
      fi
      ;;
  esac
}

main "$@"

