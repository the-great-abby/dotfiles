#!/bin/bash
# Habitica Integration for GTD System
# Syncs tasks, habits, and projects with Habitica

# Source common environment (PATH setup)
COMMON_ENV="$HOME/code/dotfiles/zsh/common_env.sh"
if [[ ! -f "$COMMON_ENV" && -f "$HOME/code/personal/dotfiles/zsh/common_env.sh" ]]; then
  COMMON_ENV="$HOME/code/personal/dotfiles/zsh/common_env.sh"
fi
if [[ -f "$COMMON_ENV" ]]; then
  source "$COMMON_ENV"
fi

# Load GTD config
GTD_CONFIG_FILE="$HOME/.gtd_config"
if [[ -f "$HOME/code/dotfiles/zsh/.gtd_config" ]]; then
  GTD_CONFIG_FILE="$HOME/code/dotfiles/zsh/.gtd_config"
elif [[ -f "$HOME/code/personal/dotfiles/zsh/.gtd_config" ]]; then
  GTD_CONFIG_FILE="$HOME/code/personal/dotfiles/zsh/.gtd_config"
fi

if [[ -f "$GTD_CONFIG_FILE" ]]; then
  source "$GTD_CONFIG_FILE"
fi

# Source common GTD helpers (DRY - reuse existing helpers)
GTD_COMMON="$HOME/code/dotfiles/bin/gtd-common.sh"
if [[ ! -f "$GTD_COMMON" && -f "$HOME/code/personal/dotfiles/bin/gtd-common.sh" ]]; then
  GTD_COMMON="$HOME/code/personal/dotfiles/bin/gtd-common.sh"
fi
if [[ -f "$GTD_COMMON" ]]; then
  source "$GTD_COMMON"
else
  echo "Warning: gtd-common.sh not found. Some features may not work." >&2
fi

# GTD_BASE_DIR is already set by init_gtd_paths in gtd-common.sh (DRY - reuse existing helper)
HABITICA_DIR="${GTD_BASE_DIR}/.gtd/habitica"
HABITICA_CONFIG="${HABITICA_DIR}/config.json"
HABITICA_SYNC_STATE="${HABITICA_DIR}/sync_state.json"

# Colors
CYAN='\033[0;36m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
RED='\033[0;31m'
BOLD='\033[1m'
NC='\033[0m'

# Habitica API base URL
HABITICA_API_URL="https://habitica.com/api/v4"

# Initialize Habitica directory
init_habitica() {
  mkdir -p "$HABITICA_DIR"
  
  if [[ ! -f "$HABITICA_SYNC_STATE" ]]; then
    cat > "$HABITICA_SYNC_STATE" <<EOF
{
  "last_sync": null,
  "synced_tasks": {},
  "synced_habits": {},
  "synced_dailies": {},
  "synced_projects": {}
}
EOF
  fi
}

# Check if Habitica is configured
check_config() {
  if [[ ! -f "$HABITICA_CONFIG" ]]; then
    echo -e "${RED}âš ï¸  Habitica not configured${NC}"
    echo ""
    echo "Run 'gtd-habitica setup' to configure Habitica integration."
    return 1
  fi
  return 0
}

# Setup Habitica integration
setup_habitica() {
  init_habitica
  
  echo -e "${BOLD}${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
  echo -e "${BOLD}${CYAN}ðŸŽ® Habitica Integration Setup${NC}"
  echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
  echo ""
  echo "To use Habitica integration, you need:"
  echo "1. A Habitica account (sign up at https://habitica.com)"
  echo "2. Your User ID and API Token"
  echo ""
  echo "To find your credentials:"
  echo "1. Go to https://habitica.com"
  echo "2. Click on your profile â†’ Settings â†’ API"
  echo "3. Copy your User ID and API Token"
  echo ""
  
  read -p "Enter your Habitica User ID: " user_id
  read -p "Enter your Habitica API Token: " api_token
  
  if [[ -z "$user_id" ]] || [[ -z "$api_token" ]]; then
    echo -e "${RED}Error: User ID and API Token are required${NC}"
    return 1
  fi
  
  # Test the credentials
  echo ""
  echo "Testing credentials..."
  
  response=$(curl -s -w "\n%{http_code}" -X GET \
    "$HABITICA_API_URL/user" \
    -H "x-api-user: $user_id" \
    -H "x-api-key: $api_token" \
    -H "x-client: GTD-System" \
    -H "x-client-version: 1.0.0" \
    -H "Content-Type: application/json")
  
  http_code=$(echo "$response" | tail -n1)
  body=$(echo "$response" | sed '$d')
  
  if [[ "$http_code" == "200" ]]; then
    echo -e "${GREEN}âœ“ Credentials valid!${NC}"
    
    cat > "$HABITICA_CONFIG" <<EOF
{
  "user_id": "$user_id",
  "api_token": "$api_token",
  "sync_enabled": true,
  "sync_direction": "bidirectional",
  "auto_sync": false
}
EOF
    
    echo ""
    echo -e "${GREEN}âœ“ Habitica integration configured!${NC}"
    echo ""
    echo "You can now use:"
    echo "  gtd-habitica sync        # Sync GTD â†’ Habitica"
    echo "  gtd-habitica sync-back    # Sync Habitica â†’ GTD"
    echo "  gtd-habitica status       # Check sync status"
  else
    echo -e "${RED}âœ— Invalid credentials (HTTP $http_code)${NC}"
    echo "Response: $body"
    return 1
  fi
}

# Make Habitica API request
habitica_api() {
  local method="$1"
  local endpoint="$2"
  local data="${3:-}"
  
  if ! check_config; then
    return 1
  fi
  
  local user_id=$(python3 -c "import json; print(json.load(open('$HABITICA_CONFIG'))['user_id'])" 2>/dev/null)
  local api_token=$(python3 -c "import json; print(json.load(open('$HABITICA_CONFIG'))['api_token'])" 2>/dev/null)
  
  if [[ -z "$user_id" ]] || [[ -z "$api_token" ]]; then
    echo -e "${RED}Error: Could not read Habitica credentials${NC}" >&2
    return 1
  fi
  
  local url="$HABITICA_API_URL/$endpoint"
  
  # Build curl command with proper header formatting
  local curl_args=(
    -s
    -X "$method"
    -H "x-api-user: $user_id"
    -H "x-api-key: $api_token"
    -H "x-client: GTD-System"
    -H "x-client-version: 1.0.0"
    -H "Content-Type: application/json"
  )
  
  if [[ -n "$data" ]]; then
    curl_args+=(-d "$data")
  fi
  
  curl_args+=("$url")
  
  curl "${curl_args[@]}"
}

# Sync GTD tasks to Habitica
sync_tasks_to_habitica() {
  if ! check_config; then
    return 1
  fi
  
  echo -e "${CYAN}Syncing tasks to Habitica...${NC}"
  
  # Get active tasks from GTD
  local tasks_dir="${GTD_BASE_DIR}/1-projects"
  local synced=0
  local skipped=0
  
  # This is a simplified version - in practice, you'd parse your task files
  # and create/update Habitica todos
  
  echo -e "${GREEN}âœ“ Synced $synced tasks (skipped $skipped)${NC}"
}

# Sync Habitica to GTD
sync_habitica_to_gtd() {
  if ! check_config; then
    return 1
  fi
  
  echo -e "${CYAN}Syncing Habitica to GTD...${NC}"
  
  # Get todos from Habitica
  local todos=$(habitica_api "GET" "tasks/user?type=todos")
  
  if [[ -z "$todos" ]]; then
    echo -e "${RED}Error: Could not fetch todos from Habitica${NC}"
    return 1
  fi
  
  echo -e "${GREEN}âœ“ Fetched todos from Habitica${NC}"
  # In practice, you'd parse these and create/update GTD tasks
}

# Show sync status
show_status() {
  if ! check_config; then
    return 1
  fi
  
  echo -e "${BOLD}${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
  echo -e "${BOLD}${CYAN}ðŸ“Š Habitica Sync Status${NC}"
  echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
  echo ""
  
  # Get user info from Habitica
  local user_info=$(habitica_api "GET" "user")
  
  if [[ -n "$user_info" ]]; then
    local username=$(echo "$user_info" | python3 -c "import sys, json; print(json.load(sys.stdin).get('data', {}).get('auth', {}).get('local', {}).get('username', 'Unknown'))" 2>/dev/null || echo "Unknown")
    local level=$(echo "$user_info" | python3 -c "import sys, json; print(json.load(sys.stdin).get('data', {}).get('stats', {}).get('lvl', 0))" 2>/dev/null || echo "0")
    local hp=$(echo "$user_info" | python3 -c "import sys, json; print(json.load(sys.stdin).get('data', {}).get('stats', {}).get('hp', 0))" 2>/dev/null || echo "0")
    local mp=$(echo "$user_info" | python3 -c "import sys, json; print(json.load(sys.stdin).get('data', {}).get('stats', {}).get('mp', 0))" 2>/dev/null || echo "0")
    local exp=$(echo "$user_info" | python3 -c "import sys, json; print(json.load(sys.stdin).get('data', {}).get('stats', {}).get('exp', 0))" 2>/dev/null || echo "0")
    local gold=$(echo "$user_info" | python3 -c "import sys, json; print(json.load(sys.stdin).get('data', {}).get('stats', {}).get('gp', 0))" 2>/dev/null || echo "0")
    
    echo -e "${BOLD}Habitica Account:${NC} $username"
    echo -e "${BOLD}Level:${NC} $level"
    echo -e "${BOLD}HP:${NC} $hp | ${BOLD}MP:${NC} $mp"
    echo -e "${BOLD}XP:${NC} $exp | ${BOLD}Gold:${NC} $gold"
    echo ""
  else
    echo -e "${RED}Error: Could not fetch user info${NC}"
    return 1
  fi
  
  # Show sync state
  if [[ -f "$HABITICA_SYNC_STATE" ]]; then
    local last_sync=$(python3 -c "import json; print(json.load(open('$HABITICA_SYNC_STATE')).get('last_sync') or 'Never')" 2>/dev/null || echo "Never")
    echo -e "${BOLD}Last Sync:${NC} $last_sync"
  fi
  
  echo ""
}

# Main function
main() {
  init_habitica
  
  case "${1:-help}" in
    setup)
      setup_habitica
      ;;
    sync)
      sync_tasks_to_habitica
      ;;
    sync-back)
      sync_habitica_to_gtd
      ;;
    status)
      show_status
      ;;
    *)
      echo "Usage: gtd-habitica [command]"
      echo ""
      echo "Commands:"
      echo "  setup       Configure Habitica integration"
      echo "  sync        Sync GTD â†’ Habitica"
      echo "  sync-back   Sync Habitica â†’ GTD"
      echo "  status      Show sync status and Habitica stats"
      echo ""
      echo "For more information, see: zsh/GAMIFICATION_SYSTEM_DESIGN.md"
      ;;
  esac
}

main "$@"

