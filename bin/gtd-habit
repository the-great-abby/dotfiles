#!/bin/bash
# GTD Habit Tracker - Track recurring tasks and habits

# Load GTD config
GTD_CONFIG_FILE="$HOME/.gtd_config"
if [[ -f "$HOME/code/dotfiles/zsh/.gtd_config" ]]; then
  GTD_CONFIG_FILE="$HOME/code/dotfiles/zsh/.gtd_config"
elif [[ -f "$HOME/code/personal/dotfiles/zsh/.gtd_config" ]]; then
  GTD_CONFIG_FILE="$HOME/code/personal/dotfiles/zsh/.gtd_config"
fi

if [[ -f "$GTD_CONFIG_FILE" ]]; then
  source "$GTD_CONFIG_FILE"
fi

# Load daily log config
DAILY_LOG_CONFIG="$HOME/.daily_log_config"
if [[ -f "$HOME/code/dotfiles/zsh/.daily_log_config" ]]; then
  DAILY_LOG_CONFIG="$HOME/code/dotfiles/zsh/.daily_log_config"
elif [[ -f "$HOME/code/personal/dotfiles/zsh/.daily_log_config" ]]; then
  DAILY_LOG_CONFIG="$HOME/code/personal/dotfiles/zsh/.daily_log_config"
fi

if [[ -f "$DAILY_LOG_CONFIG" ]]; then
  source "$DAILY_LOG_CONFIG"
fi

# Source common GTD helpers for selection functions
GTD_COMMON="$HOME/code/dotfiles/bin/gtd-common.sh"
if [[ ! -f "$GTD_COMMON" && -f "$HOME/code/personal/dotfiles/bin/gtd-common.sh" ]]; then
  GTD_COMMON="$HOME/code/personal/dotfiles/bin/gtd-common.sh"
fi
if [[ -f "$GTD_COMMON" ]]; then
  source "$GTD_COMMON"
fi

# Source selection helper for area selection
SELECT_HELPER="$HOME/code/dotfiles/bin/gtd-select-helper.sh"
if [[ ! -f "$SELECT_HELPER" && -f "$HOME/code/personal/dotfiles/bin/gtd-select-helper.sh" ]]; then
  SELECT_HELPER="$HOME/code/personal/dotfiles/bin/gtd-select-helper.sh"
fi
if [[ -f "$SELECT_HELPER" ]]; then
  source "$SELECT_HELPER"
fi

# Default values
GTD_BASE_DIR="${GTD_BASE_DIR:-$HOME/Documents/gtd}"
HABITS_PATH="${GTD_BASE_DIR}/habits"
DAILY_LOG_DIR="${DAILY_LOG_DIR:-$HOME/Documents/daily_logs}"
TASKS_PATH="${GTD_BASE_DIR}/tasks"
AREAS_PATH="${GTD_BASE_DIR}/${GTD_AREAS_DIR:-2-areas}"

mkdir -p "$HABITS_PATH"

# Colors
CYAN='\033[0;36m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
BOLD='\033[1m'
NC='\033[0m'

# Get date command
get_date_cmd() {
  if [[ -x "/usr/bin/date" ]]; then
    echo "/usr/bin/date"
  elif [[ -x "/bin/date" ]]; then
    echo "/bin/date"
  else
    echo "date"
  fi
}

DATE_CMD=$(get_date_cmd)
TODAY=$($DATE_CMD +"%Y-%m-%d")
NOW=$($DATE_CMD +"%H:%M")

# Create a habit
create_habit() {
  local habit_name="$*"
  
  if [[ -z "$habit_name" ]]; then
    read -p "Habit name: " habit_name
  fi
  
  if [[ -z "$habit_name" ]]; then
    echo "âŒ Habit name required"
    return 1
  fi
  
  local habit_slug=$(echo "$habit_name" | tr ' ' '-' | tr '[:upper:]' '[:lower:]' | sed 's/[^a-z0-9-]//g')
  local habit_file="${HABITS_PATH}/${habit_slug}.md"
  
  if [[ -f "$habit_file" ]]; then
    echo "âš ï¸  Habit already exists: $habit_name"
    return 1
  fi
  
  echo ""
  echo "Creating habit: $habit_name"
  echo ""
  
  # Get habit details
  read -p "Description: " description
  echo ""
  echo "Frequency:"
  echo "  1) Daily"
  echo "  2) Weekly"
  echo "  3) Monthly"
  echo "  4) Custom (e.g., every 3 days)"
  echo ""
  read -p "Choose (1-4): " freq_choice
  
  local frequency=""
  case "$freq_choice" in
    1) frequency="daily" ;;
    2) frequency="weekly" ;;
    3) frequency="monthly" ;;
    4)
      read -p "Custom frequency (e.g., 'every 3 days', 'weekdays'): " frequency
      ;;
    *) frequency="daily" ;;
  esac
  
  echo ""
  # Show area selection if areas exist
  area=""
  if [[ -d "$AREAS_PATH" ]] && [[ -n "$(find "$AREAS_PATH" -type f -name "*.md" 2>/dev/null)" ]]; then
    echo "Area of responsibility (optional):"
    # Don't redirect stderr - we want to see the list!
    area_name=$(select_from_list "area" "$AREAS_PATH" "name")
    if [[ -n "$area_name" ]]; then
      # Convert display name to slug format
      area=$(echo "$area_name" | tr ' ' '-' | tr '[:upper:]' '[:lower:]')
      echo "Selected: $area_name"
    else
      echo "No area selected (skipping)"
    fi
  else
    read -p "Area of responsibility (optional, or press Enter to skip): " area
    if [[ -n "$area" ]]; then
      # Convert to slug format
      area=$(echo "$area" | tr ' ' '-' | tr '[:upper:]' '[:lower:]')
    fi
  fi
  echo ""
  read -p "Context (home/office/computer/phone/errands, optional): " context
  echo ""
  read -p "Time of day (optional, e.g., 'morning', 'evening'): " time_of_day
  
  # Create habit file
  cat > "$habit_file" <<EOF
---
type: habit
name: ${habit_name}
frequency: ${frequency}
status: active
created: ${TODAY}T${NOW}
area: ${area:-}
context: ${context:-}
time_of_day: ${time_of_day:-}
streak: 0
longest_streak: 0
total_completions: 0
last_completed: 
---

# ${habit_name}

## Description
${description:-}

## Frequency
${frequency}

## Tracking
- Streak: 0 days
- Longest streak: 0 days
- Total completions: 0
- Last completed: Never

## Notes

EOF
  
  echo "âœ“ Habit created: $habit_name"
  echo ""
  echo "ğŸ’¡ Track completion with: gtd-habit complete \"$habit_name\""
  echo "   Or: gtd-habit log \"$habit_name\""
}

# Log habit completion
log_habit() {
  local habit_name="$*"
  
  if [[ -z "$habit_name" ]]; then
    echo "Usage: gtd-habit log <habit-name>"
    echo "   Or: gtd-habit complete <habit-name>"
    exit 1
  fi
  
  local habit_slug=$(echo "$habit_name" | tr ' ' '-' | tr '[:upper:]' '[:lower:]' | sed 's/[^a-z0-9-]//g')
  local habit_file="${HABITS_PATH}/${habit_slug}.md"
  
  if [[ ! -f "$habit_file" ]]; then
    echo "âŒ Habit not found: $habit_name"
    echo ""
    echo "Available habits:"
    list_habits
    return 1
  fi
  
  # Update habit file
  local current_streak=$(grep "^streak:" "$habit_file" 2>/dev/null | cut -d':' -f2 | sed 's/^[[:space:]]*//' || echo "0")
  local longest_streak=$(grep "^longest_streak:" "$habit_file" 2>/dev/null | cut -d':' -f2 | sed 's/^[[:space:]]*//' || echo "0")
  local total_completions=$(grep "^total_completions:" "$habit_file" 2>/dev/null | cut -d':' -f2 | sed 's/^[[:space:]]*//' || echo "0")
  local last_completed=$(grep "^last_completed:" "$habit_file" 2>/dev/null | cut -d':' -f2 | sed 's/^[[:space:]]*//' || echo "")
  
  # Check if already completed today
  if [[ "$last_completed" == "$TODAY" ]]; then
    echo "âœ“ Already logged for today: $habit_name"
    return 0
  fi
  
  # Calculate new streak
  local new_streak=1
  if [[ -n "$last_completed" ]]; then
    # Check if last completion was yesterday (for daily habits)
    local yesterday=$($DATE_CMD -v-1d +"%Y-%m-%d" 2>/dev/null || $DATE_CMD -d "yesterday" +"%Y-%m-%d" 2>/dev/null || echo "")
    if [[ "$last_completed" == "$yesterday" ]]; then
      new_streak=$((current_streak + 1))
    fi
  fi
  
  local new_total=$((total_completions + 1))
  local new_longest=$longest_streak
  if [[ $new_streak -gt $longest_streak ]]; then
    new_longest=$new_streak
  fi
  
  # Update habit file
  if [[ "$OSTYPE" == "darwin"* ]]; then
    sed -i '' "s/^streak:.*/streak: ${new_streak}/" "$habit_file"
    sed -i '' "s/^longest_streak:.*/longest_streak: ${new_longest}/" "$habit_file"
    sed -i '' "s/^total_completions:.*/total_completions: ${new_total}/" "$habit_file"
    sed -i '' "s/^last_completed:.*/last_completed: ${TODAY}/" "$habit_file"
  else
    sed -i "s/^streak:.*/streak: ${new_streak}/" "$habit_file"
    sed -i "s/^longest_streak:.*/longest_streak: ${new_longest}/" "$habit_file"
    sed -i "s/^total_completions:.*/total_completions: ${new_total}/" "$habit_file"
    sed -i "s/^last_completed:.*/last_completed: ${TODAY}/" "$habit_file"
  fi
  
  # Add to tracking section
  cat >> "$habit_file" <<EOF

## Completion - ${TODAY} ${NOW}
Completed successfully.

EOF
  
  # Log to daily log
  local area=$(grep "^area:" "$habit_file" 2>/dev/null | cut -d':' -f2- | sed 's/^[[:space:]]*//' || echo "")
  local log_message=""
  if [[ -n "$area" ]]; then
    log_message="Completed habit: $habit_name (${area} area)"
  else
    log_message="Completed habit: $habit_name"
  fi
  
  # Try gtd-daily-log first (standalone script), then addInfoToDailyLog (zsh function)
  if command -v gtd-daily-log &>/dev/null; then
    gtd-daily-log "$log_message" 2>/dev/null || true
  elif [[ -f "$HOME/code/dotfiles/bin/gtd-daily-log" ]]; then
    "$HOME/code/dotfiles/bin/gtd-daily-log" "$log_message" 2>/dev/null || true
  elif [[ -f "$HOME/code/personal/dotfiles/bin/gtd-daily-log" ]]; then
    "$HOME/code/personal/dotfiles/bin/gtd-daily-log" "$log_message" 2>/dev/null || true
  elif command -v addInfoToDailyLog &>/dev/null || type addInfoToDailyLog &>/dev/null 2>/dev/null; then
    addInfoToDailyLog "$log_message" 2>/dev/null || true
  fi
  
  echo "âœ“ Logged: $habit_name"
  echo "  Streak: ${new_streak} day(s)"
  echo "  Longest streak: ${new_longest} day(s)"
  echo "  Total completions: ${new_total}"
  echo ""
  
  # Celebrate milestones
  if [[ $new_streak -eq 7 ]]; then
    echo "ğŸ‰ 7-day streak! Keep it up!"
  elif [[ $new_streak -eq 30 ]]; then
    echo "ğŸ‰ğŸ‰ 30-day streak! Amazing!"
  elif [[ $new_streak -eq 100 ]]; then
    echo "ğŸ‰ğŸ‰ğŸ‰ 100-day streak! Incredible!"
  fi
}

# List all habits
list_habits() {
  echo ""
  echo -e "${BOLD}${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
  echo -e "${BOLD}${CYAN}ğŸ“Š Your Habits${NC}"
  echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
  echo ""
  
  local habits=($(find "$HABITS_PATH" -type f -name "*.md" 2>/dev/null | sort))
  local habit_count=${#habits[@]}
  
  if [[ $habit_count -eq 0 ]]; then
    echo "No habits defined yet."
    echo ""
    echo "Create one with: gtd-habit create \"Habit Name\""
    return 0
  fi
  
  for habit_file in "${habits[@]}"; do
    local habit_name=$(grep "^name:" "$habit_file" 2>/dev/null | cut -d':' -f2- | sed 's/^[[:space:]]*//' || basename "$habit_file" .md)
    local frequency=$(grep "^frequency:" "$habit_file" 2>/dev/null | cut -d':' -f2 | sed 's/^[[:space:]]*//' || echo "unknown")
    local streak=$(grep "^streak:" "$habit_file" 2>/dev/null | cut -d':' -f2 | sed 's/^[[:space:]]*//' || echo "0")
    local longest=$(grep "^longest_streak:" "$habit_file" 2>/dev/null | cut -d':' -f2 | sed 's/^[[:space:]]*//' || echo "0")
    local total=$(grep "^total_completions:" "$habit_file" 2>/dev/null | cut -d':' -f2 | sed 's/^[[:space:]]*//' || echo "0")
    local last_completed=$(grep "^last_completed:" "$habit_file" 2>/dev/null | cut -d':' -f2 | sed 's/^[[:space:]]*//' || echo "Never")
    local status=$(grep "^status:" "$habit_file" 2>/dev/null | cut -d':' -f2 | sed 's/^[[:space:]]*//' || echo "active")
    
    # Check if due today
    local is_due=""
    if [[ "$last_completed" != "$TODAY" && "$status" == "active" ]]; then
      if [[ "$frequency" == "daily" ]]; then
        is_due="${RED}âš ï¸  Due today${NC}"
      elif [[ "$frequency" == "weekly" ]]; then
        # Check if it's been a week
        if [[ -n "$last_completed" && "$last_completed" != "Never" ]]; then
          local days_since=$(( ($($DATE_CMD +%s) - $($DATE_CMD -j -f "%Y-%m-%d" "$last_completed" +%s 2>/dev/null || echo 0)) / 86400 ))
          if [[ $days_since -ge 7 ]]; then
            is_due="${RED}âš ï¸  Due${NC}"
          fi
        fi
      fi
    fi
    
    echo -e "${BOLD}${habit_name}${NC} ${is_due}"
    echo "  Frequency: ${frequency}"
    echo "  Streak: ${GREEN}${streak}${NC} day(s) | Longest: ${longest} | Total: ${total}"
    echo "  Last completed: ${last_completed}"
    echo ""
  done
  
  echo "Total: ${habit_count} habit(s)"
  echo ""
}

# Show habit dashboard
show_dashboard() {
  echo ""
  echo -e "${BOLD}${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
  echo -e "${BOLD}${CYAN}ğŸ“Š Habit Dashboard${NC}"
  echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
  echo ""
  
  local habits=($(find "$HABITS_PATH" -type f -name "*.md" 2>/dev/null | sort))
  local habit_count=${#habits[@]}
  local active_count=0
  local due_count=0
  local total_streaks=0
  local total_completions=0
  
  if [[ $habit_count -eq 0 ]]; then
    echo "No habits defined yet."
    echo ""
    echo "Create one with: gtd-habit create \"Habit Name\""
    return 0
  fi
  
  # Calculate stats
  for habit_file in "${habits[@]}"; do
    local status=$(grep "^status:" "$habit_file" 2>/dev/null | cut -d':' -f2 | sed 's/^[[:space:]]*//' || echo "active")
    if [[ "$status" == "active" ]]; then
      ((active_count++))
      
      local last_completed=$(grep "^last_completed:" "$habit_file" 2>/dev/null | cut -d':' -f2 | sed 's/^[[:space:]]*//' || echo "")
      local frequency=$(grep "^frequency:" "$habit_file" 2>/dev/null | cut -d':' -f2 | sed 's/^[[:space:]]*//' || echo "")
      
      if [[ "$last_completed" != "$TODAY" && "$frequency" == "daily" ]]; then
        ((due_count++))
      fi
      
      local streak=$(grep "^streak:" "$habit_file" 2>/dev/null | cut -d':' -f2 | sed 's/^[[:space:]]*//' || echo "0")
      local total=$(grep "^total_completions:" "$habit_file" 2>/dev/null | cut -d':' -f2 | sed 's/^[[:space:]]*//' || echo "0")
      total_streaks=$((total_streaks + streak))
      total_completions=$((total_completions + total))
    fi
  done
  
  echo "ğŸ“Š Overall Stats:"
  echo "  Total habits: ${habit_count}"
  echo "  Active habits: ${active_count}"
  echo "  Due today: ${due_count}"
  echo "  Total streak days: ${total_streaks}"
  echo "  Total completions: ${total_completions}"
  echo ""
  
  # Show habits due today
  if [[ $due_count -gt 0 ]]; then
    echo -e "${YELLOW}âš ï¸  Habits Due Today:${NC}"
    echo ""
    for habit_file in "${habits[@]}"; do
      local status=$(grep "^status:" "$habit_file" 2>/dev/null | cut -d':' -f2 | sed 's/^[[:space:]]*//' || echo "active")
      if [[ "$status" == "active" ]]; then
        local habit_name=$(grep "^name:" "$habit_file" 2>/dev/null | cut -d':' -f2- | sed 's/^[[:space:]]*//' || basename "$habit_file" .md)
        local last_completed=$(grep "^last_completed:" "$habit_file" 2>/dev/null | cut -d':' -f2 | sed 's/^[[:space:]]*//' || echo "")
        local frequency=$(grep "^frequency:" "$habit_file" 2>/dev/null | cut -d':' -f2 | sed 's/^[[:space:]]*//' || echo "")
        
        if [[ "$last_completed" != "$TODAY" && "$frequency" == "daily" ]]; then
          echo "  â€¢ $habit_name"
          echo "    Log with: gtd-habit log \"$habit_name\""
        fi
      fi
    done
    echo ""
  fi
  
  # Show top streaks
  echo -e "${GREEN}ğŸ”¥ Top Streaks:${NC}"
  echo ""
  
  # Build array of streak|name pairs, handling spaces properly
  local top_habits_raw=$(for habit_file in "${habits[@]}"; do
    local streak=$(grep "^streak:" "$habit_file" 2>/dev/null | cut -d':' -f2 | sed 's/^[[:space:]]*//' || echo "0")
    # Use cut -f2- to get everything after the colon (handles names with colons)
    local habit_name=$(grep "^name:" "$habit_file" 2>/dev/null | cut -d':' -f2- | sed 's/^[[:space:]]*//' || basename "$habit_file" .md)
    echo "${streak}|${habit_name}"
  done | sort -t'|' -k1 -nr | head -5)
  
  # Process each line using mapfile to handle spaces correctly
  local top_habits_array=()
  while IFS= read -r line; do
    [[ -z "$line" ]] && continue
    top_habits_array+=("$line")
  done <<< "$top_habits_raw"
  
  for habit_info in "${top_habits_array[@]}"; do
    [[ -z "$habit_info" ]] && continue
    local streak=$(echo "$habit_info" | cut -d'|' -f1)
    # Use cut -f2- to get everything after the pipe (handles names with pipes - unlikely but safe)
    local habit_name=$(echo "$habit_info" | cut -d'|' -f2-)
    if [[ -n "$streak" && "$streak" -gt 0 ]]; then
      echo "  ${streak} days: $habit_name"
    fi
  done
  echo ""
}

# View habit details
view_habit() {
  local habit_name="$*"
  
  if [[ -z "$habit_name" ]]; then
    echo "Usage: gtd-habit view <habit-name>"
    exit 1
  fi
  
  local habit_slug=$(echo "$habit_name" | tr ' ' '-' | tr '[:upper:]' '[:lower:]' | sed 's/[^a-z0-9-]//g')
  local habit_file="${HABITS_PATH}/${habit_slug}.md"
  
  if [[ ! -f "$habit_file" ]]; then
    echo "âŒ Habit not found: $habit_name"
    echo ""
    echo "Available habits:"
    list_habits
    return 1
  fi
  
  echo ""
  echo -e "${BOLD}${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
  echo -e "${BOLD}${CYAN}ğŸ“Š Habit: $habit_name${NC}"
  echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
  echo ""
  cat "$habit_file"
  echo ""
}

# Archive habit
archive_habit() {
  local habit_name="$*"
  
  if [[ -z "$habit_name" ]]; then
    echo "Usage: gtd-habit archive <habit-name>"
    exit 1
  fi
  
  local habit_slug=$(echo "$habit_name" | tr ' ' '-' | tr '[:upper:]' '[:lower:]' | sed 's/[^a-z0-9-]//g')
  local habit_file="${HABITS_PATH}/${habit_slug}.md"
  
  if [[ ! -f "$habit_file" ]]; then
    echo "âŒ Habit not found: $habit_name"
    return 1
  fi
  
  # Update status
  if [[ "$OSTYPE" == "darwin"* ]]; then
    sed -i '' "s/^status:.*/status: archived/" "$habit_file"
  else
    sed -i "s/^status:.*/status: archived/" "$habit_file"
  fi
  
  echo "âœ“ Archived habit: $habit_name"
}

# Show usage
show_usage() {
  cat <<EOF
Usage: gtd-habit <command> [options]

Commands:
  create <name>              Create a new habit
  log <name>                 Log habit completion (also: complete)
  list|ls                    List all habits
  dashboard                  Show habit dashboard
  view <name>                View habit details
  archive <name>             Archive a habit
  help                       Show this help

Examples:
  gtd-habit create "Morning workout"
  gtd-habit log "Morning workout"
  gtd-habit list
  gtd-habit dashboard
  gtd-habit view "Morning workout"

Habits are recurring tasks that you want to track over time.
They automatically track streaks, completions, and integrate with your daily logs.

EOF
}

# Main command handler
case "${1:-}" in
  create)
    shift
    create_habit "$@"
    ;;
  log|complete)
    shift
    log_habit "$@"
    ;;
  list|ls)
    list_habits
    ;;
  dashboard)
    show_dashboard
    ;;
  view)
    shift
    view_habit "$@"
    ;;
  archive)
    shift
    archive_habit "$@"
    ;;
  help|--help|-h)
    show_usage
    ;;
  "")
    show_dashboard
    ;;
  *)
    echo "Unknown command: $1"
    echo ""
    show_usage
    exit 1
    ;;
esac

