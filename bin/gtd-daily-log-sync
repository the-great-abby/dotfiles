#!/bin/bash
# GTD Daily Log Sync - Sync daily logs between computers
# Works with cloud storage (iCloud, Dropbox, etc.) or Second Brain directory

# Source common environment (PATH setup)
COMMON_ENV="$HOME/code/dotfiles/zsh/common_env.sh"
if [[ ! -f "$COMMON_ENV" && -f "$HOME/code/personal/dotfiles/zsh/common_env.sh" ]]; then
  COMMON_ENV="$HOME/code/personal/dotfiles/zsh/common_env.sh"
fi
if [[ -f "$COMMON_ENV" ]]; then
  source "$COMMON_ENV"
fi


# Load daily log config
DAILY_LOG_CONFIG="$HOME/.daily_log_config"
if [[ -f "$HOME/code/dotfiles/zsh/.daily_log_config" ]]; then
  DAILY_LOG_CONFIG="$HOME/code/dotfiles/zsh/.daily_log_config"
elif [[ -f "$HOME/code/personal/dotfiles/zsh/.daily_log_config" ]]; then
  DAILY_LOG_CONFIG="$HOME/code/personal/dotfiles/zsh/.daily_log_config"
fi

if [[ -f "$DAILY_LOG_CONFIG" ]]; then
  source "$DAILY_LOG_CONFIG"
fi

# Load GTD config
GTD_CONFIG_FILE="$HOME/.gtd_config"
if [[ -f "$HOME/code/dotfiles/zsh/.gtd_config" ]]; then
  GTD_CONFIG_FILE="$HOME/code/dotfiles/zsh/.gtd_config"
elif [[ -f "$HOME/code/personal/dotfiles/zsh/.gtd_config" ]]; then
  GTD_CONFIG_FILE="$HOME/code/personal/dotfiles/zsh/.gtd_config"
fi

if [[ -f "$GTD_CONFIG_FILE" ]]; then
  source "$GTD_CONFIG_FILE"
fi

# Source common GTD helpers (DRY - reuse existing helpers)
GTD_COMMON="$HOME/code/dotfiles/bin/gtd-common.sh"
if [[ ! -f "$GTD_COMMON" && -f "$HOME/code/personal/dotfiles/bin/gtd-common.sh" ]]; then
  GTD_COMMON="$HOME/code/personal/dotfiles/bin/gtd-common.sh"
fi
if [[ -f "$GTD_COMMON" ]]; then
  source "$GTD_COMMON"
else
  echo "Warning: gtd-common.sh not found. Some features may not work." >&2
fi

# Default values
# GTD_BASE_DIR is already set by init_gtd_paths in gtd-common.sh (DRY - reuse existing helper)
DAILY_LOG_DIR="${DAILY_LOG_DIR:-$HOME/Documents/daily_logs}"
SECOND_BRAIN="${SECOND_BRAIN:-$HOME/Documents/obsidian/Second Brain}"
SYNC_METHOD="${DAILY_LOG_SYNC_METHOD:-second-brain}"  # second-brain, cloud, git

# Colors
CYAN='\033[0;36m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
BOLD='\033[1m'
NC='\033[0m'

# Get date command
get_date_cmd() {
  if [[ -x "/usr/bin/date" ]]; then
    echo "/usr/bin/date"
  elif [[ -x "/bin/date" ]]; then
    echo "/bin/date"
  else
    echo "date"
  fi
}

DATE_CMD=$(get_date_cmd)

# Initialize git repo in GTD directory if it doesn't exist
init_gtd_git_repo() {
  local gtd_base="${GTD_BASE_DIR:-$HOME/Documents/gtd}"
  
  if [[ ! -d "$gtd_base" ]]; then
    mkdir -p "$gtd_base"
  fi
  
  # Check if git repo exists
  if [[ ! -d "$gtd_base/.git" ]]; then
    echo "ğŸ“¦ Initializing git repository in GTD directory..."
    cd "$gtd_base" || return 1
    
    # Initialize git repo
    git init --quiet || return 1
    
    # Create .gitignore if it doesn't exist
    if [[ ! -f "$gtd_base/.gitignore" ]]; then
      cat > "$gtd_base/.gitignore" <<EOF
# GTD Git Ignore
*.backup.*
*.banter.*
*.tmp
*.swp
*~
.DS_Store
.gtd/
*.txt
EOF
      git add .gitignore
      git commit -m "Initial commit: Add .gitignore" --quiet 2>/dev/null || true
    fi
    
    echo "  âœ“ Git repository initialized"
  fi
}

# Git-based sync: commit changes and sync to Second Brain
git_sync_to_second_brain() {
  local source_dir="$1"
  local dest_dir="$2"
  local sync_type="${3:-daily-logs}"
  
  if [[ ! -d "$source_dir" ]]; then
    return 1
  fi
  
  local gtd_base="${GTD_BASE_DIR:-$HOME/Documents/gtd}"
  
  # Initialize git repo if needed
  init_gtd_git_repo
  
  cd "$gtd_base" || return 1
  
  # Stage all changes
  git add -A 2>/dev/null || true
  
  # Check if there are changes to commit
  if git diff --staged --quiet 2>/dev/null && git diff --quiet 2>/dev/null; then
    # No changes, but still sync files
    echo "  (No changes to commit)"
  else
    # Commit with timestamp
    local timestamp=$(date +"%Y-%m-%d %H:%M:%S")
    local commit_msg="Sync ${sync_type} to Second Brain - ${timestamp}"
    
    git commit -m "$commit_msg" --quiet 2>/dev/null && {
      echo "  âœ“ Committed changes: ${commit_msg}"
    } || {
      echo "  âš ï¸  No changes to commit"
    }
  fi
  
  # Create destination directory
  mkdir -p "$dest_dir"
  
  # Copy files to Second Brain (excluding ignored files)
  # Include both .md and .txt files for daily logs
  local files_copied=0
  while IFS= read -r file; do
    if [[ -f "$file" ]]; then
      local rel_path="${file#$source_dir/}"
      local dest_file="$dest_dir/$rel_path"
      local dest_dir_path=$(dirname "$dest_file")
      
      mkdir -p "$dest_dir_path"
      
      # Only copy if source is newer or doesn't exist in dest
      if [[ ! -f "$dest_file" ]] || [[ "$file" -nt "$dest_file" ]]; then
        cp "$file" "$dest_file" 2>/dev/null && ((files_copied++))
      fi
    fi
  done < <(find "$source_dir" -type f \( -name "*.md" -o -name "*.txt" \) ! -name "*.banter.*" ! -name "*.backup.*" 2>/dev/null)
  
  if [[ $files_copied -gt 0 ]]; then
    echo "  âœ“ Copied ${files_copied} file(s) to Second Brain"
  fi
}

# Git-based sync: pull from Second Brain
git_sync_from_second_brain() {
  local source_dir="$1"
  local dest_dir="$2"
  
  if [[ ! -d "$source_dir" ]]; then
    return 1
  fi
  
  mkdir -p "$dest_dir"
  
  # Copy files from Second Brain to local (only if newer)
  # Include both .md and .txt files for daily logs
  local files_copied=0
  while IFS= read -r file; do
    if [[ -f "$file" ]]; then
      local rel_path="${file#$source_dir/}"
      local dest_file="$dest_dir/$rel_path"
      local dest_dir_path=$(dirname "$dest_file")
      
      mkdir -p "$dest_dir_path"
      
      # Only copy if source is newer or doesn't exist in dest
      if [[ ! -f "$dest_file" ]] || [[ "$file" -nt "$dest_file" ]]; then
        cp "$file" "$dest_file" 2>/dev/null && ((files_copied++))
      fi
    fi
  done < <(find "$source_dir" -type f \( -name "*.md" -o -name "*.txt" \) ! -name "*.banter.*" ! -name "*.backup.*" 2>/dev/null)
  
  if [[ $files_copied -gt 0 ]]; then
    echo "  âœ“ Pulled ${files_copied} file(s) from Second Brain"
    
    # Commit the pulled changes
    local gtd_base="${GTD_BASE_DIR:-$HOME/Documents/gtd}"
    init_gtd_git_repo
    cd "$gtd_base" || return 1
    
    git add -A 2>/dev/null || true
    if ! git diff --staged --quiet 2>/dev/null; then
      local timestamp=$(date +"%Y-%m-%d %H:%M:%S")
      git commit -m "Sync from Second Brain - ${timestamp}" --quiet 2>/dev/null && {
        echo "  âœ“ Committed pulled changes"
      }
    fi
  fi
}

# Sync to Second Brain directory (so Obsidian sync handles it)
sync_to_second_brain() {
  local sync_dir="${SECOND_BRAIN}/Daily Logs"
  
  echo ""
  echo -e "${BOLD}${CYAN}Syncing Daily Logs to Second Brain (Git-based)${NC}"
  echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
  echo ""
  
  # Create sync directory
  mkdir -p "$sync_dir"
  
  if [[ ! -d "$DAILY_LOG_DIR" ]]; then
    echo "âŒ Daily log directory not found: $DAILY_LOG_DIR"
    return 1
  fi
  
  # Push local â†’ Second Brain using git
  echo "Pushing local logs to Second Brain..."
  git_sync_to_second_brain "$DAILY_LOG_DIR" "$sync_dir" "daily-logs"
  
  # Also pull any new files from Second Brain (in case other computer added files)
  echo "Pulling new files from Second Brain..."
  git_sync_from_second_brain "$sync_dir" "$DAILY_LOG_DIR"
  
  echo ""
  echo "âœ“ Daily logs synced to: ${sync_dir}"
  echo ""
  echo "ğŸ’¡ Since this is in your Obsidian vault, it will sync automatically!"
  echo ""
}

# Sync from Second Brain (pull)
sync_from_second_brain() {
  local sync_dir="${SECOND_BRAIN}/Daily Logs"
  
  echo ""
  echo -e "${BOLD}${CYAN}Pulling Daily Logs from Second Brain (Git-based)${NC}"
  echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
  echo ""
  
  if [[ ! -d "$sync_dir" ]]; then
    echo "âŒ Sync directory not found: $sync_dir"
    echo "   Run 'gtd-daily-log-sync push' first to create it."
    return 1
  fi
  
  mkdir -p "$DAILY_LOG_DIR"
  
  # Pull from Second Brain â†’ local using git
  echo "Pulling logs from Second Brain..."
  git_sync_from_second_brain "$sync_dir" "$DAILY_LOG_DIR"
  
  echo ""
  echo "âœ“ Daily logs pulled from: ${sync_dir}"
  echo ""
}

# Two-way sync (merge)
sync_both_ways() {
  local sync_dir="${SECOND_BRAIN}/Daily Logs"
  
  echo ""
  echo -e "${BOLD}${CYAN}Two-Way Sync: Daily Logs â†” Second Brain (Git-based)${NC}"
  echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
  echo ""
  
  mkdir -p "$sync_dir"
  mkdir -p "$DAILY_LOG_DIR"
  
  # Sync local â†’ Second Brain using git
  echo "Syncing local â†’ Second Brain..."
  git_sync_to_second_brain "$DAILY_LOG_DIR" "$sync_dir" "daily-logs"
  
  # Sync Second Brain â†’ local
  echo "Syncing Second Brain â†’ local..."
  git_sync_from_second_brain "$sync_dir" "$DAILY_LOG_DIR"
  
  echo ""
  echo "âœ“ Two-way sync complete!"
  echo ""
  echo "ğŸ’¡ Your daily logs are now in: ${sync_dir}"
  echo "   This will sync automatically with Obsidian!"
  echo ""
}

# Show status
show_status() {
  local sync_dir="${SECOND_BRAIN}/Daily Logs"
  
  echo ""
  echo -e "${BOLD}${CYAN}Daily Log Sync Status${NC}"
  echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
  echo ""
  
  echo "ğŸ“ Local daily logs:"
  if [[ -d "$DAILY_LOG_DIR" ]]; then
    local local_count=$(find "$DAILY_LOG_DIR" -type f -name "*.md" -maxdepth 1 | wc -l | tr -d ' ')
    echo "   Location: $DAILY_LOG_DIR"
    echo "   Count: ${local_count} log(s)"
  else
    echo "   âŒ Directory not found"
  fi
  
  echo ""
  echo "â˜ï¸  Synced daily logs:"
  if [[ -d "$sync_dir" ]]; then
    local sync_count=$(find "$sync_dir" -type f -name "*.md" -maxdepth 1 | wc -l | tr -d ' ')
    echo "   Location: $sync_dir"
    echo "   Count: ${sync_count} log(s)"
  else
    echo "   âŒ Not synced yet (run 'gtd-daily-log-sync push')"
  fi
  
  echo ""
  echo "ğŸ”„ Sync method: Second Brain (Obsidian sync)"
  echo ""
}

# Show usage
show_usage() {
  cat <<EOF
Usage: gtd-daily-log-sync <command>

Commands:
  push          Sync local daily logs to Second Brain (for syncing to other computers)
  pull          Pull daily logs from Second Brain (when switching computers)
  sync          Two-way sync (merge both directions)
  status        Show sync status
  help          Show this help

Examples:
  gtd-daily-log-sync push    # Before switching computers (push to cloud)
  gtd-daily-log-sync pull    # After switching computers (pull from cloud)
  gtd-daily-log-sync sync    # Two-way sync (recommended)
  gtd-daily-log-sync status  # Check sync status

How it works:
  Daily logs are synced to: ~/Documents/obsidian/Second Brain/Daily Logs/
  Since this is in your Obsidian vault, it syncs automatically via Obsidian sync.
  
  When you switch computers:
  1. On old computer: gtd-daily-log-sync push (or sync)
  2. Wait for Obsidian to sync
  3. On new computer: gtd-daily-log-sync pull (or sync)

Configuration:
  Set DAILY_LOG_SYNC_METHOD in .daily_log_config (default: second-brain)

EOF
}

# Main command handler
case "${1:-}" in
  push)
    sync_to_second_brain
    ;;
  pull)
    sync_from_second_brain
    ;;
  sync)
    sync_both_ways
    ;;
  status)
    show_status
    ;;
  help|--help|-h)
    show_usage
    ;;
  "")
    # Default: two-way sync
    sync_both_ways
    ;;
  *)
    echo "âŒ Unknown command: $1"
    echo ""
    show_usage
    exit 1
    ;;
esac

