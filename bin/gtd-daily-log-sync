#!/bin/bash
# GTD Daily Log Sync - Sync daily logs between computers
# Works with cloud storage (iCloud, Dropbox, etc.) or Second Brain directory

# Source common environment (PATH setup)
COMMON_ENV="$HOME/code/dotfiles/zsh/common_env.sh"
if [[ ! -f "$COMMON_ENV" && -f "$HOME/code/personal/dotfiles/zsh/common_env.sh" ]]; then
  COMMON_ENV="$HOME/code/personal/dotfiles/zsh/common_env.sh"
fi
if [[ -f "$COMMON_ENV" ]]; then
  source "$COMMON_ENV"
fi


# Load daily log config
DAILY_LOG_CONFIG="$HOME/.daily_log_config"
if [[ -f "$HOME/code/dotfiles/zsh/.daily_log_config" ]]; then
  DAILY_LOG_CONFIG="$HOME/code/dotfiles/zsh/.daily_log_config"
elif [[ -f "$HOME/code/personal/dotfiles/zsh/.daily_log_config" ]]; then
  DAILY_LOG_CONFIG="$HOME/code/personal/dotfiles/zsh/.daily_log_config"
fi

if [[ -f "$DAILY_LOG_CONFIG" ]]; then
  source "$DAILY_LOG_CONFIG"
fi

# Load GTD config
GTD_CONFIG_FILE="$HOME/.gtd_config"
if [[ -f "$HOME/code/dotfiles/zsh/.gtd_config" ]]; then
  GTD_CONFIG_FILE="$HOME/code/dotfiles/zsh/.gtd_config"
elif [[ -f "$HOME/code/personal/dotfiles/zsh/.gtd_config" ]]; then
  GTD_CONFIG_FILE="$HOME/code/personal/dotfiles/zsh/.gtd_config"
fi

if [[ -f "$GTD_CONFIG_FILE" ]]; then
  source "$GTD_CONFIG_FILE"
fi

# Default values
DAILY_LOG_DIR="${DAILY_LOG_DIR:-$HOME/Documents/daily_logs}"
SECOND_BRAIN="${SECOND_BRAIN:-$HOME/Documents/obsidian/Second Brain}"
SYNC_METHOD="${DAILY_LOG_SYNC_METHOD:-second-brain}"  # second-brain, cloud, git

# Colors
CYAN='\033[0;36m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
BOLD='\033[1m'
NC='\033[0m'

# Get date command
get_date_cmd() {
  if [[ -x "/usr/bin/date" ]]; then
    echo "/usr/bin/date"
  elif [[ -x "/bin/date" ]]; then
    echo "/bin/date"
  else
    echo "date"
  fi
}

DATE_CMD=$(get_date_cmd)

# Sync to Second Brain directory (so Obsidian sync handles it)
sync_to_second_brain() {
  local sync_dir="${SECOND_BRAIN}/Daily Logs"
  
  echo ""
  echo -e "${BOLD}${CYAN}Syncing Daily Logs to Second Brain${NC}"
  echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
  echo ""
  
  # Create sync directory
  mkdir -p "$sync_dir"
  
  if [[ ! -d "$DAILY_LOG_DIR" ]]; then
    echo "âŒ Daily log directory not found: $DAILY_LOG_DIR"
    return 1
  fi
  
  # Push local â†’ Second Brain (only update if local is newer)
  echo "Pushing local logs to Second Brain..."
  rsync -av --update \
    --exclude='*.banter.*' \
    --exclude='*.backup.*' \
    --exclude='*.txt' \
    "${DAILY_LOG_DIR}/" "${sync_dir}/" 2>/dev/null | grep -E "^[^/]|^deleting" | sed 's/^/  /' || true
  
  # Also pull any new files from Second Brain (in case other computer added files)
  echo "Pulling new files from Second Brain..."
  rsync -av --update \
    --exclude='*.banter.*' \
    --exclude='*.backup.*' \
    "${sync_dir}/" "${DAILY_LOG_DIR}/" 2>/dev/null | grep -E "^[^/]|^deleting" | sed 's/^/  /' || true
  
  echo ""
  echo "âœ“ Daily logs synced to: ${sync_dir}"
  echo ""
  echo "ğŸ’¡ Since this is in your Obsidian vault, it will sync automatically!"
  echo ""
}

# Sync from Second Brain (pull)
sync_from_second_brain() {
  local sync_dir="${SECOND_BRAIN}/Daily Logs"
  
  echo ""
  echo -e "${BOLD}${CYAN}Pulling Daily Logs from Second Brain${NC}"
  echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
  echo ""
  
  if [[ ! -d "$sync_dir" ]]; then
    echo "âŒ Sync directory not found: $sync_dir"
    echo "   Run 'gtd-daily-log-sync push' first to create it."
    return 1
  fi
  
  mkdir -p "$DAILY_LOG_DIR"
  
  # Pull from Second Brain â†’ local (only update if sync is newer)
  echo "Pulling logs from Second Brain..."
  rsync -av --update \
    --exclude='*.banter.*' \
    --exclude='*.backup.*' \
    "${sync_dir}/" "${DAILY_LOG_DIR}/" 2>/dev/null | grep -E "^[^/]|^deleting" | sed 's/^/  /' || true
  
  echo ""
  echo "âœ“ Daily logs pulled from: ${sync_dir}"
  echo ""
}

# Two-way sync (merge)
sync_both_ways() {
  local sync_dir="${SECOND_BRAIN}/Daily Logs"
  
  echo ""
  echo -e "${BOLD}${CYAN}Two-Way Sync: Daily Logs â†” Second Brain${NC}"
  echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
  echo ""
  
  mkdir -p "$sync_dir"
  mkdir -p "$DAILY_LOG_DIR"
  
  # Sync local â†’ Second Brain using rsync
  # --update: only update if source is newer (preserves newer files in destination)
  # --exclude: skip banter files and backups
  echo "Syncing local â†’ Second Brain..."
  rsync -av --update \
    --exclude='*.banter.*' \
    --exclude='*.backup.*' \
    --exclude='*.txt' \
    "${DAILY_LOG_DIR}/" "${sync_dir}/" 2>/dev/null | grep -E "^[^/]|^deleting" | sed 's/^/  /' || true
  
  # Sync Second Brain â†’ local
  # --update: only update if source is newer (preserves newer local files)
  echo "Syncing Second Brain â†’ local..."
  rsync -av --update \
    --exclude='*.banter.*' \
    --exclude='*.backup.*' \
    "${sync_dir}/" "${DAILY_LOG_DIR}/" 2>/dev/null | grep -E "^[^/]|^deleting" | sed 's/^/  /' || true
  
  echo ""
  echo "âœ“ Two-way sync complete!"
  echo ""
  echo "ğŸ’¡ Your daily logs are now in: ${sync_dir}"
  echo "   This will sync automatically with Obsidian!"
  echo ""
}

# Show status
show_status() {
  local sync_dir="${SECOND_BRAIN}/Daily Logs"
  
  echo ""
  echo -e "${BOLD}${CYAN}Daily Log Sync Status${NC}"
  echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
  echo ""
  
  echo "ğŸ“ Local daily logs:"
  if [[ -d "$DAILY_LOG_DIR" ]]; then
    local local_count=$(find "$DAILY_LOG_DIR" -type f -name "*.md" -maxdepth 1 | wc -l | tr -d ' ')
    echo "   Location: $DAILY_LOG_DIR"
    echo "   Count: ${local_count} log(s)"
  else
    echo "   âŒ Directory not found"
  fi
  
  echo ""
  echo "â˜ï¸  Synced daily logs:"
  if [[ -d "$sync_dir" ]]; then
    local sync_count=$(find "$sync_dir" -type f -name "*.md" -maxdepth 1 | wc -l | tr -d ' ')
    echo "   Location: $sync_dir"
    echo "   Count: ${sync_count} log(s)"
  else
    echo "   âŒ Not synced yet (run 'gtd-daily-log-sync push')"
  fi
  
  echo ""
  echo "ğŸ”„ Sync method: Second Brain (Obsidian sync)"
  echo ""
}

# Show usage
show_usage() {
  cat <<EOF
Usage: gtd-daily-log-sync <command>

Commands:
  push          Sync local daily logs to Second Brain (for syncing to other computers)
  pull          Pull daily logs from Second Brain (when switching computers)
  sync          Two-way sync (merge both directions)
  status        Show sync status
  help          Show this help

Examples:
  gtd-daily-log-sync push    # Before switching computers (push to cloud)
  gtd-daily-log-sync pull    # After switching computers (pull from cloud)
  gtd-daily-log-sync sync    # Two-way sync (recommended)
  gtd-daily-log-sync status  # Check sync status

How it works:
  Daily logs are synced to: ~/Documents/obsidian/Second Brain/Daily Logs/
  Since this is in your Obsidian vault, it syncs automatically via Obsidian sync.
  
  When you switch computers:
  1. On old computer: gtd-daily-log-sync push (or sync)
  2. Wait for Obsidian to sync
  3. On new computer: gtd-daily-log-sync pull (or sync)

Configuration:
  Set DAILY_LOG_SYNC_METHOD in .daily_log_config (default: second-brain)

EOF
}

# Main command handler
case "${1:-}" in
  push)
    sync_to_second_brain
    ;;
  pull)
    sync_from_second_brain
    ;;
  sync)
    sync_both_ways
    ;;
  status)
    show_status
    ;;
  help|--help|-h)
    show_usage
    ;;
  "")
    # Default: two-way sync
    sync_both_ways
    ;;
  *)
    echo "âŒ Unknown command: $1"
    echo ""
    show_usage
    exit 1
    ;;
esac

