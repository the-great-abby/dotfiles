#!/bin/bash
# GTD Brain - AI-Suggested Zettelkasten Connections
# Suggests related notes when creating/editing notes

# Source common environment
COMMON_ENV="$HOME/code/dotfiles/zsh/common_env.sh"
if [[ ! -f "$COMMON_ENV" && -f "$HOME/code/personal/dotfiles/zsh/common_env.sh" ]]; then
  COMMON_ENV="$HOME/code/personal/dotfiles/zsh/common_env.sh"
fi
if [[ -f "$COMMON_ENV" ]]; then
  source "$COMMON_ENV"
fi

# Load GTD config
GTD_CONFIG_FILE="$HOME/.gtd_config"
if [[ -f "$HOME/code/dotfiles/zsh/.gtd_config" ]]; then
  GTD_CONFIG_FILE="$HOME/code/dotfiles/zsh/.gtd_config"
elif [[ -f "$HOME/code/personal/dotfiles/zsh/.gtd_config" ]]; then
  GTD_CONFIG_FILE="$HOME/code/personal/dotfiles/zsh/.gtd_config"
fi

if [[ -f "$GTD_CONFIG_FILE" ]]; then
  source "$GTD_CONFIG_FILE"
fi

# Default values
SECOND_BRAIN="${SECOND_BRAIN:-$HOME/Documents/obsidian/Second Brain}"
ZET_DIR="${ZET_DIR:-$SECOND_BRAIN/Zettelkasten}"
DAILY_LOG_DIR="${DAILY_LOG_DIR:-$HOME/Documents/daily_logs}"

# Colors
CYAN='\033[0;36m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
BOLD='\033[1m'
NC='\033[0m'

# Get AI suggestions for note connections
suggest_connections_for_note() {
  local note_path="$1"
  local max_suggestions="${2:-5}"
  
  if [[ ! -f "$note_path" ]]; then
    echo "âŒ Note not found: $note_path" >&2
    return 1
  fi
  
  # Extract note content
  local note_content=$(cat "$note_path")
  local note_title=$(head -1 "$note_path" | sed 's/^# //')
  
  # Get persona helper
  local persona_helper=""
  if [[ -f "$HOME/code/dotfiles/zsh/functions/gtd_persona_helper.py" ]]; then
    persona_helper="$HOME/code/dotfiles/zsh/functions/gtd_persona_helper.py"
  elif [[ -f "$HOME/code/personal/dotfiles/zsh/functions/gtd_persona_helper.py" ]]; then
    persona_helper="$HOME/code/personal/dotfiles/zsh/functions/gtd_persona_helper.py"
  fi
  
  if [[ -z "$persona_helper" ]]; then
    echo "âŒ Persona helper not found" >&2
    return 1
  fi
  
  # Find all existing notes (excluding current note)
  local all_notes=$(find "$SECOND_BRAIN" -type f \( -name "*.md" -o -name "*.txt" \) \
    ! -path "*/Templates/*" ! -path "*/.obsidian/*" ! -path "$note_path" 2>/dev/null)
  
  # Build note catalog for AI (limit to most recent 100 notes to avoid token limits)
  local note_catalog=""
  local note_count=0
  while IFS= read -r other_note && [[ $note_count -lt 100 ]]; do
    local other_title=$(head -1 "$other_note" 2>/dev/null | sed 's/^# //')
    local other_content=$(head -20 "$other_note" 2>/dev/null | head -5)
    if [[ -n "$other_title" ]]; then
      note_catalog+="Note: $other_title\nPath: $other_note\nPreview: ${other_content:0:100}...\n\n"
      ((note_count++))
    fi
  done <<< "$all_notes"
  
  # Build prompt for AI
  local prompt="I'm creating/editing a Zettelkasten note with this content:

Title: $note_title
Content:
$note_content

Here are existing notes in my knowledge base:

$note_catalog

Your task: Suggest up to $max_suggestions existing notes that would be valuable to link to this new note. For each suggestion:
1. Note title/path
2. Brief reason why they should be linked (what's the connection?)

Format your response as a simple list:
1. Note: [title] | Path: [path] | Reason: [why link]
2. Note: [title] | Path: [path] | Reason: [why link]
...

Focus on meaningful connections - similar concepts, related ideas, building on previous notes, or complementary perspectives."

  # Call AI
  local suggestions=$(python3 "$persona_helper" "david" "$prompt" "zettelkasten_suggestions" 2>/dev/null | grep -E "^[0-9]+\." | head -$max_suggestions)
  
  if [[ -z "$suggestions" ]]; then
    echo "No suggestions found"
    return 0
  fi
  
  echo "$suggestions"
}

# Detect orphaned notes (no connections)
find_orphaned_notes() {
  local max_notes="${1:-10}"
  
  echo "ðŸ” Finding orphaned notes (no connections)..."
  echo ""
  
  local orphaned=()
  
  find "$SECOND_BRAIN" -type f \( -name "*.md" -o -name "*.txt" \) \
    ! -path "*/Templates/*" ! -path "*/.obsidian/*" ! -path "*/MOCs/*" ! -path "*/Packets/*" \
    2>/dev/null | while read -r note; do
      
      # Check if note has outgoing links
      local has_outgoing=$(grep -qE '\[\[[^\]]+\]\]' "$note" 2>/dev/null && echo "yes" || echo "no")
      
      # Check if note has incoming links (backlinks)
      local note_name=$(basename "$note" .md | sed 's/[^a-zA-Z0-9]/\\&/g')
      local has_incoming=$(find "$SECOND_BRAIN" -type f \( -name "*.md" -o -name "*.txt" \) \
        ! -path "$note" ! -path "*/Templates/*" ! -path "*/.obsidian/*" \
        -exec grep -l "\[\[${note_name}\]\]" {} \; 2>/dev/null | wc -l | tr -d ' ')
      
      if [[ "$has_outgoing" == "no" && "$has_incoming" -eq 0 ]]; then
        local title=$(head -1 "$note" 2>/dev/null | sed 's/^# //')
        echo "$note|$title"
      fi
    done | head -$max_notes
}

# Suggest when journal entry should become permanent note
suggest_entries_for_permanent_notes() {
  local days_back="${1:-7}"
  local max_suggestions="${2:-5}"
  
  if [[ ! -d "$DAILY_LOG_DIR" ]]; then
    echo "âŒ Daily log directory not found" >&2
    return 1
  fi
  
  echo "ðŸ” Analyzing recent daily log entries for permanent note candidates..."
  echo ""
  
  # Get persona helper
  local persona_helper=""
  if [[ -f "$HOME/code/dotfiles/zsh/functions/gtd_persona_helper.py" ]]; then
    persona_helper="$HOME/code/dotfiles/zsh/functions/gtd_persona_helper.py"
  elif [[ -f "$HOME/code/personal/dotfiles/zsh/functions/gtd_persona_helper.py" ]]; then
    persona_helper="$HOME/code/personal/dotfiles/zsh/functions/gtd_persona_helper.py"
  fi
  
  if [[ -z "$persona_helper" ]]; then
    echo "âŒ Persona helper not found" >&2
    return 1
  fi
  
  # Collect recent log entries
  local log_entries=""
  local entry_count=0
  local today=$(date +"%Y-%m-%d")
  
  for i in $(seq 0 $((days_back - 1))); do
    local check_date=""
    if [[ "$(uname)" == "Darwin" ]]; then
      check_date=$(date -v-${i}d +"%Y-%m-%d" 2>/dev/null || echo "")
    else
      check_date=$(date -d "-${i} days" +"%Y-%m-%d" 2>/dev/null || echo "")
    fi
    
    if [[ -n "$check_date" ]]; then
      local log_file="${DAILY_LOG_DIR}/${check_date}.md"
      if [[ -f "$log_file" ]]; then
        local entries=$(grep -E "^[0-9]{2}:[0-9]{2} -" "$log_file" 2>/dev/null | head -10)
        if [[ -n "$entries" ]]; then
          log_entries+="Date: $check_date\n$entries\n\n"
          ((entry_count++))
        fi
      fi
    fi
  done
  
  if [[ -z "$log_entries" ]]; then
    echo "No log entries found in the last $days_back days"
    return 0
  fi
  
  # Build prompt for AI
  local prompt="I'm reviewing my daily logs from the last $days_back days to identify entries that should become permanent Zettelkasten notes.

Daily Log Entries:
$log_entries

Your task: Identify up to $max_suggestions log entries that contain:
- Insights or ideas worth preserving
- Concepts that could become atomic notes
- Patterns or observations that should be remembered
- Knowledge worth building upon

For each suggestion:
1. Date and entry text
2. Suggested note title
3. Reason why it should become a permanent note
4. Suggested initial content for the note

Format:
1. Entry: [date and time] [entry text] | Title: [suggested title] | Reason: [why] | Content: [initial note content]
2. Entry: ...

Focus on valuable insights, not routine daily activities."

  # Call AI
  local suggestions=$(python3 "$persona_helper" "david" "$prompt" "permanent_note_suggestions" 2>/dev/null)
  
  if [[ -z "$suggestions" ]]; then
    echo "No suggestions found"
    return 0
  fi
  
  echo "$suggestions"
}

# Generate weekly review suggestions
generate_weekly_link_suggestions() {
  local max_suggestions="${1:-10}"
  
  echo "ðŸ”— Generating 'Notes you might want to link' suggestions for weekly review..."
  echo ""
  
  # Get orphaned notes
  local orphaned=$(find_orphaned_notes "$max_suggestions")
  
  if [[ -z "$orphaned" ]]; then
    echo "âœ“ No orphaned notes found - your knowledge graph is well-connected!"
    return 0
  fi
  
  echo "ðŸ“ Orphaned Notes (no connections):"
  echo ""
  
  local count=0
  while IFS='|' read -r note_path note_title; do
    if [[ -n "$note_path" && -n "$note_title" ]]; then
      ((count++))
      echo "$count. $note_title"
      echo "   Path: $note_path"
      
      # Get connection suggestions for this orphaned note
      local suggestions=$(suggest_connections_for_note "$note_path" 3 2>/dev/null)
      if [[ -n "$suggestions" ]]; then
        echo "   Suggested links:"
        echo "$suggestions" | sed 's/^/      /'
      fi
      echo ""
      
      if [[ $count -ge $max_suggestions ]]; then
        break
      fi
    fi
  done <<< "$orphaned"
  
  if [[ $count -eq 0 ]]; then
    echo "No orphaned notes to suggest links for"
  fi
}

# Main function
main() {
  case "${1:-help}" in
    suggest)
      if [[ -z "$2" ]]; then
        echo "Usage: gtd-brain-suggest-connections suggest <note-path> [max-suggestions]"
        exit 1
      fi
      suggest_connections_for_note "$2" "${3:-5}"
      ;;
    orphaned)
      find_orphaned_notes "${2:-10}"
      ;;
    permanent-notes)
      suggest_entries_for_permanent_notes "${2:-7}" "${3:-5}"
      ;;
    weekly)
      generate_weekly_link_suggestions "${2:-10}"
      ;;
    help|*)
      echo "Usage: gtd-brain-suggest-connections <command> [args]"
      echo ""
      echo "Commands:"
      echo "  suggest <note-path> [max]     - Suggest connections for a specific note"
      echo "  orphaned [max]                - Find orphaned notes (no connections)"
      echo "  permanent-notes [days] [max]  - Suggest log entries that should become notes"
      echo "  weekly [max]                  - Generate weekly review link suggestions"
      echo ""
      echo "Examples:"
      echo "  gtd-brain-suggest-connections suggest ~/Documents/Second\ Brain/Zettelkasten/my-note.md"
      echo "  gtd-brain-suggest-connections orphaned 10"
      echo "  gtd-brain-suggest-connections permanent-notes 7"
      echo "  gtd-brain-suggest-connections weekly"
      ;;
  esac
}

main "$@"
