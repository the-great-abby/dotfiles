#!/bin/bash
# GTD Success Metrics - Track system usage and effectiveness
# Metrics:
# 1. Daily active usage (consistency)
# 2. Task suggestion acceptance rate (AI helpfulness)
# 3. Search usage (finding old info)
# 4. Review completion rate (doing reviews)
# 5. Notes created vs orphaned (Zettelkasten health)
# 6. Time to capture (friction)

# Source common environment
COMMON_ENV="$HOME/code/dotfiles/zsh/common_env.sh"
if [[ ! -f "$COMMON_ENV" && -f "$HOME/code/personal/dotfiles/zsh/common_env.sh" ]]; then
  COMMON_ENV="$HOME/code/personal/dotfiles/zsh/common_env.sh"
fi
if [[ -f "$COMMON_ENV" ]]; then
  source "$COMMON_ENV"
fi

# Load GTD config
GTD_CONFIG_FILE="$HOME/.gtd_config"
if [[ -f "$HOME/code/dotfiles/zsh/.gtd_config" ]]; then
  GTD_CONFIG_FILE="$HOME/code/dotfiles/zsh/.gtd_config"
elif [[ -f "$HOME/code/personal/dotfiles/zsh/.gtd_config" ]]; then
  GTD_CONFIG_FILE="$HOME/code/personal/dotfiles/zsh/.gtd_config"
fi

if [[ -f "$GTD_CONFIG_FILE" ]]; then
  source "$GTD_CONFIG_FILE"
fi

# Default values
GTD_BASE_DIR="${GTD_BASE_DIR:-$HOME/Documents/gtd}"
SECOND_BRAIN="${SECOND_BRAIN:-$HOME/Documents/obsidian/Second Brain}"
METRICS_FILE="$HOME/.gtd_success_metrics.json"
DAILY_LOG_DIR="${DAILY_LOG_DIR:-$HOME/Documents/daily_logs}"

# Colors
CYAN='\033[0;36m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
BOLD='\033[1m'
NC='\033[0m'

# Get date command
get_date_cmd() {
  if [[ -x "/usr/bin/date" ]]; then
    echo "/usr/bin/date"
  elif [[ -x "/bin/date" ]]; then
    echo "/bin/date"
  else
    echo "date"
  fi
}

DATE_CMD=$(get_date_cmd)

# Initialize metrics file
init_metrics() {
  if [[ ! -f "$METRICS_FILE" ]]; then
    cat > "$METRICS_FILE" <<EOF
{
  "created": "$($DATE_CMD -Iseconds)",
  "last_updated": "$($DATE_CMD -Iseconds)",
  "daily_usage": {},
  "suggestion_stats": {
    "total": 0,
    "accepted": 0,
    "dismissed": 0,
    "pending": 0
  },
  "search_usage": {
    "total": 0,
    "by_date": {},
    "by_type": {
      "gtd-search": 0,
      "gtd-find": 0
    }
  },
  "review_stats": {
    "daily": {"completed": 0, "total_opportunities": 0},
    "weekly": {"completed": 0, "total_opportunities": 0},
    "monthly": {"completed": 0, "total_opportunities": 0}
  },
  "note_stats": {
    "total_created": 0,
    "total_orphaned": 0,
    "linked_notes": 0,
    "by_date": {}
  },
  "capture_times": []
}
EOF
    chmod 644 "$METRICS_FILE" 2>/dev/null || true
  fi
}

# Track daily usage
track_daily_usage() {
  local command="$1"
  local today=$($DATE_CMD +"%Y-%m-%d")
  
  init_metrics
  
  python3 <<EOF
import json
import sys
from datetime import datetime

try:
    with open("$METRICS_FILE", "r") as f:
        data = json.load(f)
    
    if "daily_usage" not in data:
        data["daily_usage"] = {}
    
    today = "$today"
    if today not in data["daily_usage"]:
        data["daily_usage"][today] = {
            "commands": [],
            "command_count": {}
        }
    
    # Track this command
    if "$command" not in data["daily_usage"][today]["command_count"]:
        data["daily_usage"][today]["command_count"]["$command"] = 0
    data["daily_usage"][today]["command_count"]["$command"] += 1
    data["daily_usage"][today]["commands"].append({
        "command": "$command",
        "timestamp": datetime.now().isoformat()
    })
    
    data["last_updated"] = datetime.now().isoformat()
    
    with open("$METRICS_FILE", "w") as f:
        json.dump(data, f, indent=2)
except Exception as e:
    pass  # Silently fail if tracking fails
EOF
}

# Track search usage
track_search() {
  local search_type="$1"  # "gtd-search" or "gtd-find"
  local query="$2"
  local today=$($DATE_CMD +"%Y-%m-%d")
  
  init_metrics
  
  python3 <<EOF
import json
from datetime import datetime

try:
    with open("$METRICS_FILE", "r") as f:
        data = json.load(f)
    
    if "search_usage" not in data:
        data["search_usage"] = {
            "total": 0,
            "by_date": {},
            "by_type": {"gtd-search": 0, "gtd-find": 0}
        }
    
    data["search_usage"]["total"] += 1
    data["search_usage"]["by_type"]["$search_type"] = data["search_usage"]["by_type"].get("$search_type", 0) + 1
    
    today = "$today"
    if today not in data["search_usage"]["by_date"]:
        data["search_usage"]["by_date"][today] = 0
    data["search_usage"]["by_date"][today] += 1
    
    data["last_updated"] = datetime.now().isoformat()
    
    with open("$METRICS_FILE", "w") as f:
        json.dump(data, f, indent=2)
except Exception:
    pass
EOF
}

# Track capture time
track_capture_time() {
  local seconds="$1"
  
  init_metrics
  
  python3 <<EOF
import json
from datetime import datetime

try:
    with open("$METRICS_FILE", "r") as f:
        data = json.load(f)
    
    if "capture_times" not in data:
        data["capture_times"] = []
    
    data["capture_times"].append({
        "seconds": int("$seconds"),
        "timestamp": datetime.now().isoformat()
    })
    
    # Keep only last 100 capture times
    if len(data["capture_times"]) > 100:
        data["capture_times"] = data["capture_times"][-100:]
    
    data["last_updated"] = datetime.now().isoformat()
    
    with open("$METRICS_FILE", "w") as f:
        json.dump(data, f, indent=2)
except Exception:
    pass
EOF
}

# Calculate metrics
calculate_metrics() {
  init_metrics
  
  python3 <<EOF
import json
from datetime import datetime, timedelta
import os
from pathlib import Path

# Load metrics
with open("$METRICS_FILE", "r") as f:
    data = json.load(f)

# 1. Daily Active Usage (last 30 days)
today = datetime.now().date()
usage_days = 0
total_commands = 0
for i in range(30):
    check_date = today - timedelta(days=i)
    date_str = str(check_date)
    if date_str in data.get("daily_usage", {}):
        usage_days += 1
        total_commands += len(data["daily_usage"][date_str].get("commands", []))
daily_usage_rate = (usage_days / 30.0) * 100 if usage_days > 0 else 0

# 2. Task Suggestion Acceptance Rate
suggestions_dir = Path("$GTD_BASE_DIR") / "suggestions"
accepted = 0
dismissed = 0
pending = 0
total = 0

if suggestions_dir.exists():
    for suggestion_file in suggestions_dir.glob("*.json"):
        try:
            with open(suggestion_file) as f:
                suggestion = json.load(f)
                status = suggestion.get("status", "pending")
                total += 1
                if status == "accepted":
                    accepted += 1
                elif status == "dismissed":
                    dismissed += 1
                else:
                    pending += 1
        except:
            pass

acceptance_rate = (accepted / total * 100) if total > 0 else 0

# Update suggestion stats
data["suggestion_stats"] = {
    "total": total,
    "accepted": accepted,
    "dismissed": dismissed,
    "pending": pending
}

# 3. Search Usage (last 7 days)
search_count = 0
search_by_type = {"gtd-search": 0, "gtd-find": 0}
for i in range(7):
    check_date = str(today - timedelta(days=i))
    if check_date in data.get("search_usage", {}).get("by_date", {}):
        search_count += data["search_usage"]["by_date"][check_date]
search_by_type = data.get("search_usage", {}).get("by_type", {"gtd-search": 0, "gtd-find": 0})

# 4. Review Completion Rate
# Check daily log for review entries
review_stats = data.get("review_stats", {
    "daily": {"completed": 0, "total_opportunities": 0},
    "weekly": {"completed": 0, "total_opportunities": 0},
    "monthly": {"completed": 0, "total_opportunities": 0}
})

# Count reviews from daily logs (last 30 days)
daily_log_dir = Path("$DAILY_LOG_DIR")
if daily_log_dir.exists():
    for i in range(30):
        check_date = today - timedelta(days=i)
        log_file = daily_log_dir / f"{check_date}.md"
        if log_file.exists():
            try:
                content = log_file.read_text()
                # Count review mentions
                if "daily review" in content.lower() or "gtd-review daily" in content.lower():
                    review_stats["daily"]["completed"] += 1
                if "weekly review" in content.lower() or "gtd-review weekly" in content.lower():
                    review_stats["weekly"]["completed"] += 1
                if "monthly review" in content.lower() or "gtd-review monthly" in content.lower():
                    review_stats["monthly"]["completed"] += 1
            except:
                pass

# Review opportunities: daily = 30, weekly = 4, monthly = 1
review_stats["daily"]["total_opportunities"] = 30
review_stats["weekly"]["total_opportunities"] = 4
review_stats["monthly"]["total_opportunities"] = 1

daily_review_rate = (review_stats["daily"]["completed"] / 30.0 * 100) if review_stats["daily"]["completed"] > 0 else 0
weekly_review_rate = (review_stats["weekly"]["completed"] / 4.0 * 100) if review_stats["weekly"]["completed"] > 0 else 0

# 5. Notes Created vs Orphaned
second_brain = Path("$SECOND_BRAIN")
total_notes = 0
orphaned = 0
linked = 0

if second_brain.exists():
    # Count all markdown files
    for note_file in second_brain.rglob("*.md"):
        # Skip templates, MOCs, etc.
        if any(skip in str(note_file) for skip in ["Templates", "MOCs", "Packets", ".obsidian"]):
            continue
        total_notes += 1
        
        try:
            content = note_file.read_text()
            # Check for links
            if "[[" in content:
                linked += 1
            else:
                orphaned += 1
        except:
            pass

note_health = ((linked / total_notes * 100) if total_notes > 0 else 0)

# Update note stats
data["note_stats"] = {
    "total_created": total_notes,
    "total_orphaned": orphaned,
    "linked_notes": linked,
    "by_date": data.get("note_stats", {}).get("by_date", {})
}

# 6. Time to Capture (average from last 10 captures)
capture_times = data.get("capture_times", [])
avg_capture_time = 0
if capture_times:
    recent_times = capture_times[-10:]
    avg_capture_time = sum(t["seconds"] for t in recent_times) / len(recent_times)

# Save updated data
data["last_updated"] = datetime.now().isoformat()
with open("$METRICS_FILE", "w") as f:
    json.dump(data, f, indent=2)

# Output results
results = {
    "daily_usage": {
        "days_active": usage_days,
        "rate": daily_usage_rate,
        "total_commands": total_commands
    },
    "suggestion_acceptance": {
        "rate": acceptance_rate,
        "accepted": accepted,
        "total": total
    },
    "search_usage": {
        "last_7_days": search_count,
        "by_type": search_by_type
    },
    "review_completion": {
        "daily_rate": daily_review_rate,
        "weekly_rate": weekly_review_rate,
        "stats": review_stats
    },
    "note_health": {
        "linked_percentage": note_health,
        "total": total_notes,
        "orphaned": orphaned,
        "linked": linked
    },
    "capture_time": {
        "avg_seconds": avg_capture_time,
        "avg_formatted": f"{int(avg_capture_time // 60)}m {int(avg_capture_time % 60)}s" if avg_capture_time > 0 else "N/A"
    }
}

print(json.dumps(results, indent=2))
EOF
}

# Display metrics
display_metrics() {
  local metrics_json=$(calculate_metrics)
  
  echo ""
  echo -e "${BOLD}${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
  echo -e "${BOLD}${CYAN}ğŸ“Š GTD Success Metrics${NC}"
  echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
  echo ""
  
  # Parse JSON and display
  python3 <<EOF
import json
import sys

try:
    metrics = json.loads('''$metrics_json''')
    
    # 1. Daily Active Usage
    daily = metrics["daily_usage"]
    rate = daily["rate"]
    if rate >= 80:
        emoji = "ğŸŸ¢"
        color = "32"  # Green
    elif rate >= 50:
        emoji = "ğŸŸ¡"
        color = "33"  # Yellow
    else:
        emoji = "ğŸ”´"
        color = "31"  # Red
    
    print(f"\033[1;{color}m{emoji} 1. Daily Active Usage\033[0m")
    print(f"   Active {daily['days_active']}/30 days ({rate:.1f}%)")
    print(f"   Total commands: {daily['total_commands']}")
    print()
    
    # 2. Task Suggestion Acceptance Rate
    suggestion = metrics["suggestion_acceptance"]
    rate = suggestion["rate"]
    if rate >= 50:
        emoji = "ğŸŸ¢"
        color = "32"
    elif rate >= 25:
        emoji = "ğŸŸ¡"
        color = "33"
    else:
        emoji = "ğŸ”´"
        color = "31"
    
    print(f"\033[1;{color}m{emoji} 2. Task Suggestion Acceptance Rate\033[0m")
    if suggestion["total"] > 0:
        print(f"   {suggestion['accepted']}/{suggestion['total']} accepted ({rate:.1f}%)")
        # Load data to get pending count
        import json
        from pathlib import Path
        metrics_file = Path.home() / ".gtd_success_metrics.json"
        pending = 0
        if metrics_file.exists():
            try:
                with open(metrics_file) as f:
                    data = json.load(f)
                    pending = data.get("suggestion_stats", {}).get("pending", 0)
            except:
                pass
        print(f"   Pending: {pending}")
    else:
        print("   No suggestions yet")
    print()
    
    # 3. Search Usage
    search = metrics["search_usage"]
    print(f"\033[1;36mğŸ” 3. Search Usage (Last 7 Days)\033[0m")
    print(f"   Total searches: {search['last_7_days']}")
    print(f"   gtd-search: {search['by_type'].get('gtd-search', 0)}")
    print(f"   gtd-find: {search['by_type'].get('gtd-find', 0)}")
    print()
    
    # 4. Review Completion Rate
    review = metrics["review_completion"]
    daily_rate = review["daily_rate"]
    weekly_rate = review["weekly_rate"]
    
    if daily_rate >= 70:
        daily_emoji = "ğŸŸ¢"
        daily_color = "32"
    elif daily_rate >= 30:
        daily_emoji = "ğŸŸ¡"
        daily_color = "33"
    else:
        daily_emoji = "ğŸ”´"
        daily_color = "31"
    
    if weekly_rate >= 75:
        weekly_emoji = "ğŸŸ¢"
        weekly_color = "32"
    elif weekly_rate >= 50:
        weekly_emoji = "ğŸŸ¡"
        weekly_color = "33"
    else:
        weekly_emoji = "ğŸ”´"
        weekly_color = "31"
    
    print(f"\033[1;{daily_color}m{daily_emoji} 4. Review Completion Rate\033[0m")
    stats = review["stats"]
    print(f"   Daily: {stats['daily']['completed']}/30 ({daily_rate:.1f}%)")
    print(f"   Weekly: {stats['weekly']['completed']}/4 ({weekly_rate:.1f}%)")
    print(f"   Monthly: {stats['monthly']['completed']}/1")
    print()
    
    # 5. Notes Created vs Orphaned
    notes = metrics["note_health"]
    health = notes["linked_percentage"]
    if health >= 70:
        emoji = "ğŸŸ¢"
        color = "32"
    elif health >= 50:
        emoji = "ğŸŸ¡"
        color = "33"
    else:
        emoji = "ğŸ”´"
        color = "31"
    
    print(f"\033[1;{color}m{emoji} 5. Zettelkasten Health\033[0m")
    print(f"   Linked notes: {health:.1f}%")
    print(f"   Total notes: {notes['total']}")
    print(f"   Linked: {notes['linked']}, Orphaned: {notes['orphaned']}")
    print()
    
    # 6. Time to Capture
    capture = metrics["capture_time"]
    time_str = capture["avg_formatted"]
    if capture["avg_seconds"] > 0:
        if capture["avg_seconds"] < 60:
            emoji = "ğŸŸ¢"
            color = "32"
        elif capture["avg_seconds"] < 180:
            emoji = "ğŸŸ¡"
            color = "33"
        else:
            emoji = "ğŸ”´"
            color = "31"
        
        print(f"\033[1;{color}m{emoji} 6. Time to Capture (Friction)\033[0m")
        print(f"   Average: {time_str}")
        print(f"   (Lower is better - shows system is easy to use)")
    else:
        print(f"\033[1;33mâ±ï¸  6. Time to Capture\033[0m")
        print("   No capture data yet")
    
    print()
    
except Exception as e:
    print(f"Error displaying metrics: {e}", file=sys.stderr)
    sys.exit(1)
EOF
  
  echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
  echo ""
}

# Main function
main() {
  case "${1:-display}" in
    track)
      track_daily_usage "${2:-unknown}"
      ;;
    track-search)
      track_search "${2:-gtd-search}" "${3:-}"
      ;;
    track-capture)
      track_capture_time "${2:-0}"
      ;;
    calculate)
      calculate_metrics
      ;;
    display|stats|*)
      display_metrics
      ;;
  esac
}

main "$@"
