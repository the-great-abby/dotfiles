#!/bin/bash
# GTD Project Command - Project management

# Source common GTD helpers
GTD_COMMON="$HOME/code/dotfiles/bin/gtd-common.sh"
if [[ ! -f "$GTD_COMMON" && -f "$HOME/code/personal/dotfiles/bin/gtd-common.sh" ]]; then
  GTD_COMMON="$HOME/code/personal/dotfiles/bin/gtd-common.sh"
fi
if [[ -f "$GTD_COMMON" ]]; then
  source "$GTD_COMMON"
else
  echo "Warning: gtd-common.sh not found. Some features may not work." >&2
fi

# Additional paths
ARCHIVE_PATH="${GTD_BASE_DIR}/${GTD_ARCHIVE_DIR:-6-archive}"
TASKS_PATH="${GTD_BASE_DIR}/tasks"
GOALS_DIR="${GTD_BASE_DIR}/goals"

mkdir -p "$PROJECTS_PATH" "$ARCHIVE_PATH" "$TASKS_PATH" "$GOALS_DIR"

TODAY=$(gtd_get_today)
NOW=$(gtd_get_current_time)

# Use common frontmatter helper (aliased for backward compatibility)
alias get_frontmatter_value='gtd_get_frontmatter_value'

# Define wrapper function (aliases don't always work in subshells)
get_frontmatter_value() {
  gtd_get_frontmatter_value "$@"
}

# Update frontmatter value
update_frontmatter_value() {
  local file="$1"
  local key="$2"
  local value="$3"
  
  if grep -q "^${key}:" "$file" 2>/dev/null; then
    if [[ "$OSTYPE" == "darwin"* ]]; then
      sed -i '' "s/^${key}:.*/${key}: ${value}/" "$file"
    else
      sed -i "s/^${key}:.*/${key}: ${value}/" "$file"
    fi
  else
    if [[ "$OSTYPE" == "darwin"* ]]; then
      sed -i '' "/^---$/a\\
${key}: ${value}
" "$file"
    else
      sed -i "/^---$/a\\${key}: ${value}" "$file"
    fi
  fi
}

# Validate and normalize repository URL
normalize_repo_url() {
  local url="$1"
  if [[ -z "$url" ]]; then
    echo ""
    return 0
  fi
  
  # Remove trailing slash
  url="${url%/}"
  
  # If it's already a full URL, return as-is
  if [[ "$url" =~ ^https?:// ]]; then
    echo "$url"
    return 0
  fi
  
  # If it's a shorthand like "user/repo", convert to GitHub
  if [[ "$url" =~ ^[a-zA-Z0-9_-]+/[a-zA-Z0-9_.-]+$ ]]; then
    echo "https://github.com/$url"
    return 0
  fi
  
  # Return as-is (might be invalid, but user can fix later)
  echo "$url"
}

# Create project
create_project() {
  local project_name=""
  local repository=""
  local outcome=""
  local goal=""
  
  # Parse arguments
  while [[ $# -gt 0 ]]; do
    case "$1" in
      --repository|--repo)
        repository="$2"
        shift 2
        ;;
      --outcome)
        outcome="$2"
        shift 2
        ;;
      --goal)
        goal="$2"
        shift 2
        ;;
      *)
        if [[ -z "$project_name" ]]; then
          project_name="$1"
        fi
        shift
        ;;
    esac
  done
  
  if [[ -z "$project_name" ]]; then
    read -p "Project name: " project_name
  fi
  
  # Require outcome definition
  if [[ -z "$outcome" ]]; then
    echo ""
    echo "ğŸ“‹ Every project needs a clear outcome. What does 'done' look like?"
    echo "   (Example: 'A fully redesigned website launched with new branding')"
    read -p "Project outcome: " outcome
    
    if [[ -z "$outcome" ]]; then
      echo "âš ï¸  Warning: Creating project without a defined outcome."
      echo "   Consider defining one later: gtd-project update-outcome '$project_name' '<outcome>'"
      read -p "Continue anyway? (y/N): " continue_anyway
      if [[ ! "$continue_anyway" =~ ^[Yy]$ ]]; then
        echo "Cancelled."
        exit 1
      fi
    fi
  fi
  
  # Optionally link to goal
  if [[ -z "$goal" ]]; then
    # Check if there are active goals
    if [[ -d "$GOALS_DIR" ]] && [[ -n "$(find "$GOALS_DIR" -name "*.md" 2>/dev/null)" ]]; then
      echo ""
      echo "ğŸ¯ Link this project to a goal? (optional)"
      read -p "Goal name (or press Enter to skip): " goal
    fi
  fi
  
  project_name=$(echo "$project_name" | tr ' ' '-' | tr '[:upper:]' '[:lower:]')
  local project_dir="${PROJECTS_PATH}/${project_name}"
  
  if [[ -d "$project_dir" ]]; then
    echo "âš ï¸  Project already exists: $project_name"
    exit 1
  fi
  
  mkdir -p "$project_dir"
  
  # Normalize repository URL if provided
  if [[ -n "$repository" ]]; then
    repository=$(normalize_repo_url "$repository")
  fi
  
  # Create README with conditional fields
  {
    echo "---"
    echo "type: project"
    echo "status: active"
    echo "created: ${TODAY}T${NOW}"
    echo "project: ${project_name}"
    if [[ -n "$outcome" ]]; then
      echo "outcome: ${outcome}"
    fi
    if [[ -n "$goal" ]]; then
      echo "goal: ${goal}"
    fi
    if [[ -n "$repository" ]]; then
      echo "repository: ${repository}"
    fi
    echo "tags: []"
    echo "---"
    echo ""
    echo "# ${project_name}"
    echo ""
    if [[ -n "$outcome" ]]; then
      echo "## Outcome"
      echo ""
      echo "$outcome"
      echo ""
    fi
    echo "## Description"
    echo ""
    echo ""
    echo "## Goals"
    echo ""
    echo ""
    echo "## Next Actions"
    echo ""
    echo ""
    echo "## Tasks"
    echo ""
  } > "${project_dir}/README.md"
  
  echo "âœ“ Created project: $project_name"
  echo "  Location: $project_dir"
  if [[ -n "$outcome" ]]; then
    echo "  Outcome: $outcome"
  fi
  if [[ -n "$goal" ]]; then
    echo "  Linked to goal: $goal"
  fi
  
  # Ask for repository link if not provided via wizard
  if [[ -z "$repository" ]]; then
    echo ""
    echo -n "Repository URL (GitHub/GitLab, or press Enter to skip): "
    read repo_input
    if [[ -n "$repo_input" ]]; then
      repository=$(normalize_repo_url "$repo_input")
      update_frontmatter_value "${project_dir}/README.md" "repository" "$repository"
      echo "âœ“ Added repository: $repository"
    fi
  fi
}

# List projects
list_projects() {
  local status_filter="${1:-active}"
  
  echo ""
  echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
  echo "ğŸ“ Projects (status: $status_filter)"
  echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
  echo ""
  
  local count=0
  local projects=($(find "$PROJECTS_PATH" -type d -mindepth 1 -maxdepth 1 2>/dev/null))
  
  for project_dir in "${projects[@]}"; do
    local project_name=$(basename "$project_dir")
    local readme="${project_dir}/README.md"
    
    if [[ ! -f "$readme" ]]; then
      continue
    fi
    
    local status=$(get_frontmatter_value "$readme" "status")
    
    # Default to "active" if no status field exists (for projects without frontmatter)
    if [[ -z "$status" ]]; then
      status="active"
    fi
    
    if [[ "$status" != "$status_filter" && "$status_filter" != "all" ]]; then
      continue
    fi
    
    ((count++))
    local created=$(get_frontmatter_value "$readme" "created")
    local task_count=$(find "$project_dir" -name "*.md" ! -name "README.md" 2>/dev/null | wc -l | tr -d ' ')
    
    local repository=$(get_frontmatter_value "$readme" "repository")
    local outcome=$(get_frontmatter_value "$readme" "outcome")
    local goal=$(get_frontmatter_value "$readme" "goal")
    
    echo "[$count] $project_name"
    echo "     Status: $status | Created: $created | Tasks: $task_count"
    if [[ -n "$outcome" ]]; then
      echo "     Outcome: $outcome"
    fi
    if [[ -n "$goal" ]]; then
      echo "     Goal: $goal"
    fi
    if [[ -n "$repository" ]]; then
      echo "     Repository: $repository"
    fi
    echo "     Path: $project_dir"
    echo ""
  done
  
  if [[ $count -eq 0 ]]; then
    echo "No projects found."
  else
    echo "Total: $count project(s)"
  fi
}

# View project
view_project() {
  local project_name="$1"
  if [[ -z "$project_name" ]]; then
    echo "Usage: gtd-project view <project-name>"
    exit 1
  fi
  
  project_name=$(echo "$project_name" | tr ' ' '-' | tr '[:upper:]' '[:lower:]')
  local project_dir="${PROJECTS_PATH}/${project_name}"
  local readme="${project_dir}/README.md"
  
  if [[ ! -d "$project_dir" || ! -f "$readme" ]]; then
    echo "âŒ Project not found: $project_name"
    exit 1
  fi
  
  echo ""
  echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
  echo "ğŸ“ Project: $project_name"
  echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
  echo ""
  
  # Show outcome and goal if available
  local outcome=$(get_frontmatter_value "$readme" "outcome")
  local goal=$(get_frontmatter_value "$readme" "goal")
  local repository=$(get_frontmatter_value "$readme" "repository")
  
  if [[ -n "$outcome" ]]; then
    echo "ğŸ¯ Outcome: $outcome"
    echo ""
  fi
  if [[ -n "$goal" ]]; then
    echo "ğŸ† Linked to Goal: $goal"
    echo ""
  fi
  if [[ -n "$repository" ]]; then
    echo "ğŸ”— Repository: $repository"
    echo ""
  fi
  
  # Show README
  cat "$readme"
  echo ""
  
  # Show tasks
  local tasks=($(find "$project_dir" -name "*.md" ! -name "README.md" 2>/dev/null))
  if [[ ${#tasks[@]} -gt 0 ]]; then
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo "ğŸ“‹ Tasks in this project:"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo ""
    for task in "${tasks[@]}"; do
      local task_name=$(basename "$task" .md)
      local status=$(get_frontmatter_value "$task" "status")
      local next_action=$(get_frontmatter_value "$task" "next_action")
      
      echo "  â€¢ $task_name"
      echo "    Status: $status"
      if [[ -n "$next_action" ]]; then
        echo "    Next action: $next_action"
      fi
      echo ""
    done
  fi
}

# Add task to project
add_task_to_project() {
  local project_name="$1"
  shift
  local task_desc="$*"
  
  if [[ -z "$project_name" || -z "$task_desc" ]]; then
    echo "Usage: gtd-project add-task <project-name> <task-description>"
    exit 1
  fi
  
  project_name=$(echo "$project_name" | tr ' ' '-' | tr '[:upper:]' '[:lower:]')
  local project_dir="${PROJECTS_PATH}/${project_name}"
  local readme="${project_dir}/README.md"
  
  if [[ ! -d "$project_dir" || ! -f "$readme" ]]; then
    echo "âŒ Project not found: $project_name"
    exit 1
  fi
  
  local timestamp=$(date +"%Y%m%d%H%M%S")
  local filename="${timestamp}-task.md"
  local filepath="${project_dir}/${filename}"
  
  # Get task info
  read -p "Context (home/office/computer/phone/errands): " context
  read -p "Energy level (low/medium/high/creative/administrative): " energy
  
  # Create task
  cat > "$filepath" <<EOF
---
type: task
status: active
created: ${TODAY}T${NOW}
project: ${project_name}
context: ${context:-computer}
energy: ${energy:-medium}
tags: []
---

# ${task_desc}

## Next Action
${task_desc}

## Notes


EOF
  
  echo "âœ“ Added task to project: $project_name"
  echo "  Task: $task_desc"
  echo "  File: $filepath"
}

# Add note to project (creates note file in notes/ subdirectory)
add_note_to_project() {
  local project_name="$1"
  shift
  local note_title="$*"
  
  if [[ -z "$project_name" ]]; then
    echo "âŒ Project name required"
    echo "Usage: gtd-project add-note <project-name> [note-title]"
    echo ""
    echo "Examples:"
    echo "  gtd-project add-note website-redesign \"Design Notes\""
    echo "  gtd-project add-note website-redesign  # Interactive mode - prompts for title"
    exit 1
  fi
  
  project_name=$(echo "$project_name" | tr ' ' '-' | tr '[:upper:]' '[:lower:]')
  local project_dir="${PROJECTS_PATH}/${project_name}"
  local readme="${project_dir}/README.md"
  
  if [[ ! -d "$project_dir" || ! -f "$readme" ]]; then
    echo "âŒ Project not found: $project_name"
    exit 1
  fi
  
  # Create notes directory for this project
  local notes_dir="${project_dir}/notes"
  mkdir -p "$notes_dir"
  
  # Get note title
  if [[ -z "$note_title" ]]; then
    echo -n "Note title: "
    read note_title
    if [[ -z "$note_title" ]]; then
      echo "âŒ Note title required"
      exit 1
    fi
  fi
  
  # Create sanitized filename
  local timestamp=$(date +"%Y%m%d%H%M%S")
  local sanitized_title=$(echo "$note_title" | tr '[:upper:]' '[:lower:]' | sed 's/[^a-z0-9]/-/g' | sed 's/--*/-/g' | sed 's/^-\|-$//g')
  local note_filename="${timestamp}-${sanitized_title}.md"
  local note_file="${notes_dir}/${note_filename}"
  
  # Check if note already exists
  if [[ -f "$note_file" ]]; then
    echo "âš ï¸  Note already exists: $note_file"
    read -p "Create anyway with new timestamp? (y/N): " create_anyway
    if [[ ! "$create_anyway" =~ ^[Yy]$ ]]; then
      echo "Cancelled."
      exit 0
    fi
    timestamp=$(date +"%Y%m%d%H%M%S")
    note_filename="${timestamp}-${sanitized_title}.md"
    note_file="${notes_dir}/${note_filename}"
  fi
  
  # Get project description for the note
  local project_desc=$(grep "^# " "$readme" 2>/dev/null | head -1 | sed 's/^# //' || echo "")
  if [[ -z "$project_desc" ]]; then
    project_desc="$project_name"
  fi
  
  # Create the note file
  local created_time=$(date +"%Y-%m-%d %H:%M")
  cat > "$note_file" <<EOF
---
type: note
project: ${project_name}
created: ${TODAY}T${NOW}
tags: []
---

# ${note_title}

Created: ${created_time}
Project: ${project_desc}

## Content



## Links
- Related to: 

## Tags
#project-note #${project_name}

EOF
  
  # Add link to note in the project's Notes section (or create it)
  local temp_file=$(mktemp)
  local notes_section_found=false
  local relative_note_path="notes/${note_filename}"
  local note_link="[[${note_title}]] (${relative_note_path})"
  
  while IFS= read -r line || [[ -n "$line" ]]; do
    # Check if we're at the Notes section header
    if [[ "$line" == "## Notes" ]]; then
      notes_section_found=true
      echo "$line" >> "$temp_file"
      echo "" >> "$temp_file"
      echo "- ${note_link}" >> "$temp_file"
      continue
    fi
    
    echo "$line" >> "$temp_file"
  done < "$readme"
  
  # If Notes section wasn't found, add it at the end
  if [[ "$notes_section_found" == "false" ]]; then
    echo "" >> "$temp_file"
    echo "## Notes" >> "$temp_file"
    echo "" >> "$temp_file"
    echo "- ${note_link}" >> "$temp_file"
    echo "" >> "$temp_file"
  fi
  
  mv "$temp_file" "$readme"
  
  echo "âœ“ Created note for project: $project_name"
  echo "  Title: $note_title"
  echo "  File: $note_file"
  echo "  Linked in project README"
  
  # Optionally open the note in editor
  if command -v ${EDITOR:-vim} &>/dev/null; then
    read -p "Open note in editor? (y/N): " open_editor
    if [[ "$open_editor" =~ ^[Yy]$ ]]; then
      ${EDITOR:-vim} "$note_file"
    fi
  fi
}

# Show project status
project_status() {
  local project_name="$1"
  if [[ -z "$project_name" ]]; then
    echo "Usage: gtd-project status <project-name>"
    exit 1
  fi
  
  project_name=$(echo "$project_name" | tr ' ' '-' | tr '[:upper:]' '[:lower:]')
  local project_dir="${PROJECTS_PATH}/${project_name}"
  local readme="${project_dir}/README.md"
  
  if [[ ! -d "$project_dir" || ! -f "$readme" ]]; then
    echo "âŒ Project not found: $project_name"
    exit 1
  fi
  
  local status=$(get_frontmatter_value "$readme" "status")
  local tasks=($(find "$project_dir" -name "*.md" ! -name "README.md" 2>/dev/null))
  local active_tasks=0
  local done_tasks=0
  
  for task in "${tasks[@]}"; do
    local task_status=$(get_frontmatter_value "$task" "status")
    if [[ "$task_status" == "active" ]]; then
      ((active_tasks++))
    elif [[ "$task_status" == "done" ]]; then
      ((done_tasks++))
    fi
  done
  
  echo ""
  echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
  echo "ğŸ“Š Project Status: $project_name"
  echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
  echo ""
  echo "Status: $status"
  echo "Total tasks: ${#tasks[@]}"
  echo "Active tasks: $active_tasks"
  echo "Completed tasks: $done_tasks"
  if [[ ${#tasks[@]} -gt 0 ]]; then
    local completion=$((done_tasks * 100 / ${#tasks[@]}))
    echo "Completion: ${completion}%"
  fi
  echo ""
}

# Project Kickoff Checklist
project_kickoff() {
  local project_name="$1"
  if [[ -z "$project_name" ]]; then
    echo "Usage: gtd-project kickoff <project-name>"
    exit 1
  fi
  
  project_name=$(echo "$project_name" | tr ' ' '-' | tr '[:upper:]' '[:lower:]')
  local project_dir="${PROJECTS_PATH}/${project_name}"
  local readme="${project_dir}/README.md"
  
  if [[ ! -d "$project_dir" || ! -f "$readme" ]]; then
    echo "âŒ Project not found: $project_name"
    exit 1
  fi
  
  echo ""
  echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
  echo "ğŸš€ Project Kickoff Checklist: $project_name"
  echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
  echo ""
  
  # Define goals and success criteria
  echo "1. Define Goals and Success Criteria"
  read -p "   What are the main goals? " goals
  read -p "   How will you measure success? " success_criteria
  echo ""
  
  # Identify stakeholders
  echo "2. Identify Stakeholders"
  read -p "   Who are the key stakeholders? " stakeholders
  echo ""
  
  # Set timeline
  echo "3. Set Timeline and Milestones"
  read -p "   Target completion date: " target_date
  read -p "   Key milestones: " milestones
  echo ""
  
  # Create initial tasks
  echo "4. Create Initial Tasks"
  read -p "   What are the first 3-5 tasks? " initial_tasks
  echo ""
  
  # Set up tracking
  echo "5. Set Up Tracking"
  read -p "   How will you track progress? " tracking_method
  echo ""
  
  # Save checklist results
  local checklist_file="${project_dir}/kickoff-checklist.md"
  cat > "$checklist_file" <<EOF
# Project Kickoff Checklist - ${TODAY}

## Goals and Success Criteria
**Goals:** ${goals}
**Success Criteria:** ${success_criteria}

## Stakeholders
${stakeholders}

## Timeline
**Target Date:** ${target_date}
**Milestones:** ${milestones}

## Initial Tasks
${initial_tasks}

## Tracking Method
${tracking_method}

## Checklist Status
- [x] Goals defined
- [x] Stakeholders identified
- [x] Timeline set
- [x] Initial tasks created
- [x] Tracking set up

---
Completed: ${TODAY}T${NOW}
EOF

  # Update project README with goals
  if [[ -n "$goals" ]]; then
    # Add goals to README if not already there
    if ! grep -q "## Goals" "$readme" || grep -A 5 "## Goals" "$readme" | grep -q "^$"; then
      if [[ "$OSTYPE" == "darwin"* ]]; then
        sed -i '' "/^## Goals$/a\\
${goals}
" "$readme"
      else
        sed -i "/^## Goals$/a\\${goals}" "$readme"
      fi
    fi
  fi
  
  echo "âœ“ Kickoff checklist completed!"
  echo "  Saved to: $checklist_file"
  echo ""
}

# Project Review Checklist
project_review() {
  local project_name="$1"
  if [[ -z "$project_name" ]]; then
    echo "Usage: gtd-project review <project-name>"
    exit 1
  fi
  
  project_name=$(echo "$project_name" | tr ' ' '-' | tr '[:upper:]' '[:lower:]')
  local project_dir="${PROJECTS_PATH}/${project_name}"
  local readme="${project_dir}/README.md"
  
  if [[ ! -d "$project_dir" || ! -f "$readme" ]]; then
    echo "âŒ Project not found: $project_name"
    exit 1
  fi
  
  echo ""
  echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
  echo "ğŸ“Š Project Review Checklist: $project_name"
  echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
  echo ""
  
  # Review progress
  echo "1. Review Progress"
  read -p "   What progress have you made? " progress
  read -p "   What percentage complete? " completion_pct
  echo ""
  
  # Identify blockers
  echo "2. Identify Blockers"
  read -p "   What's blocking progress? " blockers
  echo ""
  
  # Update timeline
  echo "3. Update Timeline"
  read -p "   Is the timeline still realistic? " timeline_status
  read -p "   Any adjustments needed? " timeline_adjustments
  echo ""
  
  # Adjust scope
  echo "4. Adjust Scope (if needed)"
  read -p "   Any scope changes? " scope_changes
  echo ""
  
  # Plan next steps
  echo "5. Plan Next Steps"
  read -p "   What are the next 3-5 actions? " next_steps
  echo ""
  
  # Save checklist results
  local checklist_file="${project_dir}/review-${TODAY}.md"
  cat > "$checklist_file" <<EOF
# Project Review Checklist - ${TODAY}

## Progress Review
**Progress Made:** ${progress}
**Completion:** ${completion_pct}%

## Blockers
${blockers}

## Timeline Update
**Status:** ${timeline_status}
**Adjustments:** ${timeline_adjustments}

## Scope Changes
${scope_changes}

## Next Steps
${next_steps}

## Checklist Status
- [x] Progress reviewed
- [x] Blockers identified
- [x] Timeline updated
- [x] Scope adjusted (if needed)
- [x] Next steps planned

---
Completed: ${TODAY}T${NOW}
EOF

  echo "âœ“ Review checklist completed!"
  echo "  Saved to: $checklist_file"
  echo ""
}

# Project Completion Checklist
project_complete() {
  local project_name="$1"
  if [[ -z "$project_name" ]]; then
    echo "Usage: gtd-project complete <project-name>"
    exit 1
  fi
  
  project_name=$(echo "$project_name" | tr ' ' '-' | tr '[:upper:]' '[:lower:]')
  local project_dir="${PROJECTS_PATH}/${project_name}"
  local readme="${project_dir}/README.md"
  
  if [[ ! -d "$project_dir" || ! -f "$readme" ]]; then
    echo "âŒ Project not found: $project_name"
    exit 1
  fi
  
  echo ""
  echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
  echo "ğŸ‰ Project Completion Checklist: $project_name"
  echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
  echo ""
  
  # Document lessons learned
  echo "1. Document Lessons Learned"
  read -p "   What went well? " what_went_well
  read -p "   What could be improved? " improvements
  read -p "   Key takeaways: " takeaways
  echo ""
  
  # Archive project files
  echo "2. Archive Project Files"
  read -p "   Are all files organized? (y/n) " files_organized
  echo ""
  
  # Update Second Brain notes
  echo "3. Update Second Brain Notes"
  read -p "   Have you synced with Second Brain? (y/n) " synced_brain
  echo ""
  
  # Share outcomes
  echo "4. Share Outcomes"
  read -p "   Who needs to know about completion? " stakeholders
  read -p "   How will you share? " sharing_method
  echo ""
  
  # Celebrate
  echo "5. Celebrate Completion"
  read -p "   How will you celebrate? " celebration
  echo ""
  
  # Save checklist results
  local checklist_file="${project_dir}/completion-checklist.md"
  cat > "$checklist_file" <<EOF
# Project Completion Checklist - ${TODAY}

## Lessons Learned
**What Went Well:** ${what_went_well}
**Improvements:** ${improvements}
**Key Takeaways:** ${takeaways}

## Archive Status
**Files Organized:** ${files_organized}

## Second Brain Sync
**Synced:** ${synced_brain}

## Outcomes Shared
**Stakeholders:** ${stakeholders}
**Sharing Method:** ${sharing_method}

## Celebration
${celebration}

## Checklist Status
- [x] Lessons learned documented
- [x] Project files archived
- [x] Second Brain updated
- [x] Outcomes shared
- [x] Completion celebrated

---
Completed: ${TODAY}T${NOW}
EOF

  echo "âœ“ Completion checklist saved!"
  echo "  Saved to: $checklist_file"
  echo ""
  
  read -p "Archive this project now? (y/n) " -n 1 -r
  echo
  if [[ $REPLY =~ ^[Yy]$ ]]; then
    archive_project "$project_name"
  fi
}

# Archive project
archive_project() {
  local project_name="$1"
  if [[ -z "$project_name" ]]; then
    echo "Usage: gtd-project archive <project-name>"
    exit 1
  fi
  
  project_name=$(echo "$project_name" | tr ' ' '-' | tr '[:upper:]' '[:lower:]')
  local project_dir="${PROJECTS_PATH}/${project_name}"
  local readme="${project_dir}/README.md"
  
  if [[ ! -d "$project_dir" || ! -f "$readme" ]]; then
    echo "âŒ Project not found: $project_name"
    exit 1
  fi
  
  update_frontmatter_value "$readme" "status" "archived"
  update_frontmatter_value "$readme" "archived" "$(date +"%Y-%m-%dT%H:%M")"
  
  mv "$project_dir" "${ARCHIVE_PATH}/"
  
  echo "âœ“ Project archived: $project_name"
  echo "  Location: ${ARCHIVE_PATH}/${project_name}"
}

# Main
main() {
  case "$1" in
    create)
      shift
      create_project "$@"
      ;;
    list|ls)
      shift
      list_projects "${1:-active}"
      ;;
    view)
      shift
      view_project "$1"
      ;;
    add-task)
      shift
      add_task_to_project "$@"
      ;;
    add-note)
      shift
      add_note_to_project "$@"
      ;;
    status)
      shift
      project_status "$1"
      ;;
    kickoff)
      shift
      project_kickoff "$1"
      ;;
    review)
      shift
      project_review "$1"
      ;;
    complete)
      shift
      project_complete "$1"
      ;;
    archive)
      shift
      archive_project "$1"
      ;;
    --help|-h|"")
      echo "Usage: gtd-project <command> [options]"
      echo ""
      echo "Commands:"
      echo "  create <name>                    Create a new project"
      echo "  list [status]                    List projects (default: active)"
      echo "  view <name>                      View project details"
      echo "  add-task <name> <description>    Add task to project"
      echo "  add-note <name> [note]           Add note to project"
      echo "  status <name>                    Show project status"
      echo "  kickoff <name>                   Run project kickoff checklist"
      echo "  review <name>                    Run project review checklist"
      echo "  complete <name>                  Run project completion checklist"
      echo "  archive <name>                   Archive completed project"
      echo ""
      echo "Examples:"
      echo "  gtd-project create \"Website Redesign\""
      echo "  gtd-project kickoff website-redesign"
      echo "  gtd-project list"
      echo "  gtd-project view website-redesign"
      echo "  gtd-project add-task website-redesign \"Design homepage\""
      echo "  gtd-project review website-redesign"
      echo "  gtd-project status website-redesign"
      echo "  gtd-project complete website-redesign"
      exit 0
      ;;
    *)
      echo "Unknown command: $1"
      echo "Run 'gtd-project --help' for usage"
      exit 1
      ;;
  esac
}

main "$@"



