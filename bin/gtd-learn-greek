#!/bin/bash
# Greek Language Learning with Mistress Louiza as Instructor
# Integrated with GTD system for tracking progress

# Load GTD config
GTD_CONFIG_FILE="$HOME/.gtd_config"
if [[ -f "$HOME/code/dotfiles/zsh/.gtd_config" ]]; then
  GTD_CONFIG_FILE="$HOME/code/dotfiles/zsh/.gtd_config"
elif [[ -f "$HOME/code/personal/dotfiles/zsh/.gtd_config" ]]; then
  GTD_CONFIG_FILE="$HOME/code/personal/dotfiles/zsh/.gtd_config"
fi

if [[ -f "$GTD_CONFIG_FILE" ]]; then
  source "$GTD_CONFIG_FILE"
fi

# Load daily log config
DAILY_LOG_CONFIG="$HOME/.daily_log_config"
if [[ -f "$HOME/code/dotfiles/zsh/.daily_log_config" ]]; then
  DAILY_LOG_CONFIG="$HOME/code/dotfiles/zsh/.daily_log_config"
elif [[ -f "$HOME/code/personal/dotfiles/zsh/.daily_log_config" ]]; then
  DAILY_LOG_CONFIG="$HOME/code/personal/dotfiles/zsh/.daily_log_config"
fi

if [[ -f "$DAILY_LOG_CONFIG" ]]; then
  source "$DAILY_LOG_CONFIG"
fi

# Colors
CYAN='\033[0;36m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
MAGENTA='\033[0;35m'
BLUE='\033[0;34m'
BOLD='\033[1m'
NC='\033[0m'

# Find persona helper
PERSONA_HELPER=""
possible_paths=(
  "$HOME/code/personal/dotfiles/zsh/functions/gtd_persona_helper.py"
  "$HOME/code/dotfiles/zsh/functions/gtd_persona_helper.py"
)

for path in "${possible_paths[@]}"; do
  if [[ -f "$path" ]]; then
    PERSONA_HELPER="$path"
    break
  fi
done

if [[ -z "$PERSONA_HELPER" || ! -f "$PERSONA_HELPER" ]]; then
  echo "âŒ Persona helper not found" >&2
  exit 1
fi

# Find python
PYTHON_CMD=""
if [[ -f "/opt/homebrew/bin/python3" ]]; then
  PYTHON_CMD="/opt/homebrew/bin/python3"
elif command -v python3 &>/dev/null; then
  PYTHON_CMD="python3"
else
  echo "âŒ Python3 not found" >&2
  exit 1
fi

# GTD base directory
# GTD_BASE_DIR is already set by init_gtd_paths in gtd-common.sh (DRY - reuse existing helper)
STUDY_DIR="${GTD_BASE_DIR}/study"
GREEK_STUDY_DIR="${STUDY_DIR}/greek"

# Create study directories
mkdir -p "$GREEK_STUDY_DIR"/{notes,practice,progress,resources}

# Get date command
get_date_cmd() {
  if [[ -x "/usr/bin/date" ]]; then
    echo "/usr/bin/date"
  elif [[ -x "/bin/date" ]]; then
    echo "/bin/date"
  else
    echo "date"
  fi
}

DATE_CMD=$(get_date_cmd)

# Gather study data for critique
gather_greek_study_data() {
  local topic="$1"
  
  # Default paths
  SECOND_BRAIN="${SECOND_BRAIN:-$HOME/Documents/obsidian/Second Brain}"
  # GTD_BASE_DIR is already set by init_gtd_paths in gtd-common.sh (DRY - reuse existing helper)
  # PROJECTS_PATH is already set by init_gtd_paths in gtd-common.sh (DRY - reuse existing helper)
  
  local study_data=""
  
  # Study notes count and recent topics
  local notes_count=$(find "${GREEK_STUDY_DIR}/notes" -type f -name "*.md" 2>/dev/null | wc -l | tr -d ' ')
  if [[ "$notes_count" -gt 0 ]]; then
    study_data="${study_data}\nGreek Study Notes: ${notes_count} notes created"
    local recent_topics=$(find "${GREEK_STUDY_DIR}/notes" -type f -name "*.md" -exec basename {} \; 2>/dev/null | sed 's/^[0-9]*-//' | sed 's/\.md$//' | head -5 | tr '\n' ', ' | sed 's/, $//')
    if [[ -n "$recent_topics" ]]; then
      study_data="${study_data} (recent: ${recent_topics})"
    fi
  fi
  
  # Progress tracking
  local progress_files=$(find "${GREEK_STUDY_DIR}/progress" -type f -name "*.txt" 2>/dev/null | wc -l | tr -d ' ')
  if [[ "$progress_files" -gt 0 ]]; then
    study_data="${study_data}\nStudy Sessions Tracked: ${progress_files} days with logged sessions"
  fi
  
  # Second Brain notes related to Greek
  if [[ -d "$SECOND_BRAIN" ]]; then
    local greek_notes=$(find "$SECOND_BRAIN" -type f -name "*.md" ! -path "*/Templates/*" ! -path "*/.obsidian/*" -exec grep -l -i "greek\|ÎµÎ»Î»Î·Î½Î¹Îº\|hellenic" {} \; 2>/dev/null | wc -l | tr -d ' ')
    if [[ "$greek_notes" -gt 0 ]]; then
      study_data="${study_data}\nSecond Brain Notes: ${greek_notes} notes mentioning Greek"
    fi
  fi
  
  # GTD projects related to Greek
  if [[ -d "$PROJECTS_PATH" ]]; then
    local greek_projects=$(find "$PROJECTS_PATH" -type d -mindepth 1 -maxdepth 1 -exec basename {} \; 2>/dev/null | grep -i "greek\|hellenic" | wc -l | tr -d ' ')
    if [[ "$greek_projects" -gt 0 ]]; then
      local project_names=$(find "$PROJECTS_PATH" -type d -mindepth 1 -maxdepth 1 -exec basename {} \; 2>/dev/null | grep -i "greek\|hellenic" | tr '\n' ', ' | sed 's/, $//')
      study_data="${study_data}\nGTD Projects: ${greek_projects} Greek-related projects (${project_names})"
    fi
  fi
  
  # Sample note content for quality analysis (if topic-specific)
  if [[ -n "$topic" && "$notes_count" -gt 0 ]]; then
    local topic_notes=$(find "${GREEK_STUDY_DIR}/notes" -type f -name "*${topic}*" -o -name "*.md" 2>/dev/null | head -3)
    if [[ -n "$topic_notes" ]]; then
      study_data="${study_data}\nNotes on '${topic}': Found ${#topic_notes} related notes"
    fi
  fi
  
  echo -e "$study_data"
}

# Get lesson from Mistress Louiza
get_greek_lesson() {
  local topic="$1"
  local context="$2"  # beginner, intermediate, advanced
  local critique_mode="${3:-false}"  # true = include study data for critique
  
  # Gather study data if in critique mode
  local study_data=""
  if [[ "$critique_mode" == "true" ]]; then
    study_data=$(gather_greek_study_data "$topic")
  fi
  
  # Create comprehensive prompt for Louiza as Greek language instructor
  local prompt=""
  
  if [[ "$critique_mode" == "true" && -n "$study_data" ]]; then
    prompt="You are Mistress Louiza, ${GTD_USER_NAME:-Abby}'s Greek language instructor. ${GTD_USER_NAME:-Abby} wants personalized critique and feedback on her actual Greek study progress and note-taking. I've provided her actual study data below. Analyze it critically and provide specific, actionable feedback on how well she's studying Greek, taking notes, and tracking progress. Be firm but encouraging. Point out what's working well and what needs improvement. Give specific recommendations based on what you see in her data. Use your characteristic style.

${GTD_USER_NAME:-Abby}'s Current Greek Study Data:
${study_data}

"
  fi
  
  case "$topic" in
    basics|introduction|intro|alphabet)
      if [[ "$critique_mode" == "true" && -n "$study_data" ]]; then
        prompt="${prompt}Based on her actual study data above, critique her Greek learning approach, especially for basics and alphabet. How many notes has she taken? Is she tracking progress? Give specific feedback on her study habits and recommend improvements. Then provide targeted guidance on Greek basics and alphabet."
      else
        prompt="${prompt}You are Mistress Louiza, and you are ${GTD_USER_NAME:-Abby}'s Greek language instructor. Give her a comprehensive introduction to the Greek language. Explain the Greek alphabet (24 letters), how to read Greek script, pronunciation basics, and fundamental concepts. Be encouraging but firm. Use your characteristic style. Reference Greek language experts or resources when you need to explain something in more detail, but you remain the primary instructor. Make it practical with examples showing Greek text alongside transliteration. Explain how this integrates with her GTD system - she can track her study progress with 'addInfoToDailyLog' and create study tasks with 'gtd-task add'."
      fi
      ;;
    reading|read)
      prompt="You are Mistress Louiza, ${GTD_USER_NAME:-Abby}'s Greek language instructor. Teach her how to read Greek. Focus on recognizing Greek letters, reading words, understanding basic word structure, and building reading comprehension. Include examples with Greek text. Be practical and encouraging. Explain how to practice reading and track progress in her GTD system."
      ;;
    alphabet|letters)
      prompt="You are Mistress Louiza, ${GTD_USER_NAME:-Abby}'s Greek language instructor. Teach her the Greek alphabet thoroughly - all 24 letters (Î‘Î±, Î’Î², Î“Î³, Î”Î´, Î•Îµ, Î–Î¶, Î—Î·, Î˜Î¸, Î™Î¹, ÎšÎº, Î›Î», ÎœÎ¼, ÎÎ½, ÎžÎ¾, ÎŸÎ¿, Î Ï€, Î¡Ï, Î£ÏƒÏ‚, Î¤Ï„, Î¥Ï…, Î¦Ï†, Î§Ï‡, Î¨Ïˆ, Î©Ï‰), their names, sounds, and how to write them. Show examples of words starting with each letter. Be patient and encouraging. Explain how to practice writing and recognizing letters. Show her how to track practice in her GTD system."
      ;;
    vocabulary|words|vocab)
      prompt="You are Mistress Louiza, ${GTD_USER_NAME:-Abby}'s Greek language instructor. Teach her Greek vocabulary. Focus on common words, essential phrases, and building word recognition. Include Greek text with transliteration and English translations. Be practical with useful everyday words. Explain how to build vocabulary systematically and track progress. Show her how to log vocabulary practice in her GTD system."
      ;;
    grammar|grammar-basics)
      prompt="You are Mistress Louiza, ${GTD_USER_NAME:-Abby}'s Greek language instructor. Teach her Greek grammar basics. Explain noun cases, verb conjugations, word order, articles, and essential grammar rules. Be clear and systematic. Include examples with Greek text. Explain how to practice grammar and track what she's learned. Show her how to log grammar study in her GTD system."
      ;;
    verbs|verb-conjugation)
      prompt="You are Mistress Louiza, ${GTD_USER_NAME:-Abby}'s Greek language instructor. Teach her about Greek verbs. Explain verb conjugation, tenses (present, past, future), and how verbs work in Greek. Include examples with Greek text showing different verb forms. Be systematic and practical. Show her how to practice verb conjugations and track progress."
      ;;
    nouns|cases)
      prompt="You are Mistress Louiza, ${GTD_USER_NAME:-Abby}'s Greek language instructor. Teach her about Greek nouns and cases. Explain the four cases (nominative, genitive, accusative, vocative), noun endings, and how cases work. Include examples with Greek text. Be clear and patient. Show her how to practice cases and track learning."
      ;;
    comprehension|understanding)
      prompt="You are Mistress Louiza, ${GTD_USER_NAME:-Abby}'s Greek language instructor. Help her develop reading comprehension in Greek. Give her practice texts with translations, exercises to understand meaning, and strategies for understanding Greek text. Include examples. Be encouraging. Show her how to track comprehension progress in her GTD system."
      ;;
    pronunciation|pronounce)
      prompt="You are Mistress Louiza, ${GTD_USER_NAME:-Abby}'s Greek language instructor. Teach her Greek pronunciation. Explain how to pronounce Greek letters and letter combinations, accent marks, and common pronunciation patterns. Include examples with transliteration. Be encouraging about pronunciation practice. Show her how to track pronunciation practice."
      ;;
    practice|exercises|practice-reading)
      prompt="You are Mistress Louiza, ${GTD_USER_NAME:-Abby}'s Greek language instructor. Give her a hands-on practice exercise. Create a realistic reading or comprehension exercise she can practice with. Include Greek text, questions, or exercises to complete. Explain what to do and how to verify understanding. Be practical. After she completes it, she should log it with 'addInfoToDailyLog \"Completed Greek practice: [topic]\"'. Show her how to track practice sessions in her GTD system."
      ;;
    *)
      if [[ "$critique_mode" == "true" && -n "$study_data" ]]; then
        prompt="${prompt}Based on her actual study data above, critique her Greek learning for: ${topic}. Analyze her notes, progress tracking, and study habits. Give specific feedback and recommendations. Then provide targeted guidance on ${topic}."
      else
        prompt="${prompt}You are Mistress Louiza, ${GTD_USER_NAME:-Abby}'s Greek language instructor helping her learn to read and understand Greek. Teach her about: ${topic}. Be comprehensive, practical, and encouraging but firm. Include Greek text with transliteration and translations when showing examples. Reference Greek language experts or resources when you need to explain something in more detail, but you remain the primary instructor. Use your characteristic style. Explain how to track study progress in her GTD system with 'addInfoToDailyLog' and 'gtd-task add'."
      fi
      ;;
  esac
  
  # Get lesson from Louiza
  local full_output=$("$PYTHON_CMD" "$PERSONA_HELPER" "louiza" "$prompt" "greek_instructor" 2>&1)
  
  if [[ -z "$full_output" ]]; then
    return 1
  fi
  
  # Check for errors
  if echo "$full_output" | grep -qE "Error|âš ï¸|timed out|Could not connect|KeyError"; then
    return 1
  fi
  
  # Extract message
  local lesson=$(echo "$full_output" | awk '
    /^â”+$/ {
      if (in_section) {
        exit
      }
      in_section = 1
      next
    }
    in_section && !/^ðŸ’¬/ && !/^â”/ {
      print
    }
  ' | sed 's/^[[:space:]]*//' | sed 's/[[:space:]]*$//')
  
  # Clean up
  lesson=$(echo "$lesson" | sed 's/([^)]*)//g' | sed 's/\[[^\]]*\]//g')
  lesson=$(echo "$lesson" | sed 's/\*\*//g')
  lesson=$(echo "$lesson" | awk 'NF || prev_nf; {prev_nf=NF}')
  
  if [[ -n "$lesson" && ${#lesson} -gt 10 ]]; then
    echo "$lesson"
    return 0
  fi
  
  return 1
}

# Handle Q&A session after a lesson or critique
handle_qa_session() {
  local topic="$1"
  local is_critique="${2:-false}"
  
  # Ask if student wants to ask questions
  if [[ "$is_critique" == "true" ]]; then
    echo -e "${BOLD}Do you have any questions about this critique?${NC}"
  else
    echo -e "${BOLD}Do you have any questions about this topic?${NC}"
  fi
  echo -e "${GREEN}y${NC} - Ask questions"
  echo -e "${GREEN}n${NC} - Continue"
  echo ""
  read -p "Choice: " ask_questions
  echo ""
  
  if [[ "$ask_questions" != "y" && "$ask_questions" != "Y" ]]; then
    return 0
  fi
  
  # Q&A session loop
  while true; do
    echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    if [[ "$is_critique" == "true" ]]; then
      echo -e "${BOLD}ðŸ’¬ Ask Mistress Louiza about the critique on: ${topic}${NC}"
    else
      echo -e "${BOLD}ðŸ’¬ Ask Mistress Louiza about: ${topic}${NC}"
    fi
    echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo ""
    echo -e "${YELLOW}Type your question (or 'done' to finish asking questions):${NC}"
    echo ""
    read -p "â“ Question: " student_question
    
    if [[ -z "$student_question" ]]; then
      echo "Please enter a question or 'done' to continue."
      echo ""
      continue
    fi
    
    # Check if student is done
    if [[ "$student_question" == "done" || "$student_question" == "Done" || "$student_question" == "DONE" ]]; then
      echo ""
      echo "âœ“ Finished asking questions."
      echo ""
      break
    fi
    
    # Get answer from Mistress Louiza with context
    echo ""
    echo -e "${BOLD}${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo -e "${BOLD}${CYAN}ðŸ‘‘ Answer from Mistress Louiza${NC}"
    echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo ""
    echo -e "${BOLD}ðŸ’¬ From Mistress Louiza:${NC}"
    echo ""
    
    local question_prompt=""
    if [[ "$is_critique" == "true" ]]; then
      question_prompt="You are Mistress Louiza, ${GTD_USER_NAME:-Abby}'s Greek language instructor. ${GTD_USER_NAME:-Abby} just received personalized critique on: ${topic}. Now she has a question about the critique: '${student_question}'. Answer her question in detail, referencing the critique you just gave her about ${topic}. Be helpful, encouraging, and use your characteristic style with phrases like 'good girl' and 'baby girl' when appropriate. Reference other experts if needed, but you remain the primary instructor."
    else
      question_prompt="You are Mistress Louiza, ${GTD_USER_NAME:-Abby}'s Greek language instructor. ${GTD_USER_NAME:-Abby} just learned about: ${topic}. Now she has a question: '${student_question}'. Answer her question in detail, referencing what you just taught her about ${topic}. Be helpful, encouraging, and use your characteristic style with phrases like 'good girl' and 'baby girl' when appropriate. Reference other experts if needed, but you remain the primary instructor."
    fi
    
    local answer=$("$PYTHON_CMD" "$PERSONA_HELPER" "louiza" "$question_prompt" "greek_instructor" 2>&1)
    
    if [[ -n "$answer" ]]; then
      # Extract message (same extraction logic as lesson)
      local answer_text=$(echo "$answer" | awk '
        /^â”+$/ {
          if (in_section) {
            exit
          }
          in_section = 1
          next
        }
        in_section && !/^ðŸ’¬/ && !/^â”/ {
          print
        }
      ' | sed 's/^[[:space:]]*//' | sed 's/[[:space:]]*$//')
      
      # Clean up
      answer_text=$(echo "$answer_text" | sed 's/([^)]*)//g' | sed 's/\[[^\]]*\]//g')
      answer_text=$(echo "$answer_text" | sed 's/\*\*//g')
      answer_text=$(echo "$answer_text" | awk 'NF || prev_nf; {prev_nf=NF}')
      
      if [[ -n "$answer_text" && ${#answer_text} -gt 10 ]]; then
        echo "$answer_text" | sed 's/^/   /'
        echo ""
      else
        echo "   I'm here to help, baby girl. Could you rephrase your question?"
        echo ""
      fi
    else
      echo "   âš ï¸  Could not get answer. Check LM Studio connection."
      echo ""
    fi
    
    echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo ""
  done
}

# Create study note
create_study_note() {
  local topic="$1"
  local content="$2"
  local today=$($DATE_CMD +"%Y-%m-%d")
  local timestamp=$($DATE_CMD +"%Y%m%d-%H%M%S")
  local note_file="${GREEK_STUDY_DIR}/notes/${timestamp}-${topic}.md"
  
  cat > "$note_file" <<EOF
# Greek Study: ${topic}
Date: ${today}
Topic: ${topic}

${content}

---
Created: $($DATE_CMD)
EOF

  echo "$note_file"
}

# Track study session
track_study_session() {
  local topic="$1"
  local duration="${2:-0}"  # minutes
  
  local today=$($DATE_CMD +"%Y-%m-%d")
  local progress_file="${GREEK_STUDY_DIR}/progress/${today}.txt"
  
  echo "$($DATE_CMD +"%H:%M") - Studied: ${topic} (${duration} min)" >> "$progress_file"
  
  # Also log to daily log
  if command -v addInfoToDailyLog &>/dev/null; then
    addInfoToDailyLog "Greek Study: ${topic} (${duration} min)" 2>/dev/null || true
  fi
  
  # Log to habit if it exists
  if command -v gtd-habit &>/dev/null; then
    local habit_file="${GTD_BASE_DIR}/habits/greek-study.md"
    if [[ -f "$habit_file" ]]; then
      gtd-habit log "Greek Study" 2>/dev/null || true
    fi
  fi
}

# Show lesson menu
show_greek_menu() {
  clear
  echo -e "${BOLD}${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
  echo -e "${BOLD}${CYAN}ðŸ‡¬ðŸ‡· Greek Language Learning with Mistress Louiza${NC}"
  echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
  echo ""
  echo -e "${BOLD}What would you like to learn?${NC}"
  echo ""
  echo -e "${GREEN}1)${NC} Greek Basics & Introduction"
  echo -e "${GREEN}2)${NC} The Greek Alphabet (24 letters)"
  echo -e "${GREEN}3)${NC} Reading Greek"
  echo -e "${GREEN}4)${NC} Vocabulary Building"
  echo -e "${GREEN}5)${NC} Grammar Basics"
  echo -e "${GREEN}6)${NC} Verbs & Conjugation"
  echo -e "${GREEN}7)${NC} Nouns & Cases"
  echo -e "${GREEN}8)${NC} Reading Comprehension"
  echo -e "${GREEN}9)${NC} Pronunciation"
  echo -e "${GREEN}10)${NC} Practice Exercise"
  echo -e "${GREEN}11)${NC} Study Progress"
  echo -e "${GREEN}12)${NC} Custom Topic"
  echo ""
  echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
  echo -e "${BOLD}ðŸ“Š Personalized Critique${NC}"
  echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
  echo -e "${GREEN}13)${NC} Get Personalized Critique on My Greek Study"
  echo ""
  echo -e "${YELLOW}0)${NC} Exit"
  echo ""
  echo -n "Choose: "
}

# Show study progress
show_progress() {
  clear
  echo -e "${BOLD}${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
  echo -e "${BOLD}${CYAN}ðŸ“Š Greek Study Progress${NC}"
  echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
  echo ""
  
  # Today's progress
  local today=$($DATE_CMD +"%Y-%m-%d")
  local progress_file="${GREEK_STUDY_DIR}/progress/${today}.txt"
  
  if [[ -f "$progress_file" ]]; then
    echo -e "${BOLD}Today's Study Sessions:${NC}"
    echo ""
    cat "$progress_file" | sed 's/^/   /'
    echo ""
  else
    echo -e "${YELLOW}No study sessions logged today${NC}"
    echo ""
  fi
  
  # Notes count
  local notes_count=$(find "${GREEK_STUDY_DIR}/notes" -type f 2>/dev/null | wc -l | tr -d ' ')
  echo -e "${BOLD}Study Notes:${NC} ${notes_count} notes created"
  echo ""
  
  # Recent notes
  if [[ $notes_count -gt 0 ]]; then
    echo -e "${BOLD}Recent Notes:${NC}"
    echo ""
    find "${GREEK_STUDY_DIR}/notes" -type f -name "*.md" | sort -r | head -5 | while read note; do
      local note_name=$(basename "$note" .md)
      echo "   ðŸ“ $note_name"
    done
    echo ""
  fi
  
  # Study recommendations
  echo -e "${BOLD}ðŸ’¡ Study Recommendations:${NC}"
  echo ""
  echo "   â€¢ Log study sessions: 'addInfoToDailyLog \"Greek Study: [topic]\"'"
  echo "   â€¢ Create study tasks: 'gtd-task add \"Practice Greek reading\"'"
  echo "   â€¢ Create study project: 'gtd-project create \"Greek Language Learning\"'"
  echo "   â€¢ Review daily: 'gtd-review daily'"
  echo "   â€¢ Track habit: 'gtd-habit log \"Greek Study\"'"
  echo ""
  
  read -p "Press Enter to continue..."
}

# Main function
main() {
  local topic="$1"
  local critique_mode="false"
  
  if [[ -z "$topic" ]]; then
    # Interactive mode
    while true; do
      show_greek_menu
      read choice
      
      # Reset critique mode for each lesson
      critique_mode="false"
      
      case "$choice" in
        1) topic="basics" ;;
        2) topic="alphabet" ;;
        3) topic="reading" ;;
        4) topic="vocabulary" ;;
        5) topic="grammar" ;;
        6) topic="verbs" ;;
        7) topic="nouns" ;;
        8) topic="comprehension" ;;
        9) topic="pronunciation" ;;
        10) topic="practice" ;;
        11) 
          show_progress
          continue
          ;;
        12)
          echo ""
          echo -n "What Greek topic would you like to learn about? "
          read topic
          ;;
        13)
          # Personalized critique mode
          echo ""
          echo -e "${BOLD}ðŸ“Š Personalized Greek Study Critique${NC}"
          echo ""
          echo "Mistress Louiza will analyze your actual Greek study progress and provide"
          echo "personalized feedback. This includes:"
          echo "  â€¢ Your study notes and topics covered"
          echo "  â€¢ Your study session tracking"
          echo "  â€¢ Your Second Brain notes related to Greek"
          echo "  â€¢ Your GTD projects for Greek learning"
          echo "  â€¢ How well you're tracking and organizing your learning"
          echo ""
          
          # Build dynamic topic list from notes
          local topic_map=()
          local topic_index=1
          
          # Always include "Overall study critique" as option 1
          topic_map[1]=""
          echo -e "${GREEN}  ${topic_index})${NC} Overall study critique"
          ((topic_index++))
          
          # Extract unique topics from note filenames
          if [[ -d "${GREEK_STUDY_DIR}/notes" ]]; then
            local found_topics=$(find "${GREEK_STUDY_DIR}/notes" -type f -name "*.md" -exec basename {} \; 2>/dev/null | \
              sed 's/^[0-9]*-//' | sed 's/\.md$//' | \
              tr '[:upper:]' '[:lower:]' | \
              sed 's/-/ /g' | sed 's/_/ /g' | \
              awk '{for(i=1;i<=NF;i++) $i=toupper(substr($i,1,1)) substr($i,2)}1' | \
              sort -u)
            
            # Map common topic names to their canonical form
            # Initialize topic_canonical (simulated associative array)
            _set_array_value "topic_canonical" "Basics" "basics"
            _set_array_value "topic_canonical" "Alphabet" "basics"
            _set_array_value "topic_canonical" "Reading" "reading"
            _set_array_value "topic_canonical" "Comprehension" "reading"
            _set_array_value "topic_canonical" "Vocabulary" "vocabulary"
            _set_array_value "topic_canonical" "Grammar" "grammar"
            _set_array_value "topic_canonical" "Practice" "practice"
            _set_array_value "topic_canonical" "Exercises" "practice"
            
            # Process found topics and add to menu
            local seen_canonical_keys=("")
            _set_array_value "seen_canonical" "" "1"  # Mark overall as seen
            
            while IFS= read -r found_topic; do
              [[ -z "$found_topic" ]] && continue
              
              # Get canonical form
              local canonical="$(_get_array_value "topic_canonical" "$found_topic")"
              [[ -z "$canonical" ]] && canonical=""
              if [[ -z "$canonical" ]]; then
                # If not in map, use lowercase with hyphens
                canonical=$(echo "$found_topic" | tr '[:upper:]' '[:lower:]' | sed 's/ /-/g')
              fi
              
              # Skip if we've already added this canonical topic
              local seen_value="$(_get_array_value "seen_canonical" "$canonical")"
              if [[ -n "$seen_value" ]]; then
                continue
              fi
              
              _set_array_value "seen_canonical" "$canonical" "1"
              seen_canonical_keys+=("$canonical")
              topic_map[$topic_index]="$canonical"
              echo -e "${GREEN}  ${topic_index})${NC} ${found_topic}"
              ((topic_index++))
            done <<< "$found_topics"
          fi
          
          # Always include important topics that might not have notes yet
          local important_topics=("basics" "reading" "vocabulary" "grammar" "practice")
          local important_labels=("Basics & Alphabet" "Reading & Comprehension" "Vocabulary" "Grammar" "Practice & Exercises")
          
          for i in "${!important_topics[@]}"; do
            local imp_topic="${important_topics[$i]}"
            local imp_label="${important_labels[$i]}"
            
            # Check if already added
            local already_added=0
            for idx in "${!topic_map[@]}"; do
              if [[ "${topic_map[$idx]}" == "$imp_topic" ]]; then
                already_added=1
                break
              fi
            done
            
            if [[ $already_added -eq 0 ]]; then
              topic_map[$topic_index]="$imp_topic"
              echo -e "${GREEN}  ${topic_index})${NC} ${imp_label}"
              ((topic_index++))
            fi
          done
          
          echo ""
          local max_choice=$((topic_index - 1))
          read -p "Choice (1-${max_choice}): " critique_topic
          
          # Map selection to topic
          if [[ "$critique_topic" =~ ^[0-9]+$ ]] && [[ "$critique_topic" -ge 1 ]] && [[ "$critique_topic" -le $max_choice ]]; then
            topic="${topic_map[$critique_topic]}"
          else
            echo "Invalid choice, using overall study critique"
            topic=""
          fi
          
          # Set critique mode flag
          critique_mode="true"
          ;;
        0)
          echo ""
          echo "Goodbye! Keep studying, baby girl. You've got this! ðŸ‡¬ðŸ‡·"
          exit 0
          ;;
        *)
          echo "Invalid choice. Press Enter..."
          read
          continue
          ;;
      esac
      
      # Get lesson
      echo ""
      echo -e "${BOLD}${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
      echo -e "${BOLD}${CYAN}ðŸ‘‘ Lesson from Mistress Louiza${NC}"
      echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
      echo ""
      echo -e "${BOLD}ðŸ’¬ From Mistress Louiza:${NC}"
      echo ""
      
      # Get lesson
      if [[ "$critique_mode" == "true" ]]; then
        echo ""
        echo -e "${BOLD}${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
        echo -e "${BOLD}${CYAN}ðŸ“Š Gathering your Greek study data for critique...${NC}"
        echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
        echo ""
      fi
      
      echo -e "${BOLD}${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
      echo -e "${BOLD}${CYAN}ðŸ‘‘ Lesson from Mistress Louiza${NC}"
      echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
      echo ""
      echo -e "${BOLD}ðŸ’¬ From Mistress Louiza:${NC}"
      echo ""
      
      local lesson=$(get_greek_lesson "$topic" "" "$critique_mode")
      
      if [[ -n "$lesson" ]]; then
        if [[ "$critique_mode" == "true" ]]; then
          echo -e "${BOLD}${YELLOW}ðŸ“Š Personalized Critique from Mistress Louiza:${NC}"
          echo ""
        fi
        echo "$lesson" | sed 's/^/   /'
        echo ""
        echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
        echo ""
        
        # Q&A session (especially important for critiques)
        handle_qa_session "$topic" "$critique_mode"
        
        echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
        echo ""
        
        # Save to study notes (always save automatically)
        local note_file=$(create_study_note "$topic" "$lesson")
        echo -e "${GREEN}âœ“${NC} Study note saved: $(basename "$note_file")"
        echo ""
        echo -e "${CYAN}ðŸ’¡ Note: This note can be reviewed by Mistress Louiza during personalized critique${NC}"
        echo ""
        
        # Track study session
        echo -n "How many minutes did you study? (0 to skip): "
        read duration
        if [[ "$duration" =~ ^[0-9]+$ ]]; then
          track_study_session "$topic" "$duration"
          echo -e "${GREEN}âœ“${NC} Study session tracked"
        fi
        echo ""
        
        echo -e "${BOLD}Next steps:${NC}"
        echo "   â€¢ Practice what you learned"
        echo "   â€¢ Review your notes: ${note_file}"
        echo "   â€¢ Log your practice: addInfoToDailyLog \"Greek practice: ${topic}\""
        echo ""
        
        echo -e "${BOLD}Want another lesson?${NC}"
        echo -e "${GREEN}y${NC} - Another lesson"
        echo -e "${GREEN}n${NC} - Return to menu"
        echo ""
        read -p "Choice: " more
        if [[ "$more" != "y" ]]; then
          topic=""
        fi
      else
        echo "âš ï¸  Could not get lesson. Check LM Studio connection."
        echo ""
        read -p "Press Enter to continue..."
        topic=""
      fi
    done
  else
    # Direct topic mode
    echo ""
    echo -e "${BOLD}${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo -e "${BOLD}${CYAN}ðŸ‘‘ Lesson from Mistress Louiza${NC}"
    echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo ""
    echo -e "${BOLD}ðŸ’¬ From Mistress Louiza:${NC}"
    echo ""
    
    local lesson=$(get_greek_lesson "$topic" "")
    
    if [[ -n "$lesson" ]]; then
      echo "$lesson" | sed 's/^/   /'
      echo ""
      echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
      echo ""
      
      # Save to study notes
      local note_file=$(create_study_note "$topic" "$lesson")
      echo -e "${GREEN}âœ“${NC} Study note saved: $(basename "$note_file")"
      echo ""
      
      # Track lesson (non-interactive mode, default duration)
      track_study_session "$topic" "15"
    else
      echo "âš ï¸  Could not get lesson. Check LM Studio connection."
      exit 1
    fi
  fi
}

# Show usage
show_usage() {
  cat <<EOF
Usage: gtd-learn-greek [topic]

Learn Greek language (reading and understanding) with Mistress Louiza as your instructor.

Topics:
  basics, intro         - Greek introduction and basics
  alphabet, letters     - Learn the Greek alphabet (24 letters)
  reading, read         - Learn how to read Greek
  vocabulary, vocab     - Build Greek vocabulary
  grammar               - Learn Greek grammar basics
  verbs                 - Learn about Greek verbs and conjugation
  nouns, cases          - Learn about Greek nouns and cases
  comprehension         - Develop reading comprehension
  pronunciation         - Learn Greek pronunciation
  practice              - Hands-on practice exercise

Examples:
  gtd-learn-greek              # Interactive menu
  gtd-learn-greek alphabet      # Learn the Greek alphabet
  gtd-learn-greek reading       # Learn how to read Greek
  gtd-learn-greek vocabulary    # Build vocabulary

Features:
  â€¢ Mistress Louiza teaches Greek language concepts
  â€¢ Automatic study note creation
  â€¢ Progress tracking integrated with GTD
  â€¢ Practice exercises
  â€¢ Habit tracking integration

Study notes saved to: ${GREEK_STUDY_DIR}/notes/
Progress tracked in: ${GREEK_STUDY_DIR}/progress/

EOF
}

# Handle arguments
case "$1" in
  --help|-h)
    show_usage
    exit 0
    ;;
  "")
    main ""
    ;;
  *)
    main "$1"
    ;;
esac

