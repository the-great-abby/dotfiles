#!/bin/bash
# GTD Check-In - Morning and Evening Check-In Process

# Source common GTD helpers
GTD_COMMON="$HOME/code/dotfiles/bin/gtd-common.sh"
if [[ ! -f "$GTD_COMMON" && -f "$HOME/code/personal/dotfiles/bin/gtd-common.sh" ]]; then
  GTD_COMMON="$HOME/code/personal/dotfiles/bin/gtd-common.sh"
fi
if [[ -f "$GTD_COMMON" ]]; then
  source "$GTD_COMMON"
else
  echo "Warning: gtd-common.sh not found. Some features may not work." >&2
fi

# Load daily log config
DAILY_LOG_CONFIG="$HOME/.daily_log_config"
if [[ -f "$HOME/code/dotfiles/zsh/.daily_log_config" ]]; then
  DAILY_LOG_CONFIG="$HOME/code/dotfiles/zsh/.daily_log_config"
elif [[ -f "$HOME/code/personal/dotfiles/zsh/.daily_log_config" ]]; then
  DAILY_LOG_CONFIG="$HOME/code/personal/dotfiles/zsh/.daily_log_config"
fi

if [[ -f "$DAILY_LOG_CONFIG" ]]; then
  source "$DAILY_LOG_CONFIG"
fi

# Additional paths
DAILY_LOG_DIR="${DAILY_LOG_DIR:-$HOME/Documents/daily_logs}"
HABITS_PATH="${GTD_BASE_DIR}/habits"
TASKS_PATH="${GTD_BASE_DIR}/${GTD_TASKS_DIR:-1-tasks}"
PROJECTS_PATH="${GTD_BASE_DIR}/${GTD_PROJECTS_DIR:-3-projects}"
INBOX_PATH="${GTD_BASE_DIR}/${GTD_INBOX_DIR:-0-inbox}"

# Use common date helpers
TODAY=$(gtd_get_today)
NOW=$(gtd_get_current_time)
DATE_CMD=$(gtd_get_date_cmd)
DAY_OF_WEEK=$($DATE_CMD +"%A")

# Find persona helper for AI suggestions
PERSONA_HELPER=""
POSSIBLE_PATHS=(
  "$HOME/code/personal/dotfiles/zsh/functions/gtd_persona_helper.py"
  "$HOME/code/dotfiles/zsh/functions/gtd_persona_helper.py"
)

for path in "${POSSIBLE_PATHS[@]}"; do
  if [[ -f "$path" ]]; then
    PERSONA_HELPER="$path"
    break
  fi
done

# Get AI suggestions based on recent log entries
get_ai_suggestions() {
  local review_type="${1:-morning}"  # morning or evening
  local days_back="${2:-3}"  # How many days to analyze
  
  if [[ -z "$PERSONA_HELPER" || ! -f "$PERSONA_HELPER" ]]; then
    return 1  # Persona helper not available
  fi
  
  local PYTHON_CMD=$(gtd_get_mcp_python)
  if [[ -z "$PYTHON_CMD" ]]; then
    return 1  # Python not available
  fi
  
  # Collect recent log entries
  local log_content=""
  local entry_count=0
  
  for i in $(seq 0 $((days_back - 1))); do
    local check_date=""
    if [[ "$(uname)" == "Darwin" ]]; then
      check_date=$($DATE_CMD -v-${i}d +"%Y-%m-%d" 2>/dev/null || echo "")
    else
      check_date=$($DATE_CMD -d "-${i} days" +"%Y-%m-%d" 2>/dev/null || echo "")
    fi
    
    if [[ -n "$check_date" ]]; then
      local log_file="${DAILY_LOG_DIR}/${check_date}.md"
      if [[ -f "$log_file" ]]; then
        # Extract log entries (lines with timestamps)
        local entries=$(grep "^[0-9][0-9]:[0-9][0-9] -" "$log_file" 2>/dev/null | head -20)
        if [[ -n "$entries" ]]; then
          if [[ -n "$log_content" ]]; then
            log_content="${log_content}\n\n--- ${check_date} ---\n${entries}"
          else
            log_content="--- ${check_date} ---\n${entries}"
          fi
          local count=$(echo "$entries" | wc -l | tr -d ' ')
          entry_count=$((entry_count + count))
        fi
      fi
    fi
  done
  
  # Only get suggestions if we have log entries
  if [[ -z "$log_content" || $entry_count -eq 0 ]]; then
    return 1
  fi
  
  # Determine persona based on review type
  local persona="hank"  # Default to Hank for general advice
  if [[ "$review_type" == "morning" ]]; then
    persona="hank"  # Practical morning advice
  else
    persona="louiza"  # Accountability for evening
  fi
  
  # Create prompt based on review type
  local prompt=""
  if [[ "$review_type" == "morning" ]]; then
    prompt=$(printf "Based on my recent daily log entries from the last %d days, provide 2-3 brief, actionable suggestions for today. Focus on priorities, patterns you notice, and what I should focus on. Keep it concise and practical.\n\nRecent log entries:\n%s" "$days_back" "$log_content")
  else
    prompt=$(printf "Based on my recent daily log entries from the last %d days, provide 2-3 brief suggestions for improvement, patterns you notice, and what I should focus on tomorrow. Be encouraging but honest. Keep it concise.\n\nRecent log entries:\n%s" "$days_back" "$log_content")
  fi
  
  # Get AI suggestion (persona helper expects prompt as second argument)
  # Use timeout if available to prevent hanging
  local suggestion=""
  # Use printf %q to properly quote the prompt for command line
  local quoted_prompt=$(printf '%q' "$prompt")
  if command -v gtimeout &>/dev/null; then
    suggestion=$(eval "gtimeout 15 $PYTHON_CMD \"$PERSONA_HELPER\" \"$persona\" $quoted_prompt" 2>/dev/null || echo "")
  elif command -v timeout &>/dev/null; then
    suggestion=$(eval "timeout 15 $PYTHON_CMD \"$PERSONA_HELPER\" \"$persona\" $quoted_prompt" 2>/dev/null || echo "")
  else
    # No timeout available, just try to get suggestion (may take a while)
    suggestion=$(eval "$PYTHON_CMD \"$PERSONA_HELPER\" \"$persona\" $quoted_prompt" 2>/dev/null || echo "")
  fi
  
  # Clean up the suggestion (persona helper adds header, we want just the advice)
  if [[ -n "$suggestion" ]]; then
    # Extract just the advice content (between the divider lines)
    # Also remove any line numbers or debug output that might have leaked through
    suggestion=$(echo "$suggestion" | sed -n '/^â”/,/^â”/p' | sed '1d;$d' | sed '/^$/d' | grep -v '^[[:space:]]*[0-9]\+[[:space:]]*$' | grep -v '^@make' | grep -v '^([0-9]\+-[0-9]\+)')
  fi
  
  if [[ -n "$suggestion" && ${#suggestion} -gt 20 ]]; then
    echo "$suggestion"
    return 0
  fi
  
  return 1
}

# Review pending AI suggestions
review_pending_suggestions() {
  clear
  echo ""
  gtd_print_header "ðŸ“‹ Review Pending Suggestions" "" "$CYAN"
  
  SUGGESTIONS_DIR="${GTD_BASE_DIR}/suggestions"
  if [[ ! -d "$SUGGESTIONS_DIR" ]]; then
    gtd_print_info "No suggestions directory found. No pending suggestions."
    echo ""
    echo "Press Enter to continue..."
    read
    return 0
  fi
  
  local pending_count=0
  local suggestions=()
  
  # Find all pending suggestions
  for suggestion_file in "$SUGGESTIONS_DIR"/*.json; do
    if [[ -f "$suggestion_file" ]]; then
      local status=$(grep -o '"status":\s*"[^"]*"' "$suggestion_file" 2>/dev/null | cut -d'"' -f4)
      if [[ "$status" == "pending" ]]; then
        suggestions+=("$suggestion_file")
        ((pending_count++))
      fi
    fi
  done
  
  if [[ $pending_count -eq 0 ]]; then
    gtd_print_success "No pending suggestions!"
    echo ""
    echo "Press Enter to continue..."
    read
    return 0
  fi
  
  echo "You have $pending_count pending suggestion(s)."
  echo ""
  echo "Processing suggestions..."
  echo ""
  
  for suggestion_file in "${suggestions[@]}"; do
    local suggestion_id=$(basename "$suggestion_file" .json)
    local title=$(grep -o '"title":\s*"[^"]*"' "$suggestion_file" 2>/dev/null | cut -d'"' -f4)
    local reason=$(grep -o '"reason":\s*"[^"]*"' "$suggestion_file" 2>/dev/null | cut -d'"' -f4)
    local confidence=$(grep -o '"confidence":\s*[0-9.]*' "$suggestion_file" 2>/dev/null | cut -d':' -f2 | tr -d ' ')
    
    gtd_print_divider "â”" 70 "$CYAN"
    echo "ðŸ’¡ Suggestion: $title"
    echo "   Reason: $reason"
    echo "   Confidence: $confidence"
    echo ""
    echo "What would you like to do?"
    echo ""
    echo "  1) Create task from suggestion"
    echo "  2) Dismiss suggestion"
    echo "  3) Skip (view next)"
    echo ""
    echo -n "Choose: "
    read suggestion_choice
    
    case "$suggestion_choice" in
      1)
        # Create task using gtd-task
        echo ""
        echo "Creating task..."
        if command -v gtd-task &>/dev/null; then
          gtd-task add --non-interactive "$title" 2>&1
        elif [[ -f "$HOME/code/dotfiles/bin/gtd-task" ]]; then
          "$HOME/code/dotfiles/bin/gtd-task" add --non-interactive "$title" 2>&1
        elif [[ -f "$HOME/code/personal/dotfiles/bin/gtd-task" ]]; then
          "$HOME/code/personal/dotfiles/bin/gtd-task" add --non-interactive "$title" 2>&1
        fi
        
        if [[ $? -eq 0 ]]; then
          # Mark suggestion as accepted
          local PYTHON_CMD=$(gtd_get_mcp_python)
          if [[ -z "$PYTHON_CMD" ]]; then
            PYTHON_CMD="python3"
          fi
          
          if command -v "$PYTHON_CMD" &>/dev/null; then
            suggestion_type=$("$PYTHON_CMD" -c "
import json
file = '$suggestion_file'
with open(file, 'r') as f:
    data = json.load(f)
data['status'] = 'accepted'
suggestion_type = data.get('type', 'task')
with open(file, 'w') as f:
    json.dump(data, f, indent=2)
print(suggestion_type)
" 2>/dev/null)
            
            # Track suggestion acceptance for preferences learning
            if command -v gtd-preferences-learn &>/dev/null; then
              gtd-preferences-learn track-feature "suggestion" "$suggestion_type" "accepted" 2>/dev/null || true
            fi
          fi
          gtd_print_success "Task created from suggestion"
        else
          gtd_print_error "Failed to create task"
        fi
        ;;
      2)
        # Mark as dismissed
        local PYTHON_CMD=$(gtd_get_mcp_python)
        if [[ -z "$PYTHON_CMD" ]]; then
          PYTHON_CMD="python3"
        fi
        
        if command -v "$PYTHON_CMD" &>/dev/null; then
          suggestion_type=$("$PYTHON_CMD" -c "
import json
file = '$suggestion_file'
with open(file, 'r') as f:
    data = json.load(f)
data['status'] = 'dismissed'
suggestion_type = data.get('type', 'task')
with open(file, 'w') as f:
    json.dump(data, f, indent=2)
print(suggestion_type)
" 2>/dev/null)
          
          # Track suggestion dismissal for preferences learning
          if command -v gtd-preferences-learn &>/dev/null; then
            gtd-preferences-learn track-feature "suggestion" "$suggestion_type" "dismissed" 2>/dev/null || true
          fi
          
          gtd_print_success "Suggestion dismissed"
        fi
        ;;
      3|"")
        echo "â†’ Skipping..."
        ;;
      *)
        echo "Invalid choice, skipping..."
        ;;
    esac
    echo ""
  done
  
  echo ""
  echo "Press Enter to continue..."
  read
}

# Morning check-in
morning_checkin() {
  clear
  echo ""
  echo -e "${BOLD}${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
  echo -e "${BOLD}${CYAN}ðŸŒ… Morning Check-In - ${TODAY} (${DAY_OF_WEEK})${NC}"
  echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
  echo ""
  
  # System status
  echo -e "${BOLD}ðŸ“Š Quick Status${NC}"
  echo ""
  
  local inbox_count=$(find "$INBOX_PATH" -type f -name "*.md" 2>/dev/null | wc -l | tr -d ' ')
  local active_tasks=$(find "$TASKS_PATH" -type f -name "*.md" -exec grep -l "^status: active" {} \; 2>/dev/null | wc -l | tr -d ' ')
  local active_projects=$(find "$PROJECTS_PATH" -type d -mindepth 1 -maxdepth 1 2>/dev/null | wc -l | tr -d ' ')
  
  echo "  ðŸ“¥ Inbox: ${inbox_count} item(s)"
  echo "  âœ… Active tasks: ${active_tasks}"
  echo "  ðŸ“ Active projects: ${active_projects}"
  echo ""
  
  # Habits due
  if [[ -d "$HABITS_PATH" ]]; then
    local due_habits=0
    local habit_list=""
    for habit_file in "$HABITS_PATH"/*.md; do
      [[ ! -f "$habit_file" ]] && continue
      local status=$(grep "^status:" "$habit_file" 2>/dev/null | cut -d':' -f2 | sed 's/^[[:space:]]*//' || echo "active")
      if [[ "$status" == "active" ]]; then
        local frequency=$(grep "^frequency:" "$habit_file" 2>/dev/null | cut -d':' -f2 | sed 's/^[[:space:]]*//' || echo "")
        local last_completed=$(grep "^last_completed:" "$habit_file" 2>/dev/null | cut -d':' -f2 | sed 's/^[[:space:]]*//' || echo "")
        if [[ "$frequency" == "daily" && "$last_completed" != "$TODAY" ]]; then
          ((due_habits++))
          local habit_name=$(grep "^name:" "$habit_file" 2>/dev/null | cut -d':' -f2 | sed 's/^[[:space:]]*//' || basename "$habit_file" .md)
          habit_list="${habit_list}  â€¢ ${habit_name}\n"
        fi
      fi
    done
    
    if [[ $due_habits -gt 0 ]]; then
      echo -e "${YELLOW}ðŸ” Habits Due Today:${NC}"
      echo ""
      echo -e "$habit_list"
    fi
  fi
  
  echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
  echo ""
  
  # AI Suggestions based on recent logs
  echo -e "${BOLD}ðŸ¤– AI Suggestions (Based on Recent Logs)${NC}"
  echo ""
  
  local ai_suggestions=$(get_ai_suggestions "morning" 3)
  if [[ -n "$ai_suggestions" ]]; then
    echo -e "${CYAN}$ai_suggestions${NC}"
    echo ""
  else
    echo -e "${YELLOW}  (No suggestions available - try logging more entries)${NC}"
    echo ""
  fi
  
  echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
  echo ""
  
  # Morning questions
  echo -e "${BOLD}ðŸ’­ Morning Reflection${NC}"
  echo ""
  
  echo "1. How am I feeling this morning? (energy, mood, readiness)"
  read -p "   " morning_feeling
  echo ""
  
  echo "2. What are my top 3 priorities for today?"
  read -p "   Priority 1: " priority1
  read -p "   Priority 2: " priority2
  read -p "   Priority 3: " priority3
  echo ""
  
  echo "3. What do I need to accomplish today?"
  read -p "   " today_goals
  echo ""
  
  echo "4. What might get in my way today? (blockers, distractions)"
  read -p "   " blockers
  echo ""
  
  echo "5. What am I grateful for today?"
  read -p "   " gratitude
  echo ""
  
  # Optional weather logging
  echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
  echo -e "${BOLD}ðŸŒ¤ï¸  Weather Conditions${NC}"
  echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
  echo ""
  echo -e "${CYAN}ðŸ’¡ Tip:${NC} Logging weather helps identify patterns with"
  echo "   energy levels, mood, and productivity."
  echo ""
  read -p "Log current weather? (y/n, default n): " log_weather
  
  if [[ "$log_weather" == "y" || "$log_weather" == "Y" ]]; then
    if command -v gtd-log-weather &>/dev/null; then
      gtd-log-weather
    elif [[ -f "$HOME/code/dotfiles/bin/gtd-log-weather" ]]; then
      "$HOME/code/dotfiles/bin/gtd-log-weather"
    elif [[ -f "$HOME/code/personal/dotfiles/bin/gtd-log-weather" ]]; then
      "$HOME/code/personal/dotfiles/bin/gtd-log-weather"
    else
      echo "âš ï¸  Weather logging not available (gtd-log-weather command not found)"
    fi
    echo ""
  fi
  
  # Habit check-in
  echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
  echo -e "${BOLD}ðŸ” Morning Habits${NC}"
  echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
  echo ""
  
  if [[ -d "$HABITS_PATH" ]]; then
    local morning_habits=0
    for habit_file in "$HABITS_PATH"/*.md; do
      [[ ! -f "$habit_file" ]] && continue
      local status=$(grep "^status:" "$habit_file" 2>/dev/null | cut -d':' -f2 | sed 's/^[[:space:]]*//' || echo "active")
      if [[ "$status" == "active" ]]; then
        local time_of_day=$(grep "^time_of_day:" "$habit_file" 2>/dev/null | cut -d':' -f2 | sed 's/^[[:space:]]*//' || echo "")
        if [[ "$time_of_day" == "morning" || -z "$time_of_day" ]]; then
          local habit_name=$(grep "^name:" "$habit_file" 2>/dev/null | cut -d':' -f2 | sed 's/^[[:space:]]*//' || basename "$habit_file" .md)
          local last_completed=$(grep "^last_completed:" "$habit_file" 2>/dev/null | cut -d':' -f2 | sed 's/^[[:space:]]*//' || echo "")
          
          if [[ "$last_completed" != "$TODAY" ]]; then
            ((morning_habits++))
            echo -n "  Complete '${habit_name}'? (y/n): "
            read complete_habit
            if [[ "$complete_habit" == "y" || "$complete_habit" == "Y" ]]; then
              gtd-habit log "$habit_name" 2>/dev/null || echo "  âœ“ Logged: $habit_name"
            else
              # User said no - just add a newline for clean output
              echo ""
            fi
          fi
        fi
      fi
    done
    
    if [[ $morning_habits -eq 0 ]]; then
      echo "  No morning habits due"
      echo ""
    fi
  else
    echo "  No habits defined yet"
    echo ""
  fi
  
  # Save to daily log
  local log_file="${DAILY_LOG_DIR}/${TODAY}.md"
  mkdir -p "$DAILY_LOG_DIR"
  
  if [[ ! -f "$log_file" ]]; then
    echo "# Daily Log - $TODAY" > "$log_file"
    echo "" >> "$log_file"
  fi
  
  # Get AI suggestions for log
  local ai_suggestions_log=$(get_ai_suggestions "morning" 3)
  
  cat >> "$log_file" <<EOF
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ðŸŒ… Morning Check-In - ${NOW}
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

How I'm feeling: ${morning_feeling}

Top 3 Priorities:
1. ${priority1}
2. ${priority2}
3. ${priority3}

Today's Goals: ${today_goals}

Potential Blockers: ${blockers}

Gratitude: ${gratitude}

EOF

  if [[ -n "$ai_suggestions_log" ]]; then
    cat >> "$log_file" <<EOF
ðŸ¤– AI Suggestions:
${ai_suggestions_log}

EOF
  fi
  
  echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
  echo ""
  echo "âœ“ Morning check-in saved to daily log"
  echo ""
  
  # Small delay to ensure all output is flushed before showing quick actions
  sleep 0.1
  
  # Check for pending suggestions
  SUGGESTIONS_DIR="${GTD_BASE_DIR}/suggestions"
  local pending_suggestions_count=0
  if [[ -d "$SUGGESTIONS_DIR" ]]; then
    pending_suggestions_count=$(find "$SUGGESTIONS_DIR" -name "*.json" -exec grep -l '"status":\s*"pending"' {} \; 2>/dev/null | wc -l | tr -d ' ')
  fi
  
  # Offer quick actions (ensure clean output, no line numbers or debug info)
  echo "Quick actions:"
  echo "  1) Process inbox (${inbox_count} items)"
  echo "  2) View today's tasks"
  echo "  3) View habit dashboard"
  if [[ $pending_suggestions_count -gt 0 ]]; then
    echo "  4) âš¡ Review high-confidence suggestions ($pending_suggestions_count)"
    echo "  5) ðŸ“‹ Review mode - Medium-confidence suggestions"
    echo "  6) Continue"
  else
    echo "  4) âš¡ Review high-confidence suggestions"
    echo "  5) ðŸ“‹ Review mode - Medium-confidence suggestions"
    echo "  6) Continue"
  fi
  echo ""
  read -p "Choose (1-6): " quick_action
  
  case "$quick_action" in
    1)
      if [[ $inbox_count -gt 0 ]]; then
        gtd-process
      else
        echo "Inbox is empty!"
      fi
      ;;
    2)
      # Show tasks and then offer to view details
      local temp_list=$(mktemp)
      gtd-task list --status=active > "$temp_list" 2>&1
      cat "$temp_list"
      
      # Extract task IDs from the list output
      local task_ids=()
      while IFS= read -r line; do
        if [[ "$line" =~ ^[[:space:]]*ID:[[:space:]]+(.+)$ ]]; then
          task_ids+=("${BASH_REMATCH[1]}")
        fi
      done < "$temp_list"
      
      echo ""
      echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
      echo "ðŸ“‹ Task Actions"
      echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
      echo ""
      
      if [[ ${#task_ids[@]} -gt 0 ]]; then
        echo "Would you like to view a task in detail?"
        echo "  Enter task number (1-${#task_ids[@]}) to view in editor"
        echo "  Or press Enter to continue"
        echo ""
        read -p "Task number (or Enter to skip): " task_choice
        
        if [[ -n "$task_choice" && "$task_choice" =~ ^[0-9]+$ ]]; then
          local selected_idx=$((task_choice - 1))
          if [[ $selected_idx -ge 0 && $selected_idx -lt ${#task_ids[@]} ]]; then
            local selected_task_id="${task_ids[$selected_idx]}"
            
            # Find the task file
            local task_file=""
            if [[ -d "$TASKS_PATH" ]]; then
              task_file=$(find "$TASKS_PATH" -name "${selected_task_id}*.md" -type f 2>/dev/null | head -1)
            fi
            if [[ -z "$task_file" ]] && [[ -d "$PROJECTS_PATH" ]]; then
              task_file=$(find "$PROJECTS_PATH" -name "${selected_task_id}*.md" ! -name "README.md" 2>/dev/null | head -1)
            fi
            
            if [[ -n "$task_file" && -f "$task_file" ]]; then
              echo ""
              echo "Opening task in editor..."
              echo "Tip: Press :q to exit (read-only) or :wq to save changes"
              echo ""
              echo "Press Enter to continue..."
              read
              
              # Use vim in read-only mode by default, but allow editing
              local editor="${EDITOR:-vim}"
              if command -v "$editor" &>/dev/null; then
                "$editor" "$task_file"
              else
                # Fallback to cat if no editor
                cat "$task_file"
                echo ""
                echo "Press Enter to continue..."
                read
              fi
            else
              echo "âŒ Could not find task file for: $selected_task_id"
              echo "Press Enter to continue..."
              read
            fi
          else
            echo "âŒ Invalid task number. Please select 1-${#task_ids[@]}"
            echo "Press Enter to continue..."
            read
          fi
        fi
      fi
      
      rm -f "$temp_list"
      ;;
    3)
      gtd-habit dashboard
      ;;
    4)
      # High-confidence suggestions (one-keystroke)
      if command -v gtd-smart-suggestions &>/dev/null; then
        gtd-smart-suggestions immediate
      elif [[ -f "$HOME/code/dotfiles/bin/gtd-smart-suggestions" ]]; then
        "$HOME/code/dotfiles/bin/gtd-smart-suggestions" immediate
      else
        review_pending_suggestions
      fi
      ;;
    5)
      # Review mode for medium-confidence
      if command -v gtd-smart-suggestions &>/dev/null; then
        gtd-smart-suggestions review
      elif [[ -f "$HOME/code/dotfiles/bin/gtd-smart-suggestions" ]]; then
        "$HOME/code/dotfiles/bin/gtd-smart-suggestions" review
      else
        review_pending_suggestions
      fi
      ;;
  esac
  
  echo ""
  echo "Have a productive day! ðŸŒ…"
}

# Evening check-in
evening_checkin() {
  clear
  echo ""
  echo -e "${BOLD}${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
  echo -e "${BOLD}${CYAN}ðŸŒ™ Evening Check-In - ${TODAY} (${DAY_OF_WEEK})${NC}"
  echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
  echo ""
  
  # Sync Apple Health data (if available)
  if command -v gtd-sync-health &>/dev/null || [[ -f "$HOME/code/dotfiles/bin/gtd-sync-health" ]] || [[ -f "$HOME/code/personal/dotfiles/bin/gtd-sync-health" ]]; then
    echo -e "${CYAN}ðŸ“Š Syncing Apple Health data...${NC}"
    if command -v gtd-sync-health &>/dev/null; then
      gtd-sync-health
    elif [[ -f "$HOME/code/dotfiles/bin/gtd-sync-health" ]]; then
      "$HOME/code/dotfiles/bin/gtd-sync-health"
    elif [[ -f "$HOME/code/personal/dotfiles/bin/gtd-sync-health" ]]; then
      "$HOME/code/personal/dotfiles/bin/gtd-sync-health"
    fi
    echo ""
  fi
  
  # AI Suggestions based on recent logs
  echo -e "${BOLD}ðŸ¤– AI Suggestions (Based on Recent Logs)${NC}"
  echo ""
  
  local ai_suggestions=$(get_ai_suggestions "evening" 3)
  if [[ -n "$ai_suggestions" ]]; then
    echo -e "${CYAN}$ai_suggestions${NC}"
    echo ""
  else
    echo -e "${YELLOW}  (No suggestions available - try logging more entries)${NC}"
    echo ""
  fi
  
  echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
  echo ""
  
  # Evening questions
  echo -e "${BOLD}ðŸ’­ Evening Reflection${NC}"
  echo ""
  
  echo "1. What did I accomplish today?"
  read -p "   " accomplishments
  echo ""
  
  echo "2. What went well today?"
  read -p "   " went_well
  echo ""
  
  echo "3. What could have gone better?"
  read -p "   " could_improve
  echo ""
  
  echo "4. Did I complete my top priorities?"
  read -p "   " priorities_completed
  echo ""
  
  echo "5. What am I grateful for today?"
  read -p "   " evening_gratitude
  echo ""
  
  echo "6. What did I learn today?"
  read -p "   " learned
  echo ""
  
  # Habit check-in
  echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
  echo -e "${BOLD}ðŸ” Evening Habits${NC}"
  echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
  echo ""
  
  if [[ -d "$HABITS_PATH" ]]; then
    local evening_habits=0
    for habit_file in "$HABITS_PATH"/*.md; do
      [[ ! -f "$habit_file" ]] && continue
      local status=$(grep "^status:" "$habit_file" 2>/dev/null | cut -d':' -f2 | sed 's/^[[:space:]]*//' || echo "active")
      if [[ "$status" == "active" ]]; then
        local time_of_day=$(grep "^time_of_day:" "$habit_file" 2>/dev/null | cut -d':' -f2 | sed 's/^[[:space:]]*//' || echo "")
        if [[ "$time_of_day" == "evening" || -z "$time_of_day" ]]; then
          local habit_name=$(grep "^name:" "$habit_file" 2>/dev/null | cut -d':' -f2 | sed 's/^[[:space:]]*//' || basename "$habit_file" .md)
          local last_completed=$(grep "^last_completed:" "$habit_file" 2>/dev/null | cut -d':' -f2 | sed 's/^[[:space:]]*//' || echo "")
          
          if [[ "$last_completed" != "$TODAY" ]]; then
            ((evening_habits++))
            echo -n "  Complete '${habit_name}'? (y/n): "
            read complete_habit
            if [[ "$complete_habit" == "y" || "$complete_habit" == "Y" ]]; then
              gtd-habit log "$habit_name" 2>/dev/null || echo "  âœ“ Logged: $habit_name"
            fi
            echo ""
          fi
        fi
      fi
    done
    
    if [[ $evening_habits -eq 0 ]]; then
      echo "  No evening habits due"
      echo ""
    fi
  else
    echo "  No habits defined yet"
    echo ""
  fi
  
  # Review areas
  echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
  echo -e "${BOLD}ðŸŽ¯ Areas Check${NC}"
  echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
  echo ""
  echo "Which areas got attention today?"
  read -p "   " areas_attention
  echo ""
  
  # Tomorrow preview
  echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
  echo -e "${BOLD}ðŸ“… Tomorrow Preview${NC}"
  echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
  echo ""
  echo "What's important for tomorrow?"
  read -p "   " tomorrow_preview
  echo ""
  
  # Save to daily log
  local log_file="${DAILY_LOG_DIR}/${TODAY}.md"
  mkdir -p "$DAILY_LOG_DIR"
  
  if [[ ! -f "$log_file" ]]; then
    echo "# Daily Log - $TODAY" > "$log_file"
    echo "" >> "$log_file"
  fi
  
  # Get AI suggestions for log
  local ai_suggestions_log=$(get_ai_suggestions "evening" 3)
  
  cat >> "$log_file" <<EOF
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ðŸŒ™ Evening Check-In - ${NOW}
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

Accomplishments: ${accomplishments}

What Went Well: ${went_well}

Could Improve: ${could_improve}

Priorities Completed: ${priorities_completed}

Gratitude: ${evening_gratitude}

Learned: ${learned}

Areas Attention: ${areas_attention}

Tomorrow Preview: ${tomorrow_preview}

EOF

  if [[ -n "$ai_suggestions_log" ]]; then
    cat >> "$log_file" <<EOF
ðŸ¤– AI Suggestions:
${ai_suggestions_log}

EOF
  fi
  
  echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
  echo ""
  echo "âœ“ Evening check-in saved to daily log"
  echo ""
  
  # Check for pending suggestions
  SUGGESTIONS_DIR="${GTD_BASE_DIR}/suggestions"
  local pending_suggestions_count=0
  if [[ -d "$SUGGESTIONS_DIR" ]]; then
    pending_suggestions_count=$(find "$SUGGESTIONS_DIR" -name "*.json" -exec grep -l '"status":\s*"pending"' {} \; 2>/dev/null | wc -l | tr -d ' ')
  fi
  
  # Offer quick actions
  echo "Quick actions:"
  echo "  1) Review today's log"
  echo "  2) View habit dashboard"
  echo "  3) Plan tomorrow"
  if [[ $pending_suggestions_count -gt 0 ]]; then
    echo "  4) âš¡ Review high-confidence suggestions ($pending_suggestions_count)"
    echo "  5) ðŸ“‹ Review mode - Medium-confidence suggestions"
    echo "  6) Continue"
  else
    echo "  4) âš¡ Review high-confidence suggestions"
    echo "  5) ðŸ“‹ Review mode - Medium-confidence suggestions"
    echo "  6) Continue"
  fi
  echo ""
  read -p "Choose (1-6): " quick_action
  
  case "$quick_action" in
    1)
      gtd-log view "$TODAY"
      ;;
    2)
      gtd-habit dashboard
      ;;
    3)
      echo ""
      echo "Tomorrow is: $($DATE_CMD -v+1d +"%A, %B %d" 2>/dev/null || $DATE_CMD -d "tomorrow" +"%A, %B %d" 2>/dev/null || echo "Tomorrow")"
      echo ""
      echo "What do you want to accomplish tomorrow?"
      read tomorrow_plan
      if [[ -n "$tomorrow_plan" ]]; then
        local tomorrow=$($DATE_CMD -v+1d +"%Y-%m-%d" 2>/dev/null || $DATE_CMD -d "tomorrow" +"%Y-%m-%d" 2>/dev/null || echo "")
        local tomorrow_log="${DAILY_LOG_DIR}/${tomorrow}.md"
        mkdir -p "$DAILY_LOG_DIR"
        if [[ ! -f "$tomorrow_log" ]]; then
          echo "# Daily Log - $tomorrow" > "$tomorrow_log"
          echo "" >> "$tomorrow_log"
        fi
        echo "ðŸ“… Planned: $tomorrow_plan" >> "$tomorrow_log"
        echo "âœ“ Saved to tomorrow's log"
      fi
      ;;
    4)
      review_pending_suggestions
      ;;
  esac
  
  echo ""
  echo "Rest well! ðŸŒ™"
}

# Show usage
show_usage() {
  cat <<EOF
Usage: gtd-checkin [morning|evening]

Commands:
  morning              Morning check-in (default if no time specified)
  evening              Evening check-in
  help                 Show this help

Examples:
  gtd-checkin          # Morning check-in (default)
  gtd-checkin morning  # Morning check-in
  gtd-checkin evening  # Evening check-in

The check-in process helps you:
  â€¢ Reflect on your day
  â€¢ Set priorities
  â€¢ Track habits
  â€¢ Review areas
  â€¢ Plan ahead

All check-ins are automatically saved to your daily log.

EOF
}

# Auto-detect time of day
auto_detect_time() {
  local hour=$($DATE_CMD +"%H" 2>/dev/null || echo "12")
  hour=$((10#$hour))  # Force base 10 interpretation
  
  if [[ $hour -ge 5 && $hour -lt 12 ]]; then
    echo "morning"
  elif [[ $hour -ge 12 && $hour -lt 17 ]]; then
    echo "afternoon"
  elif [[ $hour -ge 17 && $hour -lt 21 ]]; then
    echo "evening"
  else
    echo "evening"  # Default to evening for late night
  fi
}

# Main command handler
case "${1:-}" in
  morning|am)
    morning_checkin
    ;;
  evening|pm|night)
    evening_checkin
    ;;
  help|--help|-h)
    show_usage
    ;;
  "")
    # Auto-detect based on time
    time_of_day=$(auto_detect_time)
    if [[ "$time_of_day" == "morning" ]]; then
      morning_checkin
    else
      echo ""
      echo "What type of check-in?"
      echo "  1) Morning"
      echo "  2) Evening"
      echo ""
      read -p "Choose (1-2): " choice
      case "$choice" in
        1) morning_checkin ;;
        2) evening_checkin ;;
        *) morning_checkin ;;
      esac
    fi
    ;;
  *)
    echo "Unknown command: $1"
    echo ""
    show_usage
    exit 1
    ;;
esac

