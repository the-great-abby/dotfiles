#!/bin/bash
# GTD Check-In - Morning and Evening Check-In Process

# Source common environment (PATH setup)
COMMON_ENV="$HOME/code/dotfiles/zsh/common_env.sh"
if [[ ! -f "$COMMON_ENV" && -f "$HOME/code/personal/dotfiles/zsh/common_env.sh" ]]; then
  COMMON_ENV="$HOME/code/personal/dotfiles/zsh/common_env.sh"
fi
if [[ -f "$COMMON_ENV" ]]; then
  source "$COMMON_ENV"
fi


# Load GTD config
GTD_CONFIG_FILE="$HOME/.gtd_config"
if [[ -f "$HOME/code/dotfiles/zsh/.gtd_config" ]]; then
  GTD_CONFIG_FILE="$HOME/code/dotfiles/zsh/.gtd_config"
elif [[ -f "$HOME/code/personal/dotfiles/zsh/.gtd_config" ]]; then
  GTD_CONFIG_FILE="$HOME/code/personal/dotfiles/zsh/.gtd_config"
fi

if [[ -f "$GTD_CONFIG_FILE" ]]; then
  source "$GTD_CONFIG_FILE"
fi

# Load daily log config
DAILY_LOG_CONFIG="$HOME/.daily_log_config"
if [[ -f "$HOME/code/dotfiles/zsh/.daily_log_config" ]]; then
  DAILY_LOG_CONFIG="$HOME/code/dotfiles/zsh/.daily_log_config"
elif [[ -f "$HOME/code/personal/dotfiles/zsh/.daily_log_config" ]]; then
  DAILY_LOG_CONFIG="$HOME/code/personal/dotfiles/zsh/.daily_log_config"
fi

if [[ -f "$DAILY_LOG_CONFIG" ]]; then
  source "$DAILY_LOG_CONFIG"
fi

# Default values
GTD_BASE_DIR="${GTD_BASE_DIR:-$HOME/Documents/gtd}"
DAILY_LOG_DIR="${DAILY_LOG_DIR:-$HOME/Documents/daily_logs}"
HABITS_PATH="${GTD_BASE_DIR}/habits"
TASKS_PATH="${GTD_BASE_DIR}/tasks"
PROJECTS_PATH="${GTD_BASE_DIR}/${GTD_PROJECTS_DIR:-1-projects}"
AREAS_PATH="${GTD_BASE_DIR}/${GTD_AREAS_DIR:-2-areas}"
INBOX_PATH="${GTD_BASE_DIR}/${GTD_INBOX_DIR:-0-inbox}"

# Colors
CYAN='\033[0;36m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
BOLD='\033[1m'
NC='\033[0m'

# Get date command
get_date_cmd() {
  if [[ -x "/usr/bin/date" ]]; then
    echo "/usr/bin/date"
  elif [[ -x "/bin/date" ]]; then
    echo "/bin/date"
  else
    echo "date"
  fi
}

DATE_CMD=$(get_date_cmd)
TODAY=$($DATE_CMD +"%Y-%m-%d")
NOW=$($DATE_CMD +"%H:%M")
DAY_OF_WEEK=$($DATE_CMD +"%A")

# Morning check-in
morning_checkin() {
  clear
  echo ""
  echo -e "${BOLD}${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
  echo -e "${BOLD}${CYAN}ðŸŒ… Morning Check-In - ${TODAY} (${DAY_OF_WEEK})${NC}"
  echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
  echo ""
  
  # System status
  echo -e "${BOLD}ðŸ“Š Quick Status${NC}"
  echo ""
  
  local inbox_count=$(find "$INBOX_PATH" -type f -name "*.md" 2>/dev/null | wc -l | tr -d ' ')
  local active_tasks=$(find "$TASKS_PATH" -type f -name "*.md" -exec grep -l "^status: active" {} \; 2>/dev/null | wc -l | tr -d ' ')
  local active_projects=$(find "$PROJECTS_PATH" -type d -mindepth 1 -maxdepth 1 2>/dev/null | wc -l | tr -d ' ')
  
  echo "  ðŸ“¥ Inbox: ${inbox_count} item(s)"
  echo "  âœ… Active tasks: ${active_tasks}"
  echo "  ðŸ“ Active projects: ${active_projects}"
  echo ""
  
  # Habits due
  if [[ -d "$HABITS_PATH" ]]; then
    local due_habits=0
    local habit_list=""
    for habit_file in "$HABITS_PATH"/*.md; do
      [[ ! -f "$habit_file" ]] && continue
      local status=$(grep "^status:" "$habit_file" 2>/dev/null | cut -d':' -f2 | sed 's/^[[:space:]]*//' || echo "active")
      if [[ "$status" == "active" ]]; then
        local frequency=$(grep "^frequency:" "$habit_file" 2>/dev/null | cut -d':' -f2 | sed 's/^[[:space:]]*//' || echo "")
        local last_completed=$(grep "^last_completed:" "$habit_file" 2>/dev/null | cut -d':' -f2 | sed 's/^[[:space:]]*//' || echo "")
        if [[ "$frequency" == "daily" && "$last_completed" != "$TODAY" ]]; then
          ((due_habits++))
          local habit_name=$(grep "^name:" "$habit_file" 2>/dev/null | cut -d':' -f2 | sed 's/^[[:space:]]*//' || basename "$habit_file" .md)
          habit_list="${habit_list}  â€¢ ${habit_name}\n"
        fi
      fi
    done
    
    if [[ $due_habits -gt 0 ]]; then
      echo -e "${YELLOW}ðŸ” Habits Due Today:${NC}"
      echo ""
      echo -e "$habit_list"
    fi
  fi
  
  echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
  echo ""
  
  # Morning questions
  echo -e "${BOLD}ðŸ’­ Morning Reflection${NC}"
  echo ""
  
  echo "1. How am I feeling this morning? (energy, mood, readiness)"
  read -p "   " morning_feeling
  echo ""
  
  echo "2. What are my top 3 priorities for today?"
  read -p "   Priority 1: " priority1
  read -p "   Priority 2: " priority2
  read -p "   Priority 3: " priority3
  echo ""
  
  echo "3. What do I need to accomplish today?"
  read -p "   " today_goals
  echo ""
  
  echo "4. What might get in my way today? (blockers, distractions)"
  read -p "   " blockers
  echo ""
  
  echo "5. What am I grateful for today?"
  read -p "   " gratitude
  echo ""
  
  # Habit check-in
  echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
  echo -e "${BOLD}ðŸ” Morning Habits${NC}"
  echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
  echo ""
  
  if [[ -d "$HABITS_PATH" ]]; then
    local morning_habits=0
    for habit_file in "$HABITS_PATH"/*.md; do
      [[ ! -f "$habit_file" ]] && continue
      local status=$(grep "^status:" "$habit_file" 2>/dev/null | cut -d':' -f2 | sed 's/^[[:space:]]*//' || echo "active")
      if [[ "$status" == "active" ]]; then
        local time_of_day=$(grep "^time_of_day:" "$habit_file" 2>/dev/null | cut -d':' -f2 | sed 's/^[[:space:]]*//' || echo "")
        if [[ "$time_of_day" == "morning" || -z "$time_of_day" ]]; then
          local habit_name=$(grep "^name:" "$habit_file" 2>/dev/null | cut -d':' -f2 | sed 's/^[[:space:]]*//' || basename "$habit_file" .md)
          local last_completed=$(grep "^last_completed:" "$habit_file" 2>/dev/null | cut -d':' -f2 | sed 's/^[[:space:]]*//' || echo "")
          
          if [[ "$last_completed" != "$TODAY" ]]; then
            ((morning_habits++))
            echo -n "  Complete '${habit_name}'? (y/n): "
            read complete_habit
            if [[ "$complete_habit" == "y" || "$complete_habit" == "Y" ]]; then
              gtd-habit log "$habit_name" 2>/dev/null || echo "  âœ“ Logged: $habit_name"
            fi
            echo ""
          fi
        fi
      fi
    done
    
    if [[ $morning_habits -eq 0 ]]; then
      echo "  No morning habits due"
      echo ""
    fi
  else
    echo "  No habits defined yet"
    echo ""
  fi
  
  # Save to daily log
  local log_file="${DAILY_LOG_DIR}/${TODAY}.md"
  mkdir -p "$DAILY_LOG_DIR"
  
  if [[ ! -f "$log_file" ]]; then
    echo "# Daily Log - $TODAY" > "$log_file"
    echo "" >> "$log_file"
  fi
  
  cat >> "$log_file" <<EOF
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ðŸŒ… Morning Check-In - ${NOW}
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

How I'm feeling: ${morning_feeling}

Top 3 Priorities:
1. ${priority1}
2. ${priority2}
3. ${priority3}

Today's Goals: ${today_goals}

Potential Blockers: ${blockers}

Gratitude: ${gratitude}

EOF
  
  echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
  echo ""
  echo "âœ“ Morning check-in saved to daily log"
  echo ""
  
  # Offer quick actions
  echo "Quick actions:"
  echo "  1) Process inbox (${inbox_count} items)"
  echo "  2) View today's tasks"
  echo "  3) View habit dashboard"
  echo "  4) Continue"
  echo ""
  read -p "Choose (1-4): " quick_action
  
  case "$quick_action" in
    1)
      if [[ $inbox_count -gt 0 ]]; then
        gtd-process
      else
        echo "Inbox is empty!"
      fi
      ;;
    2)
      gtd-task list --status=active
      ;;
    3)
      gtd-habit dashboard
      ;;
  esac
  
  echo ""
  echo "Have a productive day! ðŸŒ…"
}

# Evening check-in
evening_checkin() {
  clear
  echo ""
  echo -e "${BOLD}${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
  echo -e "${BOLD}${CYAN}ðŸŒ™ Evening Check-In - ${TODAY} (${DAY_OF_WEEK})${NC}"
  echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
  echo ""
  
  # Sync Apple Health data (if available)
  if command -v gtd-sync-health &>/dev/null || [[ -f "$HOME/code/dotfiles/bin/gtd-sync-health" ]] || [[ -f "$HOME/code/personal/dotfiles/bin/gtd-sync-health" ]]; then
    echo -e "${CYAN}ðŸ“Š Syncing Apple Health data...${NC}"
    if command -v gtd-sync-health &>/dev/null; then
      gtd-sync-health
    elif [[ -f "$HOME/code/dotfiles/bin/gtd-sync-health" ]]; then
      "$HOME/code/dotfiles/bin/gtd-sync-health"
    elif [[ -f "$HOME/code/personal/dotfiles/bin/gtd-sync-health" ]]; then
      "$HOME/code/personal/dotfiles/bin/gtd-sync-health"
    fi
    echo ""
  fi
  
  # Evening questions
  echo -e "${BOLD}ðŸ’­ Evening Reflection${NC}"
  echo ""
  
  echo "1. What did I accomplish today?"
  read -p "   " accomplishments
  echo ""
  
  echo "2. What went well today?"
  read -p "   " went_well
  echo ""
  
  echo "3. What could have gone better?"
  read -p "   " could_improve
  echo ""
  
  echo "4. Did I complete my top priorities?"
  read -p "   " priorities_completed
  echo ""
  
  echo "5. What am I grateful for today?"
  read -p "   " evening_gratitude
  echo ""
  
  echo "6. What did I learn today?"
  read -p "   " learned
  echo ""
  
  # Habit check-in
  echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
  echo -e "${BOLD}ðŸ” Evening Habits${NC}"
  echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
  echo ""
  
  if [[ -d "$HABITS_PATH" ]]; then
    local evening_habits=0
    for habit_file in "$HABITS_PATH"/*.md; do
      [[ ! -f "$habit_file" ]] && continue
      local status=$(grep "^status:" "$habit_file" 2>/dev/null | cut -d':' -f2 | sed 's/^[[:space:]]*//' || echo "active")
      if [[ "$status" == "active" ]]; then
        local time_of_day=$(grep "^time_of_day:" "$habit_file" 2>/dev/null | cut -d':' -f2 | sed 's/^[[:space:]]*//' || echo "")
        if [[ "$time_of_day" == "evening" || -z "$time_of_day" ]]; then
          local habit_name=$(grep "^name:" "$habit_file" 2>/dev/null | cut -d':' -f2 | sed 's/^[[:space:]]*//' || basename "$habit_file" .md)
          local last_completed=$(grep "^last_completed:" "$habit_file" 2>/dev/null | cut -d':' -f2 | sed 's/^[[:space:]]*//' || echo "")
          
          if [[ "$last_completed" != "$TODAY" ]]; then
            ((evening_habits++))
            echo -n "  Complete '${habit_name}'? (y/n): "
            read complete_habit
            if [[ "$complete_habit" == "y" || "$complete_habit" == "Y" ]]; then
              gtd-habit log "$habit_name" 2>/dev/null || echo "  âœ“ Logged: $habit_name"
            fi
            echo ""
          fi
        fi
      fi
    done
    
    if [[ $evening_habits -eq 0 ]]; then
      echo "  No evening habits due"
      echo ""
    fi
  else
    echo "  No habits defined yet"
    echo ""
  fi
  
  # Review areas
  echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
  echo -e "${BOLD}ðŸŽ¯ Areas Check${NC}"
  echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
  echo ""
  echo "Which areas got attention today?"
  read -p "   " areas_attention
  echo ""
  
  # Tomorrow preview
  echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
  echo -e "${BOLD}ðŸ“… Tomorrow Preview${NC}"
  echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
  echo ""
  echo "What's important for tomorrow?"
  read -p "   " tomorrow_preview
  echo ""
  
  # Save to daily log
  local log_file="${DAILY_LOG_DIR}/${TODAY}.md"
  mkdir -p "$DAILY_LOG_DIR"
  
  if [[ ! -f "$log_file" ]]; then
    echo "# Daily Log - $TODAY" > "$log_file"
    echo "" >> "$log_file"
  fi
  
  cat >> "$log_file" <<EOF
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ðŸŒ™ Evening Check-In - ${NOW}
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

Accomplishments: ${accomplishments}

What Went Well: ${went_well}

Could Improve: ${could_improve}

Priorities Completed: ${priorities_completed}

Gratitude: ${evening_gratitude}

Learned: ${learned}

Areas Attention: ${areas_attention}

Tomorrow Preview: ${tomorrow_preview}

EOF
  
  echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
  echo ""
  echo "âœ“ Evening check-in saved to daily log"
  echo ""
  
  # Offer quick actions
  echo "Quick actions:"
  echo "  1) Review today's log"
  echo "  2) View habit dashboard"
  echo "  3) Plan tomorrow"
  echo "  4) Continue"
  echo ""
  read -p "Choose (1-4): " quick_action
  
  case "$quick_action" in
    1)
      gtd-log view "$TODAY"
      ;;
    2)
      gtd-habit dashboard
      ;;
    3)
      echo ""
      echo "Tomorrow is: $($DATE_CMD -v+1d +"%A, %B %d" 2>/dev/null || $DATE_CMD -d "tomorrow" +"%A, %B %d" 2>/dev/null || echo "Tomorrow")"
      echo ""
      echo "What do you want to accomplish tomorrow?"
      read tomorrow_plan
      if [[ -n "$tomorrow_plan" ]]; then
        local tomorrow=$($DATE_CMD -v+1d +"%Y-%m-%d" 2>/dev/null || $DATE_CMD -d "tomorrow" +"%Y-%m-%d" 2>/dev/null || echo "")
        local tomorrow_log="${DAILY_LOG_DIR}/${tomorrow}.md"
        mkdir -p "$DAILY_LOG_DIR"
        if [[ ! -f "$tomorrow_log" ]]; then
          echo "# Daily Log - $tomorrow" > "$tomorrow_log"
          echo "" >> "$tomorrow_log"
        fi
        echo "ðŸ“… Planned: $tomorrow_plan" >> "$tomorrow_log"
        echo "âœ“ Saved to tomorrow's log"
      fi
      ;;
  esac
  
  echo ""
  echo "Rest well! ðŸŒ™"
}

# Show usage
show_usage() {
  cat <<EOF
Usage: gtd-checkin [morning|evening]

Commands:
  morning              Morning check-in (default if no time specified)
  evening              Evening check-in
  help                 Show this help

Examples:
  gtd-checkin          # Morning check-in (default)
  gtd-checkin morning  # Morning check-in
  gtd-checkin evening  # Evening check-in

The check-in process helps you:
  â€¢ Reflect on your day
  â€¢ Set priorities
  â€¢ Track habits
  â€¢ Review areas
  â€¢ Plan ahead

All check-ins are automatically saved to your daily log.

EOF
}

# Auto-detect time of day
auto_detect_time() {
  local hour=$($DATE_CMD +"%H" 2>/dev/null || echo "12")
  hour=$((10#$hour))  # Force base 10 interpretation
  
  if [[ $hour -ge 5 && $hour -lt 12 ]]; then
    echo "morning"
  elif [[ $hour -ge 12 && $hour -lt 17 ]]; then
    echo "afternoon"
  elif [[ $hour -ge 17 && $hour -lt 21 ]]; then
    echo "evening"
  else
    echo "evening"  # Default to evening for late night
  fi
}

# Main command handler
case "${1:-}" in
  morning|am)
    morning_checkin
    ;;
  evening|pm|night)
    evening_checkin
    ;;
  help|--help|-h)
    show_usage
    ;;
  "")
    # Auto-detect based on time
    time_of_day=$(auto_detect_time)
    if [[ "$time_of_day" == "morning" ]]; then
      morning_checkin
    else
      echo ""
      echo "What type of check-in?"
      echo "  1) Morning"
      echo "  2) Evening"
      echo ""
      read -p "Choose (1-2): " choice
      case "$choice" in
        1) morning_checkin ;;
        2) evening_checkin ;;
        *) morning_checkin ;;
      esac
    fi
    ;;
  *)
    echo "Unknown command: $1"
    echo ""
    show_usage
    exit 1
    ;;
esac

