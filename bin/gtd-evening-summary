#!/bin/bash
# GTD Evening Summary - Collects and logs daily metrics, sends to Discord
# Usage: gtd-evening-summary [--no-discord] [--force]

# Source common environment (PATH setup)
COMMON_ENV="$HOME/code/dotfiles/zsh/common_env.sh"
if [[ ! -f "$COMMON_ENV" && -f "$HOME/code/personal/dotfiles/zsh/common_env.sh" ]]; then
  COMMON_ENV="$HOME/code/personal/dotfiles/zsh/common_env.sh"
fi
if [[ -f "$COMMON_ENV" ]]; then
  source "$COMMON_ENV"
fi


# Load configs
DAILY_LOG_CONFIG="$HOME/.daily_log_config"
if [[ -f "$HOME/code/dotfiles/zsh/.daily_log_config" ]]; then
  DAILY_LOG_CONFIG="$HOME/code/dotfiles/zsh/.daily_log_config"
elif [[ -f "$HOME/code/personal/dotfiles/zsh/.daily_log_config" ]]; then
  DAILY_LOG_CONFIG="$HOME/code/personal/dotfiles/zsh/.daily_log_config"
fi

if [[ -f "$DAILY_LOG_CONFIG" ]]; then
  source "$DAILY_LOG_CONFIG"
fi

GTD_CONFIG_FILE="$HOME/.gtd_config"
if [[ -f "$HOME/code/dotfiles/zsh/.gtd_config" ]]; then
  GTD_CONFIG_FILE="$HOME/code/dotfiles/zsh/.gtd_config"
elif [[ -f "$HOME/code/personal/dotfiles/zsh/.gtd_config" ]]; then
  GTD_CONFIG_FILE="$HOME/code/personal/dotfiles/zsh/.gtd_config"
fi

if [[ -f "$GTD_CONFIG_FILE" ]]; then
  source "$GTD_CONFIG_FILE"
fi

DAILY_LOG_DIR="${DAILY_LOG_DIR:-$HOME/Documents/daily_logs}"
GTD_BASE_DIR="${GTD_BASE_DIR:-$HOME/Documents/gtd}"

# Get date command
get_date_cmd() {
  if [[ -x "/usr/bin/date" ]]; then
    echo "/usr/bin/date"
  elif [[ -x "/bin/date" ]]; then
    echo "/bin/date"
  else
    echo "date"
  fi
}

DATE_CMD=$(get_date_cmd)
today=$($DATE_CMD +"%Y-%m-%d")
current_time=$($DATE_CMD +"%H:%M")

# Parse flags
SEND_DISCORD=true
FORCE=false

for arg in "$@"; do
  case "$arg" in
    --no-discord)
      SEND_DISCORD=false
      ;;
    --force)
      FORCE=true
      ;;
    --help|-h)
      echo "Usage: gtd-evening-summary [--no-discord] [--force]"
      echo ""
      echo "Collects daily metrics and creates evening summary."
      echo ""
      echo "Options:"
      echo "  --no-discord    Don't send summary to Discord"
      echo "  --force        Force summary even if already logged today"
      exit 0
      ;;
  esac
done

# Check if already logged today (unless forced)
if [[ "$FORCE" != "true" ]]; then
  log_file="${DAILY_LOG_DIR}/${today}.md"
  if [[ -f "$log_file" ]] && grep -q "Evening Summary" "$log_file" 2>/dev/null; then
    echo "â„¹ï¸  Evening summary already logged today. Use --force to create another."
    exit 0
  fi
fi

echo "ğŸ“Š Creating Evening Summary..."
echo ""

# Collect metrics
summary_parts=()
summary_parts+=("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”")
summary_parts+=("ğŸŒ™ Evening Summary - ${today} ${current_time}")
summary_parts+=("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”")
summary_parts+=("")

# 1. Health Summary (if available)
if command -v gtd-sync-health &>/dev/null || [[ -f "$HOME/code/dotfiles/bin/gtd-sync-health" ]]; then
  echo "  ğŸ“Š Syncing health data..."
  if command -v gtd-sync-health &>/dev/null; then
    health_output=$(gtd-sync-health 2>&1)
  else
    health_output=$("$HOME/code/dotfiles/bin/gtd-sync-health" 2>&1)
  fi
  
  # Check if health data was logged today
  log_file="${DAILY_LOG_DIR}/${today}.md"
  if [[ -f "$log_file" ]]; then
    health_entry=$(grep -iE "Apple Watch.*Daily Summary|Apple Watch.*steps.*calories|Health.*Summary" "$log_file" 2>/dev/null | tail -1)
    if [[ -n "$health_entry" ]]; then
      health_time=$(echo "$health_entry" | grep -oE "^[0-9]{2}:[0-9]{2}" || echo "")
      health_data=$(echo "$health_entry" | sed 's/^[0-9][0-9]:[0-9][0-9] - //')
      summary_parts+=("ğŸ’ª **Health:** ${health_data}")
    fi
  fi
fi

# 2. Weather (check if logged today)
log_file="${DAILY_LOG_DIR}/${today}.md"
if [[ -f "$log_file" ]]; then
  weather_entry=$(grep -iE "^[0-9][0-9]:[0-9][0-9] - Weather:" "$log_file" 2>/dev/null | tail -1)
  if [[ -n "$weather_entry" ]]; then
    weather_data=$(echo "$weather_entry" | sed 's/^[0-9][0-9]:[0-9][0-9] - Weather: //')
    summary_parts+=("ğŸŒ¤ï¸  **Weather:** ${weather_data}")
  fi
fi

# 3. Calendar Events (check if logged today)
log_file="${DAILY_LOG_DIR}/${today}.md"
if [[ -f "$log_file" ]]; then
  calendar_entries=$(grep -iE "^[0-9][0-9]:[0-9][0-9] - Calendar:" "$log_file" 2>/dev/null)
  if [[ -n "$calendar_entries" ]]; then
    calendar_count=$(echo "$calendar_entries" | wc -l | tr -d ' ')
    summary_parts+=("ğŸ“… **Calendar:** ${calendar_count} event(s) today")
    # Add first few events
    first_events=$(echo "$calendar_entries" | head -3 | sed 's/^[0-9][0-9]:[0-9][0-9] - Calendar: //' | sed 's/^/   â€¢ /')
    summary_parts+=("$first_events")
  fi
fi

# 4. Mood & Energy (check if logged today)
log_file="${DAILY_LOG_DIR}/${today}.md"
if [[ -f "$log_file" ]]; then
  mood_entries=$(grep -iE "^[0-9][0-9]:[0-9][0-9] - Mood:" "$log_file" 2>/dev/null)
  if [[ -n "$mood_entries" ]]; then
    latest_mood=$(echo "$mood_entries" | tail -1 | sed 's/^[0-9][0-9]:[0-9][0-9] - Mood: //')
    summary_parts+=("ğŸ˜Š **Mood & Energy:** ${latest_mood}")
  fi
fi

# 5. Daily Log Stats
log_file="${DAILY_LOG_DIR}/${today}.md"
if [[ -f "$log_file" ]]; then
  entry_count=$(grep -cE "^[0-9][0-9]:[0-9][0-9] -" "$log_file" 2>/dev/null || echo "0")
  summary_parts+=("ğŸ“ **Daily Log:** ${entry_count} entries today")
fi

# 6. Tasks Completed
if [[ -d "${GTD_BASE_DIR}/tasks" ]]; then
  # Count tasks completed today (simplified - check for completed status)
  completed_today=$(find "${GTD_BASE_DIR}/tasks" -name "*.md" -type f -exec grep -l "status: completed" {} \; 2>/dev/null | wc -l | tr -d ' ')
  if [[ "$completed_today" -gt 0 ]]; then
    summary_parts+=("âœ… **Tasks:** ${completed_today} completed today")
  fi
fi

# 7. Inbox Status
if [[ -d "${GTD_BASE_DIR}/0-inbox" ]]; then
  inbox_count=$(ls -1 "${GTD_BASE_DIR}/0-inbox"/*.md 2>/dev/null | wc -l | tr -d ' ')
  if [[ "$inbox_count" -gt 0 ]]; then
    summary_parts+=("ğŸ“¥ **Inbox:** ${inbox_count} item(s) pending")
  else
    summary_parts+=("ğŸ“¥ **Inbox:** Empty âœ“")
  fi
fi

summary_parts+=("")
summary_parts+=("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”")

# Combine summary
summary=$(IFS=$'\n'; echo "${summary_parts[*]}")

# Log to daily log
log_file="${DAILY_LOG_DIR}/${today}.md"
mkdir -p "$(dirname "$log_file")"

if [[ ! -f "$log_file" ]]; then
  echo "# Daily Log - $today" > "$log_file"
  echo "" >> "$log_file"
fi

echo "" >> "$log_file"
echo "$summary" >> "$log_file"
echo "" >> "$log_file"

echo "âœ“ Evening summary logged to daily log"
echo ""

# Send to Discord if enabled
if [[ "$SEND_DISCORD" == "true" && -n "${GTD_DISCORD_WEBHOOK_URL:-}" ]]; then
  echo "ğŸ“¤ Sending to Discord..."
  
  # Format for Discord (convert markdown to Discord format)
  discord_message=$(echo "$summary" | sed 's/\*\*\([^*]*\)\*\*/**\1**/g' | sed 's/â”â”â”/â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”/g')
  
  # Use send_discord_message function if available, or send directly
  if [[ -f "$HOME/code/dotfiles/bin/gtd-notify" ]]; then
    # Source the function from gtd-notify
    source <(grep -A 50 "^send_discord_message()" "$HOME/code/dotfiles/bin/gtd-notify" 2>/dev/null || echo "send_discord_message() { return 1; }")
    if send_discord_message "ğŸŒ™ Evening Summary - ${today}" "$discord_message"; then
      echo "âœ“ Sent to Discord"
    else
      echo "âš ï¸  Failed to send to Discord"
    fi
  else
    # Direct Discord send
    json_payload=$(python3 -c "
import json
import sys
from datetime import datetime, timezone

title = sys.argv[1]
message = sys.argv[2]

# Discord embed description limit is 2000 characters
if len(message) > 2000:
    message = message[:1900] + '\n\n... (truncated)'

payload = {
    'embeds': [{
        'title': title,
        'description': message,
        'color': 3447003,  # Blue color for summaries
        'timestamp': datetime.now(timezone.utc).isoformat()
    }]
}

print(json.dumps(payload))
" "ğŸŒ™ Evening Summary - ${today}" "$discord_message")
    
    response=$(curl -s -w "\n%{http_code}" -X POST "${GTD_DISCORD_WEBHOOK_URL}" \
      -H "Content-Type: application/json" \
      -d "$json_payload" 2>&1)
    
    http_code=$(echo "$response" | tail -1)
    if [[ "$http_code" == "204" ]]; then
      echo "âœ“ Sent to Discord"
    else
      echo "âš ï¸  Failed to send to Discord (HTTP $http_code)"
    fi
  fi
elif [[ "$SEND_DISCORD" == "true" ]]; then
  echo "âš ï¸  Discord webhook not configured. Set GTD_DISCORD_WEBHOOK_URL in .gtd_config"
fi

echo ""
echo "âœ… Evening summary complete!"

exit 0

