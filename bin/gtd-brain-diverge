#!/bin/bash
# GTD Second Brain - Divergence Phase
# Generate many ideas without judgment (brainstorming)

# Load GTD config
GTD_CONFIG_FILE="$HOME/.gtd_config"
if [[ -f "$HOME/code/dotfiles/zsh/.gtd_config" ]]; then
  GTD_CONFIG_FILE="$HOME/code/dotfiles/zsh/.gtd_config"
elif [[ -f "$HOME/code/personal/dotfiles/zsh/.gtd_config" ]]; then
  GTD_CONFIG_FILE="$HOME/code/personal/dotfiles/zsh/.gtd_config"
fi

if [[ -f "$GTD_CONFIG_FILE" ]]; then
  source "$GTD_CONFIG_FILE"
fi

# Default values
SECOND_BRAIN="${SECOND_BRAIN:-$HOME/Documents/obsidian/Second Brain}"
DIVERGE_DIR="${SECOND_BRAIN}/Divergence"
GTD_BASE_DIR="${GTD_BASE_DIR:-$HOME/Documents/gtd}"

# Create Divergence directory
mkdir -p "$DIVERGE_DIR"

# Colors
CYAN='\033[0;36m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BOLD='\033[1m'
NC='\033[0m'

# Get date command
get_date_cmd() {
  if [[ -x "/usr/bin/date" ]]; then
    echo "/usr/bin/date"
  elif [[ -x "/bin/date" ]]; then
    echo "/bin/date"
  else
    echo "date"
  fi
}

DATE_CMD=$(get_date_cmd)

# Start divergence session
start_divergence() {
  local topic="$1"
  
  if [[ -z "$topic" ]]; then
    read -p "What topic are you brainstorming about? " topic
  fi
  
  local timestamp=$($DATE_CMD +"%Y-%m-%d %H:%M")
  local today=$($DATE_CMD +"%Y-%m-%d")
  local filename=$(echo "$topic" | tr '[:upper:]' '[:lower:]' | sed 's/[^a-z0-9]/-/g' | sed 's/--*/-/g' | sed 's/^-\|-$//g')
  local session_file="${DIVERGE_DIR}/${today}-${filename}.md"
  
  echo ""
  echo -e "${BOLD}${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
  echo -e "${BOLD}${CYAN}ðŸ’¡ Divergence Phase: ${topic}${NC}"
  echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
  echo ""
  echo "Rules for divergence:"
  echo "  â€¢ Generate MANY ideas"
  echo "  â€¢ NO judgment or criticism"
  echo "  â€¢ Build on others' ideas"
  echo "  â€¢ Think wild and creative"
  echo "  â€¢ Quantity over quality"
  echo ""
  
  # Create session file
  cat > "$session_file" <<EOF
# Divergence Session: ${topic}

Created: ${timestamp}
Phase: Divergence
Status: Active

## Topic
${topic}

## Ideas
<!-- Generate as many ideas as possible - no judgment! -->
- 

## Building on Ideas
<!-- Take an idea and expand it -->
- 

## Wild Ideas
<!-- Think outside the box -->
- 

## Related Concepts
<!-- What else relates to this? -->
- 

## Questions
<!-- What questions does this raise? -->
- 

## Tags
#divergence #brainstorming #${filename}

---
Next step: Run 'gtd-brain-converge' to narrow down ideas

EOF

  echo "âœ“ Divergence session started: $session_file"
  echo ""
  echo "ðŸ’¡ Start brainstorming! Add as many ideas as you can."
  echo "   Edit the file: $session_file"
  echo ""
  echo "When done, run: gtd-brain-converge $session_file"
  echo ""
  echo "$session_file"
}

# List divergence sessions
list_sessions() {
  echo ""
  echo -e "${BOLD}${CYAN}Divergence Sessions${NC}"
  echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
  echo ""
  
  local sessions=$(find "$DIVERGE_DIR" -name "*.md" -type f 2>/dev/null | sort -r)
  
  if [[ -z "$sessions" ]]; then
    echo "No divergence sessions found."
    echo ""
    echo "Start one with: gtd-brain-diverge <topic>"
    echo ""
    return 0
  fi
  
  echo "$sessions" | while read -r session; do
    local topic=$(grep "^# Divergence Session:" "$session" | head -1 | sed 's/^# Divergence Session: //' || basename "$session" .md)
    local created=$(grep "^Created:" "$session" | head -1 | cut -d':' -f2- | sed 's/^[[:space:]]*//' || echo "Unknown")
    local idea_count=$(grep -c "^- " "$session" 2>/dev/null | grep -A 100 "## Ideas" | head -50 | wc -l | tr -d ' ' || echo "0")
    
    echo -e "${GREEN}â€¢${NC} ${BOLD}${topic}${NC}"
    echo "  Created: ${created} | Ideas: ${idea_count}"
    echo ""
  done
}

# Show usage
show_usage() {
  cat <<EOF
Usage: gtd-brain-diverge <command> [options]

Commands:
  <topic>                         Start divergence session for topic
  list                            List all divergence sessions
  help                            Show this help

Examples:
  gtd-brain-diverge "Product features"
  gtd-brain-diverge "Ways to improve productivity"
  gtd-brain-diverge list

Divergence is the brainstorming phase - generate many ideas without judgment.
Focus on quantity and creativity. Evaluation comes later in convergence.

EOF
}

# Main command handler
case "${1:-}" in
  list)
    list_sessions
    ;;
  help|--help|-h)
    show_usage
    ;;
  "")
    show_usage
    ;;
  *)
    start_divergence "$1"
    ;;
esac

